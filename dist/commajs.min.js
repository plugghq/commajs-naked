!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CommaJS=t():e.CommaJS=t()}(window,function(){return g=[function(h,d,f){var p,n,i;function o(e){if(i[e])return i[e].exports;var t=i[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}window,h.exports=(i={},o.m=n=[function(e,c,u){"use strict";(function(n){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var o={polyfill:function(){var e=0<navigator.userAgent.indexOf("MSIE ")||!!navigator.userAgent.match(/Trident.*rv\:11\./)||0<navigator.userAgent.indexOf("Edge/");if(!("KeyboardEvent"in window)||"key"in KeyboardEvent.prototype&&!e)return!1;e={get:function(){var e=o.keys[this.which||this.keyCode];return Array.isArray(e)&&(e=e[+this.shiftKey]),e},enumerable:!0,configurable:!0};return Object.defineProperty(KeyboardEvent.prototype,"key",e),e},keys:{3:"Cancel",6:"Help",8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",28:"Convert",29:"NonConvert",30:"Accept",31:"ModeChange",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",41:"Select",42:"Print",43:"Execute",44:"PrintScreen",45:"Insert",46:"Delete",48:["0",")"],49:["1","!"],50:["2","@"],51:["3","#"],52:["4","$"],53:["5","%"],54:["6","^"],55:["7","&"],56:["8","*"],57:["9","("],91:"OS",93:"ContextMenu",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",181:"VolumeMute",182:"VolumeDown",183:"VolumeUp",186:[";",":"],187:["=","+"],188:[",","<"],189:["-","_"],190:[".",">"],191:["/","?"],192:["`","~"],219:["[","{"],220:["\\","|"],221:["]","}"],222:["'",'"'],224:"Meta",225:"AltGraph",246:"Attn",247:"CrSel",248:"ExSel",249:"EraseEof",250:"Play",251:"ZoomOut"}};function t(){var e,t=this.parentNode,n=arguments.length;if(t)for(n||t.removeChild(this);n--;)"object"!==i(e=arguments[n])?e=this.ownerDocument.createTextNode(e):e.parentNode&&e.parentNode.removeChild(e),n?t.insertBefore(this.previousSibling,e):t.replaceChild(e,this)}!function(){for(var e=1;e<25;e++)o.keys[111+e]="F"+e;for(var t="",e=65;e<91;e++)t=String.fromCharCode(e),o.keys[e]=[t.toLowerCase(),t.toUpperCase()];for(e=96;e<106;e++)t=String.fromCharCode(e-48),o.keys[e]=t;u(2)?void 0===(p="function"==typeof(p=o)?p.call(d,f,d,h):p)||(h.exports=p):void 0!==n?n.exports=o:window&&(window.keyboardeventKeyPolyfill=o)}();var r,s,a,a=(s=l,a=[{key:"Init",value:function(){o.polyfill(),Element.prototype.replaceWith||(Element.prototype.replaceWith=t),CharacterData.prototype.replaceWith||(CharacterData.prototype.replaceWith=t),DocumentType.prototype.replaceWith||(DocumentType.prototype.replaceWith=t)}}],(r=null)&&e(s.prototype,r),e(s,a),l);function l(){!function(e){if(!(e instanceof l))throw new TypeError("Cannot call a class as a function")}(this)}c.a=a}).call(this,u(1)(e))},function(e,t){e.exports=function(e){var t;return e.webpackPolyfill||((t=Object.create(e)).children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),Object.defineProperty(t,"exports",{enumerable:!0}),t.webpackPolyfill=1),t}},function(t,e){(function(e){t.exports=e}).call(this,{})},function(e,t,n){"use strict";n.r(t),n.d(t,"BlockNode",function(){return W}),n.d(t,"InlineNode",function(){return J}),n.d(t,"TextNode",function(){return D}),n.d(t,"PluginActions",function(){return ie}),n.d(t,"Plugin",function(){return lt}),n.d(t,"NodeStyle",function(){return _}),n.d(t,"Base64",function(){return ut});var i=n(0);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var r=(o(s.prototype,[{key:"PushChar",value:function(e,t){this.wordCounter++,2<this.wordCounter&&this.Push(e,t)}},{key:"Push",value:function(e,t){this.wordCounter=0;t={content:e,cursorPosition:t};this.history[this.index]=t,this.index++,this.history=this.history.slice(0,this.index)}},{key:"GetUndo",value:function(){this.wordCounter=0;var e=this.index-2,t={content:"",cursorPosition:0};return e<0?(e=0,this.index=1,t=this.history[e]):(t=this.history[e],this.index--),t}},{key:"GetRedo",value:function(){this.wordCounter=0;var e=this.index;e>this.history.length-1&&(e=this.history.length-1);var t=this.history[e];return this.index=e+1,t}}]),s);function s(){!function(e){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}(this),this.history=[],this.index=0,this.wordCounter=0}function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=["Meta+1","Meta+2","Meta+3","Meta+4","Meta+5","Meta+6","Meta+7","Meta+8","Meta+9","Meta+0","Ctrl+q","Ctrl+w","Ctrl+e","Ctrl+r","Ctrl+t","Ctrl+y","Ctrl+o","Ctrl+p","Ctrl+s","Ctrl+d","Ctrl+f","Ctrl+g","Ctrl+h","Ctrl+j","Ctrl+k","Ctrl+l","Ctrl+n","Ctrl+m"],c=(ft=[{key:"FormatKeyboardInput",value:function(e){var t=e.key,n="";return e.metaKey&&(""==n?n="Meta":n+="+Meta"),e.ctrlKey&&(""==n?n="Ctrl":n+="+Ctrl"),e.altKey&&(""==n?n="Alt":n+="+Alt"),n+="+"+t,l.indexOf(n)<0&&(n="_protected_"),n}}],a((n=u).prototype,[{key:"SetShortcuts",value:function(e){var n=this;this.shortcuts=e,null!=this.shortcuts&&this.shortcuts.forEach(function(e){var t={action:e.action,params:e.params};n.shortcutsByKey[e.shortcut.toLowerCase()]=t})}},{key:"Fire",value:function(e){var t=!1;return"_protected_"==e||null!=(e=this.shortcutsByKey[e.toLowerCase()])&&(t=!0,this._performAction(e.action,e.params)),t}},{key:"_performAction",value:function(e,t){"insertText"==e?this.editor.AppendTextAtCursor(t.text):"insertPlugin"==e?this.editor.InsertPluginAtSection(t.pluginName,t.pluginParams):"function"==e&&null!=t&&t()}}]),a(n,ft),u);function u(e,t){!function(e){if(!(e instanceof u))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.shortcutsByKey={},this.SetShortcuts(t)}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var f={ENTER:"enter",ESC:"esc",BACKSPACE:"backspace",DELETE:"delete",TAB:"tab",CUT:"cut",COPY:"copy",PASTE:"paste",CUR_POS_CHANGED:"cursorPositionHasChanged",AFTER_CHAR_ADDED:"afterCharacterIsAdded",ARROW_UP:"arrowUp",ARROW_DOWN:"arrowDown",ARROW_LEFT:"arrowLeft",ARROW_RIGHT:"arrowRight",SHIFT_ARROW_UP:"shiftArrowUp",SHIFT_ARROW_DOWN:"shiftArrowDown",SHIFT_ARROW_LEFT:"shiftArrowLeft",SHIFT_ARROW_RIGHT:"shiftArrowRight",SHIFT_DOWN:"SHIFT_DOWN",SHIFT_UP:"SHIFT_UP",SELECT_ALL:"SELECT_ALL",BEFORE_COPY:"BEFORE_COPY",BEFORE_CUT:"BEFORE_CUT",BEFORE_PASTE:"BEFORE_PASTE",BOLD:"BOLD",ITALIC:"ITALIC",UNDERLINED:"UNDERLINED",SELECTION_CHANGED:"SELECTION_CHANGED"},p=(d(g.prototype,[{key:"OnClick",value:function(e){this.editor.FireStyleMonitoring(),this.editor.Fire(f.CUR_POS_CHANGED,e),this.editor.Fire(f.CLICK,e),e.preventDefault(),e.stopPropagation()}},{key:"KeyDown",value:function(e){var t=e.key;switch(t){case"Tab":this.editor.Fire(f.TAB,e)&&(e.preventDefault(),e.stopPropagation());break;case"Meta":break;case"Shift":this.editor.Fire(f.SHIFT_DOWN,e)&&(e.preventDefault(),e.stopPropagation());break;case"Alt":case"Control":break;case"Down":case"ArrowDown":(e.shiftKey?this.editor.Fire(f.SHIFT_ARROW_DOWN,e):this.editor.Fire(f.ARROW_DOWN,e))&&(e.preventDefault(),e.stopPropagation());break;case"Up":case"ArrowUp":(e.shiftKey?this.editor.Fire(f.SHIFT_ARROW_UP,e):this.editor.Fire(f.ARROW_UP,e))&&(e.preventDefault(),e.stopPropagation());break;case"Left":case"ArrowLeft":(e.shiftKey?this.editor.Fire(f.SHIFT_ARROW_LEFT,e):this.editor.Fire(f.ARROW_LEFT,e))&&(e.preventDefault(),e.stopPropagation());break;case"Right":case"ArrowRight":(e.shiftKey?this.editor.Fire(f.SHIFT_ARROW_RIGHT,e):this.editor.Fire(f.ARROW_RIGHT,e))&&(e.preventDefault(),e.stopPropagation());break;case"CapsLock":break;case"Enter":this.editor.Fire(f.ENTER,e)&&(e.preventDefault(),e.stopPropagation());break;case"Esc":case"Escape":this.editor.Fire(f.ESC,e)&&(e.preventDefault(),e.stopPropagation());break;case"Backspace":this.editor.Fire(f.BACKSPACE,e)&&(e.preventDefault(),e.stopPropagation());break;case"Delete":this.editor.Fire(f.DELETE,e)&&(e.preventDefault(),e.stopPropagation());break;default:e.metaKey&&!e.shiftKey&&"z"==t?(this.editor.Undo(),e.preventDefault(),e.stopPropagation()):e.shiftKey&&e.metaKey&&"z"==t?(this.editor.Redo(),e.preventDefault(),e.stopPropagation()):e.ctrlKey&&!e.shiftKey&&"z"==t?(this.editor.Undo(),e.preventDefault(),e.stopPropagation()):e.ctrlKey&&e.shiftKey&&"z"==t?(this.editor.Redo(),e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey)&&"a"==t?this.editor.Fire(f.SELECT_ALL,e)&&(e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey)&&"c"==t?this.stopClipboardEvent=this.editor.Fire(f.BEFORE_COPY,e):(e.metaKey||e.ctrlKey)&&"x"==t?this.stopClipboardEvent=this.editor.Fire(f.BEFORE_CUT,e):(e.metaKey||e.ctrlKey)&&"b"==t?(this.stopClipboardEvent=this.editor.Fire(f.BOLD,e),e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey)&&"i"==t?(this.stopClipboardEvent=this.editor.Fire(f.ITALIC,e),e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey)&&"u"==t?(this.stopClipboardEvent=this.editor.Fire(f.UNDERLINED,e),e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey||e.altKey)&&""!=t&&this.editor.ManageUserShortcuts(c.FormatKeyboardInput(e))&&(e.preventDefault(),e.stopPropagation()),e.metaKey||e.ctrlKey||e.altKey||""!=t&&this.editor.InsertCharacter(t)&&(e.preventDefault(),e.stopPropagation())}this.editor.Fire(f.AFTER_CHAR_ADDED,e)}},{key:"KeyUp",value:function(e){var t=e.key;switch(t){case"Meta":break;case"Shift":this.editor.Fire(f.SHIFT_UP,e)&&(e.preventDefault(),e.stopPropagation());break;case"Alt":case"Control":break;case"Down":case"ArrowDown":this.editor.FireStyleMonitoring(),this.editor.Fire(f.CUR_POS_CHANGED,e);break;case"Up":case"ArrowUp":this.editor.FireStyleMonitoring(),this.editor.Fire(f.CUR_POS_CHANGED,e);break;case"Left":case"ArrowLeft":this.editor.FireStyleMonitoring(),this.editor.Fire(f.CUR_POS_CHANGED,e);break;case"Right":case"ArrowRight":this.editor.FireStyleMonitoring(),this.editor.Fire(f.CUR_POS_CHANGED,e)}e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||""!=t&&this.editor.DoneInsertCharacter(t)}},{key:"OnPaste",value:function(e){var t=e.clipboardData.getData("text/html"),n=Array.from(e.clipboardData.files||[]);if(!t&&0<n.length){if(null!=this.editor.onFilesPasted){var i=[],o=function(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e){if(e){if("string"==typeof e)return h(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?h(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,t=function(){};return{s:t,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return r=e.done,e},e:function(e){s=!0,o=e},f:function(){try{r||null==n.return||n.return()}finally{if(s)throw o}}}}(n);try{for(o.s();!(r=o.n()).done;){var r=r.value;0==i.length&&i.push(r)}}catch(e){o.e(e)}finally{o.f()}this.editor.onFilesPasted(i)}else console.log("Files paste not supported: add onFilesPasted implementation");e.preventDefault(),e.stopPropagation()}else this.stopClipboardEvent=this.editor.Fire(f.BEFORE_PASTE,e),(this.stopClipboardEvent||this.editor.Fire(f.PASTE,e))&&(e.preventDefault(),e.stopPropagation()),this.stopClipboardEvent=!1}},{key:"OnCut",value:function(e){(this.stopClipboardEvent||this.editor.Fire(f.CUT,e))&&(e.preventDefault(),e.stopPropagation()),this.stopClipboardEvent=!1}},{key:"OnCopy",value:function(e){(this.stopClipboardEvent||this.editor.Fire(f.COPY,e))&&(e.preventDefault(),e.stopPropagation()),this.stopClipboardEvent=!1}}]),g);function g(e){!function(e){if(!(e instanceof g))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.stopClipboardEvent=!1}function m(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var v=(m(b.prototype,[{key:"GetNew",value:function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=!1,n="";!t;){for(var i=0;i<5;i++)n+=e.charAt(Math.floor(Math.random()*e.length));null==this.allKeys[n]&&(t=this.allKeys[n]=!0)}return n}},{key:"Release",value:function(e){delete this.allKeys[e]}},{key:"VerifyAndRegister",value:function(e){return this.allKeys[e]&&(e=this.GetNew()),this.allKeys[e]=!0,e}},{key:"Reset",value:function(){this.allKeys={}}}]),b),y={exampleClass:{applyAs:"class",classes:["ex1","ex2"]},margin:{applyAs:"style",name:"margin",on:"set#by#user",off:"",isToggle:!1},width:{applyAs:"style",name:"width",on:"set#by#user",off:"",isToggle:!1},height:{applyAs:"style",name:"height",on:"set#by#user",off:"",isToggle:!1},border:{applyAs:"style",name:"border",on:"set#by#user",off:"",isToggle:!1},bold:{applyAs:"style",name:"fontWeight",on:"bold",off:"normal",isToggle:!0},italic:{applyAs:"style",name:"fontStyle",on:"italic",off:"normal",isToggle:!0},underlined:{applyAs:"style",name:"textDecorationLine",on:"underline",off:"none",preserve:!0,isToggle:!0},strike:{applyAs:"style",name:"textDecorationLine",on:"line-through",off:"none",preserve:!0,isToggle:!0},fontSize:{applyAs:"style",name:"fontSize",on:"set#by#user",off:"initial",isToggle:!1},fontFamily:{applyAs:"style",name:"fontFamily",on:"set#by#user",off:"initial",isToggle:!1},fontColor:{applyAs:"style",name:"color",on:"set#by#user",off:"initial",isToggle:!1,isColor:!0},backgroundColor:{applyAs:"style",name:"backgroundColor",on:"set#by#user",off:"initial",isToggle:!1,isColor:!0},align:{applyAs:"style",name:"textAlign",on:"set#by#user",off:"left",isToggle:!0},indent:{applyAs:"style",name:"paddingLeft",step:40,preserve:!1,calculated:!0,unit:"px",on:0,off:0,isToggle:!1},lineSpacing:{applyAs:"style",name:"lineHeight",on:"set#by#user",off:"normal",isToggle:!1},horizontalRule:{applyAs:"style",name:"borderBottom",on:"1px solid #8c8c8c",off:"none"},headerOne:{applyAs:"class",classes:["headerOne"]},headerTwo:{applyAs:"class",classes:["headerTwo"]},headerThree:{applyAs:"class",classes:["headerThree"]},superscript:{applyAs:"class",classes:["scplSup"],isToggle:!0},subscript:{applyAs:"class",classes:["scplSub"],isToggle:!0},splitSelection:{applyAs:"class",classes:["splitSelectionDummy"]},quote:{applyAs:"class",classes:["commaQuoteContainer"],isToggle:!0}};function b(e){!function(e){if(!(e instanceof b))throw new TypeError("Cannot call a class as a function")}(this),this.allKeys={},null!=e&&e.forEach(function(e){this.allKeys[e]=!0})}function C(t,e){var n,i=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)),i}function x(i){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?C(Object(o),!0).forEach(function(e){var t,n=i,e=o[t=e];t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):C(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))})}return i}function w(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function S(e,t,n){var i,o;return e.classList?n?e.classList.toggle(t,!0):e.classList.toggle(t):0<=(o=(i=e.className.split(" ")).indexOf(t))&&!n?i.splice(o,1):(i.push(t),e.className=i.join(" ")),e}var _=(n=[{key:"GetAllStyles",value:function(e){var t=y;return null!=e.allStyles&&(t=x(x({},y),e.allStyles)),t}},{key:"cssNameToJsName",value:function(e){for(var t=e.split("-"),n="",i=0;i<t.length;i++)0<i&&0<t[i].length&&(1!=i||"ms"!=t[i])&&(t[i]=t[i].substr(0,1).toUpperCase()+t[i].substr(1)),n+=t[i];return n}},{key:"jsNameToCssName",value:function(e){return e.replace(/([A-Z])/g,"-$1").toLowerCase()}},{key:"ParseDefaultFormat",value:function(e,n){var i=new E(e);return null!=n&&Object.keys(n).forEach(function(e){var t=n[e];t&&i.Toggle(e,t)}),i}},{key:"parseStyle",value:function(e){var t={};if(3!=e.nodeType&&8!=e.nodeType&&null!=e.getAttribute("cm-plugin"))for(var n=0,i=e.style.length;n<i;n++){var o=e.style[n].replace(/-([a-z])/g,function(e){return e[1].toUpperCase()}),r=e.style[o];t[o]=r}return t}},{key:"CalculateStylesForExternalHTML",value:function(e,t){var n=window.getComputedStyle(t),i=E.GetAllStyles(e),t=Object.keys(i),o={},r=new E(e);t.forEach(function(e){var t;"height"==e.toLowerCase()||"width"==e.toLowerCase()||"style"==(t=JSON.parse(JSON.stringify(i[e]))).applyAs&&(o[t.name]=e)});for(var s=n.length;s--;){var a,l=n[s],c=n.getPropertyValue(l),u=o[E.cssNameToJsName(l)];null==u||""==u||null!=(a=JSON.parse(JSON.stringify(i[u])))&&("set#by#user"==a.on?(a.on=c,r.styles[u]=a):a.preserve?c.indexOf(a.on)<0||(r.styles[u]=a):(a.calculated?(l=null!=(l=c.replace(a.unit,""))&&""!=l?parseInt(l):0,a.on=l):a.on==c||(a.on=c),r.styles[u]=a))}return r}},{key:"CalculateStyles",value:function(e,a){var l=E.parseStyle(a),c=new E(e),u=E.GetAllStyles(e);return Object.keys(u).forEach(function(e){var t,n,i,o,r,s=JSON.parse(JSON.stringify(u[e]));"style"==s.applyAs?null==a.style||null!=(t=a.style[s.name])&&""!=t&&(null!=l[s.name]&&delete l[s.name],"set#by#user"==s.on?(s.on=t,c.styles[e]=s):s.preserve?t.indexOf(s.on)<0||(c.styles[e]=s):s.calculated?(n=null!=(n=t.replace(s.unit,""))&&""!=n?parseInt(n):0,s.on=n,c.styles[e]=s):s.on==t&&(c.styles[e]=s)):"class"==s.applyAs&&(a.classList?(i=!0,s.classes.forEach(function(e){a.classList.contains(e)||(i=!1)}),i&&(c.styles[e]=s)):null!=a.className&&(o=a.className.split(" "),r=!0,s.classes.forEach(function(e){o.indexOf(e)<0&&(r=!1)}),r&&(c.styles[e]=s)))}),c.additionalStyles=l,c.additionalClasses={},c}}],w((ft=E).prototype,[{key:"isEmpty",value:function(){var e=!1,t=Object.keys(this.styles).length,n=Object.keys(this.additionalStyles).length,i=Object.keys(this.additionalStyles).length;return 0==t&&0==n&&0==i&&(e=!0),e}},{key:"toStringForStyleTag",value:function(){var i="",n=this,e=Object.keys(this.styles),o={};return e.forEach(function(e){var t=n.styles[e];"style"==t.applyAs&&(t.preserve?(null==o[t.name]&&(o[t.name]=[]),o[t.name].push(t)):(e=t.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),t=t.on,i=i+e+": "+t.replace(/"/g,"'")+";"))}),Object.keys(o).forEach(function(e){var e=o[e],t="",n="";e.forEach(function(e){"style"==e.applyAs&&e.preserve&&(t=e.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),n=""==n?e.on:n+" "+e.on)}),i=i+t+": "+n.replace(/"/g,"'")+";"}),i}},{key:"toStringForClassTag",value:function(){var t="",n=this;return Object.keys(this.styles).forEach(function(e){e=n.styles[e];"class"==e.applyAs&&e.classes.forEach(function(e){t=""==t?e:t+" "+e})}),t}},{key:"toJSON",value:function(){return{style:this.styles}}},{key:"Copy",value:function(){var e=new E(this.document);return e.styles=JSON.parse(JSON.stringify(this.styles)),e.additionalStyles=JSON.parse(JSON.stringify(this.additionalStyles)),e.additionalClasses=JSON.parse(JSON.stringify(this.additionalClasses)),e}},{key:"Equals",value:function(n){var i=!0,o=this,t=Object.keys(n.styles),e=Object.keys(o.styles);return t.length!=e.length?i=!1:(e.forEach(function(e){t.indexOf(e)<0&&(i=!1)}),i&&e.every(function(e){var t=o.styles[e],e=n.styles[e];return t.on!=e.on&&(i=!1,t.isColor&&e.isColor&&o.AreSameColors(t.on,e.on)&&(i=!0)),i})),i}},{key:"AreSameColors",value:function(e,t){return(e=this._parseColor(e))==this._parseColor(t)}},{key:"_parseColor",value:function(e){var t=e;return null!=e&&(-1<e.toLowerCase().indexOf("rgb")||-1<e.toLowerCase().indexOf("rgba"))&&(e=(e=e.toLowerCase()).split("(")[1].split(")")[0].split(","),t="#"+this._rgbToHex(e[0].split(" ").join(""))+this._rgbToHex(e[1].split(" ").join(""))+this._rgbToHex(e[2].split(" ").join(""))),t}},{key:"_rgbToHex",value:function(e){e=Number(e).toString(16);return e.length<2&&(e="0"+e),e}},{key:"isAlreadyApplied",value:function(e){var t=E.GetAllStyles(this.document);if(null==t[e])return console.log("Unknown style: "+e),!1;var n=JSON.parse(JSON.stringify(t[e])),t=!1;return"style"==n.applyAs?null!=this.styles[e]&&(t="set#by#user"!=n.on):"class"==n.applyAs&&null!=this.styles[e]&&(t=!0),t}},{key:"Apply",value:function(i){var o=this;i.style="",Object.keys(o.styles).forEach(function(e){var t,n=o.styles[e];"style"==n.applyAs?"set#by#user"==n.on?i.style[n.name]=n.on:n.preserve?(e=i.style[n.name],t="",e.split(" ").forEach(function(e){e!=n.on&&"none"!=e&&(t+=" "+e)}),t+=" "+n.on,i.style[n.name]=t):n.calculated?i.style[n.name]=n.on.toString()+n.unit:i.style[n.name]=n.on:"class"==n.applyAs&&n.classes.forEach(function(e){i=S(i,e,!0)})}),Object.keys(o.additionalStyles).forEach(function(e){i.style[e]=o.additionalStyles[e]})}},{key:"Toggle",value:function(e,t,n){var i=2<arguments.length&&void 0!==n&&n,o=E.GetAllStyles(this.document);if(null==o[e])return console.log("Unknown style: "+e),!1;n=JSON.parse(JSON.stringify(o[e])),o=!0;return this.isAlreadyApplied(e)&&!i?(o=!1,delete this.styles[e]):"style"==n.applyAs?("set#by#user"==n.on&&(n.on=t),this.styles[e]=n):"class"==n.applyAs&&(this.styles[e]=n),o}},{key:"CalculateStyle",value:function(e,t){return"style"==e.applyAs&&e.calculated&&("add"==t?e.on=e.on+e.step:"subtract"==t&&(e.on=e.on-e.step,e.on<e.off&&(e.on=e.off))),e}},{key:"ToggleOnDomElement",value:function(t,e,n,i){var o=3<arguments.length&&void 0!==i&&i,i=E.GetAllStyles(this.document);if(null==i[e])return console.log("Unknown style: "+e),!1;if(null==i[e])throw"Style '"+e+"' is not defined";var r,s,a,l=JSON.parse(JSON.stringify(i[e])),i=!0;return this.isAlreadyApplied(e)&&!o?(i=!1,"style"==l.applyAs?"set#by#user"==l.on?t.style[l.name]=l.off:l.calculated?(null==(o=this.styles[e])&&(o=JSON.parse(JSON.stringify(l))),o=this.CalculateStyle(o,n),t.style[l.name]=o.on.toString()+o.unit):(l.preserve?(s=t.style[l.name],r="",s.split(" ").forEach(function(e){e!=l.on&&(r+=" "+e)}),""==r&&(r+=" "+l.off),t.style[l.name]=r):t.style[l.name]=l.off,delete this.styles[e]):"class"==l.applyAs&&(delete this.styles[e],l.classes.forEach(function(e){t=S(t,e)}))):"style"==l.applyAs?("set#by#user"==l.on?((l=JSON.parse(JSON.stringify(l))).on=n,t.style[l.name]=n):l.preserve?(s=t.style[l.name],a="",s.split(" ").forEach(function(e){e!=l.on&&"none"!=e&&(a+=" "+e)}),a+=" "+l.on,t.style[l.name]=a):l.calculated?(l=this.CalculateStyle(l,n),t.style[l.name]=l.on.toString()+l.unit):t.style[l.name]=l.on,this.styles[e]=l):"class"==l.applyAs&&(l.classes.forEach(function(e){t=S(t,e)}),this.styles[e]=l),i}}]),w(ft,n),E);function E(e,t){!function(e){if(!(e instanceof E))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,null!=t&&(t=JSON.parse(JSON.stringify(t))),this.styles=t,null==this.styles&&(this.styles={}),this.additionalStyles={},this.additionalClasses={}}function T(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var k={BLOCK:"block",INLINE:"inline",TEXT:"text"},A=(T(O.prototype,[{key:"AddAttribute",value:function(e,t){var n={name:e,value:t};this.attributes.push(n),null!=this.domElement&&this.domElement.setAttribute(e,t)}},{key:"GetAttribute",value:function(t){var e,n=void 0;return this.attributes.forEach(function(e){e.name==t&&(n=e.value)}),null!=n||null!=(e=this.domElement.getAttribute(t))&&(n=e),n}},{key:"RemoveAttribute",value:function(t){var n=this,i=[];this.attributes.forEach(function(e){e.name==t?null!=n.domElement&&n.domElement.removeAttribute(t):i.push(e)}),this.attributes=i}},{key:"_isType",value:function(e){var t=!1;return this.type==e&&(t=!0),t}},{key:"isBlockNode",value:function(){return this._isType(k.BLOCK)}},{key:"isInlineNode",value:function(){return this._isType(k.INLINE)}},{key:"isTextNode",value:function(){return this._isType(k.TEXT)}},{key:"IsStyleApplied",value:function(e){return this.nodeStyle.isAlreadyApplied(e)}},{key:"ToggleStyle",value:function(e,t,n,i){n=!(2<arguments.length&&void 0!==n)||n,i=3<arguments.length&&void 0!==i&&i;return null!=this.nodeStyle&&null!=this.nodeStyle.styles||(this.nodeStyle=new _(this.document)),n?this.nodeStyle.ToggleOnDomElement(this.domElement,e,t,i):this.nodeStyle.Toggle(e,t,i)}},{key:"GetBlockContainer",value:function(){return this.isBlockNode()?this:this.parent.GetBlockContainer()}},{key:"SetPluginType",value:function(e){this.pluginName=e,this.domElement.setAttribute("cm-plugin",e)}},{key:"RemovePluginType",value:function(){this.pluginName="",this.domElement.removeAttribute("cm-plugin")}},{key:"GetPluginType",value:function(){return this.pluginName}},{key:"Delete",value:function(e){e?this.document.DeleteNode(this):this.document.DeleteNode(this,!0)}},{key:"Contains",value:function(t){var n=!1;return null!=this.children&&this.children.forEach(function(e){n=n||e.id==t||e.Contains(t)}),n}}]),O);function O(e,t,n,i){var o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0;!function(e){if(!(e instanceof O))throw new TypeError("Cannot call a class as a function")}(this),null==o&&(o=new _(e)),this.document=e,this.id=t,this.tagName=n,this.type=i,this.nodeStyle=o,this.attributes=[],this.children=[],this.previous=void 0,this.next=void 0,this.parent=void 0,this.domElement=void 0}function N(e){return(N="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function P(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function F(e,t){return(F=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function M(e){return(M=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var D=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),F(e,t)}(a,A);var e,t,i,o,s=(i=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=M(i),n=this;return!(t=o?(e=M(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==N(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function a(e,t,n,i,o){var r=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[];return function(e){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this),(i=s.call(this,e,t,n,k.TEXT,i)).attributes=r,null==o&&(o=""),i.text=o,i.GenerateDomElement(),i}return t=[{key:"CreateNew",value:function(e,t,n,i,o){o=new a(e,e.GenereateNewNodeId(),t,i,n,o);return e.RegisterNode(o),o}}],P((e=a).prototype,[{key:"Copy",value:function(){return new a(this.document,"",this.tagName,this.nodeStyle.Copy(),this.text,JSON.parse(JSON.stringify(this.attributes)))}},{key:"Append",value:function(){throw new Exception("Text nodes cannot contain any other node")}},{key:"GenerateDomElement",value:function(){this.domElement=void 0;var t=document.createElement(this.tagName);t.setAttribute("cm-id",this.id),t.setAttribute("cm-type",this.type),this.attributes.forEach(function(e){""!=e.name&&t.setAttribute(e.name,e.value)}),""==this.text?t.appendChild(document.createTextNode("\ufeff")):t.appendChild(document.createTextNode(this.text)),this.domElement=t,null!=this.nodeStyle&&this.nodeStyle.Apply(this.domElement)}},{key:"ApplyNodeStyle",value:function(e){null!=e&&(this.nodeStyle=e,this.nodeStyle.Apply(this.domElement))}},{key:"SetAttributes",value:function(e){var t=this;this.attributes=e,this.attributes.forEach(function(e){""!=e.name&&t.domElement.setAttribute(e.name,e.value)})}},{key:"AddAttribute",value:function(e,t){t={name:e,value:t};this.attributes.push(t),this.domElement.setAttribute(t.name,t.value)}},{key:"RemoveAttribute",value:function(t){var n=[];this.attributes.forEach(function(e){e.name!=t&&n.push(e)}),this.attributes=n,this.domElement.removeAttribute(t)}},{key:"SetFocusAtTheEnd",value:function(){this.SetCarretAtTheEnd()}},{key:"SetCarretAtTheEnd",value:function(){this.SelectText(this.text.length,this.text.length)}},{key:"SelectText",value:function(e,t){var n,i;e==t?this.SetFocus(e):(n=window.getSelection(),(i=document.createRange()).setStart(this.domElement.firstChild,e),i.setEnd(this.domElement.firstChild,t),n.removeAllRanges(),n.addRange(i))}},{key:"SetFocus",value:function(e){null==e&&(e=0),""==this.text&&(e=1);var t=document.createRange(),n=window.getSelection();if(null!=this.domElement.firstChild){this.domElement.firstChild.length<e&&(e=this.domElement.firstChild.length),t.setStart(this.domElement.firstChild,e),t.collapse(!0),n.removeAllRanges();try{n.addRange(t)}catch(e){console.log(e)}}}},{key:"HasSameStyle",value:function(e){return this.nodeStyle.Equals(e.nodeStyle)}},{key:"HasSameAttributes",value:function(e){var t,n=!0,e=e.attributes;return this.attributes.length!=e.length?n=!1:(t={},e.forEach(function(e){t[e.name]=e.value}),this.attributes.forEach(function(e){null!=t[e.name]&&t[e.name]==e.value||(n=!1)})),n}},{key:"SetZeroWidthChar",value:function(){this.text="",this.domElement.removeChild(this.domElement.firstChild),this.domElement.appendChild(document.createTextNode("\ufeff"))}},{key:"TrimTextContent",value:function(e,t){this.ForceTextContent(this.text.substring(e,t))}},{key:"DeleteText",value:function(e,t){var n,i;"string"!=typeof this.text&&(this.text=JSON.stringify(this.text)),""==this.text||(0==e&&t==this.text.length?this.text="":e==t||(0<e?t<this.text.length?(n=this.text.substring(0,e),this.text.substring(e,t),i=this.text.substring(t,this.text.length),this.text=n+i):t==this.text.length&&(i=this.text.substring(0,e),this.text.substring(e,t),this.text=i):0==e&&t<this.text.length&&(this.text.substring(e,t),t=this.text.substring(t,this.text.length),this.text=t)))}},{key:"RemoveCharAt",value:function(e,t){var n=this.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,"");this.text=n.slice(0,e)+n.slice(e+1),null!=t&&t&&this.ForceTextContent(this.text)}},{key:"AppendTextContent",value:function(e){this.text=this.text+e,this.ForceTextContent(this.text)}},{key:"ForceTextContent",value:function(e){this.text=e,""==this.text?(this.domElement.removeChild(this.domElement.firstChild),this.domElement.appendChild(document.createTextNode("\ufeff"))):(this.domElement.removeChild(this.domElement.firstChild),this.domElement.appendChild(document.createTextNode(this.text)))}},{key:"ForceInsertString",value:function(e){var t,n;""==this.text?(this.text=e,this.domElement.textContent=this.text,this.SetFocus(e.length)):null!=e&&""!=e&&(t=document.getSelection().getRangeAt(0).startOffset,n=this.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""),this.text=[n.slice(0,t),e,n.slice(t)].join(""),"\n"==e&&""==n.slice(t)&&(this.text=this.text+" "),this.domElement.textContent=this.text,this.SetFocus(t+e.length))}},{key:"InsertCharacter",value:function(e){var t,n,i=!1;return""==this.text?(" "==e&&(e="Â "),t=document.createTextNode(e),this.domElement.removeChild(this.domElement.firstChild),this.domElement.appendChild(t),(t=(n=document.getSelection()).getRangeAt(0)).selectNodeContents(this.domElement.firstChild),t.collapse(),n.removeAllRanges(),n.addRange(t),i=!0,this.text=this.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,"")):(null==e&&(e=""),n=document.getSelection().getRangeAt(0),t=this.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""),n=n.startOffset,this.text=[t.slice(0,n),e,t.slice(n)].join(""),i=!1),i}},{key:"Split",value:function(e,t){var n,i,o,r,s,a,l,c=[];return""==this.text||0==e&&t==this.text.length?c.push(this):e==t?0==e?((n=this.Copy()).text="",c.push(n),n=this.Copy(),c.push(n)):e==this.text.length?(i=this.Copy(),c.push(i),(i=this.Copy()).text="",c.push(i)):(i=this.text.substring(0,e),o=this.text.substring(e,this.text.length),(r=this.Copy()).text=i,c.push(r),(r=this.Copy()).text="",c.push(r),(r=this.Copy()).text=o,c.push(r)):0<e?t<this.text.length?(o=this.text.substring(0,e),r=this.text.substring(e,t),s=this.text.substring(t,this.text.length),(a=this.Copy()).text=o,c.push(a),(a=this.Copy()).text=r,c.push(a),(a=this.Copy()).text=s,c.push(a)):t==this.text.length&&(s=this.text.substring(0,e),a=this.text.substring(e,t),(l=this.Copy()).text=s,c.push(l),(l=this.Copy()).text=a,c.push(l)):0==e&&t<this.text.length&&(l=this.text.substring(e,t),e=this.text.substring(t,this.text.length),(t=this.Copy()).text=l,c.push(t),(t=this.Copy()).text=e,c.push(t)),c}},{key:"Merge",value:function(t,e){if(!t.isTextNode())throw console.log("87-16"),"Fatal error: 87-16";var n,i,o,r=this;null==e?r.text=r.text+t.text:(n=r.text,i=t.text,r.text=[n.slice(0,e),i,n.slice(e)].join("")),r.ForceTextContent(r.text),r.next=t.next,t.domElement.remove(),this.document.UnregisterNode(t),null!=t.parent&&(o=[],t.parent.children.forEach(function(e){e.id!=t.id&&o.push(e)}),t.parent.children=o)}},{key:"ChangeTagName",value:function(e){this.tagName=e;for(var t=this.domElement,n=document.createElement(e),i=0,o=t.attributes.length;i<o;++i){var r=t.attributes.item(i).nodeName,s=t.attributes.item(i).nodeValue;n.setAttribute(r,s)}for(;t.hasChildNodes();)n.appendChild(t.removeChild(t.firstChild));t.parentNode.replaceChild(n,t),this.domElement=n}}]),P(e,t),a}();function R(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var I=(ft=[{key:"PrintToConsole",value:function(e,t){e=new L(e);t?e._debugPrintNode(e.document.rootNode):console.log(e.document.rootNode)}},{key:"DeleteNodesBetween",value:function(e,t,n){return new L(e)._DeleteNodesBetween(t,n)}},{key:"GetAllTextNodes",value:function(e,t,n,i){return new L(e)._getAllTextNodes(t,n,i)}},{key:"InsertNodeAtCursor",value:function(e,t){e.selectionManager.IsCollapsed()||e.DeleteSelection();var n=e.selectionManager.GetCurrent(),i=n.startNode,o=n.startOffset,r=n.endOffset;i.isTextNode()&&(n=[],2==(r=i.Split(o,r)).length?0==o?(t.isInlineNode()&&n.push(D.CreateNew(e,"span","",i.nodeStyle.Copy())),n.push(t),n.push(r[1])):(n.push(r[0]),n.push(t)):3==r.length?(n.push(r[0]),n.push(t),n.push(r[2])):1==r.length&&(t.isInlineNode()&&n.push(D.CreateNew(e,"span","",i.nodeStyle.Copy())),n.push(t)),L.ReplaceNode(e,i,n,!1,!0,i.nodeStyle.Copy()),t.next.SetFocus())}},{key:"ReplaceNode",value:function(n,i,o,r,e,s){var a=n;null==r&&(r=!1);var l,c,u,h,t,d,f=i.parent,p=!0;(null==f||1==o.length&&o[0].id==i.id)&&(p=!1),p&&(c=void 0,h=u=!(l=[]),f.children.forEach(function(e){var t;e.id==i.id?(o.forEach(function(e){var t;e.id=a.GenereateNewNodeId(),e.GenerateDomElement(),null!=c&&(c.next=e,c.isInlineNode()&&e.isInlineNode()&&((t=D.CreateNew(n,"span","",s.Copy())).previous=c,t.parent=c.parent,c.next=t,c.domElement.parentNode.insertBefore(t.domElement,c.domElement.nextSibling),l.push(t),c=t)),e.previous=c,e.next=void 0,e.parent=f,e.document=f.document,c=e,l.push(e),a.RegisterNode(e)}),u=!0,r&&(h=!0)):h||(u&&(null!=c&&(c.isInlineNode()&&e.isInlineNode()?(null==s&&(s=n.GetDefaultNodeStyle()),(t=D.CreateNew(n,"span","",s.Copy())).previous=c,t.parent=c.parent,c.next=t,c=t,e.domElement.parentNode.insertBefore(t.domElement,e.domElement),l.push(t)):c.next=e),e.previous=c,u=!1),null!=(c=e).next&&e.next.id==i.id&&(e.next=void 0),l.push(e))}),f.children=l,t=!0,d=void 0,o.forEach(function(e){t?(t=!1,i.domElement.replaceWith(e.domElement)):d.domElement.parentNode.insertBefore(e.domElement,d.domElement.nextSibling),d=e}),t&&i.domElement.remove(),a.UnregisterNode(i),e?(e=D.CreateNew(n,"span","",s.Copy()),f.Append(e)):f.isBlockNode()&&0==f.children?L.ReplaceNode(n,f,[],r):i.isBlockNode())}}],R((n=L).prototype,[{key:"_debugPrintNode",value:function(e,t){var n=this;null==t&&(t=""),e.isTextNode()?console.log(t+e.id+" "+e.tagName+" %c"+e.type+" %c=> [%c"+e.text+"%c]","color:#ad0c9d","color:black","color:#129957","color:black"):console.log(t+e.id+" "+e.tagName+" %c"+e.type,"color:#ad0c9d"),e.children.forEach(function(e){n._debugPrintNode(e,t+"   ")})}},{key:"_recursive_getAllTextNodes",value:function(e){var t;this.adding?this.toNode.id==e.id?(this.adding=!1,this.includeFromAndToInResults&&e.isTextNode()&&this.opResults.push(e),this.completed=!0):e.isTextNode()&&this.opResults.push(e):this.fromNode.id==e.id&&(this.adding=!0,this.includeFromAndToInResults&&e.isTextNode()&&this.opResults.push(e)),this.completed||(t=this,e.children.every(function(e){return t._recursive_getAllTextNodes(e),!t.completed}))}},{key:"_getAllTextNodes",value:function(e,t,n){this.fromNode=e,this.toNode=t,this.includeFromAndToInResults=n,this.adding=!1,this.completed=!1,this.opResults=[];var i=this;return this.document.rootNode.children.every(function(e){return i._recursive_getAllTextNodes(e),!i.completed}),this.opResults}},{key:"_deleteNode_DNB",value:function(e){var n=[],i=this;return e.children.forEach(function(e){var t=!0;e.id==i.fromNode.id?i.deleting=!0:e.id==i.toNode.id?(i.deleting=!1,i.doneDeleting=!0):i.deleting?t=!i._deleteNode_DNB(e):i.doneDeleting||i._deleteNode_DNB(e),t&&n.push(e)}),i.deleting&&0==n.length?(e.domElement.remove(),i.document.UnregisterNode(e),null!=e.previous&&(e.previous.next=e.next),null!=e.next&&(e.next.previous=e.previous),!0):(e.children=n,!1)}},{key:"_DeleteNodesBetween",value:function(e,t){this.fromNode=e,this.toNode=t,this.deleting=!1,this.doneDeleting=!1,this._deleteNode_DNB(this.document.rootNode)}}]),R(n,ft),L);function L(e){!function(e){if(!(e instanceof L))throw new TypeError("Cannot call a class as a function")}(this),this.document=e}function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var B=(j(G.prototype,[{key:"GetRange",value:function(e){null==e&&(e=document.getSelection());var t=void 0;return e.rangeCount?t=e.getRangeAt(0):(t=document.createRange()).collapse(!0),t}},{key:"GetStartNode",value:function(e){var t;null==e&&(t=document.getSelection(),e=this.GetRange(t));e=e.startContainer.parentNode;if("BODY"==e.tagName)return this.document.rootNode.GetFirstTextNode();if(null!=e){e=e.getAttribute("cm-id");return this.document.GetNodeById(e)}}},{key:"GetEndNode",value:function(e){var t;null==e&&(t=document.getSelection(),e=this.GetRange(t));e=e.startContainer.parentNode.getAttribute("cm-id");return this.document.GetNodeById(e)}},{key:"IsCollapsed",value:function(){return document.getSelection().isCollapsed}},{key:"GetBoundingClientRect",value:function(){var e=document.getSelection(),t=this.GetRange(e),n=t.getBoundingClientRect(),e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("safari")&&(-1<e.indexOf("chrome")||(n=t.getClientRects()[0])),n}},{key:"GetCurrent",value:function(){var e=document.getSelection(),t=this.GetRange(e),n=t.startContainer.parentNode,i=t.startOffset,o=t.endContainer.parentNode,r=t.endOffset,e={hasFocus:!1,startNode:void 0,startOffset:0,endNode:void 0,endOffset:0};return null!=n&&null!=o&&(t=n.getAttribute("cm-id"),o=o.getAttribute("cm-id"),t=this.document.GetNodeById(t),e={hasFocus:null!=n&&null!=t,startNode:t,startOffset:i,endNode:this.document.GetNodeById(o),endOffset:r}),e}},{key:"SelectText",value:function(e,t,n,i){var o=window.getSelection(),r=document.createRange();r.setStart(e.domElement.firstChild,t),r.setEnd(n.domElement.firstChild,i),o.removeAllRanges(),o.addRange(r)}},{key:"_parents",value:function(e){for(var t=[e];e;e=e.parent)t.unshift(e);return t}},{key:"FindCommonNodeContainer",value:function(e,t){var n=this._parents(e),i=this._parents(t);if(n[0].id!=i[0].id)throw"No common ancestor";for(var o=0;o<n.length;o++)if(n[o].id!=i[o].id)return n[o-1]}},{key:"GetSelectedLines",value:function(){var t,n,i,e=this.GetCurrent(),o=[];return e.hasFocus&&(t=e.startNode,n=e.endNode,null!=t&&null==n?n=t:null==t&&null!=n&&(t=n),this.IsCollapsed()||t.parent.id==n.parent.id?o.push(t.GetBlockContainer()):t.isTextNode()&&n.isTextNode()&&(e=this.FindCommonNodeContainer(t,n),i=!1,e.children.forEach(function(e){e.Contains(t.id)?(i=!0,o.push(e)):i&&(o.push(e),e.Contains(n.id)&&(i=!1))}))),o}},{key:"GetSelectedTextNodes",value:function(){var e,t,n,i=[];return document.getSelection().isCollapsed||(t=(e=this.GetCurrent()).startNode,e.startOffset,n=e.endNode,e.endOffset,(i=I.GetAllTextNodes(this.document,t,n,!1)).unshift(t),n.id!=t.id&&i.push(n)),i}},{key:"_extractSelection",value:function(e,t,n){n=e.Split(t,n);return 1==n.length?e:(I.ReplaceNode(this.document,e,n),2==n.length&&0==t?n[0]:n[1])}},{key:"IsolateAndReturnSelectedTextNodes",value:function(){var t=[];if(!document.getSelection().isCollapsed){var e,n=this.GetCurrent(),i=n.startNode,o=n.startOffset,r=n.endNode,n=n.endOffset;if(!i.isTextNode()||!r.isTextNode())return void console.log("#84-22");i.id==r.id?(e=this._extractSelection(i,o,n),t.push(e)):(e=I.GetAllTextNodes(this.document,i,r,!1),i=this._extractSelection(i,o,i.text.length),t.push(i),e.forEach(function(e){t.push(e)}),n=this._extractSelection(r,0,n),t.push(n))}return t}},{key:"_getNextTextNode",value:function(e){return null==e.next?this._getNextTextNode(e.parent):e.next.isTextNode()?e.next:this._getNextTextNode(e.next.parent)}},{key:"VerifyCursorPosition",value:function(){}}]),G);function G(e){!function(e){if(!(e instanceof G))throw new TypeError("Cannot call a class as a function")}(this),this.document=e}function H(e){return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function z(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Y(e,t){return(Y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function U(e){return(U=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var W=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Y(e,t)}(l,A);var e,t,i,o,a=(i=l,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=U(i),n=this;return!(t=o?(e=U(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==H(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function l(e,t,n,i){var o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:[],r=5<arguments.length&&void 0!==arguments[5]&&arguments[5],s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:void 0;return function(e){if(!(e instanceof l))throw new TypeError("Cannot call a class as a function")}(this),(i=a.call(this,e,t,n,k.BLOCK,i)).attributes=o,i.hasTextContent=r,i.textContent=s,i.GenerateDomElement(),i.firstTextNode=void 0,i.lastTextNode=void 0,i}return t=[{key:"CreateNew",value:function(e,t,n,i,o,r){o=4<arguments.length&&void 0!==o&&o,r=5<arguments.length&&void 0!==r?r:"",r=new l(e,e.GenereateNewNodeId(),t,n,i,o,r);return e.RegisterNode(r),r}}],z((e=l).prototype,[{key:"Copy",value:function(){var t=new l(this.document,this.document.GenereateNewNodeId(),this.tagName,this.nodeStyle.Copy(),this.attributes,this.hasTextContent,this.textContent);return t.firstTextNode=this.firstTextNode,t.lastTextNode=this.lastTextNode,t.GenerateDomElement(),this.children.forEach(function(e){t.Append(e.Copy())}),t}},{key:"UpdateTextContent",value:function(e){this.hasTextContent=!0,this.textContent=e,this.domElement.setAttribute("cm-has-text-content",!0),this.domElement.textContent=this.textContent}},{key:"GenerateDomElement",value:function(){this.domElement=void 0;var t=document.createElement(this.tagName);t.setAttribute("cm-id",this.id),t.setAttribute("cm-type",this.type),this.attributes.forEach(function(e){""!=e.name&&t.setAttribute(e.name,e.value)}),this.domElement=t,this.hasTextContent&&(t.setAttribute("cm-has-text-content",!0),this.domElement.textContent=this.textContent),null!=this.nodeStyle&&this.nodeStyle.Apply(this.domElement)}},{key:"ChangeTagName",value:function(e){this.tagName=e;var t=document.createElement(this.tagName);t.setAttribute("cm-id",this.id),t.setAttribute("cm-type",this.type),this.attributes.forEach(function(e){""!=e.name&&t.setAttribute(e.name,e.value)}),this.children.forEach(function(e){t.appendChild(e.domElement)}),this.hasTextContent&&(t.setAttribute("cm-has-text-content",!0),this.domElement.textContent=this.textContent),null!=this.nodeStyle&&this.nodeStyle.Apply(t),this.domElement.parentNode.replaceChild(t,this.domElement),this.domElement=t}},{key:"SetAttributes",value:function(e,t){var n,t=1<arguments.length&&void 0!==t&&t;this.attributes=e,t||(n=this).attributes.forEach(function(e){""!=e.name&&n.domElement.setAttribute(e.name,e.value)})}},{key:"AppendAfter",value:function(t,e){var n=0,i=0;return this.children.forEach(function(e){i++,e.id==t.id&&(n=i)}),this.Append(e,n)}},{key:"Append",value:function(n,i){var e,t,o,r,s,a,l,c,u,h;n.parent=this,null!=i&&i>=this.children.length&&(i=void 0),null==i?n.isInlineNode()?(o=void 0,null!=this.document.GetStyleAtCurrentCursorPosition()&&(o=((t=new _(this.document,this.document.GetStyleAtCurrentCursorPosition().nodeStyle)).isEmpty()?this.document.GetDefaultNodeStyle():t).Copy()),e=void 0,0<this.children.length&&(e=this.children[this.children.length-1]),null!=e&&e.isTextNode()||((t=D.CreateNew(this.document,"span","",o)).parent=this,t.next=n,null!=e&&(e.next=t),t.previous=e,e=t,this.children.push(t),this.domElement.appendChild(t.domElement)),(e.next=n).previous=e,(n.parent=this).children.push(n),this.domElement.appendChild(n.domElement),(o=D.CreateNew(this.document,"span","",o)).parent=this,(o.previous=n).next=o,this.children.push(o),this.domElement.appendChild(o.domElement)):(0<(n.parent=this).children.length&&(((o=this.children[this.children.length-1]).next=n).previous=o),this.children.push(n),this.domElement.appendChild(n.domElement)):(r=void 0,s=[],l=void(a=0),null!=this.document.GetStyleAtCurrentCursorPosition()&&(l=new _(this.document,this.document.GetStyleAtCurrentCursorPosition().nodeStyle)),u=[],h=void 0,(c=this).children.forEach(function(e){var t;i==a&&(h=r,!n.isInlineNode()||null!=r&&r.isTextNode()||((t=D.CreateNew(c.document,"span","",l.Copy())).parent=c,null!=r&&(r.next=t),t.previous=r,r=t,s.push(t),u.push(t)),null!=(n.previous=r)&&(r.next=n),s.push(n),r=n,u.push(n),n.isInlineNode()&&!e.isTextNode()&&((t=D.CreateNew(c.document,"span","",l.Copy())).parent=c,(r.next=t).previous=r,(t.next=e).previous=t,s.push(t),r=t,u.push(t))),null!=(e.previous=r)&&(r.next=e),s.push(e),r=e,a++}),this.children=s,null!=h?u.forEach(function(e){h.domElement.parentNode.insertBefore(e.domElement,h.domElement.nextSibling),h=e}):null==n.next?this.domElement.appendChild(n.domElement):this.domElement.insertBefore(n.domElement,n.next.domElement))}},{key:"InsertTextNodeAtCursor",value:function(e){var t,n,i,o,r,s;!e.isTextNode()||(s=new B(this.document).GetCurrent()).hasFocus&&(n=s.startNode,o=s.startOffset,t=s.endNode,i=s.endOffset,n.isTextNode()&&t.isTextNode()?(r=n.GetBlockContainer(),s=t.GetBlockContainer(),r.id!=s.id&&console.log("#10-33"),n.id==t.id&&(1==(i=(n=n).Split(o,i)).length?this.Append(e,0):(2==i.length?0==o?i.unshift(e):i.push(e):((o=[]).push(i[0]),o.push(e),o.push(i[2]),i=o),I.ReplaceNode(this.document,n,i)))):console.log("#10-22"))}},{key:"_parseIsEmpty",value:function(e){var t=this,n=!0;return e.children.forEach(function(e){n&&(e.isTextNode()?""==e.text||(n=!1):n=!e.isInlineNode()&&t._parseIsEmpty(e))}),n}},{key:"isEmpty",value:function(){return this._parseIsEmpty(this)}},{key:"_parseGetFirstTextNode",value:function(e){var t=this;return e.children.every(function(e){return e.isTextNode()&&null==t.firstTextNode?(t.firstTextNode=e,!1):t._parseGetFirstTextNode(e)}),!0}},{key:"SelectWholeTextContent",value:function(){var e=this.GetFirstTextNode(),t=this.GetLastTextNode();this.document.selectionManager.SelectText(e,0,t,t.text.length)}},{key:"GetFirstTextNode",value:function(){return this.firstTextNode=void 0,this._parseGetFirstTextNode(this),this.firstTextNode}},{key:"_parseGetLastTextNode",value:function(e){var t=this;return e.children.every(function(e){return e.isTextNode()?void(t.lastTextNode=e):t._parseGetLastTextNode(e)}),!0}},{key:"GetLastTextNode",value:function(){return this.lastTextNode=void 0,this._parseGetLastTextNode(this),this.lastTextNode}},{key:"_parseDeleteButReturnTextNodes",value:function(e){var t=this;e.children.every(function(e){return e.isTextNode()?(t.tmpAllTextNodes.push(e),!1):t._parseDeleteButReturnTextNodes(e)}),e.Delete()}},{key:"DeleteButReturnTextNodes",value:function(){return this.tmpAllTextNodes=[],this._parseDeleteButReturnTextNodes(this),this.tmpAllTextNodes}},{key:"Delete",value:function(){this.document.DeleteNode(this)}},{key:"InsertEmptyBlockNodeBefore",value:function(e){return this._InsertEmptyLine("before",e)}},{key:"InsertEmptyBlockNodeAfter",value:function(e){return this._InsertEmptyLine("after",e)}},{key:"_InsertEmptyLine",value:function(t,e){var n=this;null==e&&(e="div");var i=this.parent,o=l.CreateNew(this.document,e),e=i.children;return i.children=[],e.forEach(function(e){"before"==t?(e.id==n.id&&i.Append(o),i.Append(e)):"after"==t&&(i.Append(e),e.id==n.id&&i.Append(o))}),o}},{key:"Merge",value:function(t,e){var n,i=this,o=void 0,r=void 0;null==i.children||0<=(n=i.children.length-1)&&(r=i.children[n]),t.children.forEach(function(e){"text"==e.type?(i.Append(e),null==o&&(o=e)):e.DeleteButReturnTextNodes().forEach(function(e){i.Append(e)})}),t.domElement.remove(),this.document.UnregisterNode(t),i.next=t.next,null!=i.next&&(i.next.previous=i);var s=[];return i.parent.children.forEach(function(e){e.id!=t.id&&s.push(e)}),i.parent.children=s,e?o:r}}]),z(e,t),l}();function X(e){return(X="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function V(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function q(e,t){return(q=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function K(e){return(K=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var J=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),q(e,t)}(a,A);var e,t,i,o,s=(i=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=K(i),n=this;return!(t=o?(e=K(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==X(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function a(e,t,n,i,o){var r=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[];return function(e){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this),(o=s.call(this,e,t,n,k.INLINE,o)).attributes=r,null==i&&(i=""),o.text=i,o.GenerateDomElement(),o}return t=[{key:"CreateNew",value:function(e,t,n,i,o){o=new a(e,e.GenereateNewNodeId(),t,n,i,o);return e.RegisterNode(o),o}}],V((e=a).prototype,[{key:"Copy",value:function(){var t=new a(this.document,this.document.GenereateNewNodeId(),this.tagName,this.text,this.nodeStyle.Copy(),this.attributes);return this.GenerateDomElement(),this.children.forEach(function(e){t.Append(e.Copy())}),t}},{key:"GenerateDomElement",value:function(){this.domElement=void 0;var t=document.createElement(this.tagName);t.setAttribute("cm-id",this.id),t.setAttribute("cm-type",this.type),this.attributes.forEach(function(e){""!=e.name&&t.setAttribute(e.name,e.value)}),""!=this.text&&t.appendChild(document.createTextNode(this.text)),this.domElement=t,null!=this.nodeStyle&&this.nodeStyle.Apply(this.domElement)}},{key:"Append",value:function(n,i){if(n.isBlockNode())throw"Inline nodes cannot contain block nodes";var e,o,r,s,a,t;null==i&&(i=this.children.length),0==this.children.length||this.children.length==i?n.isInlineNode()?(t=void 0,0<this.children.length&&(t=this.children[this.children.length-1]),null!=t&&t.isTextNode()||((e=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,e.next=n,null!=t&&(t.next=e),e.previous=t,t=e,this.children.push(e),this.domElement.appendChild(e.domElement)),n.previous=t,(n.parent=this).children.push(n),this.domElement.appendChild(n.domElement),(t=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,(t.previous=n).next=t,this.children.push(t),this.domElement.appendChild(t.domElement)):((n.parent=this).children.push(n),this.domElement.appendChild(n.domElement)):(o=void 0,s=0,a=!(r=[]),this.children.forEach(function(e){var t;o=i==s?(!n.isInlineNode()||null!=o&&o.isTextNode()||((t=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,null!=o&&(o.next=t),t.previous=o,o=t,r.push(t)),null!=(n.previous=o)&&(o.next=n),a=!0,n.parent=this,r.push(n),n):(a&&(a=!1,n.isInlineNode()&&!e.isTextNode()?((t=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,(o.next=t).previous=o,(t.next=e).previous=t,r.push(t)):(e.previous=n).next=e),e),r.push(e),s++}),a&&n.isInlineNode()&&((t=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,(o.next=t).previous=o,t.next=void 0,r.push(t)),this.children=r,null==n.next?this.domElement.appendChild(n.domElement):this.domElement.insertBefore(n.domElement,n.next.domElement))}},{key:"Delete",value:function(){this.domElement.remove(),this.document.UnregisterNode(this)}}]),V(e,t),a}();function $(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Z(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Q=(Z(ee.prototype,[{key:"GetStyleAtCurrentCursorPosition",value:function(){var e=this.selectionManager.GetCurrent();if(!e.hasFocus)return{};var t=e.startNode;if(null==t)return{};e=this._getFirstParentBlockNode(t);return{nodeStyle:t.nodeStyle.styles,lineStyle:e.nodeStyle.styles,plugin:void 0}}},{key:"ToggleStyleOnLine",value:function(t,n){var e,i,o,r,s,a,l=this.selectionManager.GetCurrent();l.hasFocus&&(e=l.startNode,i=l.startOffset,o=l.endNode,l=l.endOffset,e.isTextNode()&&o.isTextNode()?e.id==o.id?(this._getFirstParentBlockNode(e).ToggleStyle(t,n,!0),e.SelectText(i,l)):(r=this._getFirstParentBlockNode(e),s=this._getFirstParentBlockNode(o),r.id==s.id?(r.ToggleStyle(t,n,!0),this.selectionManager.SelectText(e,i,o,l)):(l=r.parent).id==s.parent.id?(a=!1,l.children.forEach(function(e){e.id==r.id&&(a=!0),a&&(e.ToggleStyle(t,n,!0),e.id==s.id&&(a=!1))})):console.log("#10-03")):console.log("#10-02"))}},{key:"_getFirstParentBlockNode",value:function(e){e=e.parent;return e.isBlockNode()||(e=this._getFirstParentBlockNode(e)),e}},{key:"ToggleStyleOnSelection",value:function(t,n){var e=this.selectionManager.GetCurrent();if(e.hasFocus){var i,o,r,s=e.startNode,a=e.startOffset,l=e.endNode,c=e.endOffset;if(!s.isTextNode()||!l.isTextNode())if(console.log("Possible #10-01",s,l),s.isTextNode()&&!l.isTextNode())c=(l=s).text.length;else{if(s.isTextNode()||!l.isTextNode())return void console.log("#10-01");s=l,a=0}s.id==l.id?this._toggleStyleOnNode(s,a,c,t,n).SelectText(0,c-a):(i=I.GetAllTextNodes(this.document,s,l,!1),r=!1,o=[],s.IsStyleApplied(t)?o.push(!0):o.push(!1),i.forEach(function(e){e.IsStyleApplied(t)?o.push(!0):o.push(!1)}),l.IsStyleApplied(t)?o.push(!0):o.push(!1),1<(e=new Set(o),(o=function(e){if(Array.isArray(e))return $(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return $(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?$(e,void 0):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).length)&&(r=!0),r?((e=s).IsStyleApplied(t)||(e=this._toggleStyleOnNode(s,a,s.text.length,t,n)),i.forEach(function(e){e.IsStyleApplied(t)||e.ToggleStyle(t,n,!0)}),(r=l).IsStyleApplied(t)||this._toggleStyleOnNode(l,0,c,t,n),this.selectionManager.SelectText(e,0,r,c)):(s=this._toggleStyleOnNode(s,a,s.text.length,t,n),i.forEach(function(e){e.ToggleStyle(t,n,!0)}),l=this._toggleStyleOnNode(l,0,c,t,n),this.selectionManager.SelectText(s,0,l,c)))}}},{key:"_toggleStyleOnNode",value:function(e,t,n,i,o){var r=e.Split(t,n);if(1==r.length)return e.ToggleStyle(i,o,!0),e;n=void 0;return(n=0==t?r[0]:r[1]).ToggleStyle(i,o,!1),I.ReplaceNode(this.document,e,r),n}}]),ee);function ee(e){!function(e){if(!(e instanceof ee))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new B(this.document)}function te(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ne=(te(oe.prototype,[{key:"Insert",value:function(){if(this.selectionManager.IsCollapsed()||this.document.DeleteSelection(),this.selectionManager.IsCollapsed()){var e=this.selectionManager.GetCurrent();if(!e.hasFocus)return{};var t,n,i,o,r,s,a,l,c=e.startNode,u=e.startOffset,h=e.endOffset;null!=c&&c.isTextNode()?(e=c.parent).isBlockNode()?(n=!(t=[]),i=[],r=o=void 0,e.children.forEach(function(e){e.id==c.id?n=!0:n?t.push(e):(i.push(e),(o=e).isTextNode()&&(r=e.nodeStyle))}),h=c.Split(u,h),s=!0,a=[],h.forEach(function(e){""==e.text?s=!1:s?a.push(e):t.unshift(e)}),0<a.length||0<i.length?(I.ReplaceNode(this.document,c,a,!0),this.InsertNewRootLine("after",c.parent,!0,c.parent.nodeStyle,c.nodeStyle,t)):(l=void 0,null!=c.parent&&(l=c.parent.nodeStyle),this.InsertNewRootLine("before",c.parent,!1,l,c.nodeStyle,a)),null!=o&&o.isInlineNode()&&(l=D.CreateNew(this.document,"span","",r),e.Append(l))):console.log("#20-03"):console.log("#20-02")}else console.log("Selection not collapsed"),console.log("#20-01");return!0}},{key:"InsertNewRootLine",value:function(e,t,n,i,o,r){var s,a,l,c,u,h,d=t.parent;null!=d&&(a=s=0,d.children.forEach(function(e){e.id==t.id&&(s=a),a++}),null==i&&(i=new _(this.document)),(l=W.CreateNew(this.document,t.tagName,i.Copy(),t.attributes)).parent=d,"before"==e?(l.previous=t.previous,null!=t.previous&&(t.previous.next=l),(l.next=t).previous=l):(s+=1,l.previous=t,l.next=t.next,null!=t.next&&(t.next.previous=l),t.next=l),c=void 0,0==r.length?(o=D.CreateNew(this.document,"span","",o.Copy()),l.Append(o),c=o):(u=this.document,h=void 0,r.forEach(function(e){""==e.id&&(e.id=u.GenereateNewNodeId(),e.GenerateDomElement(),u.RegisterNode(e));var t=!0;e.isTextNode()&&(null!=h?h.HasSameStyle(e)&&h.HasSameAttributes(e)?(t=!1,h.AppendTextContent(e.text),h.next=e.next,u.UnregisterNode(e),e.domElement.parentNode.removeChild(e.domElement)):h=e:(e.previous=void 0,h=e)),t&&(l.Append(e),null==c&&(e.isTextNode()?c=e:e.isInlineNode()&&(c=e.previous)))})),d.domElement.insertBefore(l.domElement,d.domElement.children[s]),d.children.splice(s,0,l),"after"==e&&n&&c.SetFocus())}}]),oe),ie={DELETE:"delete",DELETE_TOP:"deleteTop",DELETE_FROM_BOTTOM:"deleteFromBottom",CANCEL_FROM_TOP:"cancelFromTop",CANCEL_FROM_BOTTOM:"cancelFromBottom",ENTER:"enter",APPLY_STYLE_ON_LINE:"applyStyleOnLine",APPLY_STYLE_ON_TEXT:"applyStyleOnText",CLICK:"click",DELETE_BEFORE_INLINE:"DELETE_BEFORE_INLINE",CANCEL_BEFORE_INLINE:"CANCEL_BEFORE_INLINE",NODE_UNREGISTERED:"NODE_UNREGISTERED",TAB:"TAB",NEW_CHAR_ADDED:"newCharAdded",ARROW_UP:"arrowUp",ARROW_DOWN:"arrowDown",ARROW_LEFT:"arrowLeft",ARROW_RIGHT:"arrowRight",SHIFT_ARROW_UP:"shiftArrowUp",SHIFT_ARROW_DOWN:"shiftArrowDown",SHIFT_ARROW_LEFT:"shiftArrowLeft",SHIFT_ARROW_RIGHT:"shiftArrowRight",SHIFT_DOWN:"SHIFT_DOWN",SHIFT_UP:"SHIFT_UP",SELECT_ALL:"SELECT_ALL",BEFORE_COPY:"BEFORE_COPY",BEFORE_CUT:"BEFORE_CUT",BEFORE_PASTE:"BEFORE_PASTE",LOST_FOCUS:"LOST_FOCUS",ESC:"esc"};function oe(e){!function(e){if(!(e instanceof oe))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new B(this.document)}function re(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var se=(re(ae.prototype,[{key:"DeleteNode",value:function(e){return I.ReplaceNode(this.document,e,[],!1)}},{key:"DeleteSelection",value:function(){var n,t,e,i=!1,o=this.selectionManager.GetCurrent(),r=o.startNode,s=o.startOffset,a=o.endNode,l=o.endOffset;return null!=r&&null!=a||(r=this.document.rootNode.GetFirstTextNode(),a=this.document.rootNode.GetLastTextNode(),l=a.text.length),a.isBlockNode()&&(n=!1,a.children.forEach(function(e){var t;e.id==r.id&&(n=!0),!n||null!=(t=e.domElement.getAttribute("contenteditable"))&&"false"==t&&(a=e.next,l=0)})),r.isTextNode()&&!a.isTextNode()?l=(a=r).text.length:!r.isTextNode()&&a.isTextNode()&&(r=a,s=0),r.isTextNode()&&a.isTextNode()?r.id==a.id?(r.DeleteText(s,l),i=!0,(e=this.selectionManager.GetRange()).deleteContents(),e.collapse(!0),(o=document.getSelection()).removeAllRanges(),o.addRange(e),""==r.text&&(null==r.previous&&null==r.next&&(r.SetZeroWidthChar(),r.SetFocus()),i=!0)):(I.DeleteNodesBetween(this.document,r,a),r.TrimTextContent(0,s),a.TrimTextContent(l),r.parent.id==a.parent.id?((r.next=a).previous=r,this._adjustAndSetFocus(r,a,s)):(t=r.parent,e=a.parent,t.parent.id==e.parent.id?(e.children.forEach(function(e){t.Append(e)}),e.children=[],this.DeleteNode(e),this._adjustAndSetFocus(r,a,s)):a.SetFocus()),i=!0):console.log("#30-01-01"),i}},{key:"Delete",value:function(){var e=!1;if(this.selectionManager.IsCollapsed()){var t=this.selectionManager.GetCurrent();if(!t.hasFocus)return!0;var n,i,o,r=t.startNode,s=t.startOffset;if(t.endOffset,!r.parent.isBlockNode())return console.log("#30-01"),!0;null!=r&&r.isTextNode()?(t=!1,s!=r.text.length&&""!=r.text||(t=!0),r.RemoveCharAt(s),s<r.text.length?e=!1:null==r.next?""==r.text?(null==r.parent.next?null!=r.previous&&r.previous.isTextNode()?(n=r.previous,this.DeleteNode(r),n.SetCarretAtTheEnd()):(r.SetZeroWidthChar(),r.SetFocus()):t?(n=!0,null!=r.parent.next.GetPluginType()&&(n=!this.document.NotifyPlugin(ie.CANCEL_FROM_TOP,r.parent.next)),n&&(this.DeleteNode(r),r.parent.next.isBlockNode()?null!=(n=r.parent.next.GetFirstTextNode())&&n.SetFocus():console.log("#72-28"))):(r.SetZeroWidthChar(),r.SetFocus()),e=!0):t?(null!=r.parent.next?(i=!0,null!=r.parent.next&&null!=r.parent.next.GetPluginType()&&(i=!this.document.NotifyPlugin(ie.CANCEL_FROM_TOP,r.parent.next)),!i||null!=(o=r.parent.Merge(r.parent.next,!0))&&o.SetFocus()):this.document.NotifyPlugin(ie.CANCEL_FROM_BOTTOM,r),e=!0):""==r.text&&(r.SetZeroWidthChar(),r.SetFocus(),e=!0):(i=r.next).isInlineNode()?t?(this.document.NotifyPlugin(ie.CANCEL_BEFORE_INLINE,i)||(o=i.next,this.DeleteNode(i),this.DeleteNode(r),null!=o&&o.SetFocus()),e=!0):""==r.text&&(r.SetZeroWidthChar(),r.SetFocus(),e=!0):i.isTextNode()&&(t?(i.RemoveCharAt(0,!0),""==i.text?(this.DeleteNode(i),r.SetCarretAtTheEnd()):i.SetFocus(),e=!0):""==r.text&&(this.DeleteNode(r),i.SetFocus(),e=!0))):e=!0}else e=this.DeleteSelection();return e}},{key:"Backspace",value:function(){var e=!1;if(this.selectionManager.IsCollapsed()){var t=this.selectionManager.GetCurrent();if(!t.hasFocus)return!0;var n,i,o,r,s=t.startNode,a=t.startOffset;if(t.endOffset,!s.parent.isBlockNode())return console.log("#30-23"),!0;null!=s&&s.isTextNode()?(r=!1,""==s.text&&(r=!0),(t=a-1)<0?(e=!0,a=s.previous,""==s.text?null!=a?a.isTextNode()?(this.DeleteNode(s),a.SetCarretAtTheEnd(),console.log("I DONT UNDERSTAND THIS (see next line)"),e=!0):a.isInlineNode()&&(n=a.previous,this.DeleteNode(a),this.DeleteNode(s),null!=n&&n.SetCarretAtTheEnd(),e=!0):(null!=s.parent.previous?(this.DeleteNode(s),null!=(n=s.parent.previous.Merge(s.parent,!1))&&n.SetCarretAtTheEnd()):null==s.parent.parent.parent||(this.document.IsNodeInsidePlugin(s)?this.document.NotifyPlugin(ie.DELETE_TOP,s):this._consolidateCommaNodes(s)),e=!0):null!=a?a.isTextNode()?(null!=a&&a.SetCarretAtTheEnd(),console.log("WHY AM I HERE?!?",a)):a.isInlineNode()&&(this.document.NotifyPlugin(ie.DELETE_BEFORE_INLINE,a)||(i=a.previous,this.DeleteNode(a),null!=i&&i.SetCarretAtTheEnd()),e=!0):(null!=s.parent.previous?(i=!0,null!=s.parent.previous.GetPluginType()&&(i=!this.document.NotifyPlugin(ie.DELETE_FROM_BOTTOM,s.parent.previous)),!i||null!=(o=s.parent.previous.Merge(s.parent,!1))&&o.SetCarretAtTheEnd()):null==s.parent.parent.parent||this.document.NotifyPlugin(ie.DELETE_TOP,s),e=!0)):(s.RemoveCharAt(t),e=""==s.text&&(null==(o=s.previous)?r?null!=s.parent.previous?(t=!0,null!=s.parent.previous.GetPluginType()&&(t=!this.document.NotifyPlugin(ie.DELETE_FROM_BOTTOM,s.parent.previous)),t&&(this.DeleteNode(s),null!=(t=s.parent.previous.Merge(s.parent,!1))&&t.SetCarretAtTheEnd())):null==s.parent.parent.parent||(this.document.IsNodeInsidePlugin(s)?this.document.NotifyPlugin(ie.DELETE_TOP,s):this._consolidateCommaNodes(s)):null!=s.next&&s.next.isTextNode()?(this.DeleteNode(s),s.next.SetFocus()):(s.SetZeroWidthChar(),s.SetFocus()):o.isInlineNode()?r?this.document.NotifyPlugin(ie.DELETE_BEFORE_INLINE,s.previous)||(r=o.previous,this.DeleteNode(o),this.DeleteNode(s),null!=r&&r.SetCarretAtTheEnd()):(s.SetZeroWidthChar(),s.SetFocus(),e=!0):(this.DeleteNode(s),o.SetCarretAtTheEnd()),!0))):e=!0}else e=this.DeleteSelection();return e}},{key:"_adjustAndSetFocus",value:function(e,t,n){var i,o;""==e.text&&""==t.text?null!=e.previous?(this.DeleteNode(e),this.DeleteNode(t),e.previous.isTextNode()?e.previous.SetCarretAtTheEnd():e.previous.isInlineNode()&&(null!=(i=e.previous).next&&i.next.isTextNode()?i.next.isTextNode()&&i.next.SetFocus():(o=D.CreateNew(i.document,"span","",e.nodeStyle.Copy()),i.parent.AppendAfter(i,o),o.SetFocus()))):null!=t.next?(this.DeleteNode(e),this.DeleteNode(t),t.next.SetFocus()):(this.DeleteNode(t),e.SetFocus()):""==e.text?(this.DeleteNode(e),t.SetFocus()):""==t.text?(this.DeleteNode(t),e.SetCarretAtTheEnd()):e.nodeStyle.Equals(t.nodeStyle)?(e.Merge(t),e.SetFocus(n)):t.SetFocus()}},{key:"_consolidateCommaNodes",value:function(e){e=this._removeSubBlock(this.document.rootNode,e);0==this.document.rootNode.children.length&&this.document.InitEmptyDoc(),null!=e&&e.SetFocus()}},{key:"_removeSubBlock",value:function(e,n){var i=this,o=void 0,r=!0;return e.children.forEach(function(e){var t;e.Contains(n.id)&&(r=!1,e.isEmpty()?i.document.DeleteNode(e):null!=(t=i._removeSubBlock(e,n))&&(o=t)),r&&(o=e.GetLastTextNode())}),o}}]),ae);function ae(e){!function(e){if(!(e instanceof ae))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new B(this.document)}function le(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ce=(le(ue.prototype,[{key:"GetAll",value:function(){return this.allPictures}},{key:"GetNextPicture",value:function(){var e=this.allPictures[this.indexNextToGet];return this.indexNextToGet++,e}},{key:"ResetGetNext",value:function(){this.indexNextToGet=0}},{key:"ParseRtf",value:function(){var e=this.rtf;this.ExtractNextPicture(e),this.allPictures=Object.values(this.pictures)}},{key:"ExtractNextPicture",value:function(e){var t=e.indexOf("{\\pict");if(!(-1<t))return!1;t=this.GetPic(e,t);!1!==t&&this.ExtractNextPicture(t)}},{key:"GetPicId",value:function(e){var t,n=e.indexOf("\\blipuid"),i=e.substring(n).replace("\\blipuid",""),o="";for(t in i){var r=i[t];if("}"==r)break;o+=r}return o.trim()}},{key:"GetMimeType",value:function(e){var t="";return-1<e.indexOf("jpegblip")?t="image/jpeg":-1<e.indexOf("emfblip")?t="emf":-1<e.indexOf("pngblip")?t="image/png":-1<e.indexOf("macpict")&&(t="pict"),t}},{key:"GetContent",value:function(e){for(var t=e.replace(/({?.*})/gi,"").replace(/[\W_]+/g,""),n="",i=0;i<t.length;i+=2)n+=String.fromCharCode(parseInt(t.substr(i,2),16));return btoa(n)}},{key:"AnalizePicChunk",value:function(e){var t,n=this.GetPicId(e);null==this.pictures[n]&&((t={}).id=n,t.positionInDocument=this.counter,this.counter++,t.mimeType=this.GetMimeType(e),t.content=this.GetContent(e),t.srcReady="data:"+t.mimeType+";base64,"+t.content,this.pictures[n]=t)}},{key:"GetPic",value:function(e,t){for(var n=t,i=!1,o=0,r="",s=t;n<e.length;){var a=e[n];"{"==a&&o++,"}"==a&&o--,0<o&&!i&&(r+=a,s=n),0==o&&(i=!0),n++}return this.AnalizePicChunk(r),e.substring(s)}}]),ue);function ue(e){!function(e){if(!(e instanceof ue))throw new TypeError("Cannot call a class as a function")}(this),this.rtf=e,this.pictures={},this.counter=0,this.allPictures=[],this.indexNextToGet=0}function he(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var de=["address","article","blockquote","br","canvas","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","iframe","li","main","nav","output","p","pre","section","td","tr","video"],fe=["b","i","u"],pe=["table","ul","ol","img","a"],ge=(he(me.prototype,[{key:"ExtactAttributes",value:function(e){var t=[];if(e.hasAttributes())for(var n=e.attributes,i=n.length-1;0<=i;i--){var o=n[i].name,r=n[i].value;"style"!=o.toLowerCase()&&"cm-id"!=o.toLowerCase()&&"cm-type"!=o.toLowerCase()&&"cm-plugin"!=o.toLowerCase()&&t.push({name:o,value:r})}return t}},{key:"isBlock",value:function(e){return!(de.indexOf(e.toLowerCase())<0)}},{key:"isTagWithSpecialNeeds",value:function(e){return!(pe.indexOf(e.toLowerCase())<0)}},{key:"isFormattingTag",value:function(e){return!(fe.indexOf(e.toLowerCase())<0)}},{key:"GenerateNewTextNode",value:function(e,t){t=1<arguments.length&&void 0!==t?t:void 0;return null==t&&(t=this.document.GetDefaultNodeStyle().Copy()),D.CreateNew(this.document,"span",e,t)}},{key:"GenerateNewBlockLine",value:function(){var e=W.CreateNew(this.document,"div"),t=D.CreateNew(this.document,"span","",this.document.GetDefaultNodeStyle().Copy());return e.Append(t),e}},{key:"ParseNode",value:function(e){var t,n,i,o,r,s=this,a=void 0;return e.nodeType===e.TEXT_NODE?"O:P"===e.parentNode.tagName||""!=(n=e.textContent).trim()&&(i=_.CalculateStylesForExternalHTML(this.document,e.parentNode),a=this.GenerateNewTextNode(n.replace(/\n|\r/g," "),i)):e.nodeType===e.ELEMENT_NODE&&("O:P"==e.tagName?a=this.GenerateNewBlockLine():(t=e.tagName.toLowerCase(),n=this.ExtactAttributes(e),i=void 0,"body"==t?t="div":i=_.CalculateStylesForExternalHTML(this.document,e),this.isBlock(t)?"br"==t.toLowerCase()||(a=W.CreateNew(this.document,t,i,n),e.childNodes.forEach(function(e){e=s.ParseNode(e);null!=e&&(null!=e.length&&0<e.length?e.forEach(function(e){null!=e.length?e.forEach(function(e){}):a.Append(e)}):Array.isArray(e)||a.Append(e))})):this.isTagWithSpecialNeeds(t)?("img"==t.toLowerCase()&&(!this.fromRtf||null!=(o=this.rtfPictures.GetNextPicture())&&(e.src=o.srcReady)),a=this.pluginsManager.PasteContentToPlugin(e.tagName.toLowerCase(),e)):1<e.childNodes.length?(a=[],e.childNodes.forEach(function(e){e=s.ParseNode(e);null!=e&&a.push(e)})):(this.isFormattingTag(t)&&(t="span"),o=_.CalculateStylesForExternalHTML(this.document,e),a=D.CreateNew(this.document,t,e.textContent.replace(/\n|\r/g," ").replace(/[\u200B-\u200D\uFEFF]/g,""),o),"b"==t?a.ToggleStyle("bold","",!0,!0):"i"==t?a.ToggleStyle("italic","",!0,!0):"u"==t&&a.ToggleStyle("underlined","",!0,!0),r=[a],e.childNodes.forEach(function(e){e.nodeType===e.TEXT_NODE||null!=(e=s.ParseNode(e))&&r.push(e)}),1<r.length&&(a=r)))),a}},{key:"Parse",value:function(){var t=this,e=this.pastedDocumentInBrowser.firstChild.getElementsByTagName("body")[0];null!=e&&(null!=(e=this.ParseNode(e))&&(null!=e.length&&0<e.length?e.forEach(function(e){t.newNodes.push(e)}):this.newNodes.push(e)),0<this.newNodes.length&&this._pasteInPlace(this.newNodes))}},{key:"_pasteInPlace",value:function(e){var c=void 0,t=this.document.selectionManager.GetCurrent(),u=t.startOffset,n=t.startNode,h=n.parent,i=[],o=[],r=!0;h.children.forEach(function(e){e.id==n.id?(c=e,r=!1):(r?i:o).push(e)}),h.children=i;var s=n.text.substring(0,u),t=n.text.substring(u,n.text.length);n.ForceTextContent(s);var d=n,f=u,p=!1;e.forEach(function(e){var t,n,i,o,r,s,a,l=!0;e.isTextNode()?d.isTextNode()&&d.nodeStyle.Equals(e.nodeStyle)&&(e.parent=d.parent,d.Merge(e,u),c=d,l=!1,u+=e.text.length,f=u,p=!1):e.isBlockNode()&&(l=!1,p||h.Append(d),p=!0,t=h.parent,o=[],r=[],s=!(i=n=0),t.children.forEach(function(e){(s?o:r).push(e),e.id==h.id&&(n=i,s=!1),i++}),n+=1,t.children=o,(a=e).parent=t,a.previous=h,a.next=h.next,null!=h.next&&(h.next.previous=a),h.next=a,h=a,t.domElement.insertBefore(a.domElement,t.domElement.children[n]),t.Append(a),r.forEach(function(e){t.Append(e)}),a.children.forEach(function(e){"text"==e.type&&(f=e.text.length,c=d=e)})),l&&(e.parent=d.parent,e.next=d.next,(d.next=e).previous=d,h.Append(d),p=!1,"text"==(d=e).type&&(f=(c=e).text.length))}),p||h.Append(d),""!=t&&(t=D.CreateNew(this.document,"span",t,n.nodeStyle.Copy()),h.Append(t),f=0,c=t),o.forEach(function(e){h.Append(e)}),c.SetFocus(f)}}]),me);function me(e,t,n){!function(e){if(!(e instanceof me))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.pastedDocument=t,this.pluginsManager=e.pluginsManager,this.rtf=n,this.fromRtf=!1,null!=this.rtf&&""!=this.rtf&&(this.rtfPictures=new ce(n),this.rtfPictures.ParseRtf(),this.fromRtf=!0),this.pastedDocumentInBrowser=void 0;n=document.createElement("div");n.style.display="none",n.appendChild(t.documentElement),document.body.appendChild(n),this.pastedDocumentInBrowser=n,this.newNodes=[],this.currentLine=void 0,this.Parse(),n.parentElement.removeChild(n)}function ve(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ye=(ve(be.prototype,[{key:"HtmlToNode",value:function(e,t){t=!(1<arguments.length&&void 0!==t)||t,e=(new DOMParser).parseFromString(e,"text/html").body.firstElementChild,e=this.ParseNode(e);return t&&(e=this.Optimize(e)),e}},{key:"Optimize",value:function(e){var o,r=this;return null!=e.children&&(o=[],e.children.forEach(function(e){var t,n,i;e.isTextNode()?(n=!0,null!=(t=e.previous)&&t.isTextNode()&&t.tagName.toLowerCase()==e.tagName.toLowerCase()&&t.HasSameAttributes(e)&&(i=!1,!t.HasSameStyle(e)&&""!=e.text||(i=!0),i&&(""!=e.text&&t.AppendTextContent(e.text),t.next=e.next,null!=t.next&&(t.next.previous=t),t.document.UnregisterNode(e),e.domElement.parentNode.removeChild(e.domElement),n=!1)),n&&o.push(e)):e.isBlockNode()?o.push(r.Optimize(e)):e.isInlineNode()&&o.push(e)}),e.children=o),e}},{key:"ParseNode",value:function(e){e.getAttribute("cm-id");var t=e.getAttribute("cm-type"),n=void 0;if("block"==t.toLowerCase())n=this.ParseBlockNode(e);else if("inline"==t.toLowerCase())n=this.ParseInlineNode(e);else{if("text"!=t.toLowerCase())throw console.log("U.F.O. NODE"),"UNKNON NODE TYPE [1]: "+e.outerHTML;n=this.ParseTextNode(e)}return n}},{key:"ExtactAttributes",value:function(e){var t=[];if(e.hasAttributes())for(var n=e.attributes,i=n.length-1;0<=i;i--){var o=n[i].name,r=n[i].value;"style"!=o.toLowerCase()&&"cm-id"!=o.toLowerCase()&&"cm-type"!=o.toLowerCase()&&"cm-plugin"!=o.toLowerCase()&&"xmlns"!=o.toLowerCase()&&t.push({name:o,value:r})}return t}},{key:"ParseBlockNode",value:function(i){var e,t,n,o,r=this,s=i.getAttribute("cm-type"),a=void 0;return"block"==s.toLowerCase()&&(e=i.getAttribute("cm-id"),t=i.getAttribute("cm-plugin"),n=null!=(n=i.getAttribute("cm-has-text-content"))&&JSON.parse(n),o=_.CalculateStyles(this.document,i),s=r.ExtactAttributes(i),null==e?a=W.CreateNew(this.document,i.tagName.toLowerCase(),o.Copy(),s,n,i.textContent):(e=this.document.VerifyAndRegisterNodeId(e),a=new W(this.document,e,i.tagName.toLowerCase(),o.Copy(),s,n,i.textContent),this.document.RegisterNode(a)),i.childNodes.forEach(function(e){if(1==e.nodeType){e.getAttribute("cm-id");var t=e.getAttribute("cm-type");if(null!=t)if("block"==t.toLowerCase()){var n=r.ParseBlockNode(e);a.Append(n)}else if("inline"==t.toLowerCase()){n=r.ParseInlineNode(e);a.Append(n)}else{if("text"!=t.toLowerCase())throw console.log("UFO NODE"),"UNKNON NODE TYPE [2]: "+i.outerHTML;e=r.ParseTextNode(e);a.Append(e)}}}),null!=t&&""!=t&&this.document.CreatePluginInstance(t,a)),a}},{key:"ParseInlineNode",value:function(i){var e,t,n,o=this,r=i.getAttribute("cm-id"),s=i.getAttribute("cm-type"),a=void 0;return"inline"==s.toLowerCase()&&(e=i.getAttribute("cm-plugin"),t=_.CalculateStyles(this.document,i),n=o.ExtactAttributes(i),s=i.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""),0<i.childNodes.length&&1==i.childNodes[0].nodeType&&(s=""),null==r?a=J.CreateNew(this.document,i.tagName.toLowerCase(),s,t.Copy(),n):(r=this.document.VerifyAndRegisterNodeId(r),a=new J(this.document,r,i.tagName.toLowerCase(),s,t.Copy(),n),this.document.RegisterNode(a)),i.childNodes.forEach(function(e){if(1==e.nodeType){e.getAttribute("cm-id");var t=e.getAttribute("cm-type");if("block"==t.toLowerCase()){var n=o.ParseBlockNode(e);a.Append(n)}else if("inline"==t.toLowerCase()){n=o.ParseInlineNode(e);a.Append(n)}else{if("text"!=t.toLowerCase())throw console.log("UFO NODE"),"UNKNON NODE TYPE [3]: "+i.outerHTML;e=o.ParseTextNode(e);a.Append(e)}}}),null!=e&&""!=e&&this.document.CreatePluginInstance(e,a)),a}},{key:"ParseTextNode",value:function(e){var t,n,i,o,r=e.getAttribute("cm-id"),s=void 0;return"text"==e.getAttribute("cm-type").toLowerCase()&&(t=e.getAttribute("cm-plugin"),n=_.CalculateStyles(this.document,e),i=this.ExtactAttributes(e),o=e.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""),null==r?s=D.CreateNew(this.document,e.tagName.toLowerCase(),o,n.Copy(),i):(r=this.document.VerifyAndRegisterNodeId(r),s=new D(this.document,r,e.tagName.toLowerCase(),n.Copy(),o,i),this.document.RegisterNode(s)),null!=t&&""!=t&&this.document.CreatePluginInstance(t,s)),s}},{key:"stringIsUrl",value:function(e){return-1<e.indexOf("http://")||-1<e.indexOf("https://")}},{key:"stringIsEmail",value:function(e){return/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())}},{key:"PasteSimpleString",value:function(e){var t=[];this.stringIsUrl(e)?t=this.document.pluginsManager.PasteContentToPlugin("a",e):this.stringIsEmail(e)?t=this.document.pluginsManager.PasteContentToPlugin("a","mailTo:"+e):(e=D.CreateNew(this.document,"span",e.replace(/[\u200B-\u200D\uFEFF]/g,""),this.document.GetDefaultNodeStyle().Copy()),t.push(e)),this._pasteInPlace(t)}},{key:"PasteContentInPlace",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:"",i=(new DOMParser).parseFromString(e,"text/html"),o=i.body.firstElementChild,r=!0;null!=o&&(null!=(t=o.getAttribute("comma"))&&"comma-content"==t?r=!1:(e=o.getAttribute("cm-id"),t=o.getAttribute("cm-type"),null!=e&&""!=e&&null!=t&&""!=t&&(r=!1))),r?this._pasteExternalContent(i,n):this._pasteOurContent(o)}},{key:"_pasteExternalContent",value:function(e,t){new ge(this.document,e,t)}},{key:"_pasteOurContent",value:function(e){var i=this,o=[];e.childNodes.forEach(function(e){var t,n=void 0;3==e.nodeType?n=D.CreateNew(this.document,e.tagName.toLowerCase(),e.textContent.replace(/[\u200B-\u200D\uFEFF]/g,"")):"block"==(t=e.getAttribute("cm-type"))?n=i.ParseBlockNode(e):"inline"==t?n=i.ParseInlineNode(e):"text"==t&&(n=i.ParseTextNode(e)),o.push(n)}),this._pasteInPlace(o)}},{key:"_pasteInPlace",value:function(e){var c=void 0,t=this.document.selectionManager.GetCurrent(),u=t.startOffset,n=t.startNode,h=n.parent,i=[],o=[],r=!0;h.children.forEach(function(e){e.id==n.id?(c=e,r=!1):(r?i:o).push(e)}),h.children=i;var s=n.text.substring(0,u),t=n.text.substring(u,n.text.length);n.ForceTextContent(s);var d=n,f=u,p=!1;e.forEach(function(e){var t,n,i,o,r,s,a,l=!0;e.isTextNode()?d.isTextNode()&&d.nodeStyle.Equals(e.nodeStyle)&&(e.parent=d.parent,d.Merge(e,u),c=d,l=!1,u+=e.text.length,f=u,p=!1):e.isBlockNode()&&(l=!1,p||h.Append(d),p=!0,t=h.parent,o=[],r=[],s=!(i=n=0),t.children.forEach(function(e){(s?o:r).push(e),e.id==h.id&&(n=i,s=!1),i++}),n+=1,t.children=o,(a=e).parent=t,a.previous=h,a.next=h.next,null!=h.next&&(h.next.previous=a),h.next=a,h=a,t.domElement.insertBefore(a.domElement,t.domElement.children[n]),t.Append(a),r.forEach(function(e){t.Append(e)}),a.children.forEach(function(e){"text"==e.type&&(f=e.text.length,c=d=e)})),l&&(e.parent=d.parent,e.next=d.next,(d.next=e).previous=d,h.Append(d),p=!1,"text"==(d=e).type&&(f=(c=e).text.length))}),p||h.Append(d),""!=t&&(t=D.CreateNew(this.document,"span",t,n.nodeStyle.Copy()),h.Append(t),f=0,c=t),o.forEach(function(e){h.Append(e)}),c.SetFocus(f)}}]),be);function be(e){!function(e){if(!(e instanceof be))throw new TypeError("Cannot call a class as a function")}(this),this.document=e}function Ce(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var xe=(n=[{key:"_CleanDomNode",value:function(n,t){var i,o=!0,r=n.getAttribute("cm-id");return t.childNodes.forEach(function(e){var t=e.getAttribute("cm-id");r==t&&(o=!1,n.parentNode.replaceChild(e.cloneNode(!0),n))}),o&&(n.hasChildNodes()?(i=[],n.childNodes.forEach(function(e){3!=e.nodeType&&(o=we._CleanDomNode(e,t))&&i.push(e)}),i.forEach(function(e){try{n.removeChild(e)}catch(e){console.log("#23-239",e)}})):n.remove()),o}},{key:"_fallbackCopyTextToClipboard",value:function(e){var t,n,i=document.createElement("textarea");i.value=e,document.body.appendChild(i),i.focus(),navigator.userAgent.match(/ipad|iphone/i)?((t=document.createRange()).selectNodeContents(i),(n=window.getSelection()).removeAllRanges(),n.addRange(t),i.setSelectionRange(0,999999)):i.select();try{document.execCommand("copy")}catch(e){console.error("ClipboardManager[205]",e)}document.body.removeChild(i)}},{key:"_copyTextToClipboard",value:function(e){navigator.clipboard?navigator.clipboard.writeText(e).then(function(){},function(e){console.error("ClipboardManager[205]",e)}):we._fallbackCopyTextToClipboard(e)}}],Ce((ft=we).prototype,[{key:"Paste",value:function(e,t){t.do(_e.DELETE_SELECTION);var n=e.clipboardData.getData("text/rtf"),i=e.clipboardData.getData("text/html"),t=e.clipboardData.getData("text/plain"),e=Array.from(e.clipboardData.files||[]);return!i&&0<e.length||(null==i||""==i?new ye(this.document).PasteSimpleString(t):new ye(this.document).PasteContentInPlace(i,n)),!0}},{key:"Copy",value:function(e){var t=e,e=this.GetSelectedContent(!1);return t.clipboardData.setData("text/html",e),t.clipboardData.setData("text/plain",this._getPlainText(e)),!0}},{key:"Cut",value:function(e,t){t=this.GetSelectedContent(!0,t);return e.clipboardData.setData("text/html",t),e.clipboardData.setData("text/plain",this._getPlainText(t)),!0}},{key:"_getPlainText",value:function(e){var t=document.createElement("div");return t.innerHTML=e,Array.from(t.getElementsByTagName("div")).forEach(function(e){"block"==e.getAttribute("cm-type")&&(e.innerHTML="\r\n"+e.innerHTML)}),t.textContent||t.innerText}},{key:"GetSelectedContent",value:function(e,t){var n=this.selectionManager.GetCurrent(),r=n.startNode,s=(n.startOffset,n.endNode),i=(n.endOffset,this.selectionManager.GetRange().cloneContents()),a=!0,l="",c=new XMLSerializer,o=!0,n=this.selectionManager.FindCommonNodeContainer(r,s);return null!=n&&null!=n.pluginName&&""!=n.pluginName&&(n=n.domElement.cloneNode(!0),we._CleanDomNode(n,i),l=c.serializeToString(n),o=!1),o&&i.childNodes.forEach(function(e){var t,n,i,o;3==e.nodeType?(i=n=t="",a?(a=!1,t='id="'+r.id+'" cm-id="'+r.id+'"',""!=(o=r.nodeStyle.toStringForStyleTag())&&(n='style="'+o+'"'),""!=(o=r.nodeStyle.toStringForClassTag())&&(i='class="'+o+'"')):(t='id="'+s.id+'" cm-id="'+s.id+'"',""!=(o=s.nodeStyle.toStringForStyleTag())&&(n='style="'+o+'"'),""!=(o=s.nodeStyle.toStringForClassTag())&&(i='class="'+o+'"')),l=l+'<span cm-type="text" '+t+" "+i+" "+n+">"+c.serializeToString(e)+"</span>"):e.getAttribute("cm-id")==r.parent.id?e.childNodes.forEach(function(e){l+=c.serializeToString(e)}):l+=c.serializeToString(e)}),e&&t.do(_e.DELETE_SELECTION),l='<div comma="comma-content">'+l+"</div>"}},{key:"ForceClipboardContent",value:function(e){e=(new XMLSerializer).serializeToString(e);we._copyTextToClipboard('<div comma="comma-content">'+e+"</div>")}}]),Ce(ft,n),we);function we(e){!function(e){if(!(e instanceof we))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new B(this.document)}function Se(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var _e={GET_STYLES_AT_CARRET:"getStyleAtCurrentCursorPosition",TOGGLE_STYLE_ON_LINE:"toggleStyleOnLine",TOGGLE_STYLE_ON_SELECTION:"toggleStyleOnSelection",INSERT_CHAR:"addChar",ENTER:"enter",DELETE:"delete",DELETE_SELECTION:"deleteSelection",BACKSPACE:"backspace",TAB:"tab",CUT:"cut",COPY:"copy",PASTE:"paste",ESC:"esc"},Ee=(Se(Ne.prototype,[{key:"do",value:function(e,t){var n,i=void 0,o=!1;if(this.catchUserInput&&(n="",-1<this.charactersToCacth.indexOf(e)?n=this.charactersToCacth[this.charactersToCacth.indexOf(e)]:"addChar"==e&&-1<this.charactersToCacth.indexOf(t.character)&&(n=t.character),""!=n&&this.onCharacterEntered(n)&&(i=o=!0)),!o){var r=this.selectionManager.GetStartNode();if(null!=r&&r.isTextNode())switch(e){case _e.INSERT_CHAR:i=this._insertCharacter(t.character);break;case _e.TOGGLE_STYLE_ON_LINE:i=(i=this.document.NotifyPlugin(ie.APPLY_STYLE_ON_LINE,r,t))||this.stylesManager.ToggleStyleOnLine(t.styleName,t.value);break;case _e.TOGGLE_STYLE_ON_SELECTION:i=(i=this.document.NotifyPlugin(ie.APPLY_STYLE_ON_TEXT,r,t))||this.stylesManager.ToggleStyleOnSelection(t.styleName,t.value);break;case _e.GET_STYLES_AT_CARRET:i=this.stylesManager.GetStyleAtCurrentCursorPosition();break;case _e.ENTER:i=this.enterManager.Insert();break;case _e.DELETE:i=this.deleteManager.Delete();break;case _e.DELETE_SELECTION:i=this.deleteManager.DeleteSelection();break;case _e.BACKSPACE:i=this.deleteManager.Backspace();break;case _e.TAB:i=this.stylesManager.ToggleStyleOnLine("indent","add"),i=!0;break;case _e.COPY:i=this.clipboardManager.Copy(t);break;case _e.CUT:i=this.clipboardManager.Cut(t,this);break;case _e.PASTE:i=this.clipboardManager.Paste(t,this);break;default:return}else switch(e){case _e.TOGGLE_STYLE_ON_LINE:this.document.NotifyPlugin(ie.APPLY_STYLE_ON_LINE,void 0,t);break;case _e.TOGGLE_STYLE_ON_SELECTION:this.document.NotifyPlugin(ie.APPLY_STYLE_ON_TEXT,void 0,t);break;case _e.BACKSPACE:i=!0,null!=r&&(r.document.IsNodeInsidePlugin(r)?void 0===(i=this.document.NotifyPlugin(ie.DELETE,void 0,t))&&(i=!0):this.document.NotifyPlugin(ie.DELETE,void 0,t));break;case _e.DELETE:this.document.NotifyPlugin(ie.DELETE,void 0,t),i=!0;break;case _e.ENTER:i=!0;break;default:i=!this.document.IsNodeInsidePlugin(r)}}return i}},{key:"_insertCharacter",value:function(e){var t=!1;this.selectionManager.IsCollapsed()||this.document.DeleteSelection();var n=this.selectionManager.GetStartNode();return null!=n&&n.isTextNode()?t=n.InsertCharacter(e):(t=!0,console.log(this.selectionManager.GetCurrent()),console.log("entering text on empty node",n)),t}},{key:"ForceClipboardContent",value:function(e){this.clipboardManager.ForceClipboardContent(e)}}]),Ne),Te={},ke=function(e,t,n){if("s"!=e)return Te[t];Te[t]=n},Ae={isProduction:!0,version:"snqnrs"},Oe="97.72.82.48.99.68.111.118.76.122.65.117.77.67.52.119.76.106.65.54.77.122.65.119.77.67.57.112.80.119.61.61";function Ne(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:void 0;!function(e){if(!(e instanceof Ne))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new B(this.document),this.stylesManager=new Q(this.document),this.enterManager=new ne(this.document),this.deleteManager=new se(this.document),this.clipboardManager=new xe(this.document),this.catchUserInput=!1,null!=t&&(this.catchUserInput=!0,this.charactersToCacth=t.characters,this.onCharacterEntered=t.onCharacterEntered)}Ae.isProduction&&(Oe="97.72.82.48.99.72.77.54.76.121.57.51.100.51.99.117.89.50.57.116.98.87.70.113.99.121.53.106.98.50.48.118.97.84.56.61");var Pe="98.71.57.106.89.88.82.112.98.50.52.61",Fe="97.71.57.122.100.71.53.104.98.87.85.61",Me="90.87.53.106.98.50.82.108.86.86.74.74.81.50.57.116.99.71.57.117.90.87.53.48";function De(e){for(var t=e.split("."),n="",i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return atob(n)}var Re=!1,Ie=!1;var Le=0,je=Math.floor(481*Math.random()+20);var Be=function(){var e,t,n=!1;return e=window[De(Pe)][De(Fe)],t=!1,e!=De("98.71.57.106.89.87.120.111.98.51.78.48")&&e!=De("77.67.52.119.76.106.65.117.77.65.61.61")&&e!=De("77.84.73.51.76.106.65.117.77.67.52.120")||(t=!0),t||-1<e.indexOf(De("99.71.120.49.90.50.99.117.89.50.56.61"))&&(t=!0),t?(""==ke("g","l")||null==ke("g","l")||ke("g","v")&&ke("g","vv"))&&(n=!0):je<++Le?Ie?n=Re:(n=!0,function(){var e=function(e){if(null!=e&&""!=e){var t=window[De(Pe)][De(Fe)];4==t.split(".").length||(t=t.split(".").slice(-2).join("."));for(var n=(e+"#"+Ae.version+"#"+t).toString().split(""),i=0;i<n.length;i++)n[i].charCodeAt(0)<=126&&(n[i]=String.fromCharCode((n[i].charCodeAt(0)+13)%126));e=btoa(n.join(""))}return window[De(Me)](e)}(ke("g","l"));if(null==e)return new Promise(function(e,t){navigator.onLine?Ie=!(Re=!1):Re=Ie=!0,e()});var n=new Image;navigator.onLine&&ke("g","f")(n,De(Oe)+e);var i=!1;n[De("99.51.74.106")].indexOf(e)<0&&(i=!0),new Promise(function(e,t){i?Ie=!(Re=!1):navigator.onLine?(n[De("98.50.53.115.98.50.70.107")]=function(e){Ie=!(Re=!1)},n[De("98.50.53.108.99.110.74.118.99.103.61.61")]=function(e){Ie=Re=!0}):Re=Ie=!0,e()})}()):(ke("g","v")&&ke("g","vv"),n=!0),n};function Ge(e){return function(e){if(Array.isArray(e))return He(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return He(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?He(e,void 0):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function He(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function ze(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Ye=(ze(Ue.prototype,[{key:"Register",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:void 0,t=e.GetName();if(null!=this.allPlugins[t])throw"Plugin or plugin's name already registered: '"+t+"'";e={name:t,class:e,options:n};this.allPlugins[t]=e,null!=n&&n.fireOnChar&&null!=n.charForFire&&""!=n.charForFire&&(this.catchSpecialChars.push(n.charForFire),null==this.specialCharToPlugin[n.charForFire]&&(this.specialCharToPlugin[n.charForFire]=[]),this.specialCharToPlugin[n.charForFire].push(t))}},{key:"GetAllPluginInstances",value:function(e){var t=0<arguments.length&&void 0!==e?e:void 0,n=[],i=this;return Object.keys(this.allInstances).forEach(function(e){e=i.allInstances[e];null!=t&&e.rootNode.GetPluginType().toLowerCase()!=t.toLowerCase()||n.push(e)}),n}},{key:"GetPluginOptions",value:function(e){e=this.allPlugins[e];return null!=e?e.options:void 0}},{key:"NotifyPluginOnSpecialChar",value:function(e){var n=this,t=!1;return-1<this.catchSpecialChars.indexOf(e)&&this.specialCharToPlugin[e].forEach(function(e){var t=n.allPlugins[e];null!=t.options&&(t.options.fireCreateNew?n.InsertPluginAtSection(e):t.class[t.options.fireStaticFunction](n.document,t.options))}),Be()||(t=!0),t}},{key:"IsNodeInsidePlugin",value:function(e){return null!=this.FindNodesInstance(e)}},{key:"NotifyPlugin",value:function(e,t,n){if(null!=t){var i,o=this.FindNodesInstance(t);return null!=o?(this.idInstanceInFocus!=o.id&&(null!=(i=this.allInstances[this.idInstanceInFocus])&&i.Fire(ie.LOST_FOCUS),this.idInstanceInFocus=o.id),this.idInstanceInFocus=o.id,o.Fire(e,t,this,n)):(null==this.idInstanceInFocus||null!=(r=this.allInstances[this.idInstanceInFocus])&&r.Fire(ie.LOST_FOCUS),this.idInstanceInFocus=void 0,!1)}if(null!=this.idInstanceInFocus){var r=this.allInstances[this.idInstanceInFocus];if(null!=r)return r.Fire(e,t,this,n)}}},{key:"CallPluginStaticMethod",value:function(e,t,n){var i=this.allPlugins[e];if(null==i||null==i.class)throw"Unknown plugin: '"+e+"'";i.class[t](this.document,n)}},{key:"FindNodesInstance",value:function(e){var t=void 0;return null!=e.GetPluginType()&&""!=e.GetPluginType()?t=this.allInstances[e.id]:null!=e.parent&&(t=this.FindNodesInstance(e.parent)),t}},{key:"RegisterPluginInstance",value:function(e){this.allInstances[e.id]=e}},{key:"DeletePluginInstance",value:function(e){delete this.allInstances[e.id]}},{key:"RemovePluginInstance",value:function(e){var t=this.allInstances[e];null!=t&&(null!=t.rootNode&&t.rootNode.RemovePluginType(),delete this.allInstances[e])}},{key:"ChangePluginInstanceId",value:function(e,t){var n=this.allInstances[e];null!=n&&(n.id=t,delete this.allInstances[e],this.RegisterPluginInstance(n))}},{key:"InsertPluginAtSection",value:function(t,e){var n=this.allPlugins[t];if(null==n||null==n.class)throw"Unknown plugin: '"+t+"'";var i,e=n.class.CreateNew(this.document,e);return null!=e&&(Array.isArray(e)?(i=this,e.forEach(function(e){e.rootNode.SetPluginType(t),i.RegisterPluginInstance(e)})):(e.rootNode.SetPluginType(t),this.RegisterPluginInstance(e))),e}},{key:"CreatePluginInstance",value:function(e,t){var n=this.allPlugins[e];if(null==n||null==n.class)throw"Unknown plugin: '"+e+"'";t=new n.class(t);t.rootNode.SetPluginType(e),this.RegisterPluginInstance(t)}},{key:"FindPluginForPasteByTagName",value:function(t){var n=void 0,i=this;return Object.keys(this.allPlugins).forEach(function(e){e=i.allPlugins[e];-1<e.class.GetTagToParseOnPaste().indexOf(t.toLowerCase())&&(n=e)}),n}},{key:"PasteContentToPlugin",value:function(e,t){var n=this.FindPluginForPasteByTagName(e);if(null!=n){var i=n.class.CreateNewFromPastedNode(this.document,t);if(null!=i.mustArrangeNodes&&i.mustArrangeNodes){var o=i.pluginNode,e=i.nodesBefore,t=i.nodesAfter;return o.rootNode.SetPluginType(n.name),this.RegisterPluginInstance(o),[].concat(Ge(e),[o.rootNode],Ge(t))}return i.rootNode.SetPluginType(n.name),this.RegisterPluginInstance(i),i.rootNode}}}]),Ue);function Ue(e){!function(e){if(!(e instanceof Ue))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.allPlugins={},this.allInstances={},this.catchSpecialChars=[],this.specialCharToPlugin={},this.selectionManager=new B(this.document),this.idInstanceInFocus=void 0}function We(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Xe=(We(Qe.prototype,[{key:"SetHistoryManager",value:function(e){this.historyManager=e}},{key:"PushToHistory",value:function(){null!=this.onDocChanged&&this.onDocChanged(),this.historyManager.Push(this.GetContent(),this.GetCursorPosition())}},{key:"LoadContent",value:function(e,t){var n=!(1<arguments.length&&void 0!==t)||t;for(this.rootNode=void 0,this.allNodesById={},this.IdManager.Reset();this.nodeContainer.firstChild;)this.nodeContainer.removeChild(this.nodeContainer.firstChild);null==e||""==e?this.InitEmptyDoc():(t=new ye(this),this.rootNode=t.HtmlToNode(e,n),this.nodeContainer.appendChild(this.rootNode.domElement),null!=(n=this.rootNode.GetFirstTextNode())?n.SetFocus():console.log("#01-01"))}},{key:"AddDevContent",value:function(){var e=this;setTimeout(function(){e.InsertPluginAtSection("table",{rows:3,cols:4})},200)}},{key:"ForceClipboardContent",value:function(e){var t=this,n=this.GetCursorPosition();this.actionsManager.ForceClipboardContent(e),setTimeout(function(){t.SetCursorPosition(n)},1)}},{key:"InitEmptyDoc",value:function(){for(;this.nodeContainer.firstChild;)this.nodeContainer.removeChild(this.nodeContainer.firstChild);this.rootNode=W.CreateNew(this,"div");var e=void 0;null!=this.defaultLineStyle&&(e=this.defaultLineStyle.Copy());var t=W.CreateNew(this,"div",e),e=void 0;null!=this.defaultNodeStyle&&(e=this.defaultNodeStyle.Copy());e=D.CreateNew(this,"span","",e);t.Append(e),this.rootNode.Append(t),this.nodeContainer.appendChild(this.rootNode.domElement),e.SetFocus()}},{key:"Focus",value:function(){this.rootNode.GetFirstTextNode().SetFocus()}},{key:"FocusAtTheEnd",value:function(){this.rootNode.GetLastTextNode().SetFocusAtTheEnd()}},{key:"isContentEmpty",value:function(){return this.rootNode.isEmpty()}},{key:"GetFloatingContainer",value:function(){var e,t=void 0,n=this.rootNode.children[this.rootNode.children.length-1];return n.isBlockNode()&&(t=null==(e=n.domElement.getAttribute("cm-floating-container"))||""==e?(e=W.CreateNew(this,"div",void 0,[{name:"contentEditable",value:!1},{name:"cm-floating-container",value:!0}]),this.rootNode.Append(e),e):n),t}},{key:"GetDefaultNodeStyle",value:function(){return this.defaultNodeStyle.Copy()}},{key:"GenereateNewNodeId",value:function(){return this.IdManager.GetNew()}},{key:"VerifyAndRegisterNodeId",value:function(e){return this.IdManager.VerifyAndRegister(e)}},{key:"RegisterNode",value:function(e){this.allNodesById[e.id]=e}},{key:"GetNodeById",value:function(e){return this.allNodesById[e]}},{key:"UnregisterNode",value:function(e){this.pluginsManager.NotifyPlugin(ie.NODE_UNREGISTERED,e),delete this.allNodesById[e.id]}},{key:"GetAllPluginInstances",value:function(e){return this.pluginsManager.GetAllPluginInstances(e)}},{key:"DeleteNode",value:function(e,t,n,i){n=2<arguments.length?n:void 0,i=3<arguments.length?i:void 0;1<arguments.length&&void 0!==t&&t?(e.domElement.remove(),this.UnregisterNode(e)):I.ReplaceNode(this,e,[],!1,n,i)}},{key:"GetNodeAtCursor",value:function(){return this.selectionManager.GetStartNode()}},{key:"GetSelectionBoundingClientRect",value:function(){return this.selectionManager.GetBoundingClientRect()}},{key:"ManagerSpecialActions",value:function(e,t){var n=!1;switch(e){case"newCharAdded":this.NotifyPlugin(ie.NEW_CHAR_ADDED,this.selectionManager.GetStartNode(),t);break;case"enter":n=(n=this.NotifyPlugin(ie.ENTER,this.selectionManager.GetStartNode()))||this.actionsManager.do(_e.ENTER);break;case"backspace":n=this.actionsManager.do(_e.BACKSPACE);break;case"delete":n=(n=this.NotifyPlugin(ie.DELETE,this.selectionManager.GetStartNode()))||this.actionsManager.do(_e.DELETE);break;case"tab":n=(n=this.NotifyPlugin(ie.TAB,this.selectionManager.GetStartNode()))||this.actionsManager.do(_e.TAB);break;case"BEFORE_COPY":n=this.NotifyPlugin(ie.BEFORE_COPY,this.selectionManager.GetStartNode(),t);break;case"BEFORE_CUT":n=this.NotifyPlugin(ie.BEFORE_CUT,this.selectionManager.GetStartNode(),t);break;case"BEFORE_PASTE":n=this.NotifyPlugin(ie.BEFORE_PASTE,this.selectionManager.GetStartNode(),t);break;case"copy":n=this.actionsManager.do(_e.COPY,t);break;case"cut":n=this.actionsManager.do(_e.CUT,t);break;case"paste":n=this.actionsManager.do(_e.PASTE,t);break;case"click":var i=this.GetNodeById(t.srcElement.getAttribute("cm-id"));null!=i&&(n=this.NotifyPlugin(ie.CLICK,i));break;case"ARROW_UP":n=this.NotifyPlugin(ie.ARROW_UP,this.selectionManager.GetStartNode(),t);break;case"ARROW_DOWN":n=this.NotifyPlugin(ie.ARROW_DOWN,this.selectionManager.GetStartNode(),t);break;case"ARROW_LEFT":n=this.NotifyPlugin(ie.ARROW_LEFT,this.selectionManager.GetStartNode(),t);break;case"ARROW_RIGHT":n=this.NotifyPlugin(ie.ARROW_RIGHT,this.selectionManager.GetStartNode(),t);break;case"SHIFT_ARROW_UP":n=this.NotifyPlugin(ie.SHIFT_ARROW_UP,this.selectionManager.GetStartNode(),t);break;case"SHIFT_ARROW_DOWN":n=this.NotifyPlugin(ie.SHIFT_ARROW_DOWN,this.selectionManager.GetStartNode(),t);break;case"SHIFT_ARROW_LEFT":n=this.NotifyPlugin(ie.SHIFT_ARROW_LEFT,this.selectionManager.GetStartNode(),t);break;case"SHIFT_ARROW_RIGHT":n=this.NotifyPlugin(ie.SHIFT_ARROW_RIGHT,this.selectionManager.GetStartNode(),t);break;case"SHIFT_DOWN":n=this.NotifyPlugin(ie.SHIFT_DOWN,this.selectionManager.GetStartNode(),t);break;case"SHIFT_UP":n=this.NotifyPlugin(ie.SHIFT_UP,this.selectionManager.GetStartNode(),t);break;case"SELECT_ALL":n=this.NotifyPlugin(ie.SELECT_ALL,this.selectionManager.GetStartNode(),t);break;case"ESC":n=this.NotifyPlugin(ie.ESC,this.selectionManager.GetStartNode()),this.actionsManager.do(_e.ESC);break;case"SELECTION_CHANGED":break;default:return}return n}},{key:"SaveCursorPositonBeforeClick",value:function(){this.cursorPositonBeforeClick=this.GetCursorPosition()}},{key:"RestoreCursorPositionBeforeClick",value:function(){this.SetCursorPosition(this.cursorPositonBeforeClick)}},{key:"DeleteSelection",value:function(){return this.actionsManager.do(_e.DELETE_SELECTION)}},{key:"InsertCharacter",value:function(e){if(this.pluginsManager.NotifyPluginOnSpecialChar(e))return!0;e={character:e};return this.actionsManager.do(_e.INSERT_CHAR,e)}},{key:"ToggleStyleOnSelection",value:function(e,t){t={styleName:e,value:t};return this.actionsManager.do(_e.TOGGLE_STYLE_ON_SELECTION,t)}},{key:"ToggleStyleOnLine",value:function(e,t){t={styleName:e,value:t};return this.actionsManager.do(_e.TOGGLE_STYLE_ON_LINE,t)}},{key:"GetStyleAtCurrentCursorPosition",value:function(){return this.actionsManager.do(_e.GET_STYLES_AT_CARRET)}},{key:"GetCurrentStyle",value:function(){return new _(this,this.actionsManager.do(_e.GET_STYLES_AT_CARRET).nodeStyle).Copy()}},{key:"GetContent",value:function(){return this.content=this.nodeContainer.innerHTML,this.content}},{key:"GetCursorPosition",value:function(){var e=window.getSelection(),t=void 0;e.rangeCount?t=e.getRangeAt(0):(t=document.createRange()).collapse(!0);var n,i,o=t.startContainer.parentNode,r=t.startOffset,e=t.endContainer.parentNode,t=t.endOffset;return null!=o&&null!=e&&(n=o.getAttribute("cm-id"),i=e.getAttribute("cm-id")),{idStartNode:n,startOffset:r,idEndNode:i,endOffset:t}}},{key:"SetCursorPosition",value:function(e){var t,n,i=this.GetNodeById(e.idStartNode),o=this.GetNodeById(e.idEndNode);null!=i&&null!=o&&(t=window.getSelection(),(n=document.createRange()).setStart(i.domElement.firstChild,e.startOffset),n.setEnd(o.domElement.firstChild,e.endOffset),t.removeAllRanges(),t.addRange(n))}},{key:"VerifyCursorPosition",value:function(e){this.selectionManager.VerifyCursorPosition(e)}},{key:"IsNodeInsidePlugin",value:function(e){var t=!1;return null!=e&&(null==this.pluginsManager.FindNodesInstance(e)||(t=!0)),t}},{key:"GetPluginOptions",value:function(e){return this.pluginsManager.GetPluginOptions(e)}},{key:"CreatePluginInstance",value:function(e,t){return this.pluginsManager.CreatePluginInstance(e,t)}},{key:"RemovePluginInstance",value:function(e){return this.pluginsManager.RemovePluginInstance(e)}},{key:"InsertPluginAtSection",value:function(e,t){var n=void 0;return this.selectionManager.GetCurrent().hasFocus&&(n=this.pluginsManager.InsertPluginAtSection(e,t)),this.PushToHistory(),n}},{key:"CallPluginStaticMethod",value:function(e,t,n){this.pluginsManager.CallPluginStaticMethod(e,t,n)}},{key:"NotifyPlugin",value:function(e,t,n){return this.pluginsManager.NotifyPlugin(e,t,n)}},{key:"InsertNodeAtCursor",value:function(e){I.InsertNodeAtCursor(this,e)}},{key:"ChangePluginInstanceId",value:function(e,t){this.pluginsManager.ChangePluginInstanceId(e,t)}},{key:"AppendTextAtCursor",value:function(e,t){this.DeleteSelection();var n=this.GetCursorPosition(),i=this.GetNodeById(n.idStartNode);null==i&&(n=t,i=this.GetNodeById(n.idStartNode)),i.isTextNode()&&(t=n.startOffset,n=i.text,i.ForceTextContent([n.slice(0,t),e,n.slice(t)].join("")),i.SetFocus(t+e.length),this.PushToHistory())}},{key:"AppendHtmlAtCursor",value:function(e){this.DeleteSelection(),new ye(this).PasteContentInPlace(e)}},{key:"Autocorrect",value:function(e){var t,n,i;null!=e&&0<e.length&&(t=this.GetCursorPosition(),(n=this.GetNodeById(t.idStartNode)).isTextNode()&&(i=n.text,e.forEach(function(e){var t=i.indexOf(e.string);-1<t&&(t=t+e.replaceWith.length,n.ForceTextContent(i.replace(e.string,e.replaceWith)),t>n.text.length?t=n.text.length:t<0&&(t=0),n.SetFocus(t))})))}},{key:"GetSelectedLines",value:function(){return this.selectionManager.GetSelectedLines()}},{key:"IsolateAndReturnSelectedTextNodes",value:function(){return this.selectionManager.IsolateAndReturnSelectedTextNodes()}},{key:"GetSelectedTextNodes",value:function(){return this.selectionManager.GetSelectedTextNodes()}},{key:"FireStyleChanged",value:function(){null!=this.onStyleChanged&&this.onStyleChanged(this.GetStyleAtCurrentCursorPosition())}},{key:"Test",value:function(){console.log("Hi!")}}]),Qe),Ve=!1,qe=!1,Ke="",Je="dnsCcgEDT3JzfAFy",$e="c3YBAgNQdXZ5cQ==",Ze="dQMDfUc8PD07PTs9Oz1HQD09PTx2TA==";function Qe(e,t,n,i,o,r,s,a,l){var c=this,u=9<arguments.length&&void 0!==arguments[9]?arguments[9]:void 0;!function(e){if(!(e instanceof Qe))throw new TypeError("Cannot call a class as a function")}(this),this.readOnly=e,this.nodeContainer=n,this.allStyles=i,this.onStyleChanged=s,this.onDocChanged=a,this.IdManager=new v,this.actionsManager=new Ee(this,u),this.pluginsManager=new Ye(this),this.selectionManager=new B(this),this.historyManager=void 0,this.rootNode=void 0,this.allNodesById={},null!=l&&l.forEach(function(e){c.pluginsManager.Register(e.pClass,e.options)}),this.defaultNodeStyle=_.ParseDefaultFormat(this,o),null==t||""==t?this.InitEmptyDoc(this.defaultNodeStyle):this.LoadContent(t)}Ae.isProduction&&(Ze="dQMDfQJHPDwGBgY7cHx6em53AjtwfHo8dkw=");var et="UHx6em5XYEctfXlybgJyLX0BfAV2cXItbi0Fbnl2cS15dnBye3ByLXhyCA==",tt="b25weHQBfAR7cTpwfHl8AUcBcnFIfW5xcXZ7dEc+PX0HSHB8eXwBRzBzc3Nzc3NI";function nt(){ke("s","v",!0)}function it(){ke("s","v",!1);var e=document.getElementById(ke("g","i")).parentElement,t=document.createElement("div");t.setAttribute("style",ot(tt)),t.textContent=ot(et),e[ot(Je)](t,e[ot($e)])}function ot(e){return function(e){var t=1<arguments.length?113:13,n=2<arguments.length&&!1;if("number"!=typeof t||t%1!=0||"number"!=typeof t||t%1!=0)return e.toString();for(var i=e.toString().split(""),o=0;o<i.length;o++)i[o].charCodeAt(0)<=126&&(i[o]=String.fromCharCode((i[o].charCodeAt(0)+t)%126));return n?btoa(i.join("")):i.join("")}(e=atob(e),113)}function rt(e){var t;ke("s","i",e.idContainerOrDomElement),t=!1,(Ke=window.location.hostname)!=ot("eXxwbnl1fAID")&&Ke!=ot("PTs9Oz07PQ==")&&Ke!=ot("Pj9EOz07PTs+")||(t=!0),t||-1<Ke.indexOf(ot("}ytt;p|"))&&(t=!0),t?nt():(ke("s","f",e.InitSrc),function(e,t){if(ke("s","l",t),t=function(e){if(null!=e&&""!=e){var t=window.location.hostname;4==t.split(".").length||(t=t.split(".").slice(-2).join("."));for(var n=(e+"#"+Ae.version+"#"+t).toString().split(""),i=0;i<n.length;i++)n[i].charCodeAt(0)<=126&&(n[i]=String.fromCharCode((n[i].charCodeAt(0)+13)%126));e=btoa(n.join(""))}return window.encodeURIComponent(e)}(t),Ve)return new Promise(function(e,t){qe?t(!0):e(!1)});if(null==t)return Ve=!0,new Promise(function(e,t){navigator.onLine?(ke("s","vv",!(qe=!1)),e(!1)):(ke("s","vv",qe=!0),t(!0))});Ve=!0;var n=new Image,i=!1;return navigator.onLine&&e(n,ot(Ze)+t),n[ot("AgFw")].indexOf(t)<0&&(i=!0),new Promise(function(e,t){navigator.onLine?i?(ke("s","vv",!(qe=!1)),e(!1)):(n.onload=function(){ke("s","vv",!(qe=!1)),e(!1)},n.onerror=function(e){ke("s","vv",qe=!0),t(!0)}):(ke("s","vv",qe=!0),t(!0))})}(e.InitSrc,e.e).then(function(e){it()}).catch(function(e){(e?nt:it)()}))}var st=function(e){rt(e)};function at(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var lt=(ft=[{key:"GetName",value:function(){return""}},{key:"CreateNew",value:function(){throw"CreateNew: Not implemented"}},{key:"CreateNewFromPastedNode",value:function(){throw"CreateNewFromPastedNode: Not implemented"}},{key:"GetTagToParseOnPaste",value:function(){return[]}}],at((n=ht).prototype,[{key:"Fire",value:function(){}},{key:"InitializeDomElements",value:function(e){var t;null!=this.PluginDidMount&&(null==this.rootNode.parent?(null==e?e=0:e++,e<50?(t=this,setTimeout(function(){t.InitializeDomElements(e)},100)):console.log("#345-23")):this.readOnly||this.PluginDidMount())}}]),at(n,ft),ht),ct={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,i,o,r,s,a="",l=0;for(e=ct._utf8_encode(e);l<e.length;)i=(s=e.charCodeAt(l++))>>2,o=(3&s)<<4|(t=e.charCodeAt(l++))>>4,r=(15&t)<<2|(n=e.charCodeAt(l++))>>6,s=63&n,isNaN(t)?r=s=64:isNaN(n)&&(s=64),a=a+this._keyStr.charAt(i)+this._keyStr.charAt(o)+this._keyStr.charAt(r)+this._keyStr.charAt(s);return a},decode:function(e){var t,n,i,o,r,s="",a=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");a<e.length;)t=this._keyStr.indexOf(e.charAt(a++))<<2|(i=this._keyStr.indexOf(e.charAt(a++)))>>4,n=(15&i)<<4|(o=this._keyStr.indexOf(e.charAt(a++)))>>2,i=(3&o)<<6|(r=this._keyStr.indexOf(e.charAt(a++))),s+=String.fromCharCode(t),64!=o&&(s+=String.fromCharCode(n)),64!=r&&(s+=String.fromCharCode(i));return ct._utf8_decode(s)},_utf8_encode:function(e){var t="";e=e.replace(/\r\n/g,"\n");for(var n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t+=String.fromCharCode(i):(127<i&&i<2048?t+=String.fromCharCode(i>>6|192):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128)),t+=String.fromCharCode(63&i|128))}return t},_utf8_decode:function(e){for(var t,n,i="",o=0,r=t=0;o<e.length;)(r=e.charCodeAt(o))<128?(i+=String.fromCharCode(r),o++):191<r&&r<224?(t=e.charCodeAt(o+1),i+=String.fromCharCode((31&r)<<6|63&t),o+=2):(t=e.charCodeAt(o+1),n=e.charCodeAt(o+2),i+=String.fromCharCode((15&r)<<12|(63&t)<<6|63&n),o+=3);return i}},ut=ct;function ht(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];!function(e){if(!(e instanceof ht))throw new TypeError("Cannot call a class as a function")}(this),this.id=e.id,this.rootNode=e,t||this.InitializeDomElements()}function dt(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ft=(dt(pt.prototype,[{key:"InitSrc",value:function(e,t){return t=t,void(e.src=t)}},{key:"ValidateUserOptions",value:function(e){return null==e&&(e={}),null==e.readOnly&&(e.readOnly=!1),null==e.onChange&&(e.onChange=function(){}),null==e.onStyleChanged&&(e.onStyleChanged=function(){}),null==e.onSelectinChange&&(e.onSelectinChange=function(){}),null==e.styleMonitoring&&(e.styleMonitoring=function(){}),null==e.content&&(e.content=""),null==e.defaultStyle&&(e.defaultStyle={bold:!1,fontSize:"14px",fontColor:"#39434d"}),null==e.defaultLineStyle&&(e.defaultLineStyle={align:"left"}),e}},{key:"SetUserSettings",value:function(e){null!=e&&""!=e||(e={}),this.shortcuts=[],this.autocorrect=[],this.useAutocorrect=!1,null!=e.userSettings?(null!=e.userSettings.shortcuts&&(this.shortcuts=e.userSettings.shortcuts),null!=e.userSettings.autocorrect&&0<e.userSettings.autocorrect.length&&(this.useAutocorrect=!0,this.autocorrect=e.userSettings.autocorrect)):(null!=e.shortcuts&&(this.shortcuts=e.shortcuts),null!=e.autocorrect&&0<e.autocorrect.length&&(this.useAutocorrect=!0,this.autocorrect=e.autocorrect)),this.shortcutManager.SetShortcuts(this.shortcuts)}},{key:"_KeyDown",value:function(e){this.eventsManager.KeyDown(e)}},{key:"_KeyUp",value:function(e){this.eventsManager.KeyUp(e),this.SelectionChanged()}},{key:"_Paste",value:function(e){this.eventsManager.OnPaste(e),this.FireStyleMonitoring()}},{key:"_Cut",value:function(e){this.eventsManager.OnCut(e),this.FireStyleMonitoring()}},{key:"_Copy",value:function(e){this.eventsManager.OnCopy(e),this.FireStyleMonitoring()}},{key:"_Click",value:function(e){this.eventsManager.OnClick(e),this.FireStyleMonitoring()}},{key:"_Mousedown",value:function(){this.SaveCursorPositonBeforeClick()}},{key:"_Mouseup",value:function(){this.SelectionChanged()}},{key:"_initContainer",value:function(){var t=this;"string"==typeof this.idContainerOrDomElement?this.mainContainer=document.getElementById(this.idContainerOrDomElement):this.mainContainer=this.idContainerOrDomElement,this.mainContainer.style.outline="none",this.mainContainer.style.opacity=0,this.mainContainer.style.whiteSpace="pre-wrap",null==this.caretColor||""==this.caretColor?this.mainContainer.style.caretColor="#475666":this.mainContainer.style.caretColor=this.caretColor,null!=this.defaultStyle.fontColor&&""!=this.defaultStyle.fontColor&&(this.mainContainer.style.color=this.defaultStyle.fontColor,delete this.defaultStyle.fontColor),this.readOnly?(this.mainContainer.setAttribute("contenteditable",!1),this.document=new Xe(this.readOnly,this.content,this.mainContainer,this.allStyles,this.defaultStyle,this.defaultLineStyle,this.styleMonitoring,function(e){return t.FireDocChanged(e)},this.plugins)):(this.mainContainer.setAttribute("contenteditable",!0),this.eventsFunctions={keydown:this._KeyDown.bind(this),keyup:this._KeyUp.bind(this),paste:this._Paste.bind(this),cut:this._Cut.bind(this),copy:this._Copy.bind(this),click:this._Click.bind(this),mousedown:this._Mousedown.bind(this),mouseup:this._Mouseup.bind(this)},this.mainContainer.addEventListener("keydown",this.eventsFunctions.keydown),this.mainContainer.addEventListener("keyup",this.eventsFunctions.keyup),this.mainContainer.addEventListener("paste",this.eventsFunctions.paste),this.mainContainer.addEventListener("cut",this.eventsFunctions.cut),this.mainContainer.addEventListener("copy",this.eventsFunctions.copy),this.mainContainer.addEventListener("click",this.eventsFunctions.click),this.mainContainer.addEventListener("mousedown",this.eventsFunctions.mousedown),null!=this.mainContainer.parentNode&&this.mainContainer.parentNode.addEventListener("mouseup",this.eventsFunctions.mouseup),this.document=new Xe(this.readOnly,this.content,this.mainContainer,this.allStyles,this.defaultStyle,this.defaultLineStyle,this.styleMonitoring,function(e){return t.FireDocChanged(e)},this.plugins,this.catchUserInput),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.document.SetHistoryManager(this.historyManager),this.FireStyleMonitoring(),this.latestCursorPosition=this.document.GetCursorPosition()),this.mainContainer.style.opacity=1}},{key:"Destroy",value:function(){this.readOnly||(this.mainContainer.removeEventListener("keydown",this.eventsFunctions.keydown),this.mainContainer.removeEventListener("keyup",this.eventsFunctions.keyup),this.mainContainer.removeEventListener("paste",this.eventsFunctions.paste),this.mainContainer.removeEventListener("cut",this.eventsFunctions.cut),this.mainContainer.removeEventListener("copy",this.eventsFunctions.copy),this.mainContainer.removeEventListener("click",this.eventsFunctions.click),this.mainContainer.removeEventListener("mousedown",this.eventsFunctions.mousedown),null!=this.mainContainer.parentNode&&this.mainContainer.parentNode.removeEventListener("mouseup",this.eventsFunctions.mouseup))}},{key:"Fire",value:function(e,t){var n=!1,i=!0;switch(e){case f.CUR_POS_CHANGED:this.document.VerifyCursorPosition(t),n=i=!1;break;case f.ENTER:this.useAutocorrect&&this.Autocorrect(),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("enter");break;case f.BACKSPACE:this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("backspace");break;case f.DELETE:this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("delete");break;case f.TAB:n=this.document.ManagerSpecialActions("tab");break;case f.BEFORE_COPY:n=this.document.ManagerSpecialActions("BEFORE_COPY",t),i=!1;break;case f.BEFORE_CUT:n=this.document.ManagerSpecialActions("BEFORE_CUT",t),i=!1;break;case f.BEFORE_PASTE:n=this.document.ManagerSpecialActions("BEFORE_PASTE",t),i=!1;break;case f.COPY:n=this.document.ManagerSpecialActions("copy",t),i=!1;break;case f.CUT:this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("cut",t);break;case f.PASTE:this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("paste",t);break;case f.CLICK:n=this.document.ManagerSpecialActions("click",t),i=!1;break;case f.AFTER_CHAR_ADDED:this.document.ManagerSpecialActions("newCharAdded",t),i=!1;break;case f.ARROW_UP:n=this.document.ManagerSpecialActions("ARROW_UP",t),i=!1;break;case f.ARROW_DOWN:n=this.document.ManagerSpecialActions("ARROW_DOWN",t),i=!1;break;case f.ARROW_LEFT:n=this.document.ManagerSpecialActions("ARROW_LEFT",t),i=!1;break;case f.ARROW_RIGHT:n=this.document.ManagerSpecialActions("ARROW_RIGHT",t),i=!1;break;case f.SHIFT_ARROW_UP:n=this.document.ManagerSpecialActions("SHIFT_ARROW_UP",t),i=!1;break;case f.SHIFT_ARROW_DOWN:n=this.document.ManagerSpecialActions("SHIFT_ARROW_DOWN",t),i=!1;break;case f.SHIFT_ARROW_LEFT:n=this.document.ManagerSpecialActions("SHIFT_ARROW_LEFT",t),i=!1;break;case f.SHIFT_ARROW_RIGHT:n=this.document.ManagerSpecialActions("SHIFT_ARROW_RIGHT",t),i=!1;break;case f.SHIFT_DOWN:n=this.document.ManagerSpecialActions("SHIFT_DOWN",t),i=!1;break;case f.SHIFT_UP:n=this.document.ManagerSpecialActions("SHIFT_UP",t),i=!1;break;case f.SELECT_ALL:n=this.document.ManagerSpecialActions("SELECT_ALL",t),i=!1;break;case f.ESC:n=this.document.ManagerSpecialActions("ESC",t),i=!1;break;case f.BOLD:this.ToggleStyleOnSelection("bold",void 0),i=n=!1;break;case f.ITALIC:this.ToggleStyleOnSelection("italic",void 0),i=n=!1;break;case f.UNDERLINED:this.ToggleStyleOnSelection("underlined",void 0),i=n=!1;break;case f.SELECTION_CHANGED:this.document.ManagerSpecialActions("SELECTION_CHANGED"),i=!1;break;default:return}return i&&(this.FireDocChanged(),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition())),n}},{key:"Undo",value:function(){var e=this.historyManager.GetUndo();this.document.LoadContent(e.content,!1),this.document.SetCursorPosition(e.cursorPosition),this.FireStyleMonitoring(),this.FireDocChanged()}},{key:"Redo",value:function(){var e=this.historyManager.GetRedo();this.document.LoadContent(e.content,!1),this.document.SetCursorPosition(e.cursorPosition),this.FireStyleMonitoring(),this.FireDocChanged()}},{key:"InsertCharacter",value:function(e){return this.charAdded=!0,this.document.InsertCharacter(e)}},{key:"Focus",value:function(){this.document.Focus()}},{key:"FocusAtTheEnd",value:function(){this.document.FocusAtTheEnd()}},{key:"isContentEmpty",value:function(){return this.document.isContentEmpty()}},{key:"DoneInsertCharacter",value:function(e){this.charAdded&&(this.charAdded=!1," "==e?(this.useAutocorrect&&this.Autocorrect(),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition())):this.historyManager.PushChar(this.document.GetContent(),this.document.GetCursorPosition()),this.FireDocChanged())}},{key:"FireDocChanged",value:function(){var e=this;null!=this.onChange&&setTimeout(function(){e.onChange(e.mainContainer.innerHTML)}),this.latestCursorPosition=this.document.GetCursorPosition()}},{key:"FireStyleChanged",value:function(){var e=this.document.GetStyleAtCurrentCursorPosition();this.FireStyleMonitoring(),null!=this.onStyleChanged&&this.onStyleChanged(e)}},{key:"FireStyleMonitoring",value:function(){var e=this.document.GetStyleAtCurrentCursorPosition();null!=this.styleMonitoring&&this.styleMonitoring(e)}},{key:"ToggleStyleOnSelection",value:function(e,t){this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.document.ToggleStyleOnSelection(e,t),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.FireDocChanged(),this.FireStyleMonitoring(),this.FireStyleChanged()}},{key:"ToggleStyleOnLine",value:function(e,t){this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.document.ToggleStyleOnLine(e,t),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.FireDocChanged(),this.FireStyleMonitoring(),this.FireStyleChanged()}},{key:"SetContent",value:function(e){this.mainContainer.style.opacity=0,this.content=e,this.document.LoadContent(this.content),this.mainContainer.style.opacity=1}},{key:"GetContent",value:function(){return this.mainContainer.innerHTML}},{key:"GetStyleAtCarret",value:function(){return this.document.GetStyleAtCurrentCursorPosition()}},{key:"StoreCursorPosition",value:function(){this.storedCursorPosition=this.document.GetCursorPosition()}},{key:"RestoreCursorPosition",value:function(){this.document.SetCursorPosition(this.storedCursorPosition)}},{key:"SaveCursorPositonBeforeClick",value:function(){this.document.SaveCursorPositonBeforeClick()}},{key:"AppendTextAtCursor",value:function(e){this.document.AppendTextAtCursor(e,this.latestCursorPosition)}},{key:"AppendHtmlAtCursor",value:function(e){this.document.AppendHtmlAtCursor(e,this.latestCursorPosition)}},{key:"SelectionChanged",value:function(){var n=this;setTimeout(function(){var e,t=n.document.GetCursorPosition();null==t.idStartNode||null!=(e=n.document.GetNodeById(t.idStartNode))&&(t.startNode=e.domElement),null==t.idEndNode||null!=(e=n.document.GetNodeById(t.idEndNode))&&(t.endNode=e.domElement),t.selectionBoundingRectangle=n.document.GetSelectionBoundingClientRect(),null!=n.onSelectinChange&&n.onSelectinChange(t)},10)}},{key:"InsertPluginAtSection",value:function(e,t){this.document.InsertPluginAtSection(e,t)}},{key:"CallPluginStaticMethod",value:function(e,t,n){this.document.CallPluginStaticMethod(e,t,n)}},{key:"ManageUserShortcuts",value:function(e){e=this.shortcutManager.Fire(e);return e&&this.document.PushToHistory(),e}},{key:"Autocorrect",value:function(){this.document.Autocorrect(this.autocorrect)}},{key:"IsolateSelectedText",value:function(){this.document.ToggleStyleOnSelection("splitSelection");var e=this.document.rootNode.domElement.querySelectorAll(".splitSelectionDummy");return this.document.ToggleStyleOnSelection("splitSelection"),e}},{key:"GetNodesByAttr",value:function(e,t){return this.document.rootNode.domElement.querySelectorAll("["+e+'="'+t+'"]')}},{key:"SetAttribute",value:function(e,t,n){var e=e.getAttribute("cm-id");null==e||""==e||(e=this.document.GetNodeById(e)).isTextNode()&&e.AddAttribute(t,n)}},{key:"RemoveAttribute",value:function(t,e){var n=this;this.GetNodesByAttr(t,e).forEach(function(e){var e=e.getAttribute("cm-id");null==e||""==e||(e=n.document.GetNodeById(e)).isTextNode()&&e.RemoveAttribute(t)})}},{key:"_debugPrintNode",value:function(e,t){var n=this;null==t&&(t="");var i="noParent";null!=e.parent&&(i=e.parent.id);var o="";null!=e.pluginName&&(o=e.pluginName);var r="noPrevious";null!=e.previous&&(r=e.previous.id),e.isTextNode()?console.log(t+e.id+" %c"+e.tagName+" %c"+e.type+" %c=> [%c"+e.text+"%c] %c"+i+" %c"+r+" %c"+o,"color:red","color:#ad0c9d","color:black","color:#129957","color:black","color:#ffffff","color:#eeeeee","color:red"):console.log(t+e.id+" %c"+e.tagName+" %c"+e.type+" %c"+i+" %c"+r+" %c"+o,"color:red","color:#ad0c9d","color:#ffffff","color:#eeeeee","color:red"),e.children.forEach(function(e){n._debugPrintNode(e,t+"   ")})}},{key:"Debug",value:function(e){e?(e=this.document.rootNode,this._debugPrintNode(e)):console.log(this.document.rootNode)}},{key:"Test",value:function(){this.document.InsertPluginAtSection("image",{link:"/img/devImgTag.jpg"})}}]),pt);function pt(e,t){var n=this;!function(e){if(!(e instanceof pt))throw new TypeError("Cannot call a class as a function")}(this),i.a.Init(),this.idContainerOrDomElement=e,this.document=void 0,t=this.ValidateUserOptions(t),this.readOnly=t.readOnly,this.onChange=t.onChange,this.onStyleChanged=t.onStyleChanged,this.onFilesPasted=t.onFilesPasted,this.onSelectinChange=t.onSelectinChange,this.styleMonitoring=t.styleMonitoring,this.content=t.content,this.defaultStyle=t.defaultStyle,this.allStyles=t.styles,this.caretColor=t.caretColor,this.defaultLineStyle=t.defaultLineStyle,this.catchUserInput=t.catchUserInput,this.e=function(e){for(var t,n="",i=[107,101,121],o=0;o<i.length;o++)n+=(t=i[o],String.fromCharCode(t));return e[n]}(t),this.eventsManager=new p(this),this.historyManager=new r,this.plugins=[],null!=t.plugins&&(this.plugins=t.plugins),this.shortcutManager=new c(this),this.SetUserSettings(t),this._initContainer(),this.str="$#22#5#1975#$",setTimeout(function(){st(n)},1e3)}t.default=ft}],o.c=i,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=3))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var h=n(0);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(u,h.Plugin);var n,i,o=(n=u,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=c(n);return!(t=i?(e=c(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==r(t)&&"function"!=typeof t?l(this):t});function u(e){var t;!function(e){if(!(e instanceof u))throw new TypeError("Cannot call a class as a function")}(this),(t=o.call(this,e)).options=t.rootNode.document.GetPluginOptions("link");var n=l(t);return e.domElement.addEventListener("click",function(e){n.Click(e)}),e.domElement.addEventListener("mouseover",function(){this.style.cursor="pointer"}),t}return s(u,null,[{key:"GetName",value:function(){return"link"}}]),s(u,[{key:"Click",value:function(e){var t=this.rootNode.domElement.getAttribute("anchor-target"),n=!0;null!=this.options&&null!=this.options.onClick&&(n=null==(n=this.options.onClick(t))||!n),n&&window.open(t,"_blank"),e.preventDefault(),e.stopPropagation()}},{key:"Fire",value:function(){}}],[{key:"GetTagToParseOnPaste",value:function(){return["a"]}},{key:"CreateNewFromPastedNode",value:function(e,t){var n=new h.NodeStyle(e,e.GetStyleAtCurrentCursorPosition().nodeStyle).Copy(),i="",o="string"==typeof t?i=t:(i=t.getAttribute("href"),t.textContent),i=[{name:"anchor-target",value:i}],i=h.TextNode.CreateNew(e,"span",o,n.Copy(),i);i.ToggleStyle("underlined","",!0,!0),i.ToggleStyle("fontColor","#428ff4",!0,!0);n=h.TextNode.CreateNew(e,"span","",n.Copy());return{mustArrangeNodes:!0,nodesBefore:[],pluginNode:new u(i),nodesAfter:[n]}}},{key:"CreateNew",value:function(e,t){var n=new h.NodeStyle(e,e.GetStyleAtCurrentCursorPosition().nodeStyle).Copy(),i=t.url,o=t.label,r="#428ff4";null!=t.color&&(r=t.color),"http://"!==i.substr(0,"http://".length)&&"https://"!==i.substr(0,"https://".length)&&(i="http://"+i),null!=o&&""!=o||(o=i.replace("http://","").replace("https://",""));var s=e.IsolateAndReturnSelectedTextNodes(),a=[],l=[{name:"anchor-target",value:i}],c=void 0;return 0==s.length?(e.DeleteSelection(),t=e.GetNodeAtCursor().GetBlockContainer(),(i=h.TextNode.CreateNew(e,"span",o,n.Copy(),l)).ToggleStyle("underlined","",!0,!0),i.ToggleStyle("fontColor",r,!0,!0),t.InsertTextNodeAtCursor(i),c=i,a.push(new u(i))):s.forEach(function(e){""==e.text&&e.ForceTextContent(o),e.SetAttributes(l),e.ToggleStyle("underlined","",!0,!0),e.ToggleStyle("fontColor",r,!0,!0),a.push(new u(e)),c=e}),null==c.next?(n=h.TextNode.CreateNew(e,"span","",n.Copy()),c.parent.Append(n),n.SetFocus()):c.next.SetFocus(),a}}]),u}();t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var r=n(0);function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var s=(i(o.prototype,[{key:"InitPanel",value:function(){function e(e){t.MouseDown(e,this)}var t=this;this.panel=document.createElement("div"),this.panel.setAttribute("class","comma-img-resizable");var n=document.createElement("div");n.setAttribute("class","comma-img-resizers");var i=document.createElement("div");i.setAttribute("class","comma-img-resizer cir-top-left"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i);i=document.createElement("div");i.setAttribute("class","comma-img-resizer cir-top-right"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i);i=document.createElement("div");i.setAttribute("class","comma-img-resizer cir-bottom-left"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i);var o,r,i=document.createElement("div");function s(){t.Hide()}i.setAttribute("class","comma-img-resizer cir-bottom-right"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i),this.showEditingBtn&&((r=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-edit"),o=function(e){t.OpenEditingPanel(e)},r.removeEventListener("mousedown",o),r.addEventListener("mousedown",o),n.appendChild(r)),this.showMagnifyBtn&&((o=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-search-plus"),o.style.marginLeft="6px",r=function(e){t.MagnifyImage(e)},o.removeEventListener("mousedown",r),o.addEventListener("mousedown",r),n.appendChild(o)),this.panel.removeEventListener("mousedown",s),this.panel.addEventListener("mousedown",s),this.panel.appendChild(n),document.body.appendChild(this.panel)}},{key:"Show",value:function(){this.shown=!0,this.panel.style.display="block",this.RenderPanel()}},{key:"RenderPanel",value:function(){var e=this.img.getBoundingClientRect();this.panel.style.top=e.top+window.scrollY+"px",this.panel.style.left=e.left+window.scrollX+"px",this.panel.style.width=e.width+"px",this.panel.style.height=e.height+"px"}},{key:"Hide",value:function(){this.shown=!1,this.panel.style.display="none"}},{key:"MouseDown",value:function(e,t){var n=this;function i(e){n.StopResize(e)}function o(e){n.Resize(e,t)}this.px=e.pageX,this.f_resize=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"Resize",value:function(e,t){var n=e.pageX,i=n-this.px;this.img.style.height="auto";var o=parseInt(getComputedStyle(this.img).width.replace("px",""));t.classList.contains("cir-bottom-right")||t.classList.contains("cir-top-right")?o+=i:o-=i,this.img.style.width=o+"px",this.panel.style.width=o+"px",this.panel.style.height=getComputedStyle(this.img).height,this.px=n,this.RenderPanel(),e.preventDefault(),e.stopPropagation()}},{key:"StopResize",value:function(e){window.removeEventListener("mousemove",this.f_resize),this.imgPluginInstance.PushToHistory(),e.preventDefault(),e.stopPropagation()}},{key:"OpenEditingPanel",value:function(e){this.imgPluginInstance.OpenEditingPanel(),e.preventDefault(),e.stopPropagation()}},{key:"MagnifyImage",value:function(e){this.imgPluginInstance.MagnifyImage(),e.preventDefault(),e.stopPropagation()}}]),o);function o(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];!function(e){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this),this.img=e,this.imgPluginInstance=t,this.panel=void 0,this.shown=!1,this.showEditingBtn=n,this.showMagnifyBtn=i,this.InitPanel()}function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=(a(c.prototype,[{key:"InitPanel",value:function(){var e=this,t=document.createElement("div");t.setAttribute("class","comma-img-full-screen"),t.style.display="flex",t.tabIndex=9999;var n=document.createElement("div");n.setAttribute("class","ciifs-close-btn");var i=document.createElement("i");function o(){e.Hide()}i.setAttribute("class","fa fa-close"),n.appendChild(i),n.removeEventListener("click",o),n.addEventListener("click",o),t.appendChild(n);var r=document.createElement("div");r.setAttribute("class","comma-img-full-screen-container");i=document.createElement("div");i.setAttribute("class","ciifs-pnl-preview");n=document.createElement("img");n.src=this.imgSrc,n.setAttribute("style","object-fit: contain;width: 95vw; height: 95vh;"),i.appendChild(n),r.appendChild(i),t.appendChild(r),document.body.appendChild(t),(this.panelFullScreen=t).focus(),t.addEventListener("keydown",this.keyDownEvent,!1)}},{key:"Hide",value:function(){this.panelFullScreen.style.display="none",this.panelFullScreen.removeEventListener("keydown",this.keyDownEvent),null!=this.panelFullScreen&&null!=this.panelFullScreen.parentNode&&this.panelFullScreen.parentNode.removeChild(this.panelFullScreen)}}]),c);function c(e){var t=this;!function(e){if(!(e instanceof c))throw new TypeError("Cannot call a class as a function")}(this),this.imgSrc=e,this.keyDownEvent=function(e){e=e.key;"Esc"!==e&&"Escape"!==e||t.Hide()},this.InitPanel()}function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),e}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(n,r.Plugin);var i,o,t=(i=n,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=p(i),n=this;return!(t=o?(e=p(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==u(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function n(e){return function(e){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e)).options=e.rootNode.document.GetPluginOptions("image"),null==e.options&&(e.options={}),e.useImageEditor=!1,null!=e.options.imageEditor&&(e.ImageEditorClass=e.options.imageEditor,e.useImageEditor=!0),e.readOnly=e.rootNode.document.readOnly,e.InitializeDomElements(),e}return d(n,null,[{key:"GetName",value:function(){return"image"}}]),d(n,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#445-27")):this.readOnly||this.Init()}},{key:"Init",value:function(){var t=this,e=this;function n(){}function i(){}function o(){e.resizeManager.Show()}this.resizeManager=new s(this.rootNode.domElement,this,this.useImageEditor,!0),this.rootNode.domElement.removeEventListener("mousemove",n),this.rootNode.domElement.addEventListener("mousemove",n),this.rootNode.domElement.removeEventListener("mouseout",i),this.rootNode.domElement.addEventListener("mouseout",i),this.rootNode.domElement.removeEventListener("click",o),this.rootNode.domElement.addEventListener("click",o),this.originalSrc=this.rootNode.domElement.getAttribute("cm-origin-src"),null!=this.originalSrc&&""!=this.originalSrc||(this.originalSrc=this.rootNode.domElement.getAttribute("src"),this.rootNode.domElement.setAttribute("cm-origin-src",this.originalSrc));var r=this.rootNode.domElement.getAttribute("src");(r.indexOf("data")<0||r.indexOf("base64")<0)&&this.toDataURL(r).then(function(e){t.rootNode.RemoveAttribute("src"),t.rootNode.AddAttribute("src",e)}),null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.KeepFileFromDelete&&(this.options.externalFunctions.KeepFileFromDelete(this.rootNode.domElement.src),this.originalSrc!=this.rootNode.domElement.src&&this.options.externalFunctions.KeepFileFromDelete(this.rootNode.domElement.src))}},{key:"toDataURL",value:function(i){return new Promise(function(t,e){var n=new XMLHttpRequest;n.onload=function(){var e=new FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(n.response)},n.open("GET",i),n.responseType="blob",n.send()})}},{key:"OpenEditingPanel",value:function(){var t=this;this.resizeManager.Hide(),this.useImageEditor&&new this.ImageEditorClass(this.rootNode.domElement.getAttribute("src"),this.originalSrc,function(e){return t.SaveEditedImage(e)})}},{key:"MagnifyImage",value:function(){this.resizeManager.Hide(),new l(this.rootNode.domElement.getAttribute("src"))}},{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"SaveEditedImage",value:function(e){var t=this,n=!0;null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.SaveEditedImage&&(this.rootNode.domElement.style.opacity=.5,this.rootNode.domElement.src!=this.originalSrc&&this.options.externalFunctions.MarkFileForDelete(this.rootNode.domElement.src),n=!1,this.options.externalFunctions.SaveEditedImage(e,this.rootNode.domElement.src).then(function(e){t.rootNode.domElement.src=e,t.rootNode.domElement.style.opacity=1,t.PushToHistory()},function(e){console.log(e)})),n&&(this.rootNode.domElement.src=e)}},{key:"Fire",value:function(e){switch(e){case r.PluginActions.LOST_FOCUS:this.resizeManager.Hide();break;case r.PluginActions.NODE_UNREGISTERED:null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.MarkFileForDelete&&(this.options.externalFunctions.MarkFileForDelete(this.rootNode.domElement.src),this.rootNode.domElement.src!=this.originalSrc&&null!=this.originalSrc&&""!=this.originalSrc&&this.options.externalFunctions.MarkFileForDelete(this.originalSrc))}return!1}}],[{key:"CreateNew",value:function(e,t){e.DeleteSelection(),e.GetNodeAtCursor();t=t.link,t=r.InlineNode.CreateNew(e,"img","",void 0,[{name:"cm-origin-src",value:t},{name:"src",value:t},{name:"class",value:"commaImg"}]);return e.InsertNodeAtCursor(t),new n(t)}},{key:"GetTagToParseOnPaste",value:function(){return["img"]}},{key:"CreateNewFromPastedNode",value:function(e,t){t=t.getAttribute("src");return new n(r.InlineNode.CreateNew(e,"img","",void 0,[{name:"cm-origin-src",value:t},{name:"src",value:t},{name:"class",value:"commaImg"}]))}}]),n}();t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return o});var r=n(0);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var h=void 0,o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(l,r.Plugin);var i,o,n=(i=l,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=u(i),n=this;return!(t=o?(e=u(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==s(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function l(e){var t;!function(e){if(!(e instanceof l))throw new TypeError("Cannot call a class as a function")}(this);e=(t=n.call(this,e)).GetIdTarget();return null!=e&&""!=e?null==t.rootNode.document.GetNodeById(e)&&t.SetIdTarget():l.CleanNodeFromPlugin(t.rootNode),t}return a(l,null,[{key:"GetName",value:function(){return"outline"}}]),a(l,[{key:"SetIdTarget",value:function(){this.rootNode.domElement.setAttribute("cm-outline-id-target",this.rootNode.id)}},{key:"GetIdTarget",value:function(){return this.rootNode.domElement.getAttribute("cm-outline-id-target")}},{key:"GetLevel",value:function(){return this.rootNode.domElement.getAttribute("cm-outline-level")}},{key:"ManageEnter",value:function(){var e=void 0,t=!0;0==this.rootNode.document.GetCursorPosition().startOffset?(e=this.rootNode.InsertEmptyBlockNodeBefore("div"),t=!1):e=this.rootNode.InsertEmptyBlockNodeAfter("div");var n=r.TextNode.CreateNew(this.rootNode.document,"span","",this.rootNode.document.GetDefaultNodeStyle());return e.Append(n),(t?n:this.rootNode.GetFirstTextNode()).SetFocus(),!0}},{key:"Fire",value:function(e,t){if(e===r.PluginActions.ENTER)return this.ManageEnter(t)}}],[{key:"CleanNodeFromPlugin",value:function(e){var t=e.document,n=void 0;t.RemovePluginInstance(e.id);var i=e.domElement.getAttribute("cm-outline-level");return e.children.forEach(function(e){e.isTextNode()&&(null==n&&(n=e),"h1"==i.toLowerCase()?e.ToggleStyle("headerOne",void 0,!0):"h2"==i.toLowerCase()?e.ToggleStyle("headerTwo",void 0,!0):"h3"==i.toLowerCase()?e.ToggleStyle("headerThree",void 0,!0):i.toLowerCase(),e.ApplyNodeStyle(t.GetDefaultNodeStyle()))}),e.RemoveAttribute("cm-outline-id-target"),e.RemoveAttribute("cm-outline-level"),n}},{key:"CreateNew",value:function(t,e){var n=e,i=t.GetSelectedLines()[0],e=void 0,o=void 0;return null!=i&&("outline"==i.GetPluginType()&&(o=l.CleanNodeFromPlugin(i)),i.id,i.children.forEach(function(e){e.isTextNode()&&(null==o&&(o=e),"h1"==n.toLowerCase()?e.ToggleStyle("headerOne",void 0,!0):"h2"==n.toLowerCase()?e.ToggleStyle("headerTwo",void 0,!0):"h3"==n.toLowerCase()?e.ToggleStyle("headerThree",void 0,!0):"normal"==n.toLowerCase()&&e.ApplyNodeStyle(t.GetDefaultNodeStyle()))}),"normal"!=n.toLowerCase()&&(i.AddAttribute("cm-outline-id-target",i.id),i.AddAttribute("cm-outline-level",n),e=new l(i))),t.FireStyleChanged(),null!=o&&o.SetFocus(),e}},{key:"ParseDocument",value:function(e,o){e.children.forEach(function(e){var t,n,i;e.isBlockNode()&&(null!=e.GetPluginType()&&"outline"==e.GetPluginType().toLowerCase()?(t=e.domElement.getAttribute("cm-outline-id-target"),n=e.domElement.getAttribute("cm-outline-level"),i=e.domElement.textContent,o.push({idTarget:t,level:n,label:i})):l.ParseDocument(e,o))})}},{key:"OpenNavigationPanel",value:function(i){var e,o,t,n,r,s,a;null!=h?(document.body.removeChild(h),h=void 0):(e=[],l.ParseDocument(i.rootNode,e),o=document.createElement("div"),t=(s=(r=i.nodeContainer).getBoundingClientRect()).width/2,n=s.height,o.style.backgroundColor="#ffffff",o.style.border="1px solid #e3e3e3",o.style.boxShadow="0 4px 8px 0 rgba(0, 0, 0, 0.2)",o.style.position="absolute",o.style.top=window.scrollY+s.top+r.parentNode.scrollTop+"px",o.style.left=window.scrollX+s.left+"px",o.style.width="0px",o.style.maxHeight=n+"px",o.style.overflow="hidden",o.style.opacity=0,o.style.zIndex="999",(r=document.createElement("div")).style.display="flex",r.style.alignItems="center",r.style.height="46px",(s=document.createElement("div")).innerHTML="Table of Contents",s.style.flex="1",s.style.color="#9298a1",s.style.padding="10px",s.style.fontSize="14px",s.style.fontFamily="Arial",r.appendChild(s),(s=document.createElement("i")).setAttribute("class","fa fa-times"),s.style.color="#9298a1",s.style.cursor="pointer",s.style.margin="10px",s.addEventListener("mouseover",function(e){this.style.color="#30b7e8"}),s.addEventListener("mouseout",function(e){this.style.color="#9298a1"}),s.addEventListener("click",function(e){document.body.removeChild(o),h=void 0}),r.appendChild(s),o.appendChild(r),(a=document.createElement("div")).style.overflow="auto",a.style.maxHeight=n-46+"px",0==e.length?(a.innerHTML="Headings you add to the document will appear here",a.style.color="#9298a1",a.style.textAlign="center",a.style.padding="0px 20px 20px 20px",a.style.fontSize="16px",a.style.fontFamily="Arial",a.style.fontStyle="italic"):(a.style.padding="0px 0px 20px 0px",e.forEach(function(n){var e=document.createElement("div");e.innerHTML=n.label,e.style.color="#21252b",e.style.fontSize="16px",e.style.fontFamily="Arial",e.style.cursor="pointer","h1"==n.level?(e.style.margin="4px 0px 0px 0px",e.style.padding="5px 10px 5px 10px",e.style.fontWeight="bold"):"h2"==n.level?e.style.padding="5px 10px 5px 30px":e.style.padding="5px 10px 5px 44px",e.addEventListener("mouseover",function(e){this.style.color="#30b7e8",this.style.backgroundColor="#f7f7f7"}),e.addEventListener("mouseout",function(e){this.style.color="#21252b",this.style.backgroundColor="#ffffff"}),e.addEventListener("click",function(e){var t=i.GetNodeById(n.idTarget).GetFirstTextNode();t.domElement.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),t.SetFocus(),document.body.removeChild(o),h=void 0}),a.appendChild(e)})),o.appendChild(a),document.body.appendChild(o),h=o,l.ShowPnl(o,parseInt(t),parseInt(n)))}},{key:"ShowPnl",value:function(e,t,n){var i=parseInt(e.style.width.replace("px","")),o=parseInt(e.style.height.replace("px","")),r=!0;i<t&&(r=!1,i+=parseInt(t/10),t<i&&(i=t,r=!0)),o<n&&(r=!1,o+=parseInt(n/10),n<o&&(o=n,r=!0));o=parseFloat(e.style.opacity);1<(o+=.1)&&(o=1),e.style.width=i+"px",e.style.opacity=o,r||setTimeout(function(){l.ShowPnl(e,t,n)},20)}}]),l}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r;window,e.exports=(r={},o.m=i=[function(e,Se,_e){(function(e){var r,u,h,s,a,n,T,b,C,l,c,d,o,t,i,f,p,g,m,v,y,x,w,S,_,E,k,A,O,N,P,F,M,D,R,I,L,j,B,G,H,z,Y,U,W,X=X||{version:"4.1.0"};function V(e,t){this.__eventListeners[e]&&(e=this.__eventListeners[e],t?e[e.indexOf(t)]=!1:X.util.array.fill(e,!1))}function q(e,t,n,i,o,r,s){var a=Math.PI,l=s*a/180,c=X.util.sin(l),u=X.util.cos(l),h=0,d=0,f=-u*e*.5-c*t*.5,p=-u*t*.5+c*e*.5,g=(n=Math.abs(n))*n,m=(i=Math.abs(i))*i,v=p*p,y=f*f,b=g*m-g*v-m*y,s=0;b<0?(n*=l=Math.sqrt(1-b/(g*m)),i*=l):s=(o===r?-1:1)*Math.sqrt(b/(g*v+m*y));var y=s*n*p/i,s=-s*i*f/n,C=u*y-c*s+.5*e,x=c*y+u*s+.5*t,w=K(1,0,(f-y)/n,(p-s)/i),s=K((f-y)/n,(p-s)/i,(-f-y)/n,(-p-s)/i);0===r&&0<s?s-=2*a:1===r&&s<0&&(s+=2*a);for(var S,_,E,T,k,A,O,N,P,F,M,D,R,I,L,j,B,G=Math.ceil(Math.abs(s/a*2)),H=[],z=s/G,Y=8/3*Math.sin(z/4)*Math.sin(z/4)/Math.sin(z/2),U=w+z,W=0;W<G;W++)H[W]=(S=w,_=U,E=u,T=c,k=n,A=i,O=C,N=x,P=Y,F=h,M=d,0,D=X.util.cos(S),["C",F+P*(-E*k*(R=X.util.sin(S))-T*A*D),M+P*(-T*k*R+E*A*D),(j=E*k*(I=X.util.cos(_))-T*A*(L=X.util.sin(_))+O)+P*(E*k*L+T*A*I),(B=T*k*I+E*A*L+N)+P*(T*k*L-E*A*I),j,B]),h=H[W][5],d=H[W][6],w=U,U+=z;return H}function K(e,t,n,i){e=Math.atan2(t,e),n=Math.atan2(i,n);return e<=n?n-e:2*Math.PI-(e-n)}function J(e,t,n,i,o,r,s,a){var l;if(X.cachesBoundsOfCurve&&(l=T.call(arguments),X.boundsOfCurveCache[l]))return X.boundsOfCurveCache[l];for(var c,u,h,d=Math.sqrt,f=Math.min,p=Math.max,g=Math.abs,m=[],v=[[],[]],y=6*e-12*n+6*o,b=-3*e+9*n-9*o+3*s,C=3*n-3*e,x=0;x<2;++x)if(0<x&&(y=6*t-12*i+6*r,b=-3*t+9*i-9*r+3*a,C=3*i-3*t),g(b)<1e-12){if(g(y)<1e-12)continue;0<(c=-C/y)&&c<1&&m.push(c)}else(u=y*y-4*C*b)<0||(0<(u=(-y+(h=d(u)))/(2*b))&&u<1&&m.push(u),0<(h=(-y-h)/(2*b))&&h<1&&m.push(h));for(var w,S,_=m.length,E=_;_--;)w=(S=1-(c=m[_]))*S*S*e+3*S*S*c*n+3*S*c*c*o+c*c*c*s,v[0][_]=w,S=S*S*S*t+3*S*S*c*i+3*S*c*c*r+c*c*c*a,v[1][_]=S;v[0][E]=e,v[1][E]=t,v[0][E+1]=s,v[1][E+1]=a;p=[{x:f.apply(null,v[0]),y:f.apply(null,v[1])},{x:p.apply(null,v[0]),y:p.apply(null,v[1])}];return X.cachesBoundsOfCurve&&(X.boundsOfCurveCache[l]=p),p}function $(e,t,n){for(var i=n[1],o=n[2],r=n[3],s=n[4],a=n[5],l=q(n[6]-e,n[7]-t,i,o,s,a,r),c=0,u=l.length;c<u;c++)l[c][1]+=e,l[c][2]+=t,l[c][3]+=e,l[c][4]+=t,l[c][5]+=e,l[c][6]+=t;return l}function Z(e,t,n,i){return Math.sqrt((n-e)*(n-e)+(i-t)*(i-t))}function Q(o,r,s,a,l,c,u,h){return function(e){var t=e*e*e,n=3*e*e*(1-e),i=3*e*(1-e)*(1-e),e=(1-e)*(1-e)*(1-e);return{x:u*t+l*n+s*i+o*e,y:h*t+c*n+a*i+r*e}}}function ee(i,o,r,s,a,l){return function(e){var t=e*e,n=2*e*(1-e),e=(1-e)*(1-e);return{x:a*t+r*n+i*e,y:l*t+s*n+o*e}}}function te(e,t,n){for(var i,o={x:t,y:n},r=0,s=.01;s<=1;s+=.01)i=e(s),r+=Z(o.x,o.y,i.x,i.y),o=i;return r}function ne(e){for(var t,n,i,o=0,r=e.length,s=0,a=0,l=0,c=0,u=[],h=0;h<r;h++){switch(i={x:s,y:a,command:(t=e[h])[0]},t[0]){case"M":i.length=0,l=s=t[1],c=a=t[2];break;case"L":i.length=Z(s,a,t[1],t[2]),s=t[1],a=t[2];break;case"C":n=Q(s,a,t[1],t[2],t[3],t[4],t[5],t[6]),i.length=te(n,s,a),s=t[5],a=t[6];break;case"Q":n=ee(s,a,t[1],t[2],t[3],t[4]),i.length=te(n,s,a),s=t[3],a=t[4];break;case"Z":case"z":i.destX=l,i.destY=c,i.length=Z(s,a,l,c),s=l,a=c}o+=i.length,u.push(i)}return u.push({length:o,x:s,y:a}),u}function ie(e,t,n){if(e&&0!==e.length){var i=e.length-1,o=t?e[i][t]:e[i];if(t)for(;i--;)n(e[i][t],o)&&(o=e[i][t]);else for(;i--;)n(e[i],o)&&(o=e[i]);return o}}function oe(e,t,n){if(n)if(!X.isLikelyNode&&t instanceof Element)e=t;else if(t instanceof Array){e=[];for(var i=0,o=t.length;i<o;i++)e[i]=oe({},t[i],n)}else if(t&&"object"==typeof t)for(var r in t)"canvas"===r||"group"===r?e[r]=null:t.hasOwnProperty(r)&&(e[r]=oe({},t[r],n));else e=t;else for(var r in t)e[r]=t[r];return e}function re(){}function se(){}function ae(e){for(var t=null,n=this;n.constructor.superclass;){var i=n.constructor.superclass.prototype[e];if(n[e]!==i){t=i;break}n=n.constructor.superclass.prototype}return t?1<arguments.length?t.apply(this,c.call(arguments,1)):t.call(this):console.log("tried to callSuper "+e+", method not found in prototype chain",this)}function le(){}function ce(){return!1}function ue(e,t,n,i){return-n*Math.cos(e/i*(Math.PI/2))+n+t}function he(){return p.apply(X.window,arguments)}function de(e,t,n){var i="rgba("+parseInt(e[0]+n*(t[0]-e[0]),10)+","+parseInt(e[1]+n*(t[1]-e[1]),10)+","+parseInt(e[2]+n*(t[2]-e[2]),10);return(i+=","+(e&&t?parseFloat(e[3]+n*(t[3]-e[3])):1))+")"}function fe(e,t,n,i){return i=e<Math.abs(t)?(e=t,n/4):0===t&&0===e?n/(2*Math.PI)*Math.asin(1):n/(2*Math.PI)*Math.asin(t/e),{a:e,c:t,p:n,s:i}}function pe(e,t,n){return e.a*Math.pow(2,10*--t)*Math.sin((t*n-e.s)*(2*Math.PI)/e.p)}function ge(e,t,n,i){return n-me(i-e,0,n,i)+t}function me(e,t,n,i){return(e/=i)<1/2.75?n*(7.5625*e*e)+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t}function ve(e,t){return e.button&&e.button===t-1}function ye(e,t){if(t){if(t.toLive)return e+": url(#SVGID_"+t.id+"); ";var n=new X.Color(t),t=e+": "+n.toRgb()+"; ",n=n.getAlpha();return 1!==n&&(t+=e+"-opacity: "+n.toString()+"; "),t}return e+": none; "}function be(t,e,n){var i={};n.forEach(function(e){i[e]=t[e]}),M(t[e],i,!0)}function Ce(e,t){var n=e.canvas,i=t.targetCanvas,e=i.getContext("2d");e.translate(0,i.height),e.scale(1,-1);t=n.height-i.height;e.drawImage(n,0,t,i.width,i.height,0,0,i.width,i.height)}function xe(e,t){var n=t.targetCanvas.getContext("2d"),i=t.destinationWidth,o=t.destinationHeight,r=i*o*4,t=new Uint8Array(this.imageBuffer,0,r),r=new Uint8ClampedArray(this.imageBuffer,0,r);e.readPixels(0,0,i,o,e.RGBA,e.UNSIGNED_BYTE,t);o=new ImageData(r,i,o);n.putImageData(o,0,0)}function we(e){e.textDecoration&&(-1<e.textDecoration.indexOf("underline")&&(e.underline=!0),-1<e.textDecoration.indexOf("line-through")&&(e.linethrough=!0),-1<e.textDecoration.indexOf("overline")&&(e.overline=!0),delete e.textDecoration)}Se.fabric=X,"undefined"!=typeof document&&"undefined"!=typeof window?(document instanceof("undefined"!=typeof HTMLDocument?HTMLDocument:Document)?X.document=document:X.document=document.implementation.createHTMLDocument(""),X.window=window):(H=new(_e(6).JSDOM)(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window,X.document=H.document,X.jsdomImplForWrapper=_e(7).implForWrapper,X.nodeCanvas=_e(8).Canvas,X.window=H,DOMParser=X.window.DOMParser),X.isTouchSupported="ontouchstart"in X.window||"ontouchstart"in X.document||X.window&&X.window.navigator&&0<X.window.navigator.maxTouchPoints,X.isLikelyNode=void 0!==e&&"undefined"==typeof window,X.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],X.DPI=96,X.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",X.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,X.reNonWord=/[ \n\.,;!\?\-]/,X.fontPaths={},X.iMatrix=[1,0,0,1,0,0],X.svgNS="http://www.w3.org/2000/svg",X.perfLimitSizeTotal=2097152,X.maxCacheSideLimit=4096,X.minCacheSideLimit=256,X.charWidthsCache={},X.textureSize=2048,X.disableStyleCopyPaste=!1,X.enableGLFiltering=!0,X.devicePixelRatio=X.window.devicePixelRatio||X.window.webkitDevicePixelRatio||X.window.mozDevicePixelRatio||1,X.browserShadowBlurConstant=1,X.arcToSegmentsCache={},X.boundsOfCurveCache={},X.cachesBoundsOfCurve=!0,X.forceGLPutImageData=!1,X.initFilterBackend=function(){return X.enableGLFiltering&&X.isWebglSupported&&X.isWebglSupported(X.textureSize)?(console.log("max texture size: "+X.maxTextureSize),new X.WebglFilterBackend({tileSize:X.textureSize})):X.Canvas2dFilterBackend?new X.Canvas2dFilterBackend:void 0},"undefined"!=typeof document&&"undefined"!=typeof window&&(window.fabric=X),X.Observable={fire:function(e,t){if(!this.__eventListeners)return this;var n=this.__eventListeners[e];if(!n)return this;for(var i=0,o=n.length;i<o;i++)n[i]&&n[i].call(this,t||{});return this.__eventListeners[e]=n.filter(function(e){return!1!==e}),this},on:function(e,t){if(this.__eventListeners||(this.__eventListeners={}),1===arguments.length)for(var n in e)this.on(n,e[n]);else this.__eventListeners[e]||(this.__eventListeners[e]=[]),this.__eventListeners[e].push(t);return this},off:function(e,t){if(!this.__eventListeners)return this;if(0===arguments.length)for(e in this.__eventListeners)V.call(this,e);else if(1===arguments.length&&"object"==typeof e)for(var n in e)V.call(this,n,e[n]);else V.call(this,e,t);return this}},X.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var e=0,t=arguments.length;e<t;e++)this._onObjectAdded(arguments[e]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(e,t,n){var i=this._objects;return n?i[t]=e:i.splice(t,0,e),this._onObjectAdded&&this._onObjectAdded(e),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var e,t=this._objects,n=!1,i=0,o=arguments.length;i<o;i++)-1!==(e=t.indexOf(arguments[i]))&&(n=!0,t.splice(e,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[i]));return this.renderOnAddRemove&&n&&this.requestRenderAll(),this},forEachObject:function(e,t){for(var n=this.getObjects(),i=0,o=n.length;i<o;i++)e.call(t,n[i],i,n);return this},getObjects:function(t){return void 0===t?this._objects.concat():this._objects.filter(function(e){return e.type===t})},item:function(e){return this._objects[e]},isEmpty:function(){return 0===this._objects.length},size:function(){return this._objects.length},contains:function(e){return-1<this._objects.indexOf(e)},complexity:function(){return this._objects.reduce(function(e,t){return e+(t.complexity?t.complexity():0)},0)}},X.CommonMethods={_setOptions:function(e){for(var t in e)this.set(t,e[t])},_initGradient:function(e,t){!e||!e.colorStops||e instanceof X.Gradient||this.set(t,new X.Gradient(e))},_initPattern:function(e,t,n){!e||!e.source||e instanceof X.Pattern?n&&n():this.set(t,new X.Pattern(e,n))},_setObject:function(e){for(var t in e)this._set(t,e[t])},set:function(e,t){return"object"==typeof e?this._setObject(e):this._set(e,t),this},_set:function(e,t){this[e]=t},toggle:function(e){var t=this.get(e);return"boolean"==typeof t&&this.set(e,!t),this},get:function(e){return this[e]}},r=Se,u=Math.sqrt,h=Math.atan2,s=Math.pow,a=Math.PI/180,n=Math.PI/2,X.util={cos:function(e){if(0===e)return 1;switch(e<0&&(e=-e),e/n){case 1:case 3:return 0;case 2:return-1}return Math.cos(e)},sin:function(e){if(0===e)return 0;var t=e<0?-1:1;switch(e/n){case 1:return t;case 2:return 0;case 3:return-t}return Math.sin(e)},removeFromArray:function(e,t){t=e.indexOf(t);return-1!==t&&e.splice(t,1),e},getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},degreesToRadians:function(e){return e*a},radiansToDegrees:function(e){return e/a},rotatePoint:function(e,t,n){e.subtractEquals(t);n=X.util.rotateVector(e,n);return new X.Point(n.x,n.y).addEquals(t)},rotateVector:function(e,t){var n=X.util.sin(t),t=X.util.cos(t);return{x:e.x*t-e.y*n,y:e.x*n+e.y*t}},transformPoint:function(e,t,n){return n?new X.Point(t[0]*e.x+t[2]*e.y,t[1]*e.x+t[3]*e.y):new X.Point(t[0]*e.x+t[2]*e.y+t[4],t[1]*e.x+t[3]*e.y+t[5])},makeBoundingBoxFromPoints:function(e,t){if(t)for(var n=0;n<e.length;n++)e[n]=X.util.transformPoint(e[n],t);var i=[e[0].x,e[1].x,e[2].x,e[3].x],o=X.util.array.min(i),r=X.util.array.max(i)-o,s=[e[0].y,e[1].y,e[2].y,e[3].y],i=X.util.array.min(s);return{left:o,top:i,width:r,height:X.util.array.max(s)-i}},invertTransform:function(e){var t=1/(e[0]*e[3]-e[1]*e[2]),t=[t*e[3],-t*e[1],-t*e[2],t*e[0]],e=X.util.transformPoint({x:e[4],y:e[5]},t,!0);return t[4]=-e.x,t[5]=-e.y,t},toFixed:function(e,t){return parseFloat(Number(e).toFixed(t))},parseUnit:function(e,t){var n=/\D{0,2}$/.exec(e),i=parseFloat(e);switch(t=t||X.Text.DEFAULT_SVG_FONT_SIZE,n[0]){case"mm":return i*X.DPI/25.4;case"cm":return i*X.DPI/2.54;case"in":return i*X.DPI;case"pt":return i*X.DPI/72;case"pc":return i*X.DPI/72*12;case"em":return i*t;default:return i}},falseFunction:function(){return!1},getKlass:function(e,t){return e=X.util.string.camelize(e.charAt(0).toUpperCase()+e.slice(1)),X.util.resolveNamespace(t)[e]},getSvgAttributes:function(e){var t=["instantiated_by_use","style","id","class"];switch(e){case"linearGradient":t=t.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":t=t.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":t=t.concat(["offset","stop-color","stop-opacity"])}return t},resolveNamespace:function(e){if(!e)return X;for(var t=e.split("."),n=t.length,i=r||X.window,o=0;o<n;++o)i=i[t[o]];return i},loadImage:function(e,t,n,i){var o,r;e?(r=function(){t&&t.call(n,o,!1),o=o.onload=o.onerror=null},(o=X.util.createImage()).onload=r,o.onerror=function(){X.log("Error loading "+o.src),t&&t.call(n,null,!0),o=o.onload=o.onerror=null},0!==e.indexOf("data")&&null!=i&&(o.crossOrigin=i),"data:image/svg"===e.substring(0,14)&&(o.onload=null,X.util.loadImageInDom(o,r)),o.src=e):t&&t.call(n,e)},loadImageInDom:function(e,t){var n=X.document.createElement("div");n.style.width=n.style.height="1px",n.style.left=n.style.top="-100%",n.style.position="absolute",n.appendChild(e),X.document.querySelector("body").appendChild(n),e.onload=function(){t(),n.parentNode.removeChild(n),n=null}},enlivenObjects:function(e,t,o,r){var s=[],n=0,i=(e=e||[]).length;function a(){++n===i&&t&&t(s.filter(function(e){return e}))}i?e.forEach(function(n,i){n&&n.type?X.util.getKlass(n.type,o).fromObject(n,function(e,t){t||(s[i]=e),r&&r(n,e,t),a()}):a()}):t&&t(s)},enlivenPatterns:function(e,t){function n(){++o===r&&t&&t(i)}var i=[],o=0,r=(e=e||[]).length;r?e.forEach(function(e,t){e&&e.source?new X.Pattern(e,function(e){i[t]=e,n()}):(i[t]=e,n())}):t&&t(i)},groupSVGElements:function(e,t,n){return e&&1===e.length?e[0]:(t&&(t.width&&t.height?t.centerPoint={x:t.width/2,y:t.height/2}:(delete t.width,delete t.height)),t=new X.Group(e,t),void 0!==n&&(t.sourcePath=n),t)},populateWithProperties:function(e,t,n){if(n&&"[object Array]"===Object.prototype.toString.call(n))for(var i=0,o=n.length;i<o;i++)n[i]in e&&(t[n[i]]=e[n[i]])},drawDashedLine:function(e,t,n,i,o,r){var i=i-t,o=o-n,s=u(i*i+o*o),i=h(o,i),a=r.length,l=0,c=!0;for(e.save(),e.translate(t,n),e.moveTo(0,0),e.rotate(i),t=0;t<s;)s<(t+=r[l++%a])&&(t=s),e[c?"lineTo":"moveTo"](t,0),c=!c;e.restore()},createCanvasElement:function(){return X.document.createElement("canvas")},copyCanvasElement:function(e){var t=X.util.createCanvasElement();return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t},toDataURL:function(e,t,n){return e.toDataURL("image/"+t,n)},createImage:function(){return X.document.createElement("img")},multiplyTransformMatrices:function(e,t,n){return[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],n?0:e[0]*t[4]+e[2]*t[5]+e[4],n?0:e[1]*t[4]+e[3]*t[5]+e[5]]},qrDecompose:function(e){var t=h(e[1],e[0]),n=s(e[0],2)+s(e[1],2),i=u(n),o=(e[0]*e[3]-e[2]*e[1])/i,n=h(e[0]*e[2]+e[1]*e[3],n);return{angle:t/a,scaleX:i,scaleY:o,skewX:n/a,skewY:0,translateX:e[4],translateY:e[5]}},calcRotateMatrix:function(e){if(!e.angle)return X.iMatrix.concat();var t=X.util.degreesToRadians(e.angle),e=X.util.cos(t),t=X.util.sin(t);return[e,t,-t,e,0,0]},calcDimensionsMatrix:function(e){var t=void 0===e.scaleX?1:e.scaleX,n=void 0===e.scaleY?1:e.scaleY,i=[e.flipX?-t:t,0,0,e.flipY?-n:n,0,0],t=X.util.multiplyTransformMatrices,n=X.util.degreesToRadians;return e.skewX&&(i=t(i,[1,0,Math.tan(n(e.skewX)),1],!0)),e.skewY&&(i=t(i,[1,Math.tan(n(e.skewY)),0,1],!0)),i},composeMatrix:function(e){var t=[1,0,0,1,e.translateX||0,e.translateY||0],n=X.util.multiplyTransformMatrices;return e.angle&&(t=n(t,X.util.calcRotateMatrix(e))),(1!==e.scaleX||1!==e.scaleY||e.skewX||e.skewY||e.flipX||e.flipY)&&(t=n(t,X.util.calcDimensionsMatrix(e))),t},resetObjectTransform:function(e){e.scaleX=1,e.scaleY=1,e.skewX=0,e.skewY=0,e.flipX=!1,e.flipY=!1,e.rotate(0)},saveObjectTransform:function(e){return{scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,angle:e.angle,left:e.left,flipX:e.flipX,flipY:e.flipY,top:e.top}},isTransparent:function(e,t,n,i){0<i&&(i<t?t-=i:t=0,i<n?n-=i:n=0);for(var o=!0,r=e.getImageData(t,n,2*i||1,2*i||1),s=r.data.length,a=3;a<s&&!1!=(o=r.data[a]<=0);a+=4);return r=null,o},parsePreserveAspectRatioAttribute:function(e){var t,n="meet",e=e.split(" ");return e&&e.length&&("meet"!==(n=e.pop())&&"slice"!==n?(t=n,n="meet"):e.length&&(t=e.pop())),{meetOrSlice:n,alignX:"none"!==t?t.slice(1,4):"none",alignY:"none"!==t?t.slice(5,8):"none"}},clearFabricFontCache:function(e){(e=(e||"").toLowerCase())?X.charWidthsCache[e]&&delete X.charWidthsCache[e]:X.charWidthsCache={}},limitDimsByArea:function(e,t){e=Math.sqrt(t*e),t=Math.floor(t/e);return{x:Math.floor(e),y:t}},capValue:function(e,t,n){return Math.max(e,Math.min(t,n))},findScaleToFit:function(e,t){return Math.min(t.width/e.width,t.height/e.height)},findScaleToCover:function(e,t){return Math.max(t.width/e.width,t.height/e.height)},matrixToSVG:function(e){return"matrix("+e.map(function(e){return X.util.toFixed(e,X.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},sizeAfterTransform:function(e,t,n){e/=2,t/=2,t=[{x:-e,y:-t},{x:e,y:-t},{x:-e,y:t},{x:e,y:t}],n=X.util.calcDimensionsMatrix(n),n=X.util.makeBoundingBoxFromPoints(t,n);return{x:n.width,y:n.height}}},T=Array.prototype.join,b={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},C={m:"l",M:"L"},X.util.parsePath=function(e){var t,n,i,o,r,s=[],a=[],l=X.rePathCommand;if(!e||!e.match)return s;for(var c,u=0,h=(r=e.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;u<h;u++){for(o=(t=r[u]).slice(1).trim(),a.length=0;i=l.exec(o);)a.push(i[0]);c=[t.charAt(0)];for(var d=0,f=a.length;d<f;d++)n=parseFloat(a[d]),isNaN(n)||c.push(n);var p=c[0],g=b[p.toLowerCase()],m=C[p]||p;if(c.length-1>g)for(var v=1,y=c.length;v<y;v+=g)s.push([p].concat(c.slice(v,v+g))),p=m;else s.push(c)}return s},X.util.makePathSimpler=function(e){for(var t,n,i,o,r,s=0,a=0,l=e.length,c=0,u=0,h=[],d=0;d<l;++d){switch(n=!1,(t=e[d].slice(0))[0]){case"l":t[0]="L",t[1]+=s,t[2]+=a;case"L":s=t[1],a=t[2];break;case"h":t[1]+=s;case"H":t[0]="L",t[2]=a,s=t[1];break;case"v":t[1]+=a;case"V":t[0]="L",a=t[1],t[1]=s,t[2]=a;break;case"m":t[0]="M",t[1]+=s,t[2]+=a;case"M":s=t[1],a=t[2],c=t[1],u=t[2];break;case"c":t[0]="C",t[1]+=s,t[2]+=a,t[3]+=s,t[4]+=a,t[5]+=s,t[6]+=a;case"C":o=t[3],r=t[4],s=t[5],a=t[6];break;case"s":t[0]="S",t[1]+=s,t[2]+=a,t[3]+=s,t[4]+=a;case"S":r="C"===i?(o=2*s-o,2*a-r):(o=s,a),s=t[3],a=t[4],t[0]="C",t[5]=t[3],t[6]=t[4],t[3]=t[1],t[4]=t[2],t[1]=o,t[2]=r,o=t[3],r=t[4];break;case"q":t[0]="Q",t[1]+=s,t[2]+=a,t[3]+=s,t[4]+=a;case"Q":o=t[1],r=t[2],s=t[3],a=t[4];break;case"t":t[0]="T",t[1]+=s,t[2]+=a;case"T":r="Q"===i?(o=2*s-o,2*a-r):(o=s,a),t[0]="Q",s=t[1],a=t[2],t[1]=o,t[2]=r,t[3]=s,t[4]=a;break;case"a":t[0]="A",t[6]+=s,t[7]+=a;case"A":n=!0,h=h.concat($(s,a,t)),s=t[6],a=t[7];break;case"z":case"Z":s=c,a=u}n||h.push(t),i=t[0]}return h},X.util.getPathSegmentsInfo=ne,X.util.fromArcToBeizers=$,X.util.getBoundsOfCurve=J,X.util.getPointOnPath=function(e,t,n){for(var i=(n=n||ne(e))[n.length-1]*t,o=0;0<i-n[o]&&o<n.length;)i-=n[o],o++;var r=n[o],s=i/r.length,t=r.length,a=e[o];switch(t){case"Z":case"z":return new X.Point(r.x,r.y).lerp(new X.Point(r.destX,r.destY),s);case"L":return new X.Point(r.x,r.y).lerp(new X.Point(a[1],a[2]),s);case"C":return Q(r.x,r.y,a[1],a[2],a[3],a[4],a[5],a[6])(s);case"Q":return ee(r.x,r.y,a[1],a[2],a[3],a[4])(s)}},X.util.getBoundsOfArc=function(e,t,n,i,o,r,s,a,l){for(var c,u=0,h=0,d=[],f=q(a-e,l-t,n,i,r,s,o),p=0,g=f.length;p<g;p++)c=J(u,h,f[p][1],f[p][2],f[p][3],f[p][4],f[p][5],f[p][6]),d.push({x:c[0].x+e,y:c[0].y+t}),d.push({x:c[1].x+e,y:c[1].y+t}),u=f[p][5],h=f[p][6];return d},X.util.drawArc=function(t,e,n,i){$(e,n,i=i.slice(0).unshift("X")).forEach(function(e){t.bezierCurveTo.apply(t,e.slice(1))})},l=Array.prototype.slice,X.util.array={fill:function(e,t){for(var n=e.length;n--;)e[n]=t;return e},invoke:function(e,t){for(var n=l.call(arguments,2),i=[],o=0,r=e.length;o<r;o++)i[o]=n.length?e[o][t].apply(e[o],n):e[o][t].call(e[o]);return i},min:function(e,t){return ie(e,t,function(e,t){return e<t})},max:function(e,t){return ie(e,t,function(e,t){return t<=e})}},X.util.object={extend:oe,clone:function(e,t){return oe({},e,t)}},X.util.object.extend(X.util,X.Observable),X.util.string={camelize:function(e){return e.replace(/-+(.)?/g,function(e,t){return t?t.toUpperCase():""})},capitalize:function(e,t){return e.charAt(0).toUpperCase()+(t?e.slice(1):e.slice(1).toLowerCase())},escapeXml:function(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(e){for(var t,n=0,i=[],n=0;n<e.length;n++)!1!==(t=function(e,t){var n=e.charCodeAt(t);if(isNaN(n))return"";if(n<55296||57343<n)return e.charAt(t);if(55296<=n&&n<=56319){if(e.length<=t+1)throw"High surrogate without following low surrogate";n=e.charCodeAt(t+1);if(n<56320||57343<n)throw"High surrogate without following low surrogate";return e.charAt(t)+e.charAt(t+1)}if(0===t)throw"Low surrogate without preceding high surrogate";t=e.charCodeAt(t-1);if(t<55296||56319<t)throw"Low surrogate without preceding high surrogate";return!1}(e,n))&&i.push(t);return i}},c=Array.prototype.slice,d=function(){for(var e in{toString:1})if("toString"===e)return!1;return!0}(),X.util.createClass=function(){var e=null,t=c.call(arguments,0);function n(){this.initialize.apply(this,arguments)}"function"==typeof t[0]&&(e=t.shift()),n.superclass=e,n.subclasses=[],e&&(se.prototype=e.prototype,n.prototype=new se,e.subclasses.push(n));for(var i=0,o=t.length;i<o;i++)!function(e,i,o){for(var t in i)t in e.prototype&&"function"==typeof e.prototype[t]&&-1<(i[t]+"").indexOf("callSuper")?e.prototype[t]=function(n){return function(){var e=this.constructor.superclass;this.constructor.superclass=o;var t=i[n].apply(this,arguments);if(this.constructor.superclass=e,"initialize"!==n)return t}}(t):e.prototype[t]=i[t],d&&(i.toString!==Object.prototype.toString&&(e.prototype.toString=i.toString),i.valueOf!==Object.prototype.valueOf&&(e.prototype.valueOf=i.valueOf))}(n,t[i],e);return n.prototype.initialize||(n.prototype.initialize=re),(n.prototype.constructor=n).prototype.callSuper=ae,n},o=!!X.document.createElement("div").attachEvent,t=["touchstart","touchmove","touchend"],X.util.addListener=function(e,t,n,i){e&&e.addEventListener(t,n,!o&&i)},X.util.removeListener=function(e,t,n,i){e&&e.removeEventListener(t,n,!o&&i)},X.util.getPointer=function(e){var t=e.target,n=X.util.getScrollLeftTop(t),e=(t=e.changedTouches)&&t[0]?t[0]:e;return{x:e.clientX+n.left,y:e.clientY+n.top}},X.util.isTouchEvent=function(e){return-1<t.indexOf(e.type)||"touch"===e.pointerType},Y="string"==typeof(z=X.document.createElement("div")).style.opacity,U="string"==typeof z.style.filter,i=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,f=function(e){return e},Y?f=function(e,t){return e.style.opacity=t,e}:U&&(f=function(e,t){var n=e.style;return e.currentStyle&&!e.currentStyle.hasLayout&&(n.zoom=1),i.test(n.filter)?(t=.9999<=t?"":"alpha(opacity="+100*t+")",n.filter=n.filter.replace(i,t)):n.filter+=" alpha(opacity="+100*t+")",e}),X.util.setStyle=function(e,t){var n,i=e.style;if(!i)return e;if("string"==typeof t)return e.style.cssText+=";"+t,-1<t.indexOf("opacity")?f(e,t.match(/opacity:\s*(\d?\.?\d*)/)[1]):e;for(n in t)"opacity"===n?f(e,t[n]):i["float"===n||"cssFloat"===n?void 0===i.styleFloat?"cssFloat":"styleFloat":n]=t[n];return e},function(){var e,a,t,n,i=Array.prototype.slice,o=function(e){return i.call(e,0)};try{e=o(X.document.childNodes)instanceof Array}catch(e){}function r(e,t){var n,i=X.document.createElement(e);for(n in t)"class"===n?i.className=t[n]:"for"===n?i.htmlFor=t[n]:i.setAttribute(n,t[n]);return i}function l(e){for(var t=0,n=0,i=X.document.documentElement,o=X.document.body||{scrollLeft:0,scrollTop:0};e&&(e.parentNode||e.host)&&((e=e.parentNode||e.host)===X.document?(t=o.scrollLeft||i.scrollLeft||0,n=o.scrollTop||i.scrollTop||0):(t+=e.scrollLeft||0,n+=e.scrollTop||0),1!==e.nodeType||"fixed"!==e.style.position););return{left:t,top:n}}e||(o=function(e){for(var t=new Array(e.length),n=e.length;n--;)t[n]=e[n];return t}),a=X.document.defaultView&&X.document.defaultView.getComputedStyle?function(e,t){e=X.document.defaultView.getComputedStyle(e,null);return e?e[t]:void 0}:function(e,t){var n=e.style[t];return!n&&e.currentStyle&&(n=e.currentStyle[t]),n},t=X.document.documentElement.style,n="userSelect"in t?"userSelect":"MozUserSelect"in t?"MozUserSelect":"WebkitUserSelect"in t?"WebkitUserSelect":"KhtmlUserSelect"in t?"KhtmlUserSelect":"",X.util.makeElementUnselectable=function(e){return void 0!==e.onselectstart&&(e.onselectstart=X.util.falseFunction),n?e.style[n]="none":"string"==typeof e.unselectable&&(e.unselectable="on"),e},X.util.makeElementSelectable=function(e){return void 0!==e.onselectstart&&(e.onselectstart=null),n?e.style[n]="":"string"==typeof e.unselectable&&(e.unselectable=""),e},X.util.setImageSmoothing=function(e,t){e.imageSmoothingEnabled=e.imageSmoothingEnabled||e.webkitImageSmoothingEnabled||e.mozImageSmoothingEnabled||e.msImageSmoothingEnabled||e.oImageSmoothingEnabled,e.imageSmoothingEnabled=t},X.util.getById=function(e){return"string"==typeof e?X.document.getElementById(e):e},X.util.toArray=o,X.util.addClass=function(e,t){e&&-1===(" "+e.className+" ").indexOf(" "+t+" ")&&(e.className+=(e.className?" ":"")+t)},X.util.makeElement=r,X.util.wrapElement=function(e,t,n){return"string"==typeof t&&(t=r(t,n)),e.parentNode&&e.parentNode.replaceChild(t,e),t.appendChild(e),t},X.util.getScrollLeftTop=l,X.util.getElementOffset=function(e){var t,n,i=e&&e.ownerDocument,o={left:0,top:0},r={left:0,top:0},s={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!i)return r;for(n in s)r[s[n]]+=parseInt(a(e,n),10)||0;return t=i.documentElement,void 0!==e.getBoundingClientRect&&(o=e.getBoundingClientRect()),i=l(e),{left:o.left+i.left-(t.clientLeft||0)+r.left,top:o.top+i.top-(t.clientTop||0)+r.top}},X.util.getNodeCanvas=function(e){e=X.jsdomImplForWrapper(e);return e._canvas||e._image},X.util.cleanUpJsdomNode=function(e){!X.isLikelyNode||(e=X.jsdomImplForWrapper(e))&&(e._image=null,e._canvas=null,e._currentSrc=null,e._attributes=null,e._classList=null)}}(),X.util.request=function(e,t){var n=(t=t||{}).method?t.method.toUpperCase():"GET",i=t.onComplete||function(){},o=new X.window.XMLHttpRequest,r=t.body||t.parameters;return o.onreadystatechange=function(){4===o.readyState&&(i(o),o.onreadystatechange=le)},"GET"===n&&(r=null,"string"==typeof t.parameters&&(t=t.parameters,e=e+(/\?/.test(e)?"&":"?")+t)),o.open(n,e,!0),"POST"!==n&&"PUT"!==n||o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(r),o},X.log=console.log,X.warn=console.warn,p=X.window.requestAnimationFrame||X.window.webkitRequestAnimationFrame||X.window.mozRequestAnimationFrame||X.window.oRequestAnimationFrame||X.window.msRequestAnimationFrame||function(e){return X.window.setTimeout(e,1e3/60)},g=X.window.cancelAnimationFrame||X.window.clearTimeout,X.util.animate=function(t){he(function(e){t=t||{};var o,r=e||+new Date,s=t.duration||500,a=r+s,l=t.onChange||ce,c=t.abort||ce,u=t.onComplete||ce,h=t.easing||ue,d="startValue"in t?t.startValue:0,f="endValue"in t?t.endValue:100,p=t.byValue||f-d;t.onStart&&t.onStart(),function e(t){o=t||+new Date;var n=a<o?s:o-r,i=n/s,t=h(n,d,p,s),n=Math.abs((t-d)/p);if(!c())return a<o?(l(f,1,1),void u(f,1,1)):(l(t,n,i),void he(e));u(f,1,1)}(r)})},X.util.requestAnimFrame=he,X.util.cancelAnimFrame=function(){return g.apply(X.window,arguments)},X.util.animateColor=function(e,t,n,o){var e=new X.Color(e).getSource(),i=new X.Color(t).getSource(),r=o.onComplete,s=o.onChange;o=o||{},X.util.animate(X.util.object.extend(o,{duration:n||500,startValue:e,endValue:i,byValue:i,easing:function(e,t,n,i){return de(t,n,o.colorEasing?o.colorEasing(e,i):1-Math.cos(e/i*(Math.PI/2)))},onComplete:function(e,t,n){if(r)return r(de(i,i,0),t,n)},onChange:function(e,t,n){if(s){if(Array.isArray(e))return s(de(e,e,0),t,n);s(e,t,n)}}}))},X.util.ease={easeInQuad:function(e,t,n,i){return n*(e/=i)*e+t},easeOutQuad:function(e,t,n,i){return-n*(e/=i)*(e-2)+t},easeInOutQuad:function(e,t,n,i){return(e/=i/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,n,i){return n*(e/=i)*e*e+t},easeOutCubic:function(e,t,n,i){return n*((e=e/i-1)*e*e+1)+t},easeInOutCubic:function(e,t,n,i){return(e/=i/2)<1?n/2*e*e*e+t:n/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,n,i){return n*(e/=i)*e*e*e+t},easeOutQuart:function(e,t,n,i){return-n*((e=e/i-1)*e*e*e-1)+t},easeInOutQuart:function(e,t,n,i){return(e/=i/2)<1?n/2*e*e*e*e+t:-n/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,n,i){return n*(e/=i)*e*e*e*e+t},easeOutQuint:function(e,t,n,i){return n*((e=e/i-1)*e*e*e*e+1)+t},easeInOutQuint:function(e,t,n,i){return(e/=i/2)<1?n/2*e*e*e*e*e+t:n/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,n,i){return-n*Math.cos(e/i*(Math.PI/2))+n+t},easeOutSine:function(e,t,n,i){return n*Math.sin(e/i*(Math.PI/2))+t},easeInOutSine:function(e,t,n,i){return-n/2*(Math.cos(Math.PI*e/i)-1)+t},easeInExpo:function(e,t,n,i){return 0===e?t:n*Math.pow(2,10*(e/i-1))+t},easeOutExpo:function(e,t,n,i){return e===i?t+n:n*(1-Math.pow(2,-10*e/i))+t},easeInOutExpo:function(e,t,n,i){return 0===e?t:e===i?t+n:(e/=i/2)<1?n/2*Math.pow(2,10*(e-1))+t:n/2*(2-Math.pow(2,-10*--e))+t},easeInCirc:function(e,t,n,i){return-n*(Math.sqrt(1-(e/=i)*e)-1)+t},easeOutCirc:function(e,t,n,i){return n*Math.sqrt(1-(e=e/i-1)*e)+t},easeInOutCirc:function(e,t,n,i){return(e/=i/2)<1?-n/2*(Math.sqrt(1-e*e)-1)+t:n/2*(Math.sqrt(1-(e-=2)*e)+1)+t},easeInElastic:function(e,t,n,i){return 0===e?t:1==(e/=i)?t+n:-pe(fe(n,n,.3*i),e,i)+t},easeOutElastic:function(e,t,n,i){if(0===e)return t;if(1==(e/=i))return t+n;n=fe(n,n,.3*i);return n.a*Math.pow(2,-10*e)*Math.sin((e*i-n.s)*(2*Math.PI)/n.p)+n.c+t},easeInOutElastic:function(e,t,n,i){if(0===e)return t;if(2==(e/=i/2))return t+n;n=fe(n,n,i*(.3*1.5));return e<1?-.5*pe(n,e,i)+t:n.a*Math.pow(2,-10*--e)*Math.sin((e*i-n.s)*(2*Math.PI)/n.p)*.5+n.c+t},easeInBack:function(e,t,n,i,o){return void 0===o&&(o=1.70158),n*(e/=i)*e*((o+1)*e-o)+t},easeOutBack:function(e,t,n,i,o){return void 0===o&&(o=1.70158),n*((e=e/i-1)*e*((o+1)*e+o)+1)+t},easeInOutBack:function(e,t,n,i,o){return void 0===o&&(o=1.70158),(e/=i/2)<1?n/2*(e*e*((1+(o*=1.525))*e-o))+t:n/2*((e-=2)*e*((1+(o*=1.525))*e+o)+2)+t},easeInBounce:ge,easeOutBounce:me,easeInOutBounce:function(e,t,n,i){return e<i/2?.5*ge(2*e,0,n,i)+t:.5*me(2*e-i,0,n,i)+.5*n+t}},function(){"use strict";var h,e,t,d,n,i,b=Se.fabric||(Se.fabric={}),f=b.util.object.extend,p=b.util.object.clone,g=b.util.toFixed,C=b.util.parseUnit,m=b.util.multiplyTransformMatrices,v={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},y={stroke:"strokeOpacity",fill:"fillOpacity"},x="font-size",w="clip-path";function o(e){return new RegExp("^("+e.join("|")+")\\b","i")}function S(e,t){for(var n,i=[],o=0,r=t.length;o<r;o++)n=t[o],n=e.getElementsByTagName(n),i=i.concat(Array.prototype.slice.call(n));return i}function _(e,t,n){e[n]=Math.tan(b.util.degreesToRadians(t[0]))}function E(e,t){var n,i=e.nodeName,o=e.getAttribute("class"),e=e.getAttribute("id"),r=new RegExp("^"+i,"i");if(t=t.replace(r,""),e&&t.length&&(r=new RegExp("#"+e+"(?![a-zA-Z\\-]+)","i"),t=t.replace(r,"")),o&&t.length)for(n=(o=o.split(" ")).length;n--;)r=new RegExp("\\."+o[n]+"(?![a-zA-Z\\-]+)","i"),t=t.replace(r,"");return 0===t.length}function T(e,t){var n;if(e.getElementById&&(n=e.getElementById(t)),n)return n;for(var i,o=e.getElementsByTagName("*"),r=0,s=o.length;r<s;r++)if(t===(i=o[r]).getAttribute("id"))return i}b.svgValidTagNamesRegEx=o(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),b.svgViewBoxElementsRegEx=o(["symbol","image","marker","pattern","view","svg"]),b.svgInvalidAncestorsRegEx=o(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),b.svgValidParentsRegEx=o(["symbol","g","a","svg","clipPath","defs"]),b.cssRules={},b.gradientDefs={},b.clipPaths={},b.parseTransformAttribute=(h=b.iMatrix,e=b.reNum,d="(?:(?:(matrix)\\s*\\(\\s*("+e+")"+(t="(?:\\s+,?\\s*|,\\s*)")+"("+e+")"+t+"("+e+")"+t+"("+e+")"+t+"("+e+")"+t+"("+e+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+e+")(?:"+t+"("+e+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+e+")(?:"+t+"("+e+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+e+")(?:"+t+"("+e+")"+t+"("+e+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+e+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+e+")\\s*\\)))",n=new RegExp("^\\s*(?:(?:"+d+"(?:"+t+"*"+d+")*)?)\\s*$"),i=new RegExp(d,"g"),function(e){var c=h.concat(),u=[];if(!e||e&&!n.test(e))return c;e.replace(i,function(e){var t,n,i,o,r,s,a=new RegExp(d).exec(e).filter(function(e){return!!e}),e=a[1],l=a.slice(2).map(parseFloat);switch(e){case"translate":s=l,c[4]=s[0],2===s.length&&(c[5]=s[1]);break;case"rotate":l[0]=b.util.degreesToRadians(l[0]),t=c,n=l,i=b.util.cos(n[0]),s=b.util.sin(n[0]),r=o=0,3===n.length&&(o=n[1],r=n[2]),t[0]=i,t[1]=s,t[2]=-s,t[3]=i,t[4]=o-(i*o-s*r),t[5]=r-(s*o+i*r);break;case"scale":o=c,i=l[0],r=2===l.length?l[1]:l[0],o[0]=i,o[3]=r;break;case"skewX":_(c,l,2);break;case"skewY":_(c,l,1);break;case"matrix":c=l}u.push(c.concat()),c=h.concat()});for(var t=u[0];1<u.length;)u.shift(),t=b.util.multiplyTransformMatrices(t,u[0]);return t});var k=new RegExp("^\\s*("+b.reNum+"+)\\s*,?\\s*("+b.reNum+"+)\\s*,?\\s*("+b.reNum+"+)\\s*,?\\s*("+b.reNum+"+)\\s*$");function A(e){if(b.svgViewBoxElementsRegEx.test(e.nodeName)){var t,n,i,o=e.getAttribute("viewBox"),r=1,s=1,a=e.getAttribute("width"),l=e.getAttribute("height"),c=e.getAttribute("x")||0,u=e.getAttribute("y")||0,h=e.getAttribute("preserveAspectRatio")||"",d=!o||!(o=o.match(k)),f=!a||!l||"100%"===a||"100%"===l,p=d&&f,g={},m="",v=0,y=0;if(g.width=0,g.height=0,g.toBeParsed=p,d&&(c||u)&&"#document"!==e.parentNode.nodeName&&(m=" translate("+C(c)+" "+C(u)+") ",n=(e.getAttribute("transform")||"")+m,e.setAttribute("transform",n),e.removeAttribute("x"),e.removeAttribute("y")),p)return g;if(d)return g.width=C(a),g.height=C(l),g;if(t=-parseFloat(o[1]),p=-parseFloat(o[2]),d=parseFloat(o[3]),o=parseFloat(o[4]),g.minX=t,g.minY=p,g.viewBoxWidth=d,g.viewBoxHeight=o,f?(g.width=d,g.height=o):(g.width=C(a),g.height=C(l),r=g.width/d,s=g.height/o),"none"!==(h=b.util.parsePreserveAspectRatioAttribute(h)).alignX&&("meet"===h.meetOrSlice&&(s=r=s<r?s:r),"slice"===h.meetOrSlice&&(s=r=s<r?r:s),v=g.width-d*r,y=g.height-o*r,"Mid"===h.alignX&&(v/=2),"Mid"===h.alignY&&(y/=2),"Min"===h.alignX&&(v=0),"Min"===h.alignY&&(y=0)),1===r&&1===s&&0==t&&0==p&&0===c&&0===u)return g;if((c||u)&&"#document"!==e.parentNode.nodeName&&(m=" translate("+C(c)+" "+C(u)+") "),n=m+" matrix("+r+" 0 0 "+s+" "+(t*r+v)+" "+(p*s+y)+") ","svg"===e.nodeName){for(i=e.ownerDocument.createElementNS(b.svgNS,"g");e.firstChild;)i.appendChild(e.firstChild);e.appendChild(i)}else(i=e).removeAttribute("x"),i.removeAttribute("y"),n=i.getAttribute("transform")+n;return i.setAttribute("transform",n),g}}b.parseSVGDocument=function(e,n,t,i){if(e){!function(e){for(var t=S(e,["use","svg:use"]),n=0;t.length&&n<t.length;){var i,o=t[n],r=(o.getAttribute("xlink:href")||o.getAttribute("href")).substr(1),s=o.getAttribute("x")||0,a=o.getAttribute("y")||0,l=T(e,r).cloneNode(!0),c=(l.getAttribute("transform")||"")+" translate("+s+", "+a+")",a=t.length,u=b.svgNS;if(A(l),/^svg$/i.test(l.nodeName)){for(var h,d=l.ownerDocument.createElementNS(u,"g"),f=0,p=(h=l.attributes).length;f<p;f++)i=h.item(f),d.setAttributeNS(u,i.nodeName,i.nodeValue);for(;l.firstChild;)d.appendChild(l.firstChild);l=d}for(f=0,p=(h=o.attributes).length;f<p;f++)"x"!==(i=h.item(f)).nodeName&&"y"!==i.nodeName&&"xlink:href"!==i.nodeName&&"href"!==i.nodeName&&("transform"===i.nodeName?c=i.nodeValue+" "+c:l.setAttribute(i.nodeName,i.nodeValue));l.setAttribute("transform",c),l.setAttribute("instantiated_by_use","1"),l.removeAttribute("id"),o.parentNode.replaceChild(l,o),t.length===a&&n++}}(e);var o=b.Object.__uid++,r=A(e),s=b.util.toArray(e.getElementsByTagName("*"));if(r.crossOrigin=i&&i.crossOrigin,r.svgUid=o,0===s.length&&b.isLikelyNode){for(var a=[],l=0,c=(s=e.selectNodes('//*[name(.)!="svg"]')).length;l<c;l++)a[l]=s[l];s=a}var u,h=s.filter(function(e){return A(e),b.svgValidTagNamesRegEx.test(e.nodeName.replace("svg:",""))&&!function(e,t){for(;e=e&&e.parentNode;)if(e.nodeName&&t.test(e.nodeName.replace("svg:",""))&&!e.getAttribute("instantiated_by_use"))return 1}(e,b.svgInvalidAncestorsRegEx)});!h||h&&!h.length?n&&n([],{}):(u={},s.filter(function(e){return"clipPath"===e.nodeName.replace("svg:","")}).forEach(function(e){var t=e.getAttribute("id");u[t]=b.util.toArray(e.getElementsByTagName("*")).filter(function(e){return b.svgValidTagNamesRegEx.test(e.nodeName.replace("svg:",""))})}),b.gradientDefs[o]=b.getGradientDefs(e),b.cssRules[o]=b.getCSSRules(e),b.clipPaths[o]=u,b.parseElements(h,function(e,t){n&&(n(e,r,t,s),delete b.gradientDefs[o],delete b.cssRules[o],delete b.clipPaths[o])},p(r),t,i))}};var s=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+b.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+b.reNum+"))?\\s+(.*)");f(b,{parseFontDeclaration:function(e,t){var n,i,o,r=e.match(s);r&&(n=r[1],i=r[3],o=r[4],e=r[5],r=r[6],n&&(t.fontStyle=n),i&&(t.fontWeight=isNaN(parseFloat(i))?i:parseFloat(i)),o&&(t.fontSize=C(o)),r&&(t.fontFamily=r),e&&(t.lineHeight="normal"===e?1:e))},getGradientDefs:function(e){for(var t,n=S(e,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),i=0,o={},i=n.length;i--;)(t=n[i]).getAttribute("xlink:href")&&function e(t,n){var i="xlink:href",o=T(t,n.getAttribute(i).substr(1));if(o&&o.getAttribute(i)&&e(t,o),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(e){o&&!n.hasAttribute(e)&&o.hasAttribute(e)&&n.setAttribute(e,o.getAttribute(e))}),!n.children.length)for(var r=o.cloneNode(!0);r.firstChild;)n.appendChild(r.firstChild);n.removeAttribute(i)}(e,t),o[t.getAttribute("id")]=t;return o},parseAttributes:function(n,e,t){if(n){var i,o,r={};void 0===t&&(t=n.getAttribute("svgUid")),n.parentNode&&b.svgValidParentsRegEx.test(n.parentNode.nodeName)&&(r=b.parseAttributes(n.parentNode,e,t));var s=e.reduce(function(e,t){return(i=n.getAttribute(t))&&(e[t]=i),e},{}),t=f(function(e,t){var n,i,o,r,s,a={};for(n in b.cssRules[t])if(i=e,o=n.split(" "),r=void 0,s=void 0,s=!0,(r=E(i,o.pop()))&&o.length&&(s=function(e,t){for(var n,i=!0;e.parentNode&&1===e.parentNode.nodeType&&t.length;)i&&(n=t.pop()),i=E(e=e.parentNode,n);return 0===t.length}(i,o)),r&&s&&0===o.length)for(var l in b.cssRules[t][n])a[l]=b.cssRules[t][n][l];return a}(n,t),b.parseStyleAttribute(n)),s=f(s,t);t[w]&&n.setAttribute(w,t[w]),o=t=r.fontSize||b.Text.DEFAULT_SVG_FONT_SIZE,s[x]&&(s[x]=o=C(s[x],t));var a,l,c,u={};for(c in s)l=function(e,t,n,i){var o,r="[object Array]"===Object.prototype.toString.call(t);if("fill"!==e&&"stroke"!==e||"none"!==t){if("strokeUniform"===e)return"non-scaling-stroke"===t;if("strokeDashArray"===e)t="none"===t?null:t.replace(/,/g," ").split(/\s+/).map(parseFloat);else if("transformMatrix"===e)t=n&&n.transformMatrix?m(n.transformMatrix,b.parseTransformAttribute(t)):b.parseTransformAttribute(t);else if("visible"===e)t="none"!==t&&"hidden"!==t,n&&!1===n.visible&&(t=!1);else if("opacity"===e)t=parseFloat(t),n&&void 0!==n.opacity&&(t*=n.opacity);else if("textAnchor"===e)t="start"===t?"left":"end"===t?"right":"center";else if("charSpacing"===e)o=C(t,i)/i*1e3;else if("paintFirst"===e){var s=t.indexOf("fill"),n=t.indexOf("stroke"),t="fill";(-1<s&&-1<n&&n<s||-1===s&&-1<n)&&(t="stroke")}else{if("href"===e||"xlink:href"===e||"font"===e)return t;if("imageSmoothing"===e)return"optimizeQuality"===t;o=r?t.map(C):C(t,i)}}else t="";return!r&&isNaN(o)?t:o}(a=(l=c)in v?v[l]:l,s[c],r,o),u[a]=l;u&&u.font&&b.parseFontDeclaration(u.font,u);t=f(r,u);return b.svgValidParentsRegEx.test(n.nodeName)?t:function(e){for(var t in y)if(void 0!==e[y[t]]&&""!==e[t]){if(void 0===e[t]){if(!b.Object.prototype[t])continue;e[t]=b.Object.prototype[t]}var n;0!==e[t].indexOf("url(")&&(n=new b.Color(e[t]),e[t]=n.setAlpha(g(n.getAlpha()*e[y[t]],2)).toRgba())}return e}(t)}},parseElements:function(e,t,n,i,o){new b.ElementsParser(e,t,n,i,o).parse()},parseStyleAttribute:function(e){var t,n,i,o={},e=e.getAttribute("style");return e&&("string"==typeof e?(t=o,e.replace(/;\s*$/,"").split(";").forEach(function(e){e=e.split(":");n=e[0].trim().toLowerCase(),i=e[1].trim(),t[n]=i})):function(e,t){var n,i,o;for(o in e)void 0!==e[o]&&(n=o.toLowerCase(),i=e[o],t[n]=i)}(e,o)),o},parsePointsAttribute:function(e){if(!e)return null;for(var t=[],n=0,i=(e=(e=e.replace(/,/g," ").trim()).split(/\s+/)).length;n<i;n+=2)t.push({x:parseFloat(e[n]),y:parseFloat(e[n+1])});return t},getCSSRules:function(e){for(var t=e.getElementsByTagName("style"),s={},a=0,l=t.length;a<l;a++){var n=t[a].textContent||"";""!==(n=n.replace(/\/\*[\s\S]*?\*\//g,"")).trim()&&n.match(/[^{]*\{[\s\S]*?\}/g).map(function(e){return e.trim()}).forEach(function(e){var t=e.match(/([\s\S]*?)\s*\{([^}]*)\}/),n={},i=t[2].trim().replace(/;$/,"").split(/\s*;\s*/);for(a=0,l=i.length;a<l;a++){var o=i[a].split(/\s*:\s*/),r=o[0],o=o[1];n[r]=o}(e=t[1]).split(",").forEach(function(e){""!==(e=e.replace(/^svg/i,"").trim())&&(s[e]?b.util.object.extend(s[e],n):s[e]=b.util.object.clone(n))})})}return s},loadSVGFromURL:function(e,o,t,n){e=e.replace(/^\n\s*/,"").trim(),new b.util.request(e,{method:"get",onComplete:function(e){e=e.responseXML;if(!e||!e.documentElement)return o&&o(null),!1;b.parseSVGDocument(e.documentElement,function(e,t,n,i){o&&o(e,t,n,i)},t,n)}})},loadSVGFromString:function(e,o,t,n){e=(new b.window.DOMParser).parseFromString(e.trim(),"text/xml");b.parseSVGDocument(e.documentElement,function(e,t,n,i){o(e,t,n,i)},t,n)}})}(),X.ElementsParser=function(e,t,n,i,o,r){this.elements=e,this.callback=t,this.options=n,this.reviver=i,this.svgUid=n&&n.svgUid||0,this.parsingOptions=o,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=r},(W=X.ElementsParser.prototype).parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},W.createObjects=function(){var n=this;this.elements.forEach(function(e,t){e.setAttribute("svgUid",n.svgUid),n.createObject(e,t)})},W.findTag=function(e){return X[X.util.string.capitalize(e.tagName.replace("svg:",""))]},W.createObject=function(e,t){var n=this.findTag(e);if(n&&n.fromElement)try{n.fromElement(e,this.createCallback(t,e),this.options)}catch(e){X.log(e)}else this.checkIfDone()},W.createCallback=function(n,i){var o=this;return function(e){var t;o.resolveGradient(e,i,"fill"),o.resolveGradient(e,i,"stroke"),e instanceof X.Image&&e._originalElement&&(t=e.parsePreserveAspectRatioAttribute(i)),e._removeTransformMatrix(t),o.resolveClipPath(e,i),o.reviver&&o.reviver(i,e),o.instances[n]=e,o.checkIfDone()}},W.extractPropertyDefinition=function(e,t,n){e=e[t],t=this.regexUrl;if(t.test(e)){t.lastIndex=0;e=t.exec(e)[1];return t.lastIndex=0,X[n][this.svgUid][e]}},W.resolveGradient=function(e,t,n){var i=this.extractPropertyDefinition(e,n,"gradientDefs");i&&(t=t.getAttribute(n+"-opacity"),t=X.Gradient.fromElement(i,e,t,this.options),e.set(n,t))},W.createClipPathCallback=function(e,t){return function(e){e._removeTransformMatrix(),e.fillRule=e.clipRule,t.push(e)}},W.resolveClipPath=function(e,t){var n,i,o=this.extractPropertyDefinition(e,"clipPath","clipPaths");if(o){i=[],l=X.util.invertTransform(e.calcTransformMatrix());for(var r=o[0].parentNode,s=t;s.parentNode&&s.getAttribute("clip-path")!==e.clipPath;)s=s.parentNode;s.parentNode.appendChild(r);for(var a=0;a<o.length;a++)n=o[a],this.findTag(n).fromElement(n,this.createClipPathCallback(e,i),this.options);o=1===i.length?i[0]:new X.Group(i),l=X.util.multiplyTransformMatrices(l,o.calcTransformMatrix()),o.clipPath&&this.resolveClipPath(o,s);var l=X.util.qrDecompose(l);o.flipX=!1,o.flipY=!1,o.set("scaleX",l.scaleX),o.set("scaleY",l.scaleY),o.angle=l.angle,o.skewX=l.skewX,o.skewY=0,o.setPositionByOrigin({x:l.translateX,y:l.translateY},"center","center"),e.clipPath=o}else delete e.clipPath},W.checkIfDone=function(){0==--this.numElements&&(this.instances=this.instances.filter(function(e){return null!=e}),this.callback(this.instances,this.elements))},function(){"use strict";var e=Se.fabric||(Se.fabric={});function n(e,t){this.x=e,this.y=t}e.Point?e.warn("fabric.Point is already defined"):(e.Point=n).prototype={type:"point",constructor:n,add:function(e){return new n(this.x+e.x,this.y+e.y)},addEquals:function(e){return this.x+=e.x,this.y+=e.y,this},scalarAdd:function(e){return new n(this.x+e,this.y+e)},scalarAddEquals:function(e){return this.x+=e,this.y+=e,this},subtract:function(e){return new n(this.x-e.x,this.y-e.y)},subtractEquals:function(e){return this.x-=e.x,this.y-=e.y,this},scalarSubtract:function(e){return new n(this.x-e,this.y-e)},scalarSubtractEquals:function(e){return this.x-=e,this.y-=e,this},multiply:function(e){return new n(this.x*e,this.y*e)},multiplyEquals:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return new n(this.x/e,this.y/e)},divideEquals:function(e){return this.x/=e,this.y/=e,this},eq:function(e){return this.x===e.x&&this.y===e.y},lt:function(e){return this.x<e.x&&this.y<e.y},lte:function(e){return this.x<=e.x&&this.y<=e.y},gt:function(e){return this.x>e.x&&this.y>e.y},gte:function(e){return this.x>=e.x&&this.y>=e.y},lerp:function(e,t){return void 0===t&&(t=.5),t=Math.max(Math.min(1,t),0),new n(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t)},distanceFrom:function(e){var t=this.x-e.x,e=this.y-e.y;return Math.sqrt(t*t+e*e)},midPointFrom:function(e){return this.lerp(e)},min:function(e){return new n(Math.min(this.x,e.x),Math.min(this.y,e.y))},max:function(e){return new n(Math.max(this.x,e.x),Math.max(this.y,e.y))},toString:function(){return this.x+","+this.y},setXY:function(e,t){return this.x=e,this.y=t,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setFromPoint:function(e){return this.x=e.x,this.y=e.y,this},swap:function(e){var t=this.x,n=this.y;this.x=e.x,this.y=e.y,e.x=t,e.y=n},clone:function(){return new n(this.x,this.y)}}}(),function(){"use strict";var a=Se.fabric||(Se.fabric={});function l(e){this.status=e,this.points=[]}a.Intersection?a.warn("fabric.Intersection is already defined"):(a.Intersection=l,a.Intersection.prototype={constructor:l,appendPoint:function(e){return this.points.push(e),this},appendPoints:function(e){return this.points=this.points.concat(e),this}},a.Intersection.intersectLineLine=function(e,t,n,i){var o,r=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),s=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),i=(i.y-n.y)*(t.x-e.x)-(i.x-n.x)*(t.y-e.y);return 0!=i?(n=s/i,0<=(i=r/i)&&i<=1&&0<=n&&n<=1?(o=new l("Intersection")).appendPoint(new a.Point(e.x+i*(t.x-e.x),e.y+i*(t.y-e.y))):o=new l):o=new l(0==r||0==s?"Coincident":"Parallel"),o},a.Intersection.intersectLinePolygon=function(e,t,n){for(var i,o,r=new l,s=n.length,a=0;a<s;a++)i=n[a],o=n[(a+1)%s],o=l.intersectLineLine(e,t,i,o),r.appendPoints(o.points);return 0<r.points.length&&(r.status="Intersection"),r},a.Intersection.intersectPolygonPolygon=function(e,t){for(var n=new l,i=e.length,o=0;o<i;o++){var r=e[o],s=e[(o+1)%i],s=l.intersectLinePolygon(r,s,t);n.appendPoints(s.points)}return 0<n.points.length&&(n.status="Intersection"),n},a.Intersection.intersectPolygonRectangle=function(e,t,n){var i=t.min(n),o=t.max(n),r=new a.Point(o.x,i.y),t=new a.Point(i.x,o.y),n=l.intersectLinePolygon(i,r,e),r=l.intersectLinePolygon(r,o,e),o=l.intersectLinePolygon(o,t,e),i=l.intersectLinePolygon(t,i,e),e=new l;return e.appendPoints(n.points),e.appendPoints(r.points),e.appendPoints(o.points),e.appendPoints(i.points),0<e.points.length&&(e.status="Intersection"),e})}(),function(){"use strict";var c=Se.fabric||(Se.fabric={});function a(e){e?this._tryParsingColor(e):this.setSource([0,0,0,1])}function l(e,t,n){return n<0&&(n+=1),1<n&&--n,n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}c.Color?c.warn("fabric.Color is already defined."):(c.Color=a,c.Color.prototype={_tryParsingColor:function(e){var t;e in a.colorNameMap&&(e=a.colorNameMap[e]),"transparent"===e&&(t=[255,255,255,0]),(t=(t=(t=(t=t||a.sourceFromHex(e))||a.sourceFromRgb(e))||a.sourceFromHsl(e))||[0,0,0,1])&&this.setSource(t)},_rgbToHsl:function(e,t,n){e/=255,t/=255,n/=255;var i,o=c.util.array.max([e,t,n]),r=c.util.array.min([e,t,n]),s=(o+r)/2;if(o===r)i=l=0;else{var a=o-r,l=.5<s?a/(2-o-r):a/(o+r);switch(o){case e:i=(t-n)/a+(t<n?6:0);break;case t:i=(n-e)/a+2;break;case n:i=(e-t)/a+4}i/=6}return[Math.round(360*i),Math.round(100*l),Math.round(100*s)]},getSource:function(){return this._source},setSource:function(e){this._source=e},toRgb:function(){var e=this.getSource();return"rgb("+e[0]+","+e[1]+","+e[2]+")"},toRgba:function(){var e=this.getSource();return"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},toHsl:function(){var e=this.getSource(),e=this._rgbToHsl(e[0],e[1],e[2]);return"hsl("+e[0]+","+e[1]+"%,"+e[2]+"%)"},toHsla:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsla("+t[0]+","+t[1]+"%,"+t[2]+"%,"+e[3]+")"},toHex:function(){var e=this.getSource(),t=1===(t=e[0].toString(16)).length?"0"+t:t,n=1===(n=e[1].toString(16)).length?"0"+n:n,e=1===(e=e[2].toString(16)).length?"0"+e:e;return t.toUpperCase()+n.toUpperCase()+e.toUpperCase()},toHexa:function(){var e=this.getSource(),e=1===(e=(e=Math.round(255*e[3])).toString(16)).length?"0"+e:e;return this.toHex()+e.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(e){var t=this.getSource();return t[3]=e,this.setSource(t),this},toGrayscale:function(){var e=this.getSource(),t=parseInt((.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),10),e=e[3];return this.setSource([t,t,t,e]),this},toBlackWhite:function(e){var t=this.getSource(),n=(.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),t=t[3];return e=e||127,n=Number(n)<Number(e)?0:255,this.setSource([n,n,n,t]),this},overlayWith:function(e){e instanceof a||(e=new a(e));for(var t=[],n=this.getAlpha(),i=this.getSource(),o=e.getSource(),r=0;r<3;r++)t.push(Math.round(.5*i[r]+.5*o[r]));return t[3]=n,this.setSource(t),this}},c.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,c.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,c.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,c.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},c.Color.fromRgb=function(e){return a.fromSource(a.sourceFromRgb(e))},c.Color.sourceFromRgb=function(e){var t=e.match(a.reRGBa);if(t){var n=parseInt(t[1],10)/(/%$/.test(t[1])?100:1)*(/%$/.test(t[1])?255:1),i=parseInt(t[2],10)/(/%$/.test(t[2])?100:1)*(/%$/.test(t[2])?255:1),e=parseInt(t[3],10)/(/%$/.test(t[3])?100:1)*(/%$/.test(t[3])?255:1);return[parseInt(n,10),parseInt(i,10),parseInt(e,10),t[4]?parseFloat(t[4]):1]}},c.Color.fromRgba=a.fromRgb,c.Color.fromHsl=function(e){return a.fromSource(a.sourceFromHsl(e))},c.Color.sourceFromHsl=function(e){var t=e.match(a.reHSLa);if(t){var n,i,o,r=(parseFloat(t[1])%360+360)%360/360,s=parseFloat(t[2])/(/%$/.test(t[2])?100:1),e=parseFloat(t[3])/(/%$/.test(t[3])?100:1);return 0==s?n=i=o=e:(n=l(s=2*e-(e=e<=.5?e*(1+s):e+s-e*s),e,r+1/3),i=l(s,e,r),o=l(s,e,r-1/3)),[Math.round(255*n),Math.round(255*i),Math.round(255*o),t[4]?parseFloat(t[4]):1]}},c.Color.fromHsla=a.fromHsl,c.Color.fromHex=function(e){return a.fromSource(a.sourceFromHex(e))},c.Color.sourceFromHex=function(e){if(e.match(a.reHex)){var t=e.slice(e.indexOf("#")+1),n=3===t.length||4===t.length,i=8===t.length||4===t.length,o=n?t.charAt(0)+t.charAt(0):t.substring(0,2),r=n?t.charAt(1)+t.charAt(1):t.substring(2,4),e=n?t.charAt(2)+t.charAt(2):t.substring(4,6),t=i?n?t.charAt(3)+t.charAt(3):t.substring(6,8):"FF";return[parseInt(o,16),parseInt(r,16),parseInt(e,16),parseFloat((parseInt(t,16)/255).toFixed(2))]}},c.Color.fromSource=function(e){var t=new a;return t.setSource(e),t})}(),function(){"use strict";var a=Se.fabric||(Se.fabric={}),o=["e","se","s","sw","w","nw","n","ne","e"],r=["ns","nesw","ew","nwse"],s={},c="left",u="top",h="right",d="bottom",l="center",m={top:d,bottom:u,left:h,right:c,center:l},f=a.util.radiansToDegrees,v=Math.sign||function(e){return(0<e)-(e<0)||+e};function p(e,t){t=e.angle+f(Math.atan2(t.y,t.x))+360;return Math.round(t%360/45)}function y(e,t){var n=t.transform.target,i=n.canvas,o=Object.assign({},t,{target:n});i&&i.fire("object:"+e,o),n.fire(e,t)}function b(e,t){t=t.canvas,e=e[t.uniScaleKey];return t.uniformScaling&&!e||!t.uniformScaling&&e}function C(e){return e.originX===l&&e.originY===l}function x(e,t,n){var i=e.lockScalingX,e=e.lockScalingY;return!((!i||!e)&&(t||!i&&!e||!n)&&(!i||"x"!==t)&&(!e||"y"!==t))}function w(e,t,n,i){return{e:e,transform:t,pointer:{x:n,y:i}}}function g(s){return function(e,t,n,i){var o=t.target,r=o.getCenterPoint(),r=o.translateToOriginPoint(r,t.originX,t.originY),i=s(e,t,n,i);return o.setPositionByOrigin(r,t.originX,t.originY),i}}function S(e,t,n,i,o){var r=e.target,s=r.controls[e.corner],e=r.canvas.getZoom(),e=r.padding/e,n=r.toLocalPoint(new a.Point(i,o),t,n);return n.x>=e&&(n.x-=e),n.x<=-e&&(n.x+=e),n.y>=e&&(n.y-=e),n.y<=e&&(n.y+=e),n.x-=s.offsetX,n.y-=s.offsetY,n}function _(e){return e.flipX&&!e.flipY||!e.flipX&&e.flipY}function E(e,t,n,i,o){0!==e[t]&&(i=o/e._getTransformedDimensions()[i]*e[n],e.set(n,i))}function T(e,t,n,i){var o,r=t.target,s=r._getTransformedDimensions(0,r.skewY),a=S(t,t.originX,t.originY,n,i),l=Math.abs(2*a.x)-s.x,a=r.skewX;l<2?o=0:(o=f(Math.atan2(l/r.scaleX,s.y/r.scaleY)),t.originX===c&&t.originY===d&&(o=-o),t.originX===h&&t.originY===u&&(o=-o),_(r)&&(o=-o));s=a!==o;return s&&(a=r._getTransformedDimensions().y,r.set("skewX",o),E(r,"skewY","scaleY","y",a),y("skewing",w(e,t,n,i))),s}function k(e,t,n,i){var o,r=t.target,s=r._getTransformedDimensions(r.skewX,0),a=S(t,t.originX,t.originY,n,i),l=Math.abs(2*a.y)-s.y,a=r.skewY;l<2?o=0:(o=f(Math.atan2(l/r.scaleY,s.x/r.scaleX)),t.originX===c&&t.originY===d&&(o=-o),t.originX===h&&t.originY===u&&(o=-o),_(r)&&(o=-o));s=a!==o;return s&&(a=r._getTransformedDimensions().x,r.set("skewY",o),E(r,"skewX","scaleX","x",a),y("skewing",w(e,t,n,i))),s}function A(e,t,n,i,o){o=o||{};var r=t.target,s=r.lockScalingX,a=r.lockScalingY,l=o.by,c=b(e,r),u=x(r,l,c),h=t.gestureScale;if(u)return!1;if(h)d=t.scaleX*h,f=t.scaleY*h;else{if(o=S(t,t.originX,t.originY,n,i),p="y"!==l?v(o.x):1,g="x"!==l?v(o.y):1,t.signX||(t.signX=p),t.signY||(t.signY=g),r.lockScalingFlip&&(t.signX!==p||t.signY!==g))return!1;var d,u=r._getTransformedDimensions(),f=c&&!l?(h=Math.abs(o.x)+Math.abs(o.y),c=t.original,h=h/(Math.abs(u.x*c.scaleX/r.scaleX)+Math.abs(u.y*c.scaleY/r.scaleY)),d=c.scaleX*h,c.scaleY*h):(d=Math.abs(o.x*r.scaleX/u.x),Math.abs(o.y*r.scaleY/u.y));C(t)&&(d*=2,f*=2),t.signX!==p&&"y"!==l&&(t.originX=m[t.originX],d*=-1,t.signX=p),t.signY!==g&&"x"!==l&&(t.originY=m[t.originY],f*=-1,t.signY=g)}var p=r.scaleX,g=r.scaleY;return l?("x"===l&&r.set("scaleX",d),"y"===l&&r.set("scaleY",f)):(s||r.set("scaleX",d),a||r.set("scaleY",f)),(r=p!==r.scaleX||g!==r.scaleY)&&y("scaling",w(e,t,n,i)),r}s.scaleCursorStyleHandler=function(e,t,n){var i=b(e,n),e="";if(0!==t.x&&0===t.y?e="x":0===t.x&&0!==t.y&&(e="y"),x(n,e,i))return"not-allowed";t=p(n,t);return o[t]+"-resize"},s.skewCursorStyleHandler=function(e,t,n){var i="not-allowed";if(0!==t.x&&n.lockSkewingY)return i;if(0!==t.y&&n.lockSkewingX)return i;t=p(n,t)%4;return r[t]+"-resize"},s.scaleSkewCursorStyleHandler=function(e,t,n){return e[n.canvas.altActionKey]?s.skewCursorStyleHandler(e,t,n):s.scaleCursorStyleHandler(e,t,n)},s.rotationWithSnapping=g(function(e,t,n,i){var o=t,r=o.target,s=r.translateToOriginPoint(r.getCenterPoint(),o.originX,o.originY);if(r.lockRotation)return!1;var a,l=Math.atan2(o.ey-s.y,o.ex-s.x),s=Math.atan2(i-s.y,n-s.x),s=f(s-l+o.theta);return 0<r.snapAngle&&(l=r.snapAngle,o=r.snapThreshold||l,a=Math.ceil(s/l)*l,l=Math.floor(s/l)*l,Math.abs(s-l)<o?s=l:Math.abs(s-a)<o&&(s=a)),s<0&&(s=360+s),s%=360,a=r.angle!==s,r.angle=s,a&&y("rotating",w(e,t,n,i)),a}),s.scalingEqually=g(function(e,t,n,i){return A(e,t,n,i)}),s.scalingX=g(function(e,t,n,i){return A(e,t,n,i,{by:"x"})}),s.scalingY=g(function(e,t,n,i){return A(e,t,n,i,{by:"y"})}),s.scalingYOrSkewingX=function(e,t,n,i){return e[t.target.canvas.altActionKey]?s.skewHandlerX(e,t,n,i):s.scalingY(e,t,n,i)},s.scalingXOrSkewingY=function(e,t,n,i){return e[t.target.canvas.altActionKey]?s.skewHandlerY(e,t,n,i):s.scalingX(e,t,n,i)},s.changeWidth=g(function(e,t,n,i){var o=t.target,n=S(t,t.originX,t.originY,n,i),i=o.strokeWidth/(o.strokeUniform?o.scaleX:1),t=C(t)?2:1,i=Math.abs(n.x*t/o.scaleX)-i;return o.set("width",Math.max(i,0)),!0}),s.skewHandlerX=function(e,t,n,i){var o,r=t.target,s=r.skewX,a=t.originY;return!r.lockSkewingX&&(0===s?o=0<S(t,l,l,n,i).x?c:h:(0<s&&(o=a===u?c:h),s<0&&(o=a===u?h:c),_(r)&&(o=o===c?h:c)),t.originX=o,g(T)(e,t,n,i))},s.skewHandlerY=function(e,t,n,i){var o,r=t.target,s=r.skewY,a=t.originX;return!r.lockSkewingY&&(0===s?o=0<S(t,l,l,n,i).y?u:d:(0<s&&(o=a===c?u:d),s<0&&(o=a===c?d:u),_(r)&&(o=o===u?d:u)),t.originY=o,g(k)(e,t,n,i))},s.scaleOrSkewActionName=function(e,t,n){n=e[n.canvas.altActionKey];return 0===t.x?n?"skewX":"scaleY":0===t.y?n?"skewY":"scaleX":void 0},s.rotationStyleHandler=function(e,t,n){return n.lockRotation?"not-allowed":t.cursorStyle},s.fireEvent=y,s.wrapWithFixedAnchor=g,s.getLocalPoint=S,a.controlsUtils=s}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),c=e.util.degreesToRadians,e=e.controlsUtils;e.renderCircleControl=function(e,t,n,i,o){var r=(i=i||{}).cornerSize||o.cornerSize,s=(void 0!==i.transparentCorners?i:this).transparentCorners,a=s?"stroke":"fill",s=!s&&(i.cornerStrokeColor||o.cornerStrokeColor);e.save(),e.fillStyle=i.cornerColor||o.cornerColor,e.strokeStyle=i.cornerStrokeColor||o.cornerStrokeColor,e.lineWidth=1,e.beginPath(),e.arc(t,n,r/2,0,2*Math.PI,!1),e[a](),s&&e.stroke(),e.restore()},e.renderSquareControl=function(e,t,n,i,o){var r=(i=i||{}).cornerSize||o.cornerSize,s=(void 0!==i.transparentCorners?i:o).transparentCorners,a=s?"stroke":"fill",l=!s&&(i.cornerStrokeColor||o.cornerStrokeColor),s=r/2;e.save(),e.fillStyle=i.cornerColor||o.cornerColor,e.strokeStyle=i.strokeCornerColor||o.strokeCornerColor,e.lineWidth=1,e.translate(t,n),e.rotate(c(o.angle)),e[a+"Rect"](-s,-s,r,r),l&&e.strokeRect(-s,-s,r,r),e.restore()}}(),function(){"use strict";var r=Se.fabric||(Se.fabric={});r.Control=function(e){for(var t in e)this[t]=e[t]},r.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(e,t){return t.cursorStyle},getActionName:function(e,t){return t.actionName},getVisibility:function(e,t){e=e._controlsVisibility;return e&&void 0!==e[t]?e[t]:this.visible},setVisibility:function(e){this.visible=e},positionHandler:function(e,t){return r.util.transformPoint({x:this.x*e.x+this.offsetX,y:this.y*e.y+this.offsetY},t)},render:function(e,t,n,i,o){("circle"===((i=i||{}).cornerStyle||o.cornerStyle)?r.controlsUtils.renderCircleControl:r.controlsUtils.renderSquareControl).call(this,e,t,n,i,o)}}}(),m=X.util.object.clone,X.Gradient=X.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(t){(t=t||{}).coords||(t.coords={});var e,n=this;Object.keys(t).forEach(function(e){n[e]=t[e]}),this.id?this.id+="_"+X.Object.__uid++:this.id=X.Object.__uid++,e={x1:t.coords.x1||0,y1:t.coords.y1||0,x2:t.coords.x2||0,y2:t.coords.y2||0},"radial"===this.type&&(e.r1=t.coords.r1||0,e.r2=t.coords.r2||0),this.coords=e,this.colorStops=t.colorStops.slice()},addColorStop:function(e){for(var t in e){var n=new X.Color(e[t]);this.colorStops.push({offset:parseFloat(t),color:n.toRgb(),opacity:n.getAlpha()})}return this},toObject:function(e){var t={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform&&this.gradientTransform.concat()};return X.util.populateWithProperties(this,t,e),t},toSVG:function(e,t){var n,i=m(this.coords,!0),t=t||{},o=m(this.colorStops,!0),r=i.r1>i.r2,s=(this.gradientTransform||X.iMatrix).concat(),a=-this.offsetX,l=-this.offsetY,c=!!t.additionalTransform,u="pixels"===this.gradientUnits?"userSpaceOnUse":"objectBoundingBox";if(o.sort(function(e,t){return e.offset-t.offset}),"objectBoundingBox"==u?(a/=e.width,l/=e.height):(a+=e.width/2,l+=e.height/2),"path"===e.type&&(a-=e.pathOffset.x,l-=e.pathOffset.y),s[4]-=a,s[5]-=l,u='id="SVGID_'+this.id+'" gradientUnits="'+u+'"',u+=' gradientTransform="'+(c?t.additionalTransform+" ":"")+X.util.matrixToSVG(s)+'" ',"linear"===this.type?n=["<linearGradient ",u,' x1="',i.x1,'" y1="',i.y1,'" x2="',i.x2,'" y2="',i.y2,'">\n']:"radial"===this.type&&(n=["<radialGradient ",u,' cx="',r?i.x1:i.x2,'" cy="',r?i.y1:i.y2,'" r="',r?i.r1:i.r2,'" fx="',r?i.x2:i.x1,'" fy="',r?i.y2:i.y1,'">\n']),"radial"===this.type){if(r)for((o=o.concat()).reverse(),d=0,f=o.length;d<f;d++)o[d].offset=1-o[d].offset;r=Math.min(i.r1,i.r2);if(0<r)for(var h=r/Math.max(i.r1,i.r2),d=0,f=o.length;d<f;d++)o[d].offset+=h*(1-o[d].offset)}for(d=0,f=o.length;d<f;d++){var p=o[d];n.push("<stop ",'offset="',100*p.offset+"%",'" style="stop-color:',p.color,void 0!==p.opacity?";stop-opacity: "+p.opacity:";",'"/>\n')}return n.push("linear"===this.type?"</linearGradient>\n":"</radialGradient>\n"),n.join("")},toLive:function(e){var t,n,i,o=X.util.object.clone(this.coords);if(this.type){for("linear"===this.type?t=e.createLinearGradient(o.x1,o.y1,o.x2,o.y2):"radial"===this.type&&(t=e.createRadialGradient(o.x1,o.y1,o.r1,o.x2,o.y2,o.r2)),n=0,i=this.colorStops.length;n<i;n++){var r=this.colorStops[n].color,s=this.colorStops[n].opacity,a=this.colorStops[n].offset;void 0!==s&&(r=new X.Color(r).setAlpha(s).toRgba()),t.addColorStop(a,r)}return t}}}),X.util.object.extend(X.Gradient,{fromElement:function(e,t,n,i){var o=(o=parseFloat(n)/(/%$/.test(n)?100:1))<0?0:1<o?1:o;isNaN(o)&&(o=1);for(var r,s,a,l,c,u,h=e.getElementsByTagName("stop"),d="userSpaceOnUse"===e.getAttribute("gradientUnits")?"pixels":"percentage",f=e.getAttribute("gradientTransform")||"",p=[],g=0,m=0,v="linearGradient"===e.nodeName||"LINEARGRADIENT"===e.nodeName?(r="linear",{x1:(n=e).getAttribute("x1")||0,y1:n.getAttribute("y1")||0,x2:n.getAttribute("x2")||"100%",y2:n.getAttribute("y2")||0}):(r="radial",{x1:(v=e).getAttribute("fx")||v.getAttribute("cx")||"50%",y1:v.getAttribute("fy")||v.getAttribute("cy")||"50%",r1:0,x2:v.getAttribute("cx")||"50%",y2:v.getAttribute("cy")||"50%",r2:v.getAttribute("r")||"50%"}),y=h.length;y--;)p.push(function(e,t){var n,i,o,r=e.getAttribute("style"),s=e.getAttribute("offset")||0,s=(s=parseFloat(s)/(/%$/.test(s)?100:1))<0?0:1<s?1:s;if(r){var a=r.split(/\s*;\s*/);for(""===a[a.length-1]&&a.pop(),o=a.length;o--;){var l=a[o].split(/\s*:\s*/),c=l[0].trim(),l=l[1].trim();"stop-color"===c?n=l:"stop-opacity"===c&&(i=l)}}return n=n||e.getAttribute("stop-color")||"rgb(0,0,0)",i=i||e.getAttribute("stop-opacity"),e=(n=new X.Color(n)).getAlpha(),i=isNaN(parseFloat(i))?1:parseFloat(i),i*=e*t,{offset:s,color:n.toRgb(),opacity:i}}(h[y],o));return f=X.parseTransformAttribute(f),s=v,a=i,l=d,Object.keys(s).forEach(function(e){"Infinity"===(c=s[e])?u=1:"-Infinity"===c?u=0:(u=parseFloat(s[e],10),"string"==typeof c&&/^(\d+\.\d+)%|(\d+)%$/.test(c)&&(u*=.01,"pixels"==l&&("x1"!==e&&"x2"!==e&&"r2"!==e||(u*=a.viewBoxWidth||a.width),"y1"!==e&&"y2"!==e||(u*=a.viewBoxHeight||a.height)))),s[e]=u}),"pixels"==d&&(g=-t.left,m=-t.top),new X.Gradient({id:e.getAttribute("id"),type:r,coords:v,colorStops:p,gradientUnits:d,gradientTransform:f,offsetX:g,offsetY:m})}}),function(){"use strict";var i=X.util.toFixed;X.Pattern=X.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(e,n){var i;e=e||{},this.id=X.Object.__uid++,this.setOptions(e),!e.source||e.source&&"string"!=typeof e.source?n&&n(this):((i=this).source=X.util.createImage(),X.util.loadImage(e.source,function(e,t){i.source=e,n&&n(i,t)},null,this.crossOrigin))},toObject:function(e){var t,n=X.Object.NUM_FRACTION_DIGITS;return"string"==typeof this.source.src?t=this.source.src:"object"==typeof this.source&&this.source.toDataURL&&(t=this.source.toDataURL()),n={type:"pattern",source:t,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:i(this.offsetX,n),offsetY:i(this.offsetY,n),patternTransform:this.patternTransform?this.patternTransform.concat():null},X.util.populateWithProperties(this,n,e),n},toSVG:function(e){var t="function"==typeof this.source?this.source():this.source,n=t.width/e.width,i=t.height/e.height,o=this.offsetX/e.width,r=this.offsetY/e.height,e="";return"repeat-x"!==this.repeat&&"no-repeat"!==this.repeat||(i=1,r&&(i+=Math.abs(r))),"repeat-y"!==this.repeat&&"no-repeat"!==this.repeat||(n=1,o&&(n+=Math.abs(o))),t.src?e=t.src:t.toDataURL&&(e=t.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+o+'" y="'+r+'" width="'+n+'" height="'+i+'">\n<image x="0" y="0" width="'+t.width+'" height="'+t.height+'" xlink:href="'+e+'"></image>\n</pattern>\n'},setOptions:function(e){for(var t in e)this[t]=e[t]},toLive:function(e){var t=this.source;if(!t)return"";if(void 0!==t.src){if(!t.complete)return"";if(0===t.naturalWidth||0===t.naturalHeight)return""}return e.createPattern(t,this.repeat)}})}(),function(){"use strict";var s=Se.fabric||(Se.fabric={}),a=s.util.toFixed;s.Shadow?s.warn("fabric.Shadow is already defined."):(s.Shadow=s.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(e){for(var t in"string"==typeof e&&(e=this._parseShadow(e)),e)this[t]=e[t];this.id=s.Object.__uid++},_parseShadow:function(e){var t=e.trim(),e=s.Shadow.reOffsetsAndBlur.exec(t)||[];return{color:(t.replace(s.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseInt(e[1],10)||0,offsetY:parseInt(e[2],10)||0,blur:parseInt(e[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(e){var t=40,n=40,i=s.Object.NUM_FRACTION_DIGITS,o=s.util.rotateVector({x:this.offsetX,y:this.offsetY},s.util.degreesToRadians(-e.angle)),r=new s.Color(this.color);return e.width&&e.height&&(t=100*a((Math.abs(o.x)+this.blur)/e.width,i)+20,n=100*a((Math.abs(o.y)+this.blur)/e.height,i)+20),e.flipX&&(o.x*=-1),e.flipY&&(o.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+n+'%" height="'+(100+2*n)+'%" x="-'+t+'%" width="'+(100+2*t)+'%" >\n\t<feGaussianBlur in="SourceAlpha" stdDeviation="'+a(this.blur?this.blur/2:0,i)+'"></feGaussianBlur>\n\t<feOffset dx="'+a(o.x,i)+'" dy="'+a(o.y,i)+'" result="oBlur" ></feOffset>\n\t<feFlood flood-color="'+r.toRgb()+'" flood-opacity="'+r.getAlpha()+'"/>\n\t<feComposite in2="oBlur" operator="in" />\n\t<feMerge>\n\t\t<feMergeNode></feMergeNode>\n\t\t<feMergeNode in="SourceGraphic"></feMergeNode>\n\t</feMerge>\n</filter>\n'},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var t={},n=s.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(e){this[e]!==n[e]&&(t[e]=this[e])},this),t}}),s.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:px)?(?:\s?|$))?(-?\d+(?:px)?(?:\s?|$))?(\d+(?:px)?)?(?:\s?|$)(?:$|\s)/)}(),function(){"use strict";var o,e,c,a,r,s,n,i,t;X.StaticCanvas?X.warn("fabric.StaticCanvas is already defined."):(o=X.util.object.extend,e=X.util.getElementOffset,c=X.util.removeFromArray,a=X.util.toFixed,r=X.util.transformPoint,s=X.util.invertTransform,n=X.util.getNodeCanvas,i=X.util.createCanvasElement,t=new Error("Could not initialize `canvas` element"),X.StaticCanvas=X.util.createClass(X.CommonMethods,{initialize:function(e,t){t=t||{},this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,t)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:X.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(e,t){var n=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(e),this._initOptions(t),this.interactive||this._initRetinaScaling(),t.overlayImage&&this.setOverlayImage(t.overlayImage,n),t.backgroundImage&&this.setBackgroundImage(t.backgroundImage,n),t.backgroundColor&&this.setBackgroundColor(t.backgroundColor,n),t.overlayColor&&this.setOverlayColor(t.overlayColor,n),this.calcOffset()},_isRetinaScaling:function(){return 1!==X.devicePixelRatio&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?X.devicePixelRatio:1},_initRetinaScaling:function(){var e;this._isRetinaScaling()&&(e=X.devicePixelRatio,this.__initRetinaScaling(e,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(e,this.upperCanvasEl,this.contextTop))},__initRetinaScaling:function(e,t,n){t.setAttribute("width",this.width*e),t.setAttribute("height",this.height*e),n.scale(e,e)},calcOffset:function(){return this._offset=e(this.lowerCanvasEl),this},setOverlayImage:function(e,t,n){return this.__setBgOverlayImage("overlayImage",e,t,n)},setBackgroundImage:function(e,t,n){return this.__setBgOverlayImage("backgroundImage",e,t,n)},setOverlayColor:function(e,t){return this.__setBgOverlayColor("overlayColor",e,t)},setBackgroundColor:function(e,t){return this.__setBgOverlayColor("backgroundColor",e,t)},__setBgOverlayImage:function(i,e,o,r){return"string"==typeof e?X.util.loadImage(e,function(e,t){var n;e&&(n=new X.Image(e,r),(this[i]=n).canvas=this),o&&o(e,t)},this,r&&r.crossOrigin):(r&&e.setOptions(r),(this[i]=e)&&(e.canvas=this),o&&o(e,!1)),this},__setBgOverlayColor:function(e,t,n){return this[e]=t,this._initGradient(t,e),this._initPattern(t,e,n),this},_createCanvasElement:function(){var e=i();if(!e)throw t;if(e.style||(e.style={}),void 0===e.getContext)throw t;return e},_initOptions:function(e){var t=this.lowerCanvasEl;this._setOptions(e),this.width=this.width||parseInt(t.width,10)||0,this.height=this.height||parseInt(t.height,10)||0,this.lowerCanvasEl.style&&(t.width=this.width,t.height=this.height,t.style.width=this.width+"px",t.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(e){e&&e.getContext?this.lowerCanvasEl=e:this.lowerCanvasEl=X.util.getById(e)||this._createCanvasElement(),X.util.addClass(this.lowerCanvasEl,"lower-canvas"),this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(e,t){return this.setDimensions({width:e},t)},setHeight:function(e,t){return this.setDimensions({height:e},t)},setDimensions:function(e,t){var n,i;for(i in t=t||{},e)n=e[i],t.cssOnly||(this._setBackstoreDimension(i,e[i]),n+="px",this.hasLostContext=!0),t.backstoreOnly||this._setCssDimension(i,n);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(),this._initRetinaScaling(),this.calcOffset(),t.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(e,t){return this.lowerCanvasEl[e]=t,this.upperCanvasEl&&(this.upperCanvasEl[e]=t),this.cacheCanvasEl&&(this.cacheCanvasEl[e]=t),this[e]=t,this},_setCssDimension:function(e,t){return this.lowerCanvasEl.style[e]=t,this.upperCanvasEl&&(this.upperCanvasEl.style[e]=t),this.wrapperEl&&(this.wrapperEl.style[e]=t),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(e){var t,n,i,o=this._activeObject;for(this.viewportTransform=e,n=0,i=this._objects.length;n<i;n++)(t=this._objects[n]).group||t.setCoords(!0);return o&&o.setCoords(),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(e,t){var n=e,i=this.viewportTransform.slice(0);e=r(e,s(this.viewportTransform)),i[0]=t,i[3]=t;e=r(e,i);return i[4]+=n.x-e.x,i[5]+=n.y-e.y,this.setViewportTransform(i)},setZoom:function(e){return this.zoomToPoint(new X.Point(0,0),e),this},absolutePan:function(e){var t=this.viewportTransform.slice(0);return t[4]=-e.x,t[5]=-e.y,this.setViewportTransform(t)},relativePan:function(e){return this.absolutePan(new X.Point(-e.x-this.viewportTransform[4],-e.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(e){this.stateful&&e.setupState(),e._set("canvas",this),e.setCoords(),this.fire("object:added",{target:e}),e.fire("added")},_onObjectRemoved:function(e){this.fire("object:removed",{target:e}),e.fire("removed"),delete e.canvas},clearContext:function(e){return e.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this._objects.length=0,this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var e=this.contextContainer;return this.renderCanvas(e,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=X.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var e={},t=this.width,n=this.height,i=s(this.viewportTransform);return e.tl=r({x:0,y:0},i),e.br=r({x:t,y:n},i),e.tr=new X.Point(e.br.x,e.tl.y),e.bl=new X.Point(e.tl.x,e.br.y),this.vptCoords=e},cancelRequestedRender:function(){this.isRendering&&(X.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(e,t){var n=this.viewportTransform,i=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(e),X.util.setImageSmoothing(e,this.imageSmoothingEnabled),this.fire("before:render",{ctx:e}),this._renderBackground(e),e.save(),e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this._renderObjects(e,t),e.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(e),i&&(i.canvas=this,i.shouldCache(),i._transformDone=!0,i.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(e)),this._renderOverlay(e),this.controlsAboveOverlay&&this.interactive&&this.drawControls(e),this.fire("after:render",{ctx:e})},drawClipPathOnCanvas:function(e){var t=this.viewportTransform,n=this.clipPath;e.save(),e.transform(t[0],t[1],t[2],t[3],t[4],t[5]),e.globalCompositeOperation="destination-in",n.transform(e),e.scale(1/n.zoomX,1/n.zoomY),e.drawImage(n._cacheCanvas,-n.cacheTranslationX,-n.cacheTranslationY),e.restore()},_renderObjects:function(e,t){for(var n=0,i=t.length;n<i;++n)t[n]&&t[n].render(e)},_renderBackgroundOrOverlay:function(e,t){var n=this[t+"Color"],i=this[t+"Image"],o=this.viewportTransform,t=this[t+"Vpt"];(n||i)&&(n&&(e.save(),e.beginPath(),e.moveTo(0,0),e.lineTo(this.width,0),e.lineTo(this.width,this.height),e.lineTo(0,this.height),e.closePath(),e.fillStyle=n.toLive?n.toLive(e,this):n,t&&e.transform(o[0],o[1],o[2],o[3],o[4],o[5]),e.transform(1,0,0,1,n.offsetX||0,n.offsetY||0),(n=n.gradientTransform||n.patternTransform)&&e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),e.fill(),e.restore()),i&&(e.save(),t&&e.transform(o[0],o[1],o[2],o[3],o[4],o[5]),i.render(e),e.restore()))},_renderBackground:function(e){this._renderBackgroundOrOverlay(e,"background")},_renderOverlay:function(e){this._renderBackgroundOrOverlay(e,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},centerObjectH:function(e){return this._centerObject(e,new X.Point(this.getCenter().left,e.getCenterPoint().y))},centerObjectV:function(e){return this._centerObject(e,new X.Point(e.getCenterPoint().x,this.getCenter().top))},centerObject:function(e){var t=this.getCenter();return this._centerObject(e,new X.Point(t.left,t.top))},viewportCenterObject:function(e){var t=this.getVpCenter();return this._centerObject(e,t)},viewportCenterObjectH:function(e){var t=this.getVpCenter();return this._centerObject(e,new X.Point(t.x,e.getCenterPoint().y)),this},viewportCenterObjectV:function(e){var t=this.getVpCenter();return this._centerObject(e,new X.Point(e.getCenterPoint().x,t.y))},getVpCenter:function(){var e=this.getCenter(),t=s(this.viewportTransform);return r({x:e.left,y:e.top},t)},_centerObject:function(e,t){return e.setPositionByOrigin(t,"center","center"),e.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(e){return this.toDatalessObject(e)},toObject:function(e){return this._toObjectMethod("toObject",e)},toDatalessObject:function(e){return this._toObjectMethod("toDatalessObject",e)},_toObjectMethod:function(e,t){var n=this.clipPath,i={version:X.version,objects:this._toObjects(e,t)};return n&&(i.clipPath=this._toObject(this.clipPath,e,t)),o(i,this.__serializeBgOverlay(e,t)),X.util.populateWithProperties(this,i,t),i},_toObjects:function(t,n){return this._objects.filter(function(e){return!e.excludeFromExport}).map(function(e){return this._toObject(e,t,n)},this)},_toObject:function(e,t,n){var i;this.includeDefaultValues||(i=e.includeDefaultValues,e.includeDefaultValues=!1);n=e[t](n);return this.includeDefaultValues||(e.includeDefaultValues=i),n},__serializeBgOverlay:function(e,t){var n={},i=this.backgroundImage,o=this.overlayImage;return this.backgroundColor&&(n.background=this.backgroundColor.toObject?this.backgroundColor.toObject(t):this.backgroundColor),this.overlayColor&&(n.overlay=this.overlayColor.toObject?this.overlayColor.toObject(t):this.overlayColor),i&&!i.excludeFromExport&&(n.backgroundImage=this._toObject(i,e,t)),o&&!o.excludeFromExport&&(n.overlayImage=this._toObject(o,e,t)),n},svgViewportTransformation:!0,toSVG:function(e,t){(e=e||{}).reviver=t;var n=[];return this._setSVGPreamble(n,e),this._setSVGHeader(n,e),this.clipPath&&n.push('<g clip-path="url(#'+this.clipPath.clipPathId+')" >\n'),this._setSVGBgOverlayColor(n,"background"),this._setSVGBgOverlayImage(n,"backgroundImage",t),this._setSVGObjects(n,t),this.clipPath&&n.push("</g>\n"),this._setSVGBgOverlayColor(n,"overlay"),this._setSVGBgOverlayImage(n,"overlayImage",t),n.push("</svg>"),n.join("")},_setSVGPreamble:function(e,t){t.suppressPreamble||e.push('<?xml version="1.0" encoding="',t.encoding||"UTF-8",'" standalone="no" ?>\n','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ','"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n')},_setSVGHeader:function(e,t){var n,i=t.width||this.width,o=t.height||this.height,r='viewBox="0 0 '+this.width+" "+this.height+'" ',s=X.Object.NUM_FRACTION_DIGITS;t.viewBox?r='viewBox="'+t.viewBox.x+" "+t.viewBox.y+" "+t.viewBox.width+" "+t.viewBox.height+'" ':this.svgViewportTransformation&&(n=this.viewportTransform,r='viewBox="'+a(-n[4]/n[0],s)+" "+a(-n[5]/n[3],s)+" "+a(this.width/n[0],s)+" "+a(this.height/n[3],s)+'" '),e.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',i,'" ','height="',o,'" ',r,'xml:space="preserve">\n',"<desc>Created with Fabric.js ",X.version,"</desc>\n","<defs>\n",this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(t),"</defs>\n")},createSVGClipPathMarkup:function(e){var t=this.clipPath;return t?(t.clipPathId="CLIPPATH_"+X.Object.__uid++,'<clipPath id="'+t.clipPathId+'" >\n'+this.clipPath.toClipPathSVG(e.reviver)+"</clipPath>\n"):""},createSVGRefElementsMarkup:function(){var o=this;return["background","overlay"].map(function(e){var t=o[e+"Color"];if(t&&t.toLive){var n=o[e+"Vpt"],i=o.viewportTransform,e={width:o.width/(n?i[0]:1),height:o.height/(n?i[3]:1)};return t.toSVG(e,{additionalTransform:n?X.util.matrixToSVG(i):""})}}).join("")},createSVGFontFacesMarkup:function(){var e,t,n,i,o,r,s,a,l,c="",u={},h=X.fontPaths,d=[];for(this._objects.forEach(function e(t){d.push(t),t._objects&&t._objects.forEach(e)}),s=0,a=d.length;s<a;s++)if(t=(e=d[s]).fontFamily,-1!==e.type.indexOf("text")&&!u[t]&&h[t]&&(u[t]=!0,e.styles))for(o in n=e.styles)for(r in i=n[o])!u[t=i[r].fontFamily]&&h[t]&&(u[t]=!0);for(l in u)c+=["\t\t@font-face {\n","\t\t\tfont-family: '",l,"';\n","\t\t\tsrc: url('",h[l],"');\n","\t\t}\n"].join("");return c&&['\t<style type="text/css">',"<![CDATA[\n",c,"]]>","</style>\n"].join("")},_setSVGObjects:function(e,t){for(var n,i=this._objects,o=0,r=i.length;o<r;o++)(n=i[o]).excludeFromExport||this._setSVGObject(e,n,t)},_setSVGObject:function(e,t,n){e.push(t.toSVG(n))},_setSVGBgOverlayImage:function(e,t,n){this[t]&&!this[t].excludeFromExport&&this[t].toSVG&&e.push(this[t].toSVG(n))},_setSVGBgOverlayColor:function(e,t){var n,i=this[t+"Color"],o=this.viewportTransform,r=this.width,s=this.height;i&&(i.toLive?(n=i.repeat,o=X.util.invertTransform(o),o=this[t+"Vpt"]?X.util.matrixToSVG(o):"",e.push('<rect transform="'+o+" translate(",r/2,",",s/2,')"',' x="',i.offsetX-r/2,'" y="',i.offsetY-s/2,'" ','width="',"repeat-y"===n||"no-repeat"===n?i.source.width:r,'" height="',"repeat-x"===n||"no-repeat"===n?i.source.height:s,'" fill="url(#SVGID_'+i.id+')"',"></rect>\n")):e.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',i,'"',"></rect>\n"))},sendToBack:function(e){if(!e)return this;var t,n,i,o=this._activeObject;if(e===o&&"activeSelection"===e.type)for(t=(i=o._objects).length;t--;)n=i[t],c(this._objects,n),this._objects.unshift(n);else c(this._objects,e),this._objects.unshift(e);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(e){if(!e)return this;var t,n,i,o=this._activeObject;if(e===o&&"activeSelection"===e.type)for(i=o._objects,t=0;t<i.length;t++)n=i[t],c(this._objects,n),this._objects.push(n);else c(this._objects,e),this._objects.push(e);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(e,t){if(!e)return this;var n,i,o,r,s,a=this._activeObject,l=0;if(e===a&&"activeSelection"===e.type)for(s=a._objects,n=0;n<s.length;n++)i=s[n],0+l<(o=this._objects.indexOf(i))&&(r=o-1,c(this._objects,i),this._objects.splice(r,0,i)),l++;else 0!==(o=this._objects.indexOf(e))&&(r=this._findNewLowerIndex(e,o,t),c(this._objects,e),this._objects.splice(r,0,e));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(e,t,n){var i,o;if(n){for(o=(i=t)-1;0<=o;--o)if(e.intersectsWithObject(this._objects[o])||e.isContainedWithinObject(this._objects[o])||this._objects[o].isContainedWithinObject(e)){i=o;break}}else i=t-1;return i},bringForward:function(e,t){if(!e)return this;var n,i,o,r,s,a=this._activeObject,l=0;if(e===a&&"activeSelection"===e.type)for(n=(s=a._objects).length;n--;)i=s[n],(o=this._objects.indexOf(i))<this._objects.length-1-l&&(r=o+1,c(this._objects,i),this._objects.splice(r,0,i)),l++;else(o=this._objects.indexOf(e))!==this._objects.length-1&&(r=this._findNewUpperIndex(e,o,t),c(this._objects,e),this._objects.splice(r,0,e));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(e,t,n){var i,o,r;if(n){for(o=(i=t)+1,r=this._objects.length;o<r;++o)if(e.intersectsWithObject(this._objects[o])||e.isContainedWithinObject(this._objects[o])||this._objects[o].isContainedWithinObject(e)){i=o;break}}else i=t+1;return i},moveTo:function(e,t){return c(this._objects,e),this._objects.splice(t,0,e),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(X.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(e){e.dispose&&e.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,X.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),o(X.StaticCanvas.prototype,X.Observable),o(X.StaticCanvas.prototype,X.Collection),o(X.StaticCanvas.prototype,X.DataURLExporter),o(X.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(e){var t=i();if(!t||!t.getContext)return null;t=t.getContext("2d");return t&&"setLineDash"===e?void 0!==t.setLineDash:null}}),X.StaticCanvas.prototype.toJSON=X.StaticCanvas.prototype.toObject,X.isLikelyNode&&(X.StaticCanvas.prototype.createPNGStream=function(){var e=n(this.lowerCanvasEl);return e&&e.createPNGStream()},X.StaticCanvas.prototype.createJPEGStream=function(e){var t=n(this.lowerCanvasEl);return t&&t.createJPEGStream(e)}))}(),X.BaseBrush=X.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,_setBrushStyles:function(){var e=this.canvas.contextTop;e.strokeStyle=this.color,e.lineWidth=this.width,e.lineCap=this.strokeLineCap,e.miterLimit=this.strokeMiterLimit,e.lineJoin=this.strokeLineJoin,X.StaticCanvas.supports("setLineDash")&&e.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(e){var t=this.canvas.viewportTransform;e.save(),e.transform(t[0],t[1],t[2],t[3],t[4],t[5])},_setShadow:function(){var e,t,n,i;this.shadow&&(e=this.canvas,t=this.shadow,n=e.contextTop,i=e.getZoom(),e&&e._isRetinaScaling()&&(i*=X.devicePixelRatio),n.shadowColor=t.color,n.shadowBlur=t.blur*i,n.shadowOffsetX=t.offsetX*i,n.shadowOffsetY=t.offsetY*i)},needsFullRender:function(){return new X.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var e=this.canvas.contextTop;e.shadowColor="",e.shadowBlur=e.shadowOffsetX=e.shadowOffsetY=0}}),X.PencilBrush=X.util.createClass(X.BaseBrush,{decimate:.4,initialize:function(e){this.canvas=e,this._points=[]},_drawSegment:function(e,t,n){n=t.midPointFrom(n);return e.quadraticCurveTo(t.x,t.y,n.x,n.y),n},onMouseDown:function(e,t){this.canvas._isMainEvent(t.e)&&(this._prepareForDrawing(e),this._captureDrawingPath(e),this._render())},onMouseMove:function(e,t){var n;this.canvas._isMainEvent(t.e)&&this._captureDrawingPath(e)&&1<this._points.length&&(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this._render()):(t=(n=this._points).length,e=this.canvas.contextTop,this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(e,n[t-2],n[t-1],!0),e.stroke(),e.restore()))},onMouseUp:function(e){return!this.canvas._isMainEvent(e.e)||(this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(e){e=new X.Point(e.x,e.y);this._reset(),this._addPoint(e),this.canvas.contextTop.moveTo(e.x,e.y)},_addPoint:function(e){return!(1<this._points.length&&e.eq(this._points[this._points.length-1])||(this._points.push(e),0))},_reset:function(){this._points=[],this._setBrushStyles(),this._setShadow()},_captureDrawingPath:function(e){e=new X.Point(e.x,e.y);return this._addPoint(e)},_render:function(){var e,t,n,i=this.canvas.contextTop,o=this._points[0],r=this._points[1];for(this._saveAndTransform(i),i.beginPath(),2===this._points.length&&o.x===r.x&&o.y===r.y&&(n=this.width/1e3,o=new X.Point(o.x,o.y),r=new X.Point(r.x,r.y),o.x-=n,r.x+=n),i.moveTo(o.x,o.y),e=1,t=this._points.length;e<t;e++)this._drawSegment(i,o,r),o=this._points[e],r=this._points[e+1];i.lineTo(o.x,o.y),i.stroke(),i.restore()},convertPointsToSVGPath:function(e){var t,n,i=[],o=this.width/1e3,r=new X.Point(e[0].x,e[0].y),s=new X.Point(e[1].x,e[1].y),a=e.length,l=1,c=0,u=2<a;for(u&&(l=e[2].x<s.x?-1:e[2].x===s.x?0:1,c=e[2].y<s.y?-1:e[2].y===s.y?0:1),i.push("M ",r.x-l*o," ",r.y-c*o," "),t=1;t<a;t++)r.eq(s)||(n=r.midPointFrom(s),i.push("Q ",r.x," ",r.y," ",n.x," ",n.y," ")),r=e[t],t+1<e.length&&(s=e[t+1]);return u&&(l=r.x>e[t-2].x?1:r.x===e[t-2].x?0:-1,c=r.y>e[t-2].y?1:r.y===e[t-2].y?0:-1),i.push("L ",r.x+l*o," ",r.y+c*o),i},createPath:function(e){e=new X.Path(e,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,e.shadow=new X.Shadow(this.shadow)),e},decimatePoints:function(e,t){if(e.length<=2)return e;for(var n=this.canvas.getZoom(),i=Math.pow(t/n,2),o=e.length-1,r=e[0],s=[r],a=1;a<o;a++)i<=Math.pow(r.x-e[a].x,2)+Math.pow(r.y-e[a].y,2)&&(r=e[a],s.push(r));return 1===s.length&&s.push(new X.Point(s[0].x,s[0].y)),s},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var e=this.convertPointsToSVGPath(this._points).join("");"M 0 0 Q 0 0 0 0 L 0 0"!==e?(e=this.createPath(e),this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:e}),this.canvas.add(e),this.canvas.requestRenderAll(),e.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:e})):this.canvas.requestRenderAll()}}),X.CircleBrush=X.util.createClass(X.BaseBrush,{width:10,initialize:function(e){this.canvas=e,this.points=[]},drawDot:function(e){var t=this.addPoint(e),e=this.canvas.contextTop;this._saveAndTransform(e),this.dot(e,t),e.restore()},dot:function(e,t){e.fillStyle=t.fill,e.beginPath(),e.arc(t.x,t.y,t.radius,0,2*Math.PI,!1),e.closePath(),e.fill()},onMouseDown:function(e){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(e)},_render:function(){var e,t,n=this.canvas.contextTop,i=this.points;for(this._saveAndTransform(n),e=0,t=i.length;e<t;e++)this.dot(n,i[e]);n.restore()},onMouseMove:function(e){this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(e),this._render()):this.drawDot(e)},onMouseUp:function(){var e=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var t=[],n=0,i=this.points.length;n<i;n++){var o=this.points[n],o=new X.Circle({radius:o.radius,left:o.x,top:o.y,originX:"center",originY:"center",fill:o.fill});this.shadow&&(o.shadow=new X.Shadow(this.shadow)),t.push(o)}var r=new X.Group(t);r.canvas=this.canvas,this.canvas.fire("before:path:created",{path:r}),this.canvas.add(r),this.canvas.fire("path:created",{path:r}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=e,this.canvas.requestRenderAll()},addPoint:function(e){var t=new X.Point(e.x,e.y),n=X.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,e=new X.Color(this.color).setAlpha(X.util.getRandomInt(0,100)/100).toRgba();return t.radius=n,t.fill=e,this.points.push(t),t}}),X.SprayBrush=X.util.createClass(X.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(e){this.canvas=e,this.sprayChunks=[]},onMouseDown:function(e){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(e),this.render(this.sprayChunkPoints)},onMouseMove:function(e){this.addSprayChunk(e),this.render(this.sprayChunkPoints)},onMouseUp:function(){var e=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var t=[],n=0,i=this.sprayChunks.length;n<i;n++)for(var o=this.sprayChunks[n],r=0,s=o.length;r<s;r++){var a=new X.Rect({width:o[r].width,height:o[r].width,left:o[r].x+1,top:o[r].y+1,originX:"center",originY:"center",fill:this.color});t.push(a)}this.optimizeOverlapping&&(t=this._getOptimizedRects(t));var l=new X.Group(t);this.shadow&&l.set("shadow",new X.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:l}),this.canvas.add(l),this.canvas.fire("path:created",{path:l}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=e,this.canvas.requestRenderAll()},_getOptimizedRects:function(e){for(var t,n={},i=0,o=e.length;i<o;i++)n[t=e[i].left+""+e[i].top]||(n[t]=e[i]);var r=[];for(t in n)r.push(n[t]);return r},render:function(e){var t,n,i=this.canvas.contextTop;for(i.fillStyle=this.color,this._saveAndTransform(i),t=0,n=e.length;t<n;t++){var o=e[t];void 0!==o.opacity&&(i.globalAlpha=o.opacity),i.fillRect(o.x,o.y,o.width,o.width)}i.restore()},_render:function(){var e,t,n=this.canvas.contextTop;for(n.fillStyle=this.color,this._saveAndTransform(n),e=0,t=this.sprayChunks.length;e<t;e++)this.render(this.sprayChunks[e]);n.restore()},addSprayChunk:function(e){this.sprayChunkPoints=[];for(var t,n,i=this.width/2,o=0;o<this.density;o++){t=X.util.getRandomInt(e.x-i,e.x+i),r=X.util.getRandomInt(e.y-i,e.y+i),n=this.dotWidthVariance?X.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var r=new X.Point(t,r);r.width=n,this.randomOpacity&&(r.opacity=X.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(r)}this.sprayChunks.push(this.sprayChunkPoints)}}),X.PatternBrush=X.util.createClass(X.PencilBrush,{getPatternSrc:function(){var e=X.util.createCanvasElement(),t=e.getContext("2d");return e.width=e.height=25,t.fillStyle=this.color,t.beginPath(),t.arc(10,10,10,0,2*Math.PI,!1),t.closePath(),t.fill(),e},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(){return this.canvas.contextTop.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(){this.callSuper("_setBrushStyles"),this.canvas.contextTop.strokeStyle=this.getPattern()},createPath:function(e){var t=this.callSuper("createPath",e),e=t._getLeftTopCoords().scalarAdd(t.strokeWidth/2);return t.stroke=new X.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-e.x,offsetY:-e.y}),t}}),function(){var e,s=X.util.getPointer,l=X.util.degreesToRadians,c=Math.abs,u=X.StaticCanvas.supports("setLineDash"),h=X.util.isTouchEvent;for(e in X.Canvas=X.util.createClass(X.StaticCanvas,{initialize:function(e,t){t=t||{},this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,t),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",rotationCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=X.PencilBrush&&new X.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var e,t,n,i=this.getActiveObjects();if(0<i.length&&!this.preserveObjectStacking){t=[],n=[];for(var o=0,r=this._objects.length;o<r;o++)e=this._objects[o],(-1===i.indexOf(e)?t:n).push(e);1<i.length&&(this._activeObject._objects=n),t.push.apply(t,n)}else t=this._objects;return t},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&this.renderTopLayer(this.contextTop);var e=this.contextContainer;return this.renderCanvas(e,this._chooseObjectsToRender()),this},renderTopLayer:function(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()},renderTop:function(){var e=this.contextTop;return this.clearContext(e),this.renderTopLayer(e),this.fire("after:render"),this},_normalizePointer:function(e,t){e=e.calcTransformMatrix(),e=X.util.invertTransform(e),t=this.restorePointerVpt(t);return X.util.transformPoint(t,e)},isTargetTransparent:function(e,t,n){if(e.shouldCache()&&e._cacheCanvas&&e!==this._activeObject){var i=this._normalizePointer(e,{x:t,y:n}),o=Math.max(e.cacheTranslationX+i.x*e.zoomX,0),r=Math.max(e.cacheTranslationY+i.y*e.zoomY,0);return X.util.isTransparent(e._cacheContext,Math.round(o),Math.round(r),this.targetFindTolerance)}i=this.contextCache,o=e.selectionBackgroundColor,r=this.viewportTransform;return e.selectionBackgroundColor="",this.clearContext(i),i.save(),i.transform(r[0],r[1],r[2],r[3],r[4],r[5]),e.render(i),i.restore(),e===this._activeObject&&e._renderControls(i,{hasBorders:!1,transparentCorners:!1},{hasBorders:!1}),e.selectionBackgroundColor=o,X.util.isTransparent(i,t,n,this.targetFindTolerance)},_isSelectionKeyPressed:function(t){return"[object Array]"===Object.prototype.toString.call(this.selectionKey)?!!this.selectionKey.find(function(e){return!0===t[e]}):t[this.selectionKey]},_shouldClearSelection:function(e,t){var n=this.getActiveObjects(),i=this._activeObject;return!t||t&&i&&1<n.length&&-1===n.indexOf(t)&&i!==t&&!this._isSelectionKeyPressed(e)||t&&!t.evented||t&&!t.selectable&&i&&i!==t},_shouldCenterTransform:function(e,t,n){var i;if(e)return"scale"===t||"scaleX"===t||"scaleY"===t||"resizing"===t?i=this.centeredScaling||e.centeredScaling:"rotate"===t&&(i=this.centeredRotation||e.centeredRotation),i?!n:n},_getOriginFromCorner:function(e,t){e={x:e.originX,y:e.originY};return"ml"===t||"tl"===t||"bl"===t?e.x="right":"mr"!==t&&"tr"!==t&&"br"!==t||(e.x="left"),"tl"===t||"mt"===t||"tr"===t?e.y="bottom":"bl"===t||"mb"===t||"br"===t?e.y="top":"mtr"===t&&(e.x="center",e.y="center"),e},_getActionFromCorner:function(e,t,n,i){if(!t||!e)return"drag";t=i.controls[t];return t.getActionName(n,t,i)},_setupCurrentTransform:function(e,t,n){var i,o,r,s,a;t&&(a=this.getPointer(e),o=!!(i=t.__corner)&&t.controls[i].getActionHandler(),r=this._getActionFromCorner(n,i,e,t),s=this._getOriginFromCorner(t,i),n=e[this.centeredKey],a={target:t,action:r,actionHandler:o,corner:i,scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,offsetX:a.x-t.left,offsetY:a.y-t.top,originX:s.x,originY:s.y,ex:a.x,ey:a.y,lastX:a.x,lastY:a.y,theta:l(t.angle),width:t.width*t.scaleX,shiftKey:e.shiftKey,altKey:n,original:X.util.saveObjectTransform(t)},this._shouldCenterTransform(t,r,n)&&(a.originX="center",a.originY="center"),a.original.originX=s.x,a.original.originY=s.y,this._currentTransform=a,this._beforeTransform(e))},_translateObject:function(e,t){var n=this._currentTransform,i=n.target,o=e-n.offsetX,e=t-n.offsetY,t=!i.get("lockMovementX")&&i.left!==o,n=!i.get("lockMovementY")&&i.top!==e;return t&&i.set("left",o),n&&i.set("top",e),t||n},setCursor:function(e){this.upperCanvasEl.style.cursor=e},_drawSelection:function(e){var t,n,i=this._groupSelector,o=i.left,r=i.top,s=c(o),a=c(r);this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(i.ex-(0<o?0:-o),i.ey-(0<r?0:-r),s,a)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,1<this.selectionDashArray.length&&!u?(t=i.ex+.5-(0<o?0:s),n=i.ey+.5-(0<r?0:a),e.beginPath(),X.util.drawDashedLine(e,t,n,t+s,n,this.selectionDashArray),X.util.drawDashedLine(e,t,n+a-1,t+s,n+a-1,this.selectionDashArray),X.util.drawDashedLine(e,t,n,t,n+a,this.selectionDashArray),X.util.drawDashedLine(e,t+s-1,n,t+s-1,n+a,this.selectionDashArray),e.closePath(),e.stroke()):(X.Object.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(i.ex+.5-(0<o?0:s),i.ey+.5-(0<r?0:a),s,a)))},findTarget:function(e,t){if(!this.skipTargetFind){var n,i,o=this.getPointer(e,!0),r=this._activeObject,s=this.getActiveObjects(),a=h(e);if(this.targets=[],1<s.length&&!t&&r===this._searchPossibleTargets([r],o))return r;if(1===s.length&&r._findTargetCorner(o,a))return r;if(1===s.length&&r===this._searchPossibleTargets([r],o)){if(!this.preserveObjectStacking)return r;n=r,i=this.targets,this.targets=[]}o=this._searchPossibleTargets(this._objects,o);return e[this.altSelectionKey]&&o&&n&&o!==n&&(o=n,this.targets=i),o}},_checkTarget:function(e,t,n){if(t&&t.visible&&t.evented&&(t.containsPoint(e)||t._findTargetCorner(e)))return!((this.perPixelTargetFind||t.perPixelTargetFind)&&!t.isEditing)||(!this.isTargetTransparent(t,n.x,n.y)||void 0)},_searchPossibleTargets:function(e,t){for(var n,i,o=e.length;o--;){var r=e[o],s=r.group?this._normalizePointer(r.group,t):t;if(this._checkTarget(s,r,t)){(n=e[o]).subTargetCheck&&n instanceof X.Group&&(i=this._searchPossibleTargets(n._objects,t))&&this.targets.push(i);break}}return n},restorePointerVpt:function(e){return X.util.transformPoint(e,X.util.invertTransform(this.viewportTransform))},getPointer:function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var n=s(e),i=this.upperCanvasEl,o=i.getBoundingClientRect(),r=o.width||0,e=o.height||0;r&&e||("top"in o&&"bottom"in o&&(e=Math.abs(o.top-o.bottom)),"right"in o&&"left"in o&&(r=Math.abs(o.right-o.left))),this.calcOffset(),n.x=n.x-this._offset.left,n.y=n.y-this._offset.top,t||(n=this.restorePointerVpt(n));t=this.getRetinaScaling();return 1!==t&&(n.x/=t,n.y/=t),e=0===r||0===e?{width:1,height:1}:{width:i.width/r,height:i.height/e},{x:n.x*e.width,y:n.y*e.height}},_createUpperCanvas:function(){var e=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),t=this.lowerCanvasEl,n=this.upperCanvasEl;n?n.className="":(n=this._createCanvasElement(),this.upperCanvasEl=n),X.util.addClass(n,"upper-canvas "+e),this.wrapperEl.appendChild(n),this._copyCanvasStyle(t,n),this._applyCanvasStyle(n),this.contextTop=n.getContext("2d")},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=X.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),X.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),X.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(e){var t=this.width||e.width,n=this.height||e.height;X.util.setStyle(e,{position:"absolute",width:t+"px",height:n+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),e.width=t,e.height=n,X.util.makeElementUnselectable(e)},_copyCanvasStyle:function(e,t){t.style.cssText=e.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var e=this._activeObject;return e?"activeSelection"===e.type&&e._objects?e._objects.slice(0):[e]:[]},_onObjectRemoved:function(e){e===this._activeObject&&(this.fire("before:selection:cleared",{target:e}),this._discardActiveObject(),this.fire("selection:cleared",{target:e}),e.fire("deselected")),e===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",e)},_fireSelectionEvents:function(t,e){var n=!1,i=this.getActiveObjects(),o=[],r=[],s={e:e};t.forEach(function(e){-1===i.indexOf(e)&&(n=!0,e.fire("deselected",s),r.push(e))}),i.forEach(function(e){-1===t.indexOf(e)&&(n=!0,e.fire("selected",s),o.push(e))}),0<t.length&&0<i.length?(s.selected=o,s.deselected=r,s.updated=o[0]||r[0],s.target=this._activeObject,n&&this.fire("selection:updated",s)):0<i.length?(s.selected=o,s.target=this._activeObject,this.fire("selection:created",s)):0<t.length&&(s.deselected=r,this.fire("selection:cleared",s))},setActiveObject:function(e,t){var n=this.getActiveObjects();return this._setActiveObject(e,t),this._fireSelectionEvents(n,t),this},_setActiveObject:function(e,t){return this._activeObject!==e&&!!this._discardActiveObject(t,e)&&!e.onSelect({e:t})&&(this._activeObject=e,!0)},_discardActiveObject:function(e,t){var n=this._activeObject;if(n){if(n.onDeselect({e:e,object:t}))return!1;this._activeObject=null}return!0},discardActiveObject:function(e){var t=this.getActiveObjects(),n=this.getActiveObject();return t.length&&this.fire("before:selection:cleared",{target:n,e:e}),this._discardActiveObject(e),this._fireSelectionEvents(t,e),this},dispose:function(){var e=this.wrapperEl;return this.removeListeners(),e.removeChild(this.upperCanvasEl),e.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach(function(e){X.util.cleanUpJsdomNode(this[e]),this[e]=void 0}.bind(this)),e.parentNode&&e.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,X.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(e){var t=this._activeObject;t&&t._renderControls(e)},_toObject:function(e,t,n){var i=this._realizeGroupTransformOnObject(e),n=this.callSuper("_toObject",e,t,n);return this._unwindGroupTransformOnObject(e,i),n},_realizeGroupTransformOnObject:function(t){if(t.group&&"activeSelection"===t.group.type&&this._activeObject===t.group){var n={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(e){n[e]=t[e]}),this._activeObject.realizeTransform(t),n}return null},_unwindGroupTransformOnObject:function(e,t){t&&e.set(t)},_setSVGObject:function(e,t,n){var i=this._realizeGroupTransformOnObject(t);this.callSuper("_setSVGObject",e,t,n),this._unwindGroupTransformOnObject(t,i)},setViewportTransform:function(e){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),X.StaticCanvas.prototype.setViewportTransform.call(this,e)}}),X.StaticCanvas)"prototype"!==e&&(X.Canvas[e]=X.StaticCanvas[e])}(),v=X.util.addListener,y=X.util.removeListener,x={passive:!1},X.util.object.extend(X.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(v,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(e,t){var n=this.upperCanvasEl,i=this._getEventPrefix();e(X.window,"resize",this._onResize),e(n,i+"down",this._onMouseDown),e(n,i+"move",this._onMouseMove,x),e(n,i+"out",this._onMouseOut),e(n,i+"enter",this._onMouseEnter),e(n,"wheel",this._onMouseWheel),e(n,"contextmenu",this._onContextMenu),e(n,"dblclick",this._onDoubleClick),e(n,"dragover",this._onDragOver),e(n,"dragenter",this._onDragEnter),e(n,"dragleave",this._onDragLeave),e(n,"drop",this._onDrop),this.enablePointerEvents||e(n,"touchstart",this._onTouchStart,x),"undefined"!=typeof eventjs&&t in eventjs&&(eventjs[t](n,"gesture",this._onGesture),eventjs[t](n,"drag",this._onDrag),eventjs[t](n,"orientation",this._onOrientationChange),eventjs[t](n,"shake",this._onShake),eventjs[t](n,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(y,"remove");var e=this._getEventPrefix();y(X.document,e+"up",this._onMouseUp),y(X.document,"touchend",this._onTouchEnd,x),y(X.document,e+"move",this._onMouseMove,x),y(X.document,"touchmove",this._onMouseMove,x)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._simpleEventHandler.bind(this,"drop"),this.eventsBound=!0)},_onGesture:function(e,t){this.__onTransformGesture&&this.__onTransformGesture(e,t)},_onDrag:function(e,t){this.__onDrag&&this.__onDrag(e,t)},_onMouseWheel:function(e){this.__onMouseWheel(e)},_onMouseOut:function(t){var n=this._hoveredTarget;this.fire("mouse:out",{target:n,e:t}),this._hoveredTarget=null,n&&n.fire("mouseout",{e:t});var i=this;this._hoveredTargets.forEach(function(e){i.fire("mouse:out",{target:n,e:t}),e&&n.fire("mouseout",{e:t})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(e){e.isEditing&&e.hiddenTextarea.focus()})},_onMouseEnter:function(e){this.currentTransform||this.findTarget(e)||(this.fire("mouse:over",{target:null,e:e}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(e,t){this.__onOrientationChange&&this.__onOrientationChange(e,t)},_onShake:function(e,t){this.__onShake&&this.__onShake(e,t)},_onLongPress:function(e,t){this.__onLongPress&&this.__onLongPress(e,t)},_onDragOver:function(e){e.preventDefault();var t=this._simpleEventHandler("dragover",e);this._fireEnterLeaveEvents(t,e)},_onContextMenu:function(e){return this.stopContextMenu&&(e.stopPropagation(),e.preventDefault()),!1},_onDoubleClick:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"dblclick"),this._resetTransformEventData(e)},getPointerId:function(e){var t=e.changedTouches;return t?t[0]&&t[0].identifier:this.enablePointerEvents?e.pointerId:-1},_isMainEvent:function(e){return!0===e.isPrimary||!1!==e.isPrimary&&("touchend"===e.type&&0===e.touches.length||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(e){e.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,e=this._getEventPrefix();v(X.document,"touchend",this._onTouchEnd,x),v(X.document,"touchmove",this._onMouseMove,x),y(t,e+"down",this._onMouseDown)},_onMouseDown:function(e){this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,e=this._getEventPrefix();y(t,e+"move",this._onMouseMove,x),v(X.document,e+"up",this._onMouseUp),v(X.document,e+"move",this._onMouseMove,x)},_onTouchEnd:function(e){var t,n;0<e.touches.length||(this.__onMouseUp(e),this._resetTransformEventData(),this.mainTouchId=null,t=this._getEventPrefix(),y(X.document,"touchend",this._onTouchEnd,x),y(X.document,"touchmove",this._onMouseMove,x),(n=this)._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){v(n.upperCanvasEl,t+"down",n._onMouseDown),n._willAddMouseDown=0},400))},_onMouseUp:function(e){this.__onMouseUp(e),this._resetTransformEventData();var t=this.upperCanvasEl,n=this._getEventPrefix();this._isMainEvent(e)&&(y(X.document,n+"up",this._onMouseUp),y(X.document,n+"move",this._onMouseMove,x),v(t,n+"move",this._onMouseMove,x))},_onMouseMove:function(e){!this.allowTouchScrolling&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)},_onResize:function(){this.calcOffset()},_shouldRender:function(e){var t=this._activeObject;return!!(!!t!=!!e||t&&e&&t!==e)||(t&&t.isEditing,!1)},__onMouseUp:function(e){var t,n=this._currentTransform,i=this._groupSelector,o=!1,r=!i||0===i.left&&0===i.top;if(this._cacheTransformEventData(e),i=this._target,this._handleEvent(e,"up:before"),ve(e,3))this.fireRightClick&&this._handleEvent(e,"up",3,r);else{if(ve(e,2))return this.fireMiddleClick&&this._handleEvent(e,"up",2,r),void this._resetTransformEventData();this.isDrawingMode&&this._isCurrentlyDrawing?this._onMouseUpInDrawingMode(e):this._isMainEvent(e)&&(n&&(this._finalizeCurrentTransform(e),o=n.actionPerformed),r||(t=i===this._activeObject,this._maybeGroupObjects(e),o=o||this._shouldRender(i)||!t&&i===this._activeObject),i&&(n=i._findTargetCorner(this.getPointer(e,!0),X.util.isTouchEvent(e)),(n=(t=i.controls[n])&&t.getMouseUpHandler(e,i,t))&&n(e,i,t),i.isMoving=!1),this._setCursorFromEvent(e,i),this._handleEvent(e,"up",1,r),this._groupSelector=null,this._currentTransform=null,i&&(i.__corner=0),o?this.requestRenderAll():r||this.renderTop())}},_simpleEventHandler:function(e,t){var n=this.findTarget(t),i=this.targets,o={e:t,target:n,subTargets:i};if(this.fire(e,o),n&&n.fire(e,o),!i)return n;for(var r=0;r<i.length;r++)i[r].fire(e,o);return n},_handleEvent:function(e,t,n,i){var o=this._target,r=this.targets||[],s={e:e,target:o,subTargets:r,button:n||1,isClick:i||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};this.fire("mouse:"+t,s),o&&o.fire("mouse"+t,s);for(var a=0;a<r.length;a++)r[a].fire("mouse"+t,s)},_finalizeCurrentTransform:function(e){var t=this._currentTransform,n=t.target,e={e:e,target:n,transform:t};n._scaling&&(n._scaling=!1),n.setCoords(),(t.actionPerformed||this.stateful&&n.hasStateChanged())&&(t.actionPerformed&&(t=this._addEventOptions(e,t),this._fire(t,e)),this._fire("modified",e))},_addEventOptions:function(e,t){var n,i;switch(t.action){case"scaleX":n="scaled",i="x";break;case"scaleY":n="scaled",i="y";break;case"skewX":n="skewed",i="x";break;case"skewY":n="skewed",i="y";break;case"scale":n="scaled",i="equally";break;case"rotate":n="rotated";break;case"drag":n="moved"}return e.by=i,n},_onMouseDownInDrawingMode:function(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(e).requestRenderAll();var t=this.getPointer(e);this.freeDrawingBrush.onMouseDown(t,{e:e,pointer:t}),this._handleEvent(e,"down")},_onMouseMoveInDrawingMode:function(e){var t;this._isCurrentlyDrawing&&(t=this.getPointer(e),this.freeDrawingBrush.onMouseMove(t,{e:e,pointer:t})),this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")},_onMouseUpInDrawingMode:function(e){var t=this.getPointer(e);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:e,pointer:t}),this._handleEvent(e,"up")},__onMouseDown:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"down:before");var t,n,i,o,r,s=this._target;ve(e,3)?this.fireRightClick&&this._handleEvent(e,"down",3):ve(e,2)?this.fireMiddleClick&&this._handleEvent(e,"down",2):this.isDrawingMode?this._onMouseDownInDrawingMode(e):this._isMainEvent(e)&&(this._currentTransform||(o=this._pointer,this._previousPointer=o,t=this._shouldRender(s),n=this._shouldGroup(e,s),this._shouldClearSelection(e,s)?this.discardActiveObject(e):n&&(this._handleGrouping(e,s),s=this._activeObject),!this.selection||s&&(s.selectable||s.isEditing||s===this._activeObject)||(this._groupSelector={ex:o.x,ey:o.y,top:0,left:0}),s&&(i=s===this._activeObject,s.selectable&&this.setActiveObject(s,e),r=s._findTargetCorner(this.getPointer(e,!0),X.util.isTouchEvent(e)),s.__corner=r,s!==this._activeObject||!r&&n||((r=(o=s.controls[r])&&o.getMouseDownHandler(e,s,o))&&r(e,s,o),this._setupCurrentTransform(e,s,i))),this._handleEvent(e,"down"),(t||n)&&this.requestRenderAll()))},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(e){this._resetTransformEventData(),this._pointer=this.getPointer(e,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)||null},_beforeTransform:function(e){var t=this._currentTransform;this.stateful&&t.target.saveState(),this.fire("before:transform",{e:e,transform:t})},__onMouseMove:function(e){var t,n;this._handleEvent(e,"move:before"),this._cacheTransformEventData(e),this.isDrawingMode?this._onMouseMoveInDrawingMode(e):this._isMainEvent(e)&&((n=this._groupSelector)?(t=this._pointer,n.left=t.x-n.ex,n.top=t.y-n.ey,this.renderTop()):this._currentTransform?this._transformObject(e):(n=this.findTarget(e)||null,this._setCursorFromEvent(e,n),this._fireOverOutEvents(n,e)),this._handleEvent(e,"move"),this._resetTransformEventData())},_fireOverOutEvents:function(e,t){var n=this._hoveredTarget,i=this._hoveredTargets,o=this.targets,r=Math.max(i.length,o.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:n,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var s=0;s<r;s++)this.fireSyntheticInOutEvents(o[s],t,{oldTarget:i[s],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(e,t){var n=this._draggedoverTarget,i=this._hoveredTargets,o=this.targets,r=Math.max(i.length,o.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:n,evtOut:"dragleave",evtIn:"dragenter"});for(var s=0;s<r;s++)this.fireSyntheticInOutEvents(o[s],t,{oldTarget:i[s],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=e},fireSyntheticInOutEvents:function(e,t,n){var i,o,r=n.oldTarget,s=r!==e,a=n.canvasEvtIn,l=n.canvasEvtOut;s&&(i={e:t,target:e,previousTarget:r},o={e:t,target:r,nextTarget:e}),t=e&&s,r&&s&&(l&&this.fire(l,o),r.fire(n.evtOut,o)),t&&(a&&this.fire(a,i),e.fire(n.evtIn,i))},__onMouseWheel:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()},_transformObject:function(e){var t=this.getPointer(e),n=this._currentTransform;n.reset=!1,n.target.isMoving=!0,n.shiftKey=e.shiftKey,n.altKey=e[this.centeredKey],this._performTransformAction(e,n,t),n.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(e,t,n){var i=n.x,o=n.y,r=t.action,s=!1,a=t.actionHandler,n={target:t.target,e:e,transform:t,pointer:n};"drag"===r?(s=this._translateObject(i,o))&&(this._fire("moving",n),this.setCursor(n.target.moveCursor||this.moveCursor)):a&&(s=a(e,t,i,o))&&this._fire(r,n),t.actionPerformed=t.actionPerformed||s},_fire:X.controlsUtils.fireEvent,_setCursorFromEvent:function(e,t){if(!t)return this.setCursor(this.defaultCursor),!1;var n=t.hoverCursor||this.hoverCursor,i=this._activeObject&&"activeSelection"===this._activeObject.type?this._activeObject:null,i=(!i||!i.contains(t))&&t._findTargetCorner(this.getPointer(e,!0));i?this.setCursor(this.getCornerCursor(i,t,e)):(t.subTargetCheck&&this.targets.concat().reverse().map(function(e){n=e.hoverCursor||n}),this.setCursor(n))},getCornerCursor:function(e,t,n){e=t.controls[e];return e.cursorStyleHandler(n,e,t)}}),w=Math.min,S=Math.max,X.util.object.extend(X.Canvas.prototype,{_shouldGroup:function(e,t){var n=this._activeObject;return n&&this._isSelectionKeyPressed(e)&&t&&t.selectable&&this.selection&&(n!==t||"activeSelection"===n.type)&&!t.onSelect({e:e})},_handleGrouping:function(e,t){var n=this._activeObject;n.__corner||(t!==n||(t=this.findTarget(e,!0))&&t.selectable)&&(n&&"activeSelection"===n.type?this._updateActiveSelection(t,e):this._createActiveSelection(t,e))},_updateActiveSelection:function(e,t){var n=this._activeObject,i=n._objects.slice(0);n.contains(e)?(n.removeWithUpdate(e),this._hoveredTarget=e,this._hoveredTargets=this.targets.concat(),1===n.size()&&this._setActiveObject(n.item(0),t)):(n.addWithUpdate(e),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(i,t)},_createActiveSelection:function(e,t){var n=this.getActiveObjects(),e=this._createGroup(e);this._hoveredTarget=e,this._setActiveObject(e,t),this._fireSelectionEvents(n,t)},_createGroup:function(e){var t=this._objects,e=t.indexOf(this._activeObject)<t.indexOf(e)?[this._activeObject,e]:[e,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new X.ActiveSelection(e,{canvas:this})},_groupSelectedObjects:function(e){var t=this._collectObjects(e);1===t.length?this.setActiveObject(t[0],e):1<t.length&&(t=new X.ActiveSelection(t.reverse(),{canvas:this}),this.setActiveObject(t,e))},_collectObjects:function(t){for(var e,n=[],i=this._groupSelector.ex,o=this._groupSelector.ey,r=i+this._groupSelector.left,s=o+this._groupSelector.top,a=new X.Point(w(i,r),w(o,s)),l=new X.Point(S(i,r),S(o,s)),c=!this.selectionFullyContained,u=i===r&&o===s,h=this._objects.length;h--&&!((e=this._objects[h])&&e.selectable&&e.visible&&(c&&e.intersectsWithRect(a,l)||e.isContainedWithinRect(a,l)||c&&e.containsPoint(a)||c&&e.containsPoint(l))&&(n.push(e),u)););return 1<n.length&&(n=n.filter(function(e){return!e.onSelect({e:t})})),n},_maybeGroupObjects:function(e){this.selection&&this._groupSelector&&this._groupSelectedObjects(e),this.setCursor(this.defaultCursor),this._groupSelector=null}}),X.util.object.extend(X.StaticCanvas.prototype,{toDataURL:function(e){var t=(e=e||{}).format||"png",n=e.quality||1,i=(e.multiplier||1)*(e.enableRetinaScaling?this.getRetinaScaling():1),e=this.toCanvasElement(i,e);return X.util.toDataURL(e,t,n)},toCanvasElement:function(e,t){e=e||1;var n=((t=t||{}).width||this.width)*e,i=(t.height||this.height)*e,o=this.getZoom(),r=this.width,s=this.height,a=o*e,l=this.viewportTransform,c=(l[4]-(t.left||0))*e,o=(l[5]-(t.top||0))*e,t=this.interactive,e=[a,0,0,a,c,o],a=this.enableRetinaScaling,c=X.util.createCanvasElement(),o=this.contextTop;return c.width=n,c.height=i,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=e,this.width=n,this.height=i,this.calcViewportBoundaries(),this.renderCanvas(c.getContext("2d"),this._objects),this.viewportTransform=l,this.width=r,this.height=s,this.calcViewportBoundaries(),this.interactive=t,this.enableRetinaScaling=a,this.contextTop=o,c}}),X.util.object.extend(X.StaticCanvas.prototype,{loadFromJSON:function(e,n,t){if(e){var i="string"==typeof e?JSON.parse(e):X.util.object.clone(e),o=this,r=i.clipPath,s=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete i.clipPath,this._enlivenObjects(i.objects,function(t){o.clear(),o._setBgOverlay(i,function(){r?o._enlivenObjects([r],function(e){o.clipPath=e[0],o.__setupCanvas.call(o,i,t,s,n)}):o.__setupCanvas.call(o,i,t,s,n)})},t),this}},__setupCanvas:function(e,t,n,i){var o=this;t.forEach(function(e,t){o.insertAt(e,t)}),this.renderOnAddRemove=n,delete e.objects,delete e.backgroundImage,delete e.overlayImage,delete e.background,delete e.overlay,this._setOptions(e),this.renderAll(),i&&i()},_setBgOverlay:function(e,t){var n,i={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};e.backgroundImage||e.overlayImage||e.background||e.overlay?(n=function(){i.backgroundImage&&i.overlayImage&&i.backgroundColor&&i.overlayColor&&t&&t()},this.__setBgOverlay("backgroundImage",e.backgroundImage,i,n),this.__setBgOverlay("overlayImage",e.overlayImage,i,n),this.__setBgOverlay("backgroundColor",e.background,i,n),this.__setBgOverlay("overlayColor",e.overlay,i,n)):t&&t()},__setBgOverlay:function(t,e,n,i){var o=this;if(!e)return n[t]=!0,void(i&&i());"backgroundImage"===t||"overlayImage"===t?X.util.enlivenObjects([e],function(e){o[t]=e[0],n[t]=!0,i&&i()}):this["set"+X.util.string.capitalize(t,!0)](e,function(){n[t]=!0,i&&i()})},_enlivenObjects:function(e,t,n){e&&0!==e.length?X.util.enlivenObjects(e,function(e){t&&t(e)},null,n):t&&t([])},_toDataURL:function(t,n){this.clone(function(e){n(e.toDataURL(t))})},_toDataURLWithMultiplier:function(t,n,i){this.clone(function(e){i(e.toDataURLWithMultiplier(t,n))})},clone:function(t,e){var n=JSON.stringify(this.toJSON(e));this.cloneWithoutData(function(e){e.loadFromJSON(n,function(){t&&t(e)})})},cloneWithoutData:function(e){var t=X.util.createCanvasElement();t.width=this.width,t.height=this.height;var n=new X.Canvas(t);this.backgroundImage?(n.setBackgroundImage(this.backgroundImage.src,function(){n.renderAll(),e&&e(n)}),n.backgroundImageOpacity=this.backgroundImageOpacity,n.backgroundImageStretch=this.backgroundImageStretch):e&&e(n)}}),function(){"use strict";var p=Se.fabric||(Se.fabric={}),e=p.util.object.extend,r=p.util.object.clone,n=p.util.toFixed,t=p.util.string.capitalize,s=p.util.degreesToRadians,i=p.StaticCanvas.supports("setLineDash"),o=!p.isLikelyNode;p.Object||(p.Object=p.util.createClass(p.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:o,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(e){e&&this.setOptions(e)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=p.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(e){var t=p.perfLimitSizeTotal,n=e.width,i=e.height,o=p.maxCacheSideLimit,r=p.minCacheSideLimit;if(n<=o&&i<=o&&n*i<=t)return n<r&&(e.width=r),i<r&&(e.height=r),e;var s=n/i,a=p.util.limitDimsByArea(s,t),s=p.util.capValue,t=s(r,a.x,o),o=s(r,a.y,o);return t<n&&(e.zoomX/=n/t,e.width=t,e.capped=!0),o<i&&(e.zoomY/=i/o,e.height=o,e.capped=!0),e},_getCacheCanvasDimensions:function(){var e=this.getTotalObjectScaling(),t=this._getTransformedDimensions(0,0),n=t.x*e.scaleX/this.scaleX,t=t.y*e.scaleY/this.scaleY;return{width:2+n,height:2+t,zoomX:e.scaleX,zoomY:e.scaleY,x:n,y:t}},_updateCacheCanvas:function(){var e=this.canvas;if(this.noScaleCache&&e&&e._currentTransform){var t=e._currentTransform.target,n=e._currentTransform.action;if(this===t&&n.slice&&"scale"===n.slice(0,5))return!1}var i=this._cacheCanvas,o=this._limitCacheSize(this._getCacheCanvasDimensions()),r=p.minCacheSideLimit,s=o.width,a=o.height,l=o.zoomX,c=o.zoomY,u=s!==this.cacheWidth||a!==this.cacheHeight,h=this.zoomX!==l||this.zoomY!==c,d=u||h,f=0,e=0,t=!1;return u&&(n=this._cacheCanvas.width,h=this._cacheCanvas.height,t=(u=n<s||h<a)||(s<.9*n||a<.9*h)&&r<n&&r<h,u&&!o.capped&&(r<s||r<a)&&(f=.1*s,e=.1*a)),d&&(t?(i.width=Math.ceil(s+f),i.height=Math.ceil(a+e)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,i.width,i.height)),e=o.x/2,o=o.y/2,this.cacheTranslationX=Math.round(i.width/2-e)+e,this.cacheTranslationY=Math.round(i.height/2-o)+o,this.cacheWidth=s,this.cacheHeight=a,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(l,c),this.zoomX=l,this.zoomY=c,!0)},setOptions:function(e){this._setOptions(e),this._initGradient(e.fill,"fill"),this._initGradient(e.stroke,"stroke"),this._initPattern(e.fill,"fill"),this._initPattern(e.stroke,"stroke")},transform:function(e){var t=this.group&&!this.group._transformDone||this.group&&this.canvas&&e===this.canvas.contextTop,t=this.calcTransformMatrix(!t);e.transform(t[0],t[1],t[2],t[3],t[4],t[5])},toObject:function(e){var t=p.Object.NUM_FRACTION_DIGITS,t={type:this.type,version:p.version,originX:this.originX,originY:this.originY,left:n(this.left,t),top:n(this.top,t),width:n(this.width,t),height:n(this.height,t),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:n(this.strokeWidth,t),strokeDashArray:this.strokeDashArray&&this.strokeDashArray.concat(),strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeMiterLimit:n(this.strokeMiterLimit,t),scaleX:n(this.scaleX,t),scaleY:n(this.scaleY,t),angle:n(this.angle,t),flipX:this.flipX,flipY:this.flipY,opacity:n(this.opacity,t),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:n(this.skewX,t),skewY:n(this.skewY,t)};return this.clipPath&&(t.clipPath=this.clipPath.toObject(e),t.clipPath.inverted=this.clipPath.inverted,t.clipPath.absolutePositioned=this.clipPath.absolutePositioned),p.util.populateWithProperties(this,t,e),this.includeDefaultValues||(t=this._removeDefaultValues(t)),t},toDatalessObject:function(e){return this.toObject(e)},_removeDefaultValues:function(t){var n=p.util.getKlass(t.type).prototype;return n.stateProperties.forEach(function(e){"left"!==e&&"top"!==e&&(t[e]===n[e]&&delete t[e],"[object Array]"===Object.prototype.toString.call(t[e])&&"[object Array]"===Object.prototype.toString.call(n[e])&&0===t[e].length&&0===n[e].length&&delete t[e])}),t},toString:function(){return"#<fabric."+t(this.type)+">"},getObjectScaling:function(){var e=p.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(e.scaleX),scaleY:Math.abs(e.scaleY)}},getTotalObjectScaling:function(){var e,t=this.getObjectScaling(),n=t.scaleX,i=t.scaleY;return this.canvas&&(n*=(e=this.canvas.getZoom())*(t=this.canvas.getRetinaScaling()),i*=e*t),{scaleX:n,scaleY:i}},getObjectOpacity:function(){var e=this.opacity;return this.group&&(e*=this.group.getObjectOpacity()),e},_set:function(e,t){var n="scaleX"===e||"scaleY"===e,i=this[e]!==t;return n&&(t=this._constrainScale(t)),"scaleX"===e&&t<0?(this.flipX=!this.flipX,t*=-1):"scaleY"===e&&t<0?(this.flipY=!this.flipY,t*=-1):"shadow"!==e||!t||t instanceof p.Shadow?"dirty"===e&&this.group&&this.group.set("dirty",t):t=new p.Shadow(t),this[e]=t,i&&(i=this.group&&this.group.isOnACache(),-1<this.cacheProperties.indexOf(e)?(this.dirty=!0,i&&this.group.set("dirty",!0)):i&&-1<this.stateProperties.indexOf(e)&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:p.iMatrix.concat()},isNotVisible:function(){return 0===this.opacity||!this.width&&!this.height&&0===this.strokeWidth||!this.visible},render:function(e){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(e.save(),this._setupCompositeOperation(e),this.drawSelectionBackground(e),this.transform(e),this._setOpacity(e),this._setShadow(e,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(e)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(e),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),e.restore())},renderCache:function(e){e=e||{},this._cacheCanvas||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,e.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&"transparent"!==this.stroke&&0!==this.strokeWidth},hasFill:function(){return this.fill&&"transparent"!==this.fill},needsItsOwnCache:function(){return!("stroke"!==this.paintFirst||!this.hasFill()||!this.hasStroke()||"object"!=typeof this.shadow)||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)},drawClipPathOnCache:function(e){var t,n=this.clipPath;e.save(),n.inverted?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="destination-in",n.absolutePositioned&&(t=p.util.invertTransform(this.calcTransformMatrix()),e.transform(t[0],t[1],t[2],t[3],t[4],t[5])),n.transform(e),e.scale(1/n.zoomX,1/n.zoomY),e.drawImage(n._cacheCanvas,-n.cacheTranslationX,-n.cacheTranslationY),e.restore()},drawObject:function(e,t){var n=this.fill,i=this.stroke;t?(this.fill="black",this.stroke="",this._setClippingProperties(e)):(this._renderBackground(e),this._setStrokeStyles(e,this),this._setFillStyles(e,this)),this._render(e),this._drawClipPath(e),this.fill=n,this.stroke=i},_drawClipPath:function(e){var t=this.clipPath;t&&(t.canvas=this.canvas,t.shouldCache(),t._transformDone=!0,t.renderCache({forClipping:!0}),this.drawClipPathOnCache(e))},drawCacheOnCanvas:function(e){e.scale(1/this.zoomX,1/this.zoomY),e.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(e){return!(this.isNotVisible()||(!this._cacheCanvas||e||!this._updateCacheCanvas())&&(!(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties"))||(this._cacheCanvas&&!e&&(t=this.cacheWidth/this.zoomX,e=this.cacheHeight/this.zoomY,this._cacheContext.clearRect(-t/2,-e/2,t,e)),0)));var t},_renderBackground:function(e){var t;this.backgroundColor&&(t=this._getNonTransformedDimensions(),e.fillStyle=this.backgroundColor,e.fillRect(-t.x/2,-t.y/2,t.x,t.y),this._removeShadow(e))},_setOpacity:function(e){this.group&&!this.group._transformDone?e.globalAlpha=this.getObjectOpacity():e.globalAlpha*=this.opacity},_setStrokeStyles:function(e,t){t.stroke&&(e.lineWidth=t.strokeWidth,e.lineCap=t.strokeLineCap,e.lineDashOffset=t.strokeDashOffset,e.lineJoin=t.strokeLineJoin,e.miterLimit=t.strokeMiterLimit,e.strokeStyle=t.stroke.toLive?t.stroke.toLive(e,this):t.stroke)},_setFillStyles:function(e,t){t.fill&&(e.fillStyle=t.fill.toLive?t.fill.toLive(e,this):t.fill)},_setClippingProperties:function(e){e.globalAlpha=1,e.strokeStyle="transparent",e.fillStyle="#000000"},_setLineDash:function(e,t,n){t&&0!==t.length&&(1&t.length&&t.push.apply(t,t),i?e.setLineDash(t):n&&n(e))},_renderControls:function(e,t){var n=this.getViewportTransform(),i=this.calcTransformMatrix(),o=(void 0!==(t=t||{}).hasBorders?t:this).hasBorders,r=(void 0!==t.hasControls?t:this).hasControls,i=p.util.multiplyTransformMatrices(n,i),i=p.util.qrDecompose(i);e.save(),e.translate(i.translateX,i.translateY),e.lineWidth=+this.borderScaleFactor,this.group||(e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),t.forActiveSelection?(e.rotate(s(i.angle)),o&&this.drawBordersInGroup(e,i,t)):(e.rotate(s(this.angle)),o&&this.drawBorders(e,t)),r&&this.drawControls(e,t),e.restore()},_setShadow:function(e){var t,n,i,o,r;this.shadow&&(t=this.shadow,i=(n=this.canvas)&&n.viewportTransform[0]||1,o=n&&n.viewportTransform[3]||1,r=t.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),n&&n._isRetinaScaling()&&(i*=p.devicePixelRatio,o*=p.devicePixelRatio),e.shadowColor=t.color,e.shadowBlur=t.blur*p.browserShadowBlurConstant*(i+o)*(r.scaleX+r.scaleY)/4,e.shadowOffsetX=t.offsetX*i*r.scaleX,e.shadowOffsetY=t.offsetY*o*r.scaleY)},_removeShadow:function(e){this.shadow&&(e.shadowColor="",e.shadowBlur=e.shadowOffsetX=e.shadowOffsetY=0)},_applyPatternGradientTransform:function(e,t){if(!t||!t.toLive)return{offsetX:0,offsetY:0};var n=t.gradientTransform||t.patternTransform,i=-this.width/2+t.offsetX||0,o=-this.height/2+t.offsetY||0;return"percentage"===t.gradientUnits?e.transform(this.width,0,0,this.height,i,o):e.transform(1,0,0,1,i,o),n&&e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),{offsetX:i,offsetY:o}},_renderPaintInOrder:function(e){"stroke"===this.paintFirst?(this._renderStroke(e),this._renderFill(e)):(this._renderFill(e),this._renderStroke(e))},_render:function(){},_renderFill:function(e){this.fill&&(e.save(),this._applyPatternGradientTransform(e,this.fill),"evenodd"===this.fillRule?e.fill("evenodd"):e.fill(),e.restore())},_renderStroke:function(e){var t;this.stroke&&0!==this.strokeWidth&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this.strokeUniform&&this.group?(t=this.getObjectScaling(),e.scale(1/t.scaleX,1/t.scaleY)):this.strokeUniform&&e.scale(1/this.scaleX,1/this.scaleY),this._setLineDash(e,this.strokeDashArray,this._renderDashedStroke),this.stroke.toLive&&"percentage"===this.stroke.gradientUnits?this._applyPatternForTransformedGradient(e,this.stroke):this._applyPatternGradientTransform(e,this.stroke),e.stroke(),e.restore())},_applyPatternForTransformedGradient:function(e,t){var n,i=this._limitCacheSize(this._getCacheCanvasDimensions()),o=p.util.createCanvasElement(),r=this.canvas.getRetinaScaling(),s=i.x/this.scaleX/r,a=i.y/this.scaleY/r;o.width=s,o.height=a,(n=o.getContext("2d")).beginPath(),n.moveTo(0,0),n.lineTo(s,0),n.lineTo(s,a),n.lineTo(0,a),n.closePath(),n.translate(s/2,a/2),n.scale(i.zoomX/this.scaleX/r,i.zoomY/this.scaleY/r),this._applyPatternGradientTransform(n,t),n.fillStyle=t.toLive(e),n.fill(),e.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),e.scale(r*this.scaleX/i.zoomX,r*this.scaleY/i.zoomY),e.strokeStyle=n.createPattern(o,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){var e;this.transformMatrix&&(e=p.util.qrDecompose(this.transformMatrix),this.flipX=!1,this.flipY=!1,this.set("scaleX",e.scaleX),this.set("scaleY",e.scaleY),this.angle=e.angle,this.skewX=e.skewX,this.skewY=0)},_removeTransformMatrix:function(e){var t=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),t=p.util.transformPoint(t,this.transformMatrix)),this.transformMatrix=null,e&&(this.scaleX*=e.scaleX,this.scaleY*=e.scaleY,this.cropX=e.cropX,this.cropY=e.cropY,t.x+=e.offsetLeft,t.y+=e.offsetTop,this.width=e.width,this.height=e.height),this.setPositionByOrigin(t,"center","center")},clone:function(e,t){t=this.toObject(t);this.constructor.fromObject?this.constructor.fromObject(t,e):p.Object._fromObject("Object",t,e)},cloneAsImage:function(e,t){t=this.toCanvasElement(t);return e&&e(new p.Image(t)),this},toCanvasElement:function(e){e=e||{};var t=p.util,n=t.saveObjectTransform(this),i=this.group,o=this.shadow,r=Math.abs,s=(e.multiplier||1)*(e.enableRetinaScaling?p.devicePixelRatio:1);delete this.group,e.withoutTransform&&t.resetObjectTransform(this),e.withoutShadow&&(this.shadow=null);var a,l=p.util.createCanvasElement(),c=this.getBoundingRect(!0,!0),u=this.shadow,h={x:0,y:0};u&&(t=u.blur,a=u.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),h.x=2*Math.round(r(u.offsetX)+t)*r(a.scaleX),h.y=2*Math.round(r(u.offsetY)+t)*r(a.scaleY)),a=c.width+h.x,h=c.height+h.y,l.width=Math.ceil(a),l.height=Math.ceil(h);h=new p.StaticCanvas(l,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});"jpeg"===e.format&&(h.backgroundColor="#fff"),this.setPositionByOrigin(new p.Point(h.width/2,h.height/2),"center","center");l=this.canvas;h.add(this);e=h.toCanvasElement(s||1,e);return this.shadow=o,this.set("canvas",l),i&&(this.group=i),this.set(n).setCoords(),h._objects=[],h.dispose(),h=null,e},toDataURL:function(e){return e=e||{},p.util.toDataURL(this.toCanvasElement(e),e.format||"png",e.quality||1)},isType:function(e){return this.type===e},complexity:function(){return 1},toJSON:function(e){return this.toObject(e)},rotate:function(e){var t=("center"!==this.originX||"center"!==this.originY)&&this.centeredRotation;return t&&this._setOriginToCenter(),this.set("angle",e),t&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(e,t){t=t||this.canvas.getPointer(e);e=new p.Point(t.x,t.y),t=this._getLeftTopCoords();return this.angle&&(e=p.util.rotatePoint(e,t,s(-this.angle))),{x:e.x-t.x,y:e.y-t.y}},_setupCompositeOperation:function(e){this.globalCompositeOperation&&(e.globalCompositeOperation=this.globalCompositeOperation)}}),p.util.createAccessors&&p.util.createAccessors(p.Object),e(p.Object.prototype,p.Observable),p.Object.NUM_FRACTION_DIGITS=2,p.Object._fromObject=function(e,t,n,i){var o=p[e];t=r(t,!0),p.util.enlivenPatterns([t.fill,t.stroke],function(e){void 0!==e[0]&&(t.fill=e[0]),void 0!==e[1]&&(t.stroke=e[1]),p.util.enlivenObjects([t.clipPath],function(e){t.clipPath=e[0];e=i?new o(t[i],t):new o(t);n&&n(e)})})},p.Object.__uid=0)}(),_=X.util.degreesToRadians,E={left:-.5,center:0,right:.5},k={top:-.5,center:0,bottom:.5},X.util.object.extend(X.Object.prototype,{translateToGivenOrigin:function(e,t,n,i,o){var r=e.x,s=e.y;return"string"==typeof t?t=E[t]:t-=.5,"string"==typeof i?i=E[i]:i-=.5,"string"==typeof n?n=k[n]:n-=.5,"string"==typeof o?o=k[o]:o-=.5,n=o-n,((i=i-t)||n)&&(t=this._getTransformedDimensions(),r=e.x+i*t.x,s=e.y+n*t.y),new X.Point(r,s)},translateToCenterPoint:function(e,t,n){n=this.translateToGivenOrigin(e,t,n,"center","center");return this.angle?X.util.rotatePoint(n,e,_(this.angle)):n},translateToOriginPoint:function(e,t,n){n=this.translateToGivenOrigin(e,"center","center",t,n);return this.angle?X.util.rotatePoint(n,e,_(this.angle)):n},getCenterPoint:function(){var e=new X.Point(this.left,this.top);return this.translateToCenterPoint(e,this.originX,this.originY)},getPointByOrigin:function(e,t){var n=this.getCenterPoint();return this.translateToOriginPoint(n,e,t)},toLocalPoint:function(e,t,n){var i=this.getCenterPoint(),n=void 0!==t&&void 0!==n?this.translateToGivenOrigin(i,"center","center",t,n):new X.Point(this.left,this.top),e=new X.Point(e.x,e.y);return this.angle&&(e=X.util.rotatePoint(e,i,-_(this.angle))),e.subtractEquals(n)},setPositionByOrigin:function(e,t,n){n=this.translateToCenterPoint(e,t,n),n=this.translateToOriginPoint(n,this.originX,this.originY);this.set("left",n.x),this.set("top",n.y)},adjustPosition:function(e){var t=_(this.angle),n=this.getScaledWidth(),i=X.util.cos(t)*n,o=X.util.sin(t)*n,t="string"==typeof this.originX?E[this.originX]:this.originX-.5,n="string"==typeof e?E[e]:e-.5;this.left+=i*(n-t),this.top+=o*(n-t),this.setCoords(),this.originX=e},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var e=this.getCenterPoint();this.originX="center",this.originY="center",this.left=e.x,this.top=e.y},_resetOrigin:function(){var e=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=e.x,this.top=e.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),A=X.util,O=A.degreesToRadians,N=A.multiplyTransformMatrices,P=A.transformPoint,A.object.extend(X.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(e,t){return t?e?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),e?this.aCoords:this.lineCoords)},getCoords:function(e,t){return t=this._getCoords(e,t),[new X.Point(t.tl.x,t.tl.y),new X.Point(t.tr.x,t.tr.y),new X.Point(t.br.x,t.br.y),new X.Point(t.bl.x,t.bl.y)]},intersectsWithRect:function(e,t,n,i){i=this.getCoords(n,i);return"Intersection"===X.Intersection.intersectPolygonRectangle(i,e,t).status},intersectsWithObject:function(e,t,n){return"Intersection"===X.Intersection.intersectPolygonPolygon(this.getCoords(t,n),e.getCoords(t,n)).status||e.isContainedWithinObject(this,t,n)||this.isContainedWithinObject(e,t,n)},isContainedWithinObject:function(e,t,n){for(var i=this.getCoords(t,n),t=t?e.aCoords:e.lineCoords,o=0,r=e._getImageLines(t);o<4;o++)if(!e.containsPoint(i[o],r))return!1;return!0},isContainedWithinRect:function(e,t,n,i){i=this.getBoundingRect(n,i);return i.left>=e.x&&i.left+i.width<=t.x&&i.top>=e.y&&i.top+i.height<=t.y},containsPoint:function(e,t,n,i){i=this._getCoords(n,i),t=t||this._getImageLines(i),t=this._findCrossPoints(e,t);return 0!==t&&t%2==1},isOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,n=this.canvas.vptCoords.br;return!!this.getCoords(!0,e).some(function(e){return e.x<=n.x&&e.x>=t.x&&e.y<=n.y&&e.y>=t.y})||!!this.intersectsWithRect(t,n,!0,e)||this._containsCenterOfCanvas(t,n,e)},_containsCenterOfCanvas:function(e,t,n){t={x:(e.x+t.x)/2,y:(e.y+t.y)/2};return!!this.containsPoint(t,null,!0,n)},isPartiallyOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,n=this.canvas.vptCoords.br;return!!this.intersectsWithRect(t,n,!0,e)||this.getCoords(!0,e).every(function(e){return(e.x>=n.x||e.x<=t.x)&&(e.y>=n.y||e.y<=t.y)})&&this._containsCenterOfCanvas(t,n,e)},_getImageLines:function(e){return{topline:{o:e.tl,d:e.tr},rightline:{o:e.tr,d:e.br},bottomline:{o:e.br,d:e.bl},leftline:{o:e.bl,d:e.tl}}},_findCrossPoints:function(e,t){var n,i,o,r=0;for(o in t)if(!((i=t[o]).o.y<e.y&&i.d.y<e.y||i.o.y>=e.y&&i.d.y>=e.y||((i.o.x===i.d.x&&i.o.x>=e.x?i.o.x:(n=(i.d.y-i.o.y)/(i.d.x-i.o.x),-(e.y-0*e.x-(i.o.y-n*i.o.x))/(0-n)))>=e.x&&(r+=1),2!==r)))break;return r},getBoundingRect:function(e,t){t=this.getCoords(e,t);return A.makeBoundingBoxFromPoints(t)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(e){return Math.abs(e)<this.minScaleLimit?e<0?-this.minScaleLimit:this.minScaleLimit:0===e?1e-4:e},scale:function(e){return this._set("scaleX",e),this._set("scaleY",e),this.setCoords()},scaleToWidth:function(e,t){t=this.getBoundingRect(t).width/this.getScaledWidth();return this.scale(e/this.width/t)},scaleToHeight:function(e,t){t=this.getBoundingRect(t).height/this.getScaledHeight();return this.scale(e/this.height/t)},calcCoords:function(e){return e?this.calcACoords():this.calcOCoords()},calcLineCoords:function(){var e=this.getViewportTransform(),t=this.padding,n=O(this.angle),i=A.cos(n)*t,o=A.sin(n)*t,n=i+o,i=i-o,o=this.calcACoords(),e={tl:P(o.tl,e),tr:P(o.tr,e),bl:P(o.bl,e),br:P(o.br,e)};return t&&(e.tl.x-=i,e.tl.y-=n,e.tr.x+=n,e.tr.y-=i,e.bl.x-=n,e.bl.y+=i,e.br.x+=i,e.br.y+=n),e},calcOCoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),n=this.getViewportTransform(),t=N(n,t),i=N(t,e),i=N(i,[1/n[0],0,0,1/n[3],0,0]),o=this._calculateCurrentDimensions(),r={};return this.forEachControl(function(e,t,n){r[t]=e.positionHandler(o,i,n)}),r},calcACoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),n=N(t,e),t=this._getTransformedDimensions(),e=t.x/2,t=t.y/2;return{tl:P({x:-e,y:-t},n),tr:P({x:e,y:-t},n),bl:P({x:-e,y:t},n),br:P({x:e,y:t},n)}},setCoords:function(e){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),e||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return A.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var e=this.getCenterPoint();return[1,0,0,1,e.x,e.y]},transformMatrixKey:function(e){var t="";return!e&&this.group&&(t=this.group.transformMatrixKey(e)+"_"),t+this.top+"_"+this.left+"_"+this.scaleX+"_"+this.scaleY+"_"+this.skewX+"_"+this.skewY+"_"+this.angle+"_"+this.originX+"_"+this.originY+"_"+this.width+"_"+this.height+"_"+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(e){var t=this.calcOwnMatrix();if(e||!this.group)return t;var n=this.transformMatrixKey(e),e=this.matrixCache||(this.matrixCache={});return e.key===n?e.value:(this.group&&(t=N(this.group.calcTransformMatrix(!1),t)),e.key=n,e.value=t)},calcOwnMatrix:function(){var e=this.transformMatrixKey(!0),t=this.ownMatrixCache||(this.ownMatrixCache={});if(t.key===e)return t.value;var n=this._calcTranslateMatrix(),n={angle:this.angle,translateX:n[4],translateY:n[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return t.key=e,t.value=A.composeMatrix(n),t.value},_calcDimensionsTransformMatrix:function(e,t,n){return A.calcDimensionsMatrix({skewX:e,skewY:t,scaleX:this.scaleX*(n&&this.flipX?-1:1),scaleY:this.scaleY*(n&&this.flipY?-1:1)})},_getNonTransformedDimensions:function(){var e=this.strokeWidth;return{x:this.width+e,y:this.height+e}},_getTransformedDimensions:function(e,t){void 0===e&&(e=this.skewX),void 0===t&&(t=this.skewY);var n,i=this._getNonTransformedDimensions(),o=0===e&&0===t,i=this.strokeUniform?(n=this.width,this.height):(n=i.x,i.y);if(o)return this._finalizeDimensions(n*this.scaleX,i*this.scaleY);t=A.sizeAfterTransform(n,i,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:e,skewY:t});return this._finalizeDimensions(t.x,t.y)},_finalizeDimensions:function(e,t){return this.strokeUniform?{x:e+this.strokeWidth,y:t+this.strokeWidth}:{x:e,y:t}},_calculateCurrentDimensions:function(){var e=this.getViewportTransform(),t=this._getTransformedDimensions();return P(t,e,!0).scalarAdd(2*this.padding)}}),X.util.object.extend(X.Object.prototype,{sendToBack:function(){return this.group?X.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?X.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(e){return this.group?X.StaticCanvas.prototype.sendBackwards.call(this.group,this,e):this.canvas&&this.canvas.sendBackwards(this,e),this},bringForward:function(e){return this.group?X.StaticCanvas.prototype.bringForward.call(this.group,this,e):this.canvas&&this.canvas.bringForward(this,e),this},moveTo:function(e){return this.group&&"activeSelection"!==this.group.type?X.StaticCanvas.prototype.moveTo.call(this.group,this,e):this.canvas&&this.canvas.moveTo(this,e),this}}),F=X.util.toFixed,X.util.object.extend(X.Object.prototype,{getSvgStyles:function(e){var t=this.fillRule||"nonzero",n=this.strokeWidth||"0",i=this.strokeDashArray?this.strokeDashArray.join(" "):"none",o=this.strokeDashOffset||"0",r=this.strokeLineCap||"butt",s=this.strokeLineJoin||"miter",a=this.strokeMiterLimit||"4",l=void 0!==this.opacity?this.opacity:"1",c=this.visible?"":" visibility: hidden;",u=e?"":this.getSvgFilter(),e=ye("fill",this.fill);return[ye("stroke",this.stroke),"stroke-width: ",n,"; ","stroke-dasharray: ",i,"; ","stroke-linecap: ",r,"; ","stroke-dashoffset: ",o,"; ","stroke-linejoin: ",s,"; ","stroke-miterlimit: ",a,"; ",e,"fill-rule: ",t,"; ","opacity: ",l,";",u,c].join("")},getSvgSpanStyles:function(e,t){var n=e.fontFamily?"font-family: "+(-1===e.fontFamily.indexOf("'")&&-1===e.fontFamily.indexOf('"')?"'"+e.fontFamily+"'":e.fontFamily)+"; ":"",i=e.strokeWidth?"stroke-width: "+e.strokeWidth+"; ":"",n=n,o=e.fontSize?"font-size: "+e.fontSize+"px; ":"",r=e.fontStyle?"font-style: "+e.fontStyle+"; ":"",s=e.fontWeight?"font-weight: "+e.fontWeight+"; ":"",a=e.fill?ye("fill",e.fill):"",l=e.stroke?ye("stroke",e.stroke):"",c=this.getSvgTextDecoration(e);return[l,i,n,o,r,s,c=c&&"text-decoration: "+c+"; ",a,e.deltaY?"baseline-shift: "+-e.deltaY+"; ":"",t?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(t){return["overline","underline","line-through"].filter(function(e){return t[e.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(e,t){e=e?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+X.util.matrixToSVG(e)+(t||"")+'" '},_setSVGBg:function(e){var t;this.backgroundColor&&(t=X.Object.NUM_FRACTION_DIGITS,e.push("\t\t<rect ",this._getFillAttributes(this.backgroundColor),' x="',F(-this.width/2,t),'" y="',F(-this.height/2,t),'" width="',F(this.width,t),'" height="',F(this.height,t),'"></rect>\n'))},toSVG:function(e){return this._createBaseSVGMarkup(this._toSVG(e),{reviver:e})},toClipPathSVG:function(e){return"\t"+this._createBaseClipPathSVGMarkup(this._toSVG(e),{reviver:e})},_createBaseClipPathSVGMarkup:function(e,t){var n=(t=t||{}).reviver,i=t.additionalTransform||"",t=[this.getSvgTransform(!0,i),this.getSvgCommons()].join(""),i=e.indexOf("COMMON_PARTS");return e[i]=t,n?n(e.join("")):e.join("")},_createBaseSVGMarkup:function(e,t){var n,i=(t=t||{}).noStyle,o=t.reviver,r=i?"":'style="'+this.getSvgStyles()+'" ',s=t.withShadow?'style="'+this.getSvgFilter()+'" ':"",a=this.clipPath,l=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",c=a&&a.absolutePositioned,u=this.stroke,h=this.fill,d=this.shadow,f=[],p=e.indexOf("COMMON_PARTS"),t=t.additionalTransform;return a&&(a.clipPathId="CLIPPATH_"+X.Object.__uid++,n='<clipPath id="'+a.clipPathId+'" >\n'+a.toClipPathSVG(o)+"</clipPath>\n"),c&&f.push("<g ",s,this.getSvgCommons()," >\n"),f.push("<g ",this.getSvgTransform(!1),c?"":s+this.getSvgCommons()," >\n"),t=[r,l,i?"":this.addPaintOrder()," ",t?'transform="'+t+'" ':""].join(""),e[p]=t,h&&h.toLive&&f.push(h.toSVG(this)),u&&u.toLive&&f.push(u.toSVG(this)),d&&f.push(d.toSVG(this)),a&&f.push(n),f.push(e.join("")),f.push("</g>\n"),c&&f.push("</g>\n"),o?o(f.join("")):f.join("")},addPaintOrder:function(){return"fill"!==this.paintFirst?' paint-order="'+this.paintFirst+'" ':""}}),M=X.util.object.extend,D="stateProperties",X.util.object.extend(X.Object.prototype,{hasStateChanged:function(e){var t="_"+(e=e||D);return Object.keys(this[t]).length<this[e].length||!function e(t,n,i){if(t===n)return 1;if(Array.isArray(t)){if(!Array.isArray(n)||t.length!==n.length)return;for(var o=0,r=t.length;o<r;o++)if(!e(t[o],n[o]))return;return 1}if(t&&"object"==typeof t){var s,a=Object.keys(t);if(n&&"object"==typeof n&&(i||a.length===Object.keys(n).length)){for(o=0,r=a.length;o<r;o++)if("canvas"!==(s=a[o])&&"group"!==s&&!e(t[s],n[s]))return;return 1}}}(this[t],this,!0)},saveState:function(e){var t=e&&e.propertySet||D,n="_"+t;return this[n]?(be(this,n,this[t]),e&&e.stateProperties&&be(this,n,e.stateProperties),this):this.setupState(e)},setupState:function(e){var t=(e=e||{}).propertySet||D;return this["_"+(e.propertySet=t)]={},this.saveState(e),this}}),R=X.util.degreesToRadians,X.util.object.extend(X.Object.prototype,{_findTargetCorner:function(e,t){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var n,i,o=e.x,r=e.y,s=Object.keys(this.oCoords),a=s.length-1;for(this.__corner=0;0<=a;a--)if(i=s[a],this.isControlVisible(i)&&(n=this._getImageLines(t?this.oCoords[i].touchCorner:this.oCoords[i].corner),0!==(n=this._findCrossPoints({x:o,y:r},n))&&n%2==1))return this.__corner=i;return!1},forEachControl:function(e){for(var t in this.controls)e(this.controls[t],t,this)},_setCornerCoords:function(){var e,t,n,i=this.oCoords,o=R(45-this.angle),r=X.util.cos(o),s=X.util.sin(o),a=.707106*this.cornerSize,o=.707106*this.touchCornerSize,l=a*r,c=a*s,u=o*r,h=o*s;for(n in i)e=i[n].x,t=i[n].y,i[n].corner={tl:{x:e-c,y:t-l},tr:{x:e+l,y:t-c},bl:{x:e-l,y:t+c},br:{x:e+c,y:t+l}},i[n].touchCorner={tl:{x:e-h,y:t-u},tr:{x:e+u,y:t-h},bl:{x:e-u,y:t+h},br:{x:e+h,y:t+u}}},drawSelectionBackground:function(e){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;e.save();var t=this.getCenterPoint(),n=this._calculateCurrentDimensions(),i=this.canvas.viewportTransform;return e.translate(t.x,t.y),e.scale(1/i[0],1/i[3]),e.rotate(R(this.angle)),e.fillStyle=this.selectionBackgroundColor,e.fillRect(-n.x/2,-n.y/2,n.x,n.y),e.restore(),this},drawBorders:function(i,e){e=e||{};var t=this._calculateCurrentDimensions(),n=this.borderScaleFactor,o=t.x+n,r=t.y+n,n=(void 0!==e.hasControls?e:this).hasControls,s=!1;return i.save(),i.strokeStyle=e.borderColor||this.borderColor,this._setLineDash(i,e.borderDashArray||this.borderDashArray,null),i.strokeRect(-o/2,-r/2,o,r),n&&(i.beginPath(),this.forEachControl(function(e,t,n){e.withConnection&&e.getVisibility(n,t)&&(s=!0,i.moveTo(e.x*o,e.y*r),i.lineTo(e.x*o+e.offsetX,e.y*r+e.offsetY))}),s&&i.stroke()),i.restore(),this},drawBordersInGroup:function(e,t,n){n=n||{};var i=X.util.sizeAfterTransform(this.width,this.height,t),o=this.strokeWidth,r=this.strokeUniform,s=this.borderScaleFactor,a=i.x+o*(r?this.canvas.getZoom():t.scaleX)+s,s=i.y+o*(r?this.canvas.getZoom():t.scaleY)+s;return e.save(),this._setLineDash(e,n.borderDashArray||this.borderDashArray,null),e.strokeStyle=n.borderColor||this.borderColor,e.strokeRect(-a/2,-s/2,a,s),e.restore(),this},drawControls:function(i,o){return o=o||{},i.save(),i.setTransform(this.canvas.getRetinaScaling(),0,0,this.canvas.getRetinaScaling(),0,0),i.strokeStyle=i.fillStyle=o.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=o.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,o.cornerDashArray||this.cornerDashArray,null),this.setCoords(),this.forEachControl(function(e,t,n){e.getVisibility(n,t)&&e.render(i,n.oCoords[t].x,n.oCoords[t].y,o,n)}),i.restore(),this},isControlVisible:function(e){return this.controls[e]&&this.controls[e].getVisibility(this,e)},setControlVisible:function(e,t){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[e]=t,this},setControlsVisibility:function(e){for(var t in e=e||{})this.setControlVisible(t,e[t]);return this},onDeselect:function(){},onSelect:function(){}}),X.util.object.extend(X.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(t,e){function n(){}var i=(e=e||{}).onComplete||n,o=e.onChange||n,r=this;return X.util.animate({startValue:t.left,endValue:this.getCenter().left,duration:this.FX_DURATION,onChange:function(e){t.set("left",e),r.requestRenderAll(),o()},onComplete:function(){t.setCoords(),i()}}),this},fxCenterObjectV:function(t,e){function n(){}var i=(e=e||{}).onComplete||n,o=e.onChange||n,r=this;return X.util.animate({startValue:t.top,endValue:this.getCenter().top,duration:this.FX_DURATION,onChange:function(e){t.set("top",e),r.requestRenderAll(),o()},onComplete:function(){t.setCoords(),i()}}),this},fxRemove:function(t,e){function n(){}var i=(e=e||{}).onComplete||n,o=e.onChange||n,r=this;return X.util.animate({startValue:t.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(e){t.set("opacity",e),r.requestRenderAll(),o()},onComplete:function(){r.remove(t),i()}}),this}}),X.util.object.extend(X.Object.prototype,{animate:function(){if(arguments[0]&&"object"==typeof arguments[0]){var e,t,n=[];for(e in arguments[0])n.push(e);for(var i=0,o=n.length;i<o;i++)e=n[i],t=i!==o-1,this._animate(e,arguments[0][e],arguments[1],t)}else this._animate.apply(this,arguments);return this},_animate:function(i,e,o,r){var s,a=this;e=e.toString(),o=o?X.util.object.clone(o):{},~i.indexOf(".")&&(s=i.split("."));var t=-1<a.colorProperties.indexOf(i)||s&&-1<a.colorProperties.indexOf(s[1]),n=s?this.get(s[0])[s[1]]:this.get(i);"from"in o||(o.from=n),t||(e=~e.indexOf("=")?n+parseFloat(e.replace("=","")):parseFloat(e));e={startValue:o.from,endValue:e,byValue:o.by,easing:o.easing,duration:o.duration,abort:o.abort&&function(){return o.abort.call(a)},onChange:function(e,t,n){s?a[s[0]][s[1]]=e:a.set(i,e),r||o.onChange&&o.onChange(e,t,n)},onComplete:function(e,t,n){r||(a.setCoords(),o.onComplete&&o.onComplete(e,t,n))}};t?X.util.animateColor(e.startValue,e.endValue,e.duration,e):X.util.animate(e)}}),function(){"use strict";var o=Se.fabric||(Se.fabric={}),r=o.util.object.extend,i=o.util.object.clone,n={x1:1,x2:1,y1:1,y2:1},s=o.StaticCanvas.supports("setLineDash");function e(e,t){var n=e.origin,i=e.axis1,o=e.axis2,r=e.dimension,s=t.nearest,a=t.center,l=t.farthest;return function(){switch(this.get(n)){case s:return Math.min(this.get(i),this.get(o));case a:return Math.min(this.get(i),this.get(o))+.5*this.get(r);case l:return Math.max(this.get(i),this.get(o))}}}o.Line?o.warn("fabric.Line is already defined"):(o.Line=o.util.createClass(o.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:o.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(e,t){e=e||[0,0,0,0],this.callSuper("initialize",t),this.set("x1",e[0]),this.set("y1",e[1]),this.set("x2",e[2]),this.set("y2",e[3]),this._setWidthHeight(t)},_setWidthHeight:function(e){e=e||{},this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in e?e.left:this._getLeftToOriginX(),this.top="top"in e?e.top:this._getTopToOriginY()},_set:function(e,t){return this.callSuper("_set",e,t),void 0!==n[e]&&this._setWidthHeight(),this},_getLeftToOriginX:e({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:e({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(e){e.beginPath(),(!this.strokeDashArray||this.strokeDashArray&&s)&&(t=this.calcLinePoints(),e.moveTo(t.x1,t.y1),e.lineTo(t.x2,t.y2)),e.lineWidth=this.strokeWidth;var t=e.strokeStyle;e.strokeStyle=this.stroke||e.fillStyle,this.stroke&&this._renderStroke(e),e.strokeStyle=t},_renderDashedStroke:function(e){var t=this.calcLinePoints();e.beginPath(),o.util.drawDashedLine(e,t.x1,t.y1,t.x2,t.y2,this.strokeDashArray),e.closePath()},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(e){return r(this.callSuper("toObject",e),this.calcLinePoints())},_getNonTransformedDimensions:function(){var e=this.callSuper("_getNonTransformedDimensions");return"butt"===this.strokeLineCap&&(0===this.width&&(e.y-=this.strokeWidth),0===this.height&&(e.x-=this.strokeWidth)),e},calcLinePoints:function(){var e=this.x1<=this.x2?-1:1,t=this.y1<=this.y2?-1:1,n=e*this.width*.5,i=t*this.height*.5;return{x1:n,x2:e*this.width*-.5,y1:i,y2:t*this.height*-.5}},_toSVG:function(){var e=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',e.x1,'" y1="',e.y1,'" x2="',e.x2,'" y2="',e.y2,'" />\n']}}),o.Line.ATTRIBUTE_NAMES=o.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),o.Line.fromElement=function(e,t,n){n=n||{};var i=o.parseAttributes(e,o.Line.ATTRIBUTE_NAMES),e=[i.x1||0,i.y1||0,i.x2||0,i.y2||0];t(new o.Line(e,r(i,n)))},o.Line.fromObject=function(e,t){var n=i(e,!0);n.points=[e.x1,e.y1,e.x2,e.y2],o.Object._fromObject("Line",n,function(e){delete e.points,t&&t(e)},"points")})}(),function(){"use strict";var r=Se.fabric||(Se.fabric={}),s=Math.PI;r.Circle?r.warn("fabric.Circle is already defined."):(r.Circle=r.util.createClass(r.Object,{type:"circle",radius:0,startAngle:0,endAngle:2*s,cacheProperties:r.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(e,t){return this.callSuper("_set",e,t),"radius"===e&&this.setRadius(t),this},toObject:function(e){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(e))},_toSVG:function(){var e,t,n,i,o=(this.endAngle-this.startAngle)%(2*s);return 0==o?["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,'" />\n']:(e=r.util.cos(this.startAngle)*this.radius,t=r.util.sin(this.startAngle)*this.radius,n=r.util.cos(this.endAngle)*this.radius,i=r.util.sin(this.endAngle)*this.radius,o=s<o?"1":"0",['<path d="M '+e+" "+t," A "+this.radius+" "+this.radius," 0 ",+o+" 1"," "+n+" "+i,'" ',"COMMON_PARTS"," />\n"])},_render:function(e){e.beginPath(),e.arc(0,0,this.radius,this.startAngle,this.endAngle,!1),this._renderPaintInOrder(e)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(e){return this.radius=e,this.set("width",2*e).set("height",2*e)}}),r.Circle.ATTRIBUTE_NAMES=r.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),r.Circle.fromElement=function(e,t){e=r.parseAttributes(e,r.Circle.ATTRIBUTE_NAMES);if(!("radius"in e&&0<=e.radius))throw new Error("value of `r` attribute is required and can not be negative");e.left=(e.left||0)-e.radius,e.top=(e.top||0)-e.radius,t(new r.Circle(e))},r.Circle.fromObject=function(e,t){return r.Object._fromObject("Circle",e,t)})}(),function(){"use strict";var i=Se.fabric||(Se.fabric={});i.Triangle?i.warn("fabric.Triangle is already defined"):(i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(e){var t=this.width/2,n=this.height/2;e.beginPath(),e.moveTo(-t,n),e.lineTo(0,-n),e.lineTo(t,n),e.closePath(),this._renderPaintInOrder(e)},_renderDashedStroke:function(e){var t=this.width/2,n=this.height/2;e.beginPath(),i.util.drawDashedLine(e,-t,n,0,-n,this.strokeDashArray),i.util.drawDashedLine(e,0,-n,t,n,this.strokeDashArray),i.util.drawDashedLine(e,t,n,-t,n,this.strokeDashArray),e.closePath()},_toSVG:function(){var e=this.width/2,t=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-e+" "+t,"0 "+-t,e+" "+t].join(","),'" />']}}),i.Triangle.fromObject=function(e,t){return i.Object._fromObject("Triangle",e,t)})}(),function(){"use strict";var n=Se.fabric||(Se.fabric={}),t=2*Math.PI;n.Ellipse?n.warn("fabric.Ellipse is already defined."):(n.Ellipse=n.util.createClass(n.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:n.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(e){this.callSuper("initialize",e),this.set("rx",e&&e.rx||0),this.set("ry",e&&e.ry||0)},_set:function(e,t){switch(this.callSuper("_set",e,t),e){case"rx":this.rx=t,this.set("width",2*t);break;case"ry":this.ry=t,this.set("height",2*t)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(e){return this.callSuper("toObject",["rx","ry"].concat(e))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,'" />\n']},_render:function(e){e.beginPath(),e.save(),e.transform(1,0,0,this.ry/this.rx,0,0),e.arc(0,0,this.rx,0,t,!1),e.restore(),this._renderPaintInOrder(e)}}),n.Ellipse.ATTRIBUTE_NAMES=n.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),n.Ellipse.fromElement=function(e,t){e=n.parseAttributes(e,n.Ellipse.ATTRIBUTE_NAMES);e.left=(e.left||0)-e.rx,e.top=(e.top||0)-e.ry,t(new n.Ellipse(e))},n.Ellipse.fromObject=function(e,t){return n.Object._fromObject("Ellipse",e,t)})}(),function(){"use strict";var r=Se.fabric||(Se.fabric={}),i=r.util.object.extend;r.Rect?r.warn("fabric.Rect is already defined"):(r.Rect=r.util.createClass(r.Object,{stateProperties:r.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:r.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(e){this.callSuper("initialize",e),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(e){var t=this.rx?Math.min(this.rx,this.width/2):0,n=this.ry?Math.min(this.ry,this.height/2):0,i=this.width,o=this.height,r=-this.width/2,s=-this.height/2,a=0!==t||0!==n,l=.4477152502;e.beginPath(),e.moveTo(r+t,s),e.lineTo(r+i-t,s),a&&e.bezierCurveTo(r+i-l*t,s,r+i,s+l*n,r+i,s+n),e.lineTo(r+i,s+o-n),a&&e.bezierCurveTo(r+i,s+o-l*n,r+i-l*t,s+o,r+i-t,s+o),e.lineTo(r+t,s+o),a&&e.bezierCurveTo(r+l*t,s+o,r,s+o-l*n,r,s+o-n),e.lineTo(r,s+n),a&&e.bezierCurveTo(r,s+l*n,r+l*t,s,r+t,s),e.closePath(),this._renderPaintInOrder(e)},_renderDashedStroke:function(e){var t=-this.width/2,n=-this.height/2,i=this.width,o=this.height;e.beginPath(),r.util.drawDashedLine(e,t,n,t+i,n,this.strokeDashArray),r.util.drawDashedLine(e,t+i,n,t+i,n+o,this.strokeDashArray),r.util.drawDashedLine(e,t+i,n+o,t,n+o,this.strokeDashArray),r.util.drawDashedLine(e,t,n+o,t,n,this.strokeDashArray),e.closePath()},toObject:function(e){return this.callSuper("toObject",["rx","ry"].concat(e))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,'" />\n']}}),r.Rect.ATTRIBUTE_NAMES=r.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),r.Rect.fromElement=function(e,t,n){if(!e)return t(null);n=n||{};e=r.parseAttributes(e,r.Rect.ATTRIBUTE_NAMES);e.left=e.left||0,e.top=e.top||0,e.height=e.height||0,e.width=e.width||0;e=new r.Rect(i(n?r.util.object.clone(n):{},e));e.visible=e.visible&&0<e.width&&0<e.height,t(e)},r.Rect.fromObject=function(e,t){return r.Object._fromObject("Rect",e,t)})}(),function(){"use strict";var s=Se.fabric||(Se.fabric={}),r=s.util.object.extend,i=s.util.array.min,o=s.util.array.max,a=s.util.toFixed;s.Polyline?s.warn("fabric.Polyline is already defined"):(s.Polyline=s.util.createClass(s.Object,{type:"polyline",points:null,cacheProperties:s.Object.prototype.cacheProperties.concat("points"),initialize:function(e,t){t=t||{},this.points=e||[],this.callSuper("initialize",t),this._setPositionDimensions(t)},_setPositionDimensions:function(e){var t,n=this._calcDimensions(e);this.width=n.width,this.height=n.height,e.fromSVG||(t=this.translateToGivenOrigin({x:n.left-this.strokeWidth/2,y:n.top-this.strokeWidth/2},"left","top",this.originX,this.originY)),void 0===e.left&&(this.left=e.fromSVG?n.left:t.x),void 0===e.top&&(this.top=e.fromSVG?n.top:t.y),this.pathOffset={x:n.left+this.width/2,y:n.top+this.height/2}},_calcDimensions:function(){var e=this.points,t=i(e,"x")||0,n=i(e,"y")||0;return{left:t,top:n,width:(o(e,"x")||0)-t,height:(o(e,"y")||0)-n}},toObject:function(e){return r(this.callSuper("toObject",e),{points:this.points.concat()})},_toSVG:function(){for(var e=[],t=this.pathOffset.x,n=this.pathOffset.y,i=s.Object.NUM_FRACTION_DIGITS,o=0,r=this.points.length;o<r;o++)e.push(a(this.points[o].x-t,i),",",a(this.points[o].y-n,i)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',e.join(""),'" />\n']},commonRender:function(e){var t,n=this.points.length,i=this.pathOffset.x,o=this.pathOffset.y;if(!n||isNaN(this.points[n-1].y))return!1;e.beginPath(),e.moveTo(this.points[0].x-i,this.points[0].y-o);for(var r=0;r<n;r++)t=this.points[r],e.lineTo(t.x-i,t.y-o);return!0},_render:function(e){this.commonRender(e)&&this._renderPaintInOrder(e)},_renderDashedStroke:function(e){var t,n;e.beginPath();for(var i=0,o=this.points.length;i<o;i++)t=this.points[i],n=this.points[i+1]||t,s.util.drawDashedLine(e,t.x,t.y,n.x,n.y,this.strokeDashArray)},complexity:function(){return this.get("points").length}}),s.Polyline.ATTRIBUTE_NAMES=s.SHARED_ATTRIBUTES.concat(),s.Polyline.fromElementGenerator=function(o){return function(e,t,n){if(!e)return t(null);n=n||{};var i=s.parsePointsAttribute(e.getAttribute("points")),e=s.parseAttributes(e,s[o].ATTRIBUTE_NAMES);e.fromSVG=!0,t(new s[o](i,r(e,n)))}},s.Polyline.fromElement=s.Polyline.fromElementGenerator("Polyline"),s.Polyline.fromObject=function(e,t){return s.Object._fromObject("Polyline",e,t,"points")})}(),function(){"use strict";var n=Se.fabric||(Se.fabric={});n.Polygon?n.warn("fabric.Polygon is already defined"):(n.Polygon=n.util.createClass(n.Polyline,{type:"polygon",_render:function(e){this.commonRender(e)&&(e.closePath(),this._renderPaintInOrder(e))},_renderDashedStroke:function(e){this.callSuper("_renderDashedStroke",e),e.closePath()}}),n.Polygon.ATTRIBUTE_NAMES=n.SHARED_ATTRIBUTES.concat(),n.Polygon.fromElement=n.Polyline.fromElementGenerator("Polygon"),n.Polygon.fromObject=function(e,t){return n.Object._fromObject("Polygon",e,t,"points")})}(),function(){"use strict";var d=Se.fabric||(Se.fabric={}),f=d.util.array.min,p=d.util.array.max,i=d.util.object.extend,o=Object.prototype.toString,t=d.util.toFixed;d.Path?d.warn("fabric.Path is already defined"):(d.Path=d.util.createClass(d.Object,{type:"path",path:null,cacheProperties:d.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:d.Object.prototype.stateProperties.concat("path"),initialize:function(e,t){t=t||{},this.callSuper("initialize",t),e=e||[];var n="[object Array]"===o.call(e);this.path=n?d.util.makePathSimpler(e):d.util.makePathSimpler(d.util.parsePath(e)),this.path&&d.Polyline.prototype._setPositionDimensions.call(this,t)},_renderPathCommands:function(e){var t,n=0,i=0,o=0,r=0,s=0,a=0,l=-this.pathOffset.x,c=-this.pathOffset.y;e.beginPath();for(var u=0,h=this.path.length;u<h;++u)switch((t=this.path[u])[0]){case"L":o=t[1],r=t[2],e.lineTo(o+l,r+c);break;case"M":n=o=t[1],i=r=t[2],e.moveTo(o+l,r+c);break;case"C":o=t[5],r=t[6],s=t[3],a=t[4],e.bezierCurveTo(t[1]+l,t[2]+c,s+l,a+c,o+l,r+c);break;case"Q":e.quadraticCurveTo(t[1]+l,t[2]+c,t[3]+l,t[4]+c),o=t[3],r=t[4],s=t[1],a=t[2];break;case"z":case"Z":o=n,r=i,e.closePath()}},_render:function(e){this._renderPathCommands(e),this._renderPaintInOrder(e)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(e){return i(this.callSuper("toObject",e),{path:this.path.map(function(e){return e.slice()})})},toDatalessObject:function(e){e=this.toObject(["sourcePath"].concat(e));return e.sourcePath&&delete e.path,e},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',this.path.map(function(e){return e.join(" ")}).join(" "),'" stroke-linecap="round" ',"/>\n"]},_getOffsetTransform:function(){var e=d.Object.NUM_FRACTION_DIGITS;return" translate("+t(-this.pathOffset.x,e)+", "+t(-this.pathOffset.y,e)+")"},toClipPathSVG:function(e){var t=this._getOffsetTransform();return"\t"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:e,additionalTransform:t})},toSVG:function(e){var t=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:e,additionalTransform:t})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var e,t,n=[],i=[],o=0,r=0,s=0,a=0,l=0,c=this.path.length;l<c;++l){switch((e=this.path[l])[0]){case"L":s=e[1],a=e[2],t=[];break;case"M":o=s=e[1],r=a=e[2],t=[];break;case"C":t=d.util.getBoundsOfCurve(s,a,e[1],e[2],e[3],e[4],e[5],e[6]),s=e[5],a=e[6];break;case"Q":t=d.util.getBoundsOfCurve(s,a,e[1],e[2],e[1],e[2],e[3],e[4]),s=e[3],a=e[4];break;case"z":case"Z":s=o,a=r}t.forEach(function(e){n.push(e.x),i.push(e.y)}),n.push(s),i.push(a)}var u=f(n)||0,h=f(i)||0;return{left:u,top:h,width:(p(n)||0)-u,height:(p(i)||0)-h}}}),d.Path.fromObject=function(t,n){var e;"string"==typeof t.sourcePath?(e=t.sourcePath,d.loadSVGFromURL(e,function(e){e=e[0];e.setOptions(t),n&&n(e)})):d.Object._fromObject("Path",t,n,"path")},d.Path.ATTRIBUTE_NAMES=d.SHARED_ATTRIBUTES.concat(["d"]),d.Path.fromElement=function(e,t,n){e=d.parseAttributes(e,d.Path.ATTRIBUTE_NAMES);e.fromSVG=!0,t(new d.Path(e.d,i(e,n)))})}(),function(){"use strict";var s=Se.fabric||(Se.fabric={}),a=s.util.array.min,l=s.util.array.max;s.Group||(s.Group=s.util.createClass(s.Object,s.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(e,t,n){t=t||{},this._objects=[],n&&this.callSuper("initialize",t),this._objects=e||[];for(var i=this._objects.length;i--;)this._objects[i].group=this;n?this._updateObjectsACoords():(n=t&&t.centerPoint,void 0!==t.originX&&(this.originX=t.originX),void 0!==t.originY&&(this.originY=t.originY),n||this._calcBounds(),this._updateObjectsCoords(n),delete t.centerPoint,this.callSuper("initialize",t)),this.setCoords()},_updateObjectsACoords:function(){for(var e=this._objects.length;e--;)this._objects[e].setCoords(!0)},_updateObjectsCoords:function(e){for(var e=e||this.getCenterPoint(),t=this._objects.length;t--;)this._updateObjectCoords(this._objects[t],e)},_updateObjectCoords:function(e,t){var n=e.left,i=e.top;e.set({left:n-t.x,top:i-t.y}),e.group=this,e.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(e){return this._restoreObjectsState(),s.util.resetObjectTransform(this),e&&(this._objects.push(e),e.group=this,e._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},removeWithUpdate:function(e){return this._restoreObjectsState(),s.util.resetObjectTransform(this),this.remove(e),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(e){this.dirty=!0,e.group=this,e._set("canvas",this.canvas)},_onObjectRemoved:function(e){this.dirty=!0,delete e.group},_set:function(e,t){var n=this._objects.length;if(this.useSetOnGroup)for(;n--;)this._objects[n].setOnGroup(e,t);if("canvas"===e)for(;n--;)this._objects[n]._set(e,t);s.Object.prototype._set.call(this,e,t)},toObject:function(i){var o=this.includeDefaultValues,e=this._objects.map(function(e){var t=e.includeDefaultValues;e.includeDefaultValues=o;var n=e.toObject(i);return e.includeDefaultValues=t,n}),t=s.Object.prototype.toObject.call(this,i);return t.objects=e,t},toDatalessObject:function(i){var o,e=this.sourcePath||(o=this.includeDefaultValues,this._objects.map(function(e){var t=e.includeDefaultValues;e.includeDefaultValues=o;var n=e.toDatalessObject(i);return e.includeDefaultValues=t,n})),t=s.Object.prototype.toDatalessObject.call(this,i);return t.objects=e,t},render:function(e){this._transformDone=!0,this.callSuper("render",e),this._transformDone=!1},shouldCache:function(){var e=s.Object.prototype.shouldCache.call(this);if(e)for(var t=0,n=this._objects.length;t<n;t++)if(this._objects[t].willDrawShadow())return this.ownCaching=!1;return e},willDrawShadow:function(){if(s.Object.prototype.willDrawShadow.call(this))return!0;for(var e=0,t=this._objects.length;e<t;e++)if(this._objects[e].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(e){for(var t=0,n=this._objects.length;t<n;t++)this._objects[t].render(e);this._drawClipPath(e)},isCacheDirty:function(e){if(this.callSuper("isCacheDirty",e))return!0;if(!this.statefullCache)return!1;for(var t,n,i=0,o=this._objects.length;i<o;i++)if(this._objects[i].isCacheDirty(!0))return this._cacheCanvas&&(t=this.cacheWidth/this.zoomX,n=this.cacheHeight/this.zoomY,this._cacheContext.clearRect(-t/2,-n/2,t,n)),!0;return!1},_restoreObjectsState:function(){return this._objects.forEach(this._restoreObjectState,this),this},realizeTransform:function(e){var t=e.calcTransformMatrix(),n=s.util.qrDecompose(t),t=new s.Point(n.translateX,n.translateY);return e.flipX=!1,e.flipY=!1,e.set("scaleX",n.scaleX),e.set("scaleY",n.scaleY),e.skewX=n.skewX,e.skewY=n.skewY,e.angle=n.angle,e.setPositionByOrigin(t,"center","center"),e},_restoreObjectState:function(e){return this.realizeTransform(e),delete e.group,e.setCoords(),this},destroy:function(){return this._objects.forEach(function(e){e.set("dirty",!0)}),this._restoreObjectsState()},toActiveSelection:function(){if(this.canvas){var e=this._objects,t=this.canvas;this._objects=[];var n=this.toObject();delete n.objects;var i=new s.ActiveSelection([]);return i.set(n),i.type="activeSelection",t.remove(this),e.forEach(function(e){e.group=i,e.dirty=!0,t.add(e)}),i.canvas=t,i._objects=e,(t._activeObject=i).setCoords(),i}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(e){e.setCoords(!0)}),this},_calcBounds:function(e){for(var t,n,i,o=[],r=[],s=["tr","br","bl","tl"],a=0,l=this._objects.length,c=s.length;a<l;++a)for((t=this._objects[a]).aCoords=t.calcACoords(),i=0;i<c;i++)n=s[i],o.push(t.aCoords[n].x),r.push(t.aCoords[n].y);this._getBounds(o,r,e)},_getBounds:function(e,t,n){var i=new s.Point(a(e),a(t)),o=new s.Point(l(e),l(t)),r=i.y||0,e=i.x||0,t=o.x-i.x||0,i=o.y-i.y||0;this.width=t,this.height=i,n||this.setPositionByOrigin({x:e,y:r},"left","top")},_toSVG:function(e){for(var t=["<g ","COMMON_PARTS"," >\n"],n=0,i=this._objects.length;n<i;n++)t.push("\t\t",this._objects[n].toSVG(e));return t.push("</g>\n"),t},getSvgStyles:function(){var e=void 0!==this.opacity&&1!==this.opacity?"opacity: "+this.opacity+";":"",t=this.visible?"":" visibility: hidden;";return[e,this.getSvgFilter(),t].join("")},toClipPathSVG:function(e){for(var t=[],n=0,i=this._objects.length;n<i;n++)t.push("\t",this._objects[n].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(t,{reviver:e})}}),s.Group.fromObject=function(i,o){var t=i.objects,n=s.util.object.clone(i,!0);delete n.objects,"string"!=typeof t?s.util.enlivenObjects(t,function(n){s.util.enlivenObjects([i.clipPath],function(e){var t=s.util.object.clone(i,!0);t.clipPath=e[0],delete t.objects,o&&o(new s.Group(n,t,!0))})}):s.loadSVGFromURL(t,function(e){e=s.util.groupSVGElements(e,i,t);e.set(n),o&&o(e)})})}(),function(){"use strict";var i=Se.fabric||(Se.fabric={});i.ActiveSelection||(i.ActiveSelection=i.util.createClass(i.Group,{type:"activeSelection",initialize:function(e,t){t=t||{},this._objects=e||[];for(var n=this._objects.length;n--;)this._objects[n].group=this;t.originX&&(this.originX=t.originX),t.originY&&(this.originY=t.originY),this._calcBounds(),this._updateObjectsCoords(),i.Object.prototype.initialize.call(this,t),this.setCoords()},toGroup:function(){var e=this._objects.concat();this._objects=[];var t=i.Object.prototype.toObject.call(this),n=new i.Group([]);if(delete t.type,n.set(t),e.forEach(function(e){e.canvas.remove(e),e.group=n}),n._objects=e,!this.canvas)return n;e=this.canvas;return e.add(n),(e._activeObject=n).setCoords(),n},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(e,t,n){e.save(),e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",e,t),void 0===(n=n||{}).hasControls&&(n.hasControls=!1),n.forActiveSelection=!0;for(var i=0,o=this._objects.length;i<o;i++)this._objects[i]._renderControls(e,n);e.restore()}}),i.ActiveSelection.fromObject=function(t,n){i.util.enlivenObjects(t.objects,function(e){delete t.objects,n&&n(new i.ActiveSelection(e,t,!0))})})}(),function(e){"use strict";var i=X.util.object.extend;e.fabric||(e.fabric={}),e.fabric.Image?X.warn("fabric.Image is already defined."):(X.Image=X.util.createClass(X.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:X.Object.prototype.stateProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(e,t){t=t||{},this.filters=[],this.cacheKey="texture"+X.Object.__uid++,this.callSuper("initialize",t),this._initElement(e,t)},getElement:function(){return this._element||{}},setElement:function(e,t){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=e,this._originalElement=e,this._initConfig(t),0!==this.filters.length&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(e){var t=X.filterBackend;t&&t.evictCachesForKey&&t.evictCachesForKey(e)},dispose:function(){this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(function(e){X.util.cleanUpJsdomNode(this[e]),this[e]=void 0}.bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var e=this.getElement();return{width:e.naturalWidth||e.width,height:e.naturalHeight||e.height}},_stroke:function(e){var t,n;this.stroke&&0!==this.strokeWidth&&(t=this.width/2,n=this.height/2,e.beginPath(),e.moveTo(-t,-n),e.lineTo(t,-n),e.lineTo(t,n),e.lineTo(-t,n),e.lineTo(-t,-n),e.closePath())},_renderDashedStroke:function(e){var t=-this.width/2,n=-this.height/2,i=this.width,o=this.height;e.save(),this._setStrokeStyles(e,this),e.beginPath(),X.util.drawDashedLine(e,t,n,t+i,n,this.strokeDashArray),X.util.drawDashedLine(e,t+i,n,t+i,n+o,this.strokeDashArray),X.util.drawDashedLine(e,t+i,n+o,t,n+o,this.strokeDashArray),X.util.drawDashedLine(e,t,n+o,t,n,this.strokeDashArray),e.closePath(),e.restore()},toObject:function(e){var t=[];this.filters.forEach(function(e){e&&t.push(e.toObject())});e=i(this.callSuper("toObject",["cropX","cropY"].concat(e)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:t});return this.resizeFilter&&(e.resizeFilter=this.resizeFilter.toObject()),e},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var e,t,n=[],i=[],o=this._element,r=-this.width/2,s=-this.height/2,a="",l="";return o?(this.hasCrop()&&(t=X.Object.__uid++,n.push('<clipPath id="imageCrop_'+t+'">\n','\t<rect x="'+r+'" y="'+s+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),a=' clip-path="url(#imageCrop_'+t+')" '),this.imageSmoothing||(l='" image-rendering="optimizeSpeed'),i.push("\t<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',r-this.cropX,'" y="',s-this.cropY,'" width="',o.width||o.naturalWidth,'" height="',o.height||o.height,l,'"',a,"></image>\n"),(this.stroke||this.strokeDashArray)&&(a=this.fill,this.fill=null,e=["\t<rect ",'x="',r,'" y="',s,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'"/>\n'],this.fill=a),n="fill"!==this.paintFirst?n.concat(e,i):n.concat(i,e)):[]},getSrc:function(e){e=e?this._element:this._originalElement;return e?e.toDataURL?e.toDataURL():this.srcFromAttribute?e.getAttribute("src"):e.src:this.src||""},setSrc:function(e,n,i){return X.util.loadImage(e,function(e,t){this.setElement(e,i),this._setWidthHeight(),n&&n(this,t)},this,i&&i.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var e=this.resizeFilter,t=this.minimumScaleTrigger,n=this.getTotalObjectScaling(),i=n.scaleX,o=n.scaleY,r=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!e||t<i&&t<o)return this._element=r,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=i,void(this._lastScaleY=o);X.filterBackend||(X.filterBackend=X.initFilterBackend());var s=X.util.createCanvasElement(),a=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,n=r.width,t=r.height;s.width=n,s.height=t,this._element=s,this._lastScaleX=e.scaleX=i,this._lastScaleY=e.scaleY=o,X.filterBackend.applyFilters([e],r,n,t,this._element,a),this._filterScalingX=s.width/this._originalElement.width,this._filterScalingY=s.height/this._originalElement.height},applyFilters:function(e){if(e=(e=e||this.filters||[]).filter(function(e){return e&&!e.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),0===e.length)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var t=this._originalElement,n=t.naturalWidth||t.width,i=t.naturalHeight||t.height;return this._element===this._originalElement?((t=X.util.createCanvasElement()).width=n,t.height=i,this._element=t,this._filteredEl=t):(this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,n,i),this._lastScaleX=1,this._lastScaleY=1),X.filterBackend||(X.filterBackend=X.initFilterBackend()),X.filterBackend.applyFilters(e,this._originalElement,n,i,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(e){X.util.setImageSmoothing(e,this.imageSmoothing),!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(e),this._renderPaintInOrder(e)},drawCacheOnCanvas:function(e){X.util.setImageSmoothing(e,this.imageSmoothing),X.Object.prototype.drawCacheOnCanvas.call(this,e)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(e){var t,n,i,o,r,s,a,l,c,u,h,d,f,p,g=this._element;g&&(t=this._filterScalingX,d=this._filterScalingY,n=this.width,i=this.height,o=Math.min,f=(h=Math.max)(this.cropX,0),p=h(this.cropY,0),r=g.naturalWidth||g.width,s=g.naturalHeight||g.height,l=p*d,c=o(n*t,r-(a=f*t)),u=o(i*d,s-l),h=-n/2,d=-i/2,f=o(n,r/t-f),p=o(i,s/t-p),g&&e.drawImage(g,a,l,c,u,h,d,f,p))},_needsResize:function(){var e=this.getTotalObjectScaling();return e.scaleX!==this._lastScaleX||e.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(e,t){this.setElement(X.util.getById(e),t),X.util.addClass(this.getElement(),X.Image.CSS_CANVAS)},_initConfig:function(e){e=e||{},this.setOptions(e),this._setWidthHeight(e)},_initFilters:function(e,t){e&&e.length?X.util.enlivenObjects(e,function(e){t&&t(e)},"fabric.Image.filters"):t&&t()},_setWidthHeight:function(e){e=e||{};var t=this.getElement();this.width=e.width||t.naturalWidth||t.width||0,this.height=e.height||t.naturalHeight||t.height||0},parsePreserveAspectRatioAttribute:function(){var e,t=X.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),n=this._element.width,i=this._element.height,o=1,r=1,s=0,a=0,l=0,c=0,u=this.width,h=this.height,d={width:u,height:h};return!t||"none"===t.alignX&&"none"===t.alignY?(o=u/n,r=h/i):("meet"===t.meetOrSlice&&(e=(u-n*(o=r=X.util.findScaleToFit(this._element,d)))/2,"Min"===t.alignX&&(s=-e),"Max"===t.alignX&&(s=e),e=(h-i*r)/2,"Min"===t.alignY&&(a=-e),"Max"===t.alignY&&(a=e)),"slice"===t.meetOrSlice&&(e=n-u/(o=r=X.util.findScaleToCover(this._element,d)),"Mid"===t.alignX&&(l=e/2),"Max"===t.alignX&&(l=e),e=i-h/r,"Mid"===t.alignY&&(c=e/2),"Max"===t.alignY&&(c=e),n=u/o,i=h/r)),{width:n,height:i,scaleX:o,scaleY:r,offsetLeft:s,offsetTop:a,cropX:l,cropY:c}}}),X.Image.CSS_CANVAS="canvas-img",X.Image.prototype.getSvgSrc=X.Image.prototype.getSrc,X.Image.fromObject=function(e,n){var i=X.util.object.clone(e);X.util.loadImage(i.src,function(t,e){e?n&&n(null,!0):X.Image.prototype._initFilters.call(i,i.filters,function(e){i.filters=e||[],X.Image.prototype._initFilters.call(i,[i.resizeFilter],function(e){i.resizeFilter=e[0],X.util.enlivenObjects([i.clipPath],function(e){i.clipPath=e[0];e=new X.Image(t,i);n(e,!1)})})})},null,i.crossOrigin)},X.Image.fromURL=function(e,n,i){X.util.loadImage(e,function(e,t){n&&n(new X.Image(e,i),t)},null,i&&i.crossOrigin)},X.Image.ATTRIBUTE_NAMES=X.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),X.Image.fromElement=function(e,t,n){e=X.parseAttributes(e,X.Image.ATTRIBUTE_NAMES);X.Image.fromURL(e["xlink:href"],t,i(n?X.util.object.clone(n):{},e))})}(Se),X.util.object.extend(X.Object.prototype,{_getAngleValueForStraighten:function(){var e=this.angle%360;return 0<e?90*Math.round((e-1)/90):90*Math.round(e/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten()),this},fxStraighten:function(e){function t(){}var n=(e=e||{}).onComplete||t,i=e.onChange||t,o=this;return X.util.animate({startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(e){o.rotate(e),i()},onComplete:function(){o.setCoords(),n()}}),this}}),X.util.object.extend(X.StaticCanvas.prototype,{straightenObject:function(e){return e.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(e){return e.fxStraighten({onChange:this.requestRenderAllBound}),this}}),function(){"use strict";X.isWebglSupported=function(e){if(X.isLikelyNode)return!1;e=e||X.WebglFilterBackend.prototype.tileSize;var t,n,i,o=document.createElement("canvas"),r=o.getContext("webgl")||o.getContext("experimental-webgl"),o=!1;if(r){X.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),o=X.maxTextureSize>=e;for(var s=["highp","mediump","lowp"],a=0;a<3;a++)if(0,n="precision "+s[a]+" float;\nvoid main(){}",i=(t=r).createShader(t.FRAGMENT_SHADER),t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)){X.webGlPrecision=s[a];break}}return this.isSupported=o},(X.WebglFilterBackend=function(e){e&&e.tileSize&&(this.tileSize=e.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}).prototype={tileSize:2048,resources:{},setupGLContext:function(e,t){this.dispose(),this.createWebGLCanvas(e,t),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(e,t)},chooseFastestCopyGLTo2DMethod:function(e,t){var n,i=void 0!==window.performance;try{new ImageData(1,1),n=!0}catch(e){n=!1}var o="undefined"!=typeof ArrayBuffer,r="undefined"!=typeof Uint8ClampedArray;if(i&&n&&o&&r){i=X.util.createCanvasElement(),o=new ArrayBuffer(e*t*4);if(X.forceGLPutImageData)return this.imageBuffer=o,void(this.copyGLTo2D=xe);r={imageBuffer:o,destinationWidth:e,destinationHeight:t,targetCanvas:i};i.width=e,i.height=t,i=window.performance.now(),Ce.call(r,this.gl,r),t=window.performance.now()-i,i=window.performance.now(),xe.call(r,this.gl,r),window.performance.now()-i<t?(this.imageBuffer=o,this.copyGLTo2D=xe):this.copyGLTo2D=Ce}},createWebGLCanvas:function(e,t){var n=X.util.createCanvasElement();n.width=e,n.height=t;e={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},t=n.getContext("webgl",e);(t=t||n.getContext("experimental-webgl",e))&&(t.clearColor(0,0,0,0),this.canvas=n,this.gl=t)},applyFilters:function(e,t,n,i,o,r){var s=this.gl;r&&(a=this.getCachedTexture(r,t));var a,l={originalWidth:t.width||t.originalWidth,originalHeight:t.height||t.originalHeight,sourceWidth:n,sourceHeight:i,destinationWidth:n,destinationHeight:i,context:s,sourceTexture:this.createTexture(s,n,i,!a&&t),targetTexture:this.createTexture(s,n,i),originalTexture:a||this.createTexture(s,n,i,!a&&t),passes:e.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:o},n=s.createFramebuffer();return s.bindFramebuffer(s.FRAMEBUFFER,n),e.forEach(function(e){e&&e.applyTo(l)}),a=(i=l.targetCanvas).width,t=i.height,e=l.destinationHeight,a===(a=l.destinationWidth)&&t===e||(i.width=a,i.height=e),this.copyGLTo2D(s,l),s.bindTexture(s.TEXTURE_2D,null),s.deleteTexture(l.sourceTexture),s.deleteTexture(l.targetTexture),s.deleteFramebuffer(n),o.getContext("2d").setTransform(1,0,0,1,0,0),l},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(e,t,n,i){var o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),i?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,n,0,e.RGBA,e.UNSIGNED_BYTE,null),o},getCachedTexture:function(e,t){if(this.textureCache[e])return this.textureCache[e];t=this.createTexture(this.gl,t.width,t.height,t);return this.textureCache[e]=t},evictCachesForKey:function(e){this.textureCache[e]&&(this.gl.deleteTexture(this.textureCache[e]),delete this.textureCache[e])},copyGLTo2D:Ce,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var e=this.gl,t={renderer:"",vendor:""};if(!e)return t;var n,i=e.getExtension("WEBGL_debug_renderer_info");return i&&(n=e.getParameter(i.UNMASKED_RENDERER_WEBGL),i=e.getParameter(i.UNMASKED_VENDOR_WEBGL),n&&(t.renderer=n.toLowerCase()),i&&(t.vendor=i.toLowerCase())),this.gpuInfo=t}}}(),function(){"use strict";function e(){}(X.Canvas2dFilterBackend=function(){}).prototype={evictCachesForKey:e,dispose:e,clearWebGLCaches:e,resources:{},applyFilters:function(e,t,n,i,o){var r=o.getContext("2d");r.drawImage(t,0,0,n,i);var s={sourceWidth:n,sourceHeight:i,imageData:r.getImageData(0,0,n,i),originalEl:t,originalImageData:r.getImageData(0,0,n,i),canvasEl:o,ctx:r,filterBackend:this};return e.forEach(function(e){e.applyTo(s)}),s.imageData.width===n&&s.imageData.height===i||(o.width=s.imageData.width,o.height=s.imageData.height),r.putImageData(s.imageData,0,0),s}}}(),X.Image=X.Image||{},X.Image.filters=X.Image.filters||{},X.Image.filters.BaseFilter=X.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:function(e){e&&this.setOptions(e)},setOptions:function(e){for(var t in e)this[t]=e[t]},createProgram:function(e,t,n){t=t||this.fragmentSource,n=n||this.vertexSource,"highp"!==X.webGlPrecision&&(t=t.replace(/precision highp float/g,"precision "+X.webGlPrecision+" float"));var i=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(i,n),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+e.getShaderInfoLog(i));n=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(n,t),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+e.getShaderInfoLog(n));t=e.createProgram();if(e.attachShader(t,i),e.attachShader(t,n),e.linkProgram(t),!e.getProgramParameter(t,e.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+e.getProgramInfoLog(t));i=this.getAttributeLocations(e,t),n=this.getUniformLocations(e,t)||{};return n.uStepW=e.getUniformLocation(t,"uStepW"),n.uStepH=e.getUniformLocation(t,"uStepH"),{program:t,attributeLocations:i,uniformLocations:n}},getAttributeLocations:function(e,t){return{aPosition:e.getAttribLocation(t,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(e,t,n){var i=t.aPosition,t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW)},_setupFrameBuffer:function(e){var t,n,i=e.context;1<e.passes?(t=e.destinationWidth,n=e.destinationHeight,e.sourceWidth===t&&e.sourceHeight===n||(i.deleteTexture(e.targetTexture),e.targetTexture=e.filterBackend.createTexture(i,t,n)),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e.targetTexture,0)):(i.bindFramebuffer(i.FRAMEBUFFER,null),i.finish())},_swapTextures:function(e){e.passes--,e.pass++;var t=e.targetTexture;e.targetTexture=e.sourceTexture,e.sourceTexture=t},isNeutralState:function(){var e=this.mainParameter,t=X.Image.filters[this.type].prototype;if(e){if(Array.isArray(t[e])){for(var n=t[e].length;n--;)if(this[e][n]!==t[e][n])return!1;return!0}return t[e]===this[e]}return!1},applyTo:function(e){e.webgl?(this._setupFrameBuffer(e),this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},retrieveShader:function(e){return e.programCache.hasOwnProperty(this.type)||(e.programCache[this.type]=this.createProgram(e.context)),e.programCache[this.type]},applyToWebGL:function(e){var t=e.context,n=this.retrieveShader(e);0===e.pass&&e.originalTexture?t.bindTexture(t.TEXTURE_2D,e.originalTexture):t.bindTexture(t.TEXTURE_2D,e.sourceTexture),t.useProgram(n.program),this.sendAttributeData(t,n.attributeLocations,e.aPosition),t.uniform1f(n.uniformLocations.uStepW,1/e.sourceWidth),t.uniform1f(n.uniformLocations.uStepH,1/e.sourceHeight),this.sendUniformData(t,n.uniformLocations),t.viewport(0,0,e.destinationWidth,e.destinationHeight),t.drawArrays(t.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(e,t,n){e.activeTexture(n),e.bindTexture(e.TEXTURE_2D,t),e.activeTexture(e.TEXTURE0)},unbindAdditionalTexture:function(e,t){e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(e){this[this.mainParameter]=e},sendUniformData:function(){},createHelpLayer:function(e){var t;e.helpLayer||((t=document.createElement("canvas")).width=e.sourceWidth,t.height=e.sourceHeight,e.helpLayer=t)},toObject:function(){var e={type:this.type},t=this.mainParameter;return t&&(e[t]=this[t]),e},toJSON:function(){return this.toObject()}}),X.Image.filters.BaseFilter.fromObject=function(e,t){e=new X.Image.filters[e.type](e);return t&&t(e),e},function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.Image.filters,n=e.util.createClass;t.ColorMatrix=n(t.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(e){this.callSuper("initialize",e),this.matrix=this.matrix.slice(0)},applyTo2d:function(e){for(var t,n,i,o,r=e.imageData.data,s=r.length,a=this.matrix,l=this.colorsOnly,c=0;c<s;c+=4)t=r[c],n=r[c+1],i=r[c+2],l?(r[c]=t*a[0]+n*a[1]+i*a[2]+255*a[4],r[c+1]=t*a[5]+n*a[6]+i*a[7]+255*a[9],r[c+2]=t*a[10]+n*a[11]+i*a[12]+255*a[14]):(o=r[c+3],r[c]=t*a[0]+n*a[1]+i*a[2]+o*a[3]+255*a[4],r[c+1]=t*a[5]+n*a[6]+i*a[7]+o*a[8]+255*a[9],r[c+2]=t*a[10]+n*a[11]+i*a[12]+o*a[13]+255*a[14],r[c+3]=t*a[15]+n*a[16]+i*a[17]+o*a[18]+255*a[19])},getUniformLocations:function(e,t){return{uColorMatrix:e.getUniformLocation(t,"uColorMatrix"),uConstants:e.getUniformLocation(t,"uConstants")}},sendUniformData:function(e,t){var n=this.matrix,i=[n[0],n[1],n[2],n[3],n[5],n[6],n[7],n[8],n[10],n[11],n[12],n[13],n[15],n[16],n[17],n[18]],n=[n[4],n[9],n[14],n[19]];e.uniformMatrix4fv(t.uColorMatrix,!1,i),e.uniform4fv(t.uConstants,n)}}),e.Image.filters.ColorMatrix.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Brightness=n(t.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:function(e){if(0!==this.brightness)for(var t=e.imageData.data,n=t.length,i=Math.round(255*this.brightness),o=0;o<n;o+=4)t[o]=t[o]+i,t[o+1]=t[o+1]+i,t[o+2]=t[o+2]+i},getUniformLocations:function(e,t){return{uBrightness:e.getUniformLocation(t,"uBrightness")}},sendUniformData:function(e,t){e.uniform1f(t.uBrightness,this.brightness)}}),e.Image.filters.Brightness.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.util.object.extend,n=e.Image.filters,i=e.util.createClass;n.Convolute=i(n.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:function(e){var t=Math.sqrt(this.matrix.length),n=this.type+"_"+t+"_"+(this.opaque?1:0),t=this.fragmentSource[n];return e.programCache.hasOwnProperty(n)||(e.programCache[n]=this.createProgram(e.context,t)),e.programCache[n]},applyTo2d:function(e){for(var t,n,i,o,r,s,a,l,c,u,h=e.imageData,d=h.data,f=this.matrix,p=Math.round(Math.sqrt(f.length)),g=Math.floor(p/2),m=h.width,v=h.height,h=e.ctx.createImageData(m,v),y=h.data,b=this.opaque?1:0,C=0;C<v;C++)for(l=0;l<m;l++){for(r=4*(C*m+l),u=o=i=n=t=0;u<p;u++)for(c=0;c<p;c++)a=l+c-g,(s=C+u-g)<0||v<=s||a<0||m<=a||(s=4*(s*m+a),a=f[u*p+c],t+=d[s]*a,n+=d[1+s]*a,i+=d[2+s]*a,b||(o+=d[3+s]*a));y[r]=t,y[1+r]=n,y[2+r]=i,y[3+r]=b?d[3+r]:o}e.imageData=h},getUniformLocations:function(e,t){return{uMatrix:e.getUniformLocation(t,"uMatrix"),uOpaque:e.getUniformLocation(t,"uOpaque"),uHalfSize:e.getUniformLocation(t,"uHalfSize"),uSize:e.getUniformLocation(t,"uSize")}},sendUniformData:function(e,t){e.uniform1fv(t.uMatrix,this.matrix)},toObject:function(){return t(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),e.Image.filters.Convolute.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Grayscale=n(t.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:function(e){for(var t,n=e.imageData.data,i=n.length,o=this.mode,r=0;r<i;r+=4)"average"===o?t=(n[r]+n[r+1]+n[r+2])/3:"lightness"===o?t=(Math.min(n[r],n[r+1],n[r+2])+Math.max(n[r],n[r+1],n[r+2]))/2:"luminosity"===o&&(t=.21*n[r]+.72*n[r+1]+.07*n[r+2]),n[r]=t,n[r+1]=t,n[r+2]=t},retrieveShader:function(e){var t,n=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(n)||(t=this.fragmentSource[this.mode],e.programCache[n]=this.createProgram(e.context,t)),e.programCache[n]},getUniformLocations:function(e,t){return{uMode:e.getUniformLocation(t,"uMode")}},sendUniformData:function(e,t){e.uniform1i(t.uMode,1)},isNeutralState:function(){return!1}}),e.Image.filters.Grayscale.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Invert=n(t.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:function(e){for(var t=e.imageData.data,n=t.length,i=0;i<n;i+=4)t[i]=255-t[i],t[i+1]=255-t[i+1],t[i+2]=255-t[i+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(e,t){return{uInvert:e.getUniformLocation(t,"uInvert")}},sendUniformData:function(e,t){e.uniform1i(t.uInvert,this.invert)}}),e.Image.filters.Invert.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.util.object.extend,n=e.Image.filters,i=e.util.createClass;n.Noise=i(n.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:function(e){if(0!==this.noise)for(var t,n=e.imageData.data,i=n.length,o=this.noise,r=0,i=n.length;r<i;r+=4)t=(.5-Math.random())*o,n[r]+=t,n[r+1]+=t,n[r+2]+=t},getUniformLocations:function(e,t){return{uNoise:e.getUniformLocation(t,"uNoise"),uSeed:e.getUniformLocation(t,"uSeed")}},sendUniformData:function(e,t){e.uniform1f(t.uNoise,this.noise/255),e.uniform1f(t.uSeed,Math.random())},toObject:function(){return t(this.callSuper("toObject"),{noise:this.noise})}}),e.Image.filters.Noise.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Pixelate=n(t.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:function(e){for(var t,n,i,o,r,s,a,l,c,u,e=e.imageData,h=e.data,d=e.height,f=e.width,p=0;p<d;p+=this.blocksize)for(n=0;n<f;n+=this.blocksize)for(i=h[t=4*p*f+4*n],o=h[1+t],r=h[2+t],s=h[3+t],c=Math.min(p+this.blocksize,d),u=Math.min(n+this.blocksize,f),a=p;a<c;a++)for(l=n;l<u;l++)h[t=4*a*f+4*l]=i,h[1+t]=o,h[2+t]=r,h[3+t]=s},isNeutralState:function(){return 1===this.blocksize},getUniformLocations:function(e,t){return{uBlocksize:e.getUniformLocation(t,"uBlocksize"),uStepW:e.getUniformLocation(t,"uStepW"),uStepH:e.getUniformLocation(t,"uStepH")}},sendUniformData:function(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}}),e.Image.filters.Pixelate.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var c=Se.fabric||(Se.fabric={}),e=c.util.object.extend,t=c.Image.filters,n=c.util.createClass;t.RemoveColor=n(t.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:function(e){for(var t,n,i,o=e.imageData.data,r=255*this.distance,e=new c.Color(this.color).getSource(),s=[e[0]-r,e[1]-r,e[2]-r],a=[e[0]+r,e[1]+r,e[2]+r],l=0;l<o.length;l+=4)t=o[l],n=o[l+1],i=o[l+2],s[0]<t&&s[1]<n&&s[2]<i&&t<a[0]&&n<a[1]&&i<a[2]&&(o[l+3]=0)},getUniformLocations:function(e,t){return{uLow:e.getUniformLocation(t,"uLow"),uHigh:e.getUniformLocation(t,"uHigh")}},sendUniformData:function(e,t){var n=new c.Color(this.color).getSource(),i=parseFloat(this.distance),o=[0+n[0]/255-i,0+n[1]/255-i,0+n[2]/255-i,1],i=[n[0]/255+i,n[1]/255+i,n[2]/255+i,1];e.uniform4fv(t.uLow,o),e.uniform4fv(t.uHigh,i)},toObject:function(){return e(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),c.Image.filters.RemoveColor.fromObject=c.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e,t=Se.fabric||(Se.fabric={}),n=t.Image.filters,i=t.util.createClass,o={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(e in o)n[e]=i(n.ColorMatrix,{type:e,matrix:o[e],mainParameter:!1,colorsOnly:!0}),t.Image.filters[e].fromObject=t.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var h=Se.fabric,e=h.Image.filters,t=h.util.createClass;e.BlendColor=t(e.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:function(e){return"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ngl_FragColor = color;\nif (color.a > 0.0) {\n"+this.fragmentSource[e]+"}\n}"},retrieveShader:function(e){var t,n=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(n)||(t=this.buildSource(this.mode),e.programCache[n]=this.createProgram(e.context,t)),e.programCache[n]},applyTo2d:function(e){for(var t,n,i,o=e.imageData.data,r=o.length,s=1-this.alpha,e=new h.Color(this.color).getSource(),a=e[0]*this.alpha,l=e[1]*this.alpha,c=e[2]*this.alpha,u=0;u<r;u+=4)switch(t=o[u],n=o[u+1],i=o[u+2],this.mode){case"multiply":o[u]=t*a/255,o[u+1]=n*l/255,o[u+2]=i*c/255;break;case"screen":o[u]=255-(255-t)*(255-a)/255,o[u+1]=255-(255-n)*(255-l)/255,o[u+2]=255-(255-i)*(255-c)/255;break;case"add":o[u]=t+a,o[u+1]=n+l,o[u+2]=i+c;break;case"diff":case"difference":o[u]=Math.abs(t-a),o[u+1]=Math.abs(n-l),o[u+2]=Math.abs(i-c);break;case"subtract":o[u]=t-a,o[u+1]=n-l,o[u+2]=i-c;break;case"darken":o[u]=Math.min(t,a),o[u+1]=Math.min(n,l),o[u+2]=Math.min(i,c);break;case"lighten":o[u]=Math.max(t,a),o[u+1]=Math.max(n,l),o[u+2]=Math.max(i,c);break;case"overlay":o[u]=a<128?2*t*a/255:255-2*(255-t)*(255-a)/255,o[u+1]=l<128?2*n*l/255:255-2*(255-n)*(255-l)/255,o[u+2]=c<128?2*i*c/255:255-2*(255-i)*(255-c)/255;break;case"exclusion":o[u]=a+t-2*a*t/255,o[u+1]=l+n-2*l*n/255,o[u+2]=c+i-2*c*i/255;break;case"tint":o[u]=a+t*s,o[u+1]=l+n*s,o[u+2]=c+i*s}},getUniformLocations:function(e,t){return{uColor:e.getUniformLocation(t,"uColor")}},sendUniformData:function(e,t){var n=new h.Color(this.color).getSource();n[0]=this.alpha*n[0]/255,n[1]=this.alpha*n[1]/255,n[2]=this.alpha*n[2]/255,n[3]=this.alpha,e.uniform4fv(t.uColor,n)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),h.Image.filters.BlendColor.fromObject=h.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var v=Se.fabric,e=v.Image.filters,t=v.util.createClass;e.BlendImage=t(e.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:function(e){var t=this.type+"_"+this.mode,n=this.fragmentSource[this.mode];return e.programCache.hasOwnProperty(t)||(e.programCache[t]=this.createProgram(e.context,n)),e.programCache[t]},applyToWebGL:function(e){var t=e.context,n=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(t,n,t.TEXTURE1),this.callSuper("applyToWebGL",e),this.unbindAdditionalTexture(t,t.TEXTURE1)},createTexture:function(e,t){return e.getCachedTexture(t.cacheKey,t._element)},calculateMatrix:function(){var e=this.image,t=e._element.width,n=e._element.height;return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/t,-e.top/n,1]},applyTo2d:function(e){var t,n,i,o,r,s,a,l,c,u=e.imageData,h=e.filterBackend.resources,d=u.data,f=d.length,p=u.width,g=u.height,e=this.image;h.blendImage||(h.blendImage=v.util.createCanvasElement()),h=(u=h.blendImage).getContext("2d"),u.width!==p||u.height!==g?(u.width=p,u.height=g):h.clearRect(0,0,p,g),h.setTransform(e.scaleX,0,0,e.scaleY,e.left,e.top),h.drawImage(e._element,0,0,p,g),c=h.getImageData(0,0,p,g).data;for(var m=0;m<f;m+=4)switch(r=d[m],s=d[m+1],a=d[m+2],l=d[m+3],t=c[m],n=c[m+1],i=c[m+2],o=c[m+3],this.mode){case"multiply":d[m]=r*t/255,d[m+1]=s*n/255,d[m+2]=a*i/255,d[m+3]=l*o/255;break;case"mask":d[m+3]=o}},getUniformLocations:function(e,t){return{uTransformMatrix:e.getUniformLocation(t,"uTransformMatrix"),uImage:e.getUniformLocation(t,"uImage")}},sendUniformData:function(e,t){var n=this.calculateMatrix();e.uniform1i(t.uImage,1),e.uniformMatrix3fv(t.uTransformMatrix,!1,n)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),v.Image.filters.BlendImage.fromObject=function(n,i){v.Image.fromObject(n.image,function(e){var t=v.util.object.clone(n);t.image=e,i(new v.Image.filters.BlendImage(t))})}}(),function(){"use strict";var m=Se.fabric||(Se.fabric={}),N=Math.pow,P=Math.floor,F=Math.sqrt,M=Math.abs,s=Math.round,i=Math.sin,D=Math.ceil,e=m.Image.filters,t=m.util.createClass;e.Resize=t(e.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(e,t){return{uDelta:e.getUniformLocation(t,"uDelta"),uTaps:e.getUniformLocation(t,"uTaps")}},sendUniformData:function(e,t){e.uniform2fv(t.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),e.uniform1fv(t.uTaps,this.taps)},retrieveShader:function(e){var t=this.getFilterWindow(),n=this.type+"_"+t;return e.programCache.hasOwnProperty(n)||(t=this.generateShader(t),e.programCache[n]=this.createProgram(e.context,t)),e.programCache[n]},getFilterWindow:function(){var e=this.tempScale;return Math.ceil(this.lanczosLobes/e)},getTaps:function(){for(var e=this.lanczosCreate(this.lanczosLobes),t=this.tempScale,n=this.getFilterWindow(),i=new Array(n),o=1;o<=n;o++)i[o-1]=e(o*t);return i},generateShader:function(e){for(var t=new Array(e),n=this.fragmentSourceTOP,i=1;i<=e;i++)t[i-1]=i+".0 * uDelta";return n+="uniform float uTaps["+e+"];\n",n+="void main() {\n",n+="  vec4 color = texture2D(uTexture, vTexCoord);\n",n+="  float sum = 1.0;\n",t.forEach(function(e,t){n+="  color += texture2D(uTexture, vTexCoord + "+e+") * uTaps["+t+"];\n",n+="  color += texture2D(uTexture, vTexCoord - "+e+") * uTaps["+t+"];\n",n+="  sum += 2.0 * uTaps["+t+"];\n"}),n+="  gl_FragColor = color / sum;\n",n+="}"},fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:function(e){e.webgl?(e.passes++,this.width=e.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=e.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),e.destinationWidth=this.dW,this._setupFrameBuffer(e),this.applyToWebGL(e),this._swapTextures(e),e.sourceWidth=e.destinationWidth,this.height=e.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),e.destinationHeight=this.dH,this._setupFrameBuffer(e),this.applyToWebGL(e),this._swapTextures(e),e.sourceHeight=e.destinationHeight):this.applyTo2d(e)},isNeutralState:function(){return 1===this.scaleX&&1===this.scaleY},lanczosCreate:function(n){return function(e){if(n<=e||e<=-n)return 0;if(e<1.1920929e-7&&-1.1920929e-7<e)return 1;var t=(e*=Math.PI)/n;return i(e)/e*i(t)/t}},applyTo2d:function(e){var t=e.imageData,n=this.scaleX,i=this.scaleY;this.rcpScaleX=1/n,this.rcpScaleY=1/i;var o,r=t.width,t=t.height,n=s(r*n),i=s(t*i);"sliceHack"===this.resizeType?o=this.sliceByTwo(e,r,t,n,i):"hermite"===this.resizeType?o=this.hermiteFastResize(e,r,t,n,i):"bilinear"===this.resizeType?o=this.bilinearFiltering(e,r,t,n,i):"lanczos"===this.resizeType&&(o=this.lanczosResize(e,r,t,n,i)),e.imageData=o},sliceByTwo:function(e,t,n,i,o){var r,s,a=e.imageData,l=!1,c=!1,u=.5*t,h=.5*n,e=m.filterBackend.resources,d=0,f=0,p=t,g=0;for(e.sliceByTwo||(e.sliceByTwo=document.createElement("canvas")),((r=e.sliceByTwo).width<1.5*t||r.height<n)&&(r.width=1.5*t,r.height=n),(s=r.getContext("2d")).clearRect(0,0,1.5*t,n),s.putImageData(a,0,0),i=P(i),o=P(o);!l||!c;)n=h,i<P(.5*(t=u))?u=P(.5*u):(u=i,l=!0),o<P(.5*h)?h=P(.5*h):(h=o,c=!0),s.drawImage(r,d,f,t,n,p,g,u,h),d=p,f=g,g+=h;return s.getImageData(d,f,i,o)},lanczosResize:function(e,f,p,g,m){var v=e.imageData.data,y=e.ctx.createImageData(g,m),b=y.data,C=this.lanczosCreate(this.lanczosLobes),x=this.rcpScaleX,w=this.rcpScaleY,S=2/this.rcpScaleX,_=2/this.rcpScaleY,E=D(x*this.lanczosLobes/2),T=D(w*this.lanczosLobes/2),k={},A={},O={};return function e(t){var n,i,o,r,s,a,l,c,u,h;for(A.x=(t+.5)*x,O.x=P(A.x),n=0;n<m;n++){for(A.y=(n+.5)*w,O.y=P(A.y),c=l=a=s=r=0,i=O.x-E;i<=O.x+E;i++)if(!(i<0||f<=i)){u=P(1e3*M(i-A.x)),k[u]||(k[u]={});for(var d=O.y-T;d<=O.y+T;d++)d<0||p<=d||(h=P(1e3*M(d-A.y)),k[u][h]||(k[u][h]=C(F(N(u*S,2)+N(h*_,2))/1e3)),0<(h=k[u][h])&&(r+=h,s+=h*v[o=4*(d*f+i)],a+=h*v[o+1],l+=h*v[o+2],c+=h*v[o+3]))}b[o=4*(n*g+t)]=s/r,b[o+1]=a/r,b[o+2]=l/r,b[o+3]=c/r}return++t<g?e(t):y}(0)},bilinearFiltering:function(e,t,n,i,o){for(var r,s,a,l,c,u,h,d,f=0,p=this.rcpScaleX,g=this.rcpScaleY,m=4*(t-1),v=e.imageData.data,e=e.ctx.createImageData(i,o),y=e.data,b=0;b<o;b++)for(a=0;a<i;a++)for(l=p*a-(r=P(p*a)),c=g*b-(s=P(g*b)),d=4*(s*t+r),u=0;u<4;u++)h=v[d+u]*(1-l)*(1-c)+v[4+d+u]*l*(1-c)+v[d+m+u]*c*(1-l)+v[d+m+4+u]*l*c,y[f++]=h;return e},hermiteFastResize:function(e,t,n,i,o){for(var r=this.rcpScaleX,s=this.rcpScaleY,a=D(r/2),l=D(s/2),c=e.imageData.data,e=e.ctx.createImageData(i,o),u=e.data,h=0;h<o;h++)for(var d=0;d<i;d++){for(var f=4*(d+h*i),p=0,g=0,m=0,v=0,y=0,b=0,C=0,x=(h+.5)*s,w=P(h*s);w<(h+1)*s;w++)for(var S=M(x-(w+.5))/l,_=(d+.5)*r,E=S*S,T=P(d*r);T<(d+1)*r;T++){var k=M(_-(T+.5))/a,A=F(E+k*k);1<A&&A<-1||0<(p=2*A*A*A-3*A*A+1)&&(C+=p*c[3+(k=4*(T+w*t))],m+=p,c[3+k]<255&&(p=p*c[3+k]/250),v+=p*c[k],y+=p*c[1+k],b+=p*c[2+k],g+=p)}u[f]=v/g,u[1+f]=y/g,u[2+f]=b/g,u[3+f]=C/m}return e},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),m.Image.filters.Resize.fromObject=m.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Contrast=n(t.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:function(e){if(0!==this.contrast)for(var t=e.imageData.data,n=t.length,e=Math.floor(255*this.contrast),i=259*(e+255)/(255*(259-e)),o=0;o<n;o+=4)t[o]=i*(t[o]-128)+128,t[o+1]=i*(t[o+1]-128)+128,t[o+2]=i*(t[o+2]-128)+128},getUniformLocations:function(e,t){return{uContrast:e.getUniformLocation(t,"uContrast")}},sendUniformData:function(e,t){e.uniform1f(t.uContrast,this.contrast)}}),e.Image.filters.Contrast.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Saturation=n(t.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:function(e){if(0!==this.saturation)for(var t,n=e.imageData.data,i=n.length,o=-this.saturation,r=0;r<i;r+=4)t=Math.max(n[r],n[r+1],n[r+2]),n[r]+=t!==n[r]?(t-n[r])*o:0,n[r+1]+=t!==n[r+1]?(t-n[r+1])*o:0,n[r+2]+=t!==n[r+2]?(t-n[r+2])*o:0},getUniformLocations:function(e,t){return{uSaturation:e.getUniformLocation(t,"uSaturation")}},sendUniformData:function(e,t){e.uniform1f(t.uSaturation,-this.saturation)}}),e.Image.filters.Saturation.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var f=Se.fabric||(Se.fabric={}),e=f.Image.filters,t=f.util.createClass;e.Blur=t(e.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:function(e){e.webgl?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},applyTo2d:function(e){e.imageData=this.simpleBlur(e)},simpleBlur:function(e){var t,n,i=e.filterBackend.resources,o=e.imageData.width,r=e.imageData.height;i.blurLayer1||(i.blurLayer1=f.util.createCanvasElement(),i.blurLayer2=f.util.createCanvasElement()),t=i.blurLayer1,n=i.blurLayer2,t.width===o&&t.height===r||(n.width=t.width=o,n.height=t.height=r);var s,a,l,c,u=t.getContext("2d"),h=n.getContext("2d"),d=.06*this.blur*.5;for(u.putImageData(e.imageData,0,0),h.clearRect(0,0,o,r),c=-15;c<=15;c++)l=d*(a=c/15)*o+(s=(Math.random()-.5)/4),h.globalAlpha=1-Math.abs(a),h.drawImage(t,l,s),u.drawImage(n,0,0),h.globalAlpha=1,h.clearRect(0,0,n.width,n.height);for(c=-15;c<=15;c++)l=d*(a=c/15)*r+(s=(Math.random()-.5)/4),h.globalAlpha=1-Math.abs(a),h.drawImage(t,s,l),u.drawImage(n,0,0),h.globalAlpha=1,h.clearRect(0,0,n.width,n.height);e.ctx.drawImage(t,0,0);e=e.ctx.getImageData(0,0,t.width,t.height);return u.globalAlpha=1,u.clearRect(0,0,t.width,t.height),e},getUniformLocations:function(e,t){return{delta:e.getUniformLocation(t,"uDelta")}},sendUniformData:function(e,t){var n=this.chooseRightDelta();e.uniform2fv(t.delta,n)},chooseRightDelta:function(){var e=1,t=[0,0];return this.horizontal?1<this.aspectRatio&&(e=1/this.aspectRatio):this.aspectRatio<1&&(e=this.aspectRatio),e=e*this.blur*.12,this.horizontal?t[0]=e:t[1]=e,t}}),e.Blur.fromObject=f.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Se.fabric||(Se.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Gamma=n(t.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:function(e){this.gamma=[1,1,1],t.BaseFilter.prototype.initialize.call(this,e)},applyTo2d:function(e){var t,n=e.imageData.data,e=this.gamma,i=n.length,o=1/e[0],r=1/e[1],s=1/e[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),t=0,i=256;t<i;t++)this.rVals[t]=255*Math.pow(t/255,o),this.gVals[t]=255*Math.pow(t/255,r),this.bVals[t]=255*Math.pow(t/255,s);for(t=0,i=n.length;t<i;t+=4)n[t]=this.rVals[n[t]],n[t+1]=this.gVals[n[t+1]],n[t+2]=this.bVals[n[t+2]]},getUniformLocations:function(e,t){return{uGamma:e.getUniformLocation(t,"uGamma")}},sendUniformData:function(e,t){e.uniform3fv(t.uGamma,this.gamma)}}),e.Image.filters.Gamma.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var n=Se.fabric||(Se.fabric={}),e=n.Image.filters,t=n.util.createClass;e.Composed=t(e.BaseFilter,{type:"Composed",subFilters:[],initialize:function(e){this.callSuper("initialize",e),this.subFilters=this.subFilters.slice(0)},applyTo:function(t){t.passes+=this.subFilters.length-1,this.subFilters.forEach(function(e){e.applyTo(t)})},toObject:function(){return n.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(e){return e.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(e){return!e.isNeutralState()})}}),n.Image.filters.Composed.fromObject=function(e,t){e=(e.subFilters||[]).map(function(e){return new n.Image.filters[e.type](e)}),e=new n.Image.filters.Composed({subFilters:e});return t&&t(e),e}}(),function(){"use strict";var i=Se.fabric||(Se.fabric={}),t=i.Image.filters,e=i.util.createClass;t.HueRotation=e(t.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var e=this.rotation*Math.PI,t=i.util.cos(e),n=i.util.sin(e),e=Math.sqrt(1/3)*n,n=1-t;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=t+n/3,this.matrix[1]=1/3*n-e,this.matrix[2]=1/3*n+e,this.matrix[5]=1/3*n+e,this.matrix[6]=t+1/3*n,this.matrix[7]=1/3*n-e,this.matrix[10]=1/3*n-e,this.matrix[11]=1/3*n+e,this.matrix[12]=t+1/3*n},isNeutralState:function(e){return this.calculateMatrix(),t.BaseFilter.prototype.isNeutralState.call(this,e)},applyTo:function(e){this.calculateMatrix(),t.BaseFilter.prototype.applyTo.call(this,e)}}),i.Image.filters.HueRotation.fromObject=i.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var s=Se.fabric||(Se.fabric={}),a=s.util.object.clone;s.Text?s.warn("fabric.Text is already defined"):(s.Text=s.util.createClass(s.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:s.Object.prototype.stateProperties.concat("fontFamily","fontWeight","fontSize","text","underline","overline","linethrough","textAlign","fontStyle","lineHeight","textBackgroundColor","charSpacing","styles"),cacheProperties:s.Object.prototype.cacheProperties.concat("fontFamily","fontWeight","fontSize","text","underline","overline","linethrough","textAlign","fontStyle","lineHeight","textBackgroundColor","charSpacing","styles"),stroke:null,shadow:null,_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(e,t){this.styles=t&&t.styles||{},this.text=e,this.__skipDimension=!0,this.callSuper("initialize",t),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},getMeasuringContext:function(){return s._measuringContext||(s._measuringContext=this.canvas&&this.canvas.contextCache||s.util.createCanvasElement().getContext("2d")),s._measuringContext},_splitText:function(){var e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var e,t,n,i,o,r,s,a=0,l=this._textLines.length;a<l;a++)if(("justify"===this.textAlign||a!==l-1&&!this.isEndOfWrapping(a))&&(i=0,o=this._textLines[a],(t=this.getLineWidth(a))<this.width&&(s=this.textLines[a].match(this._reSpacesAndTabs)))){n=s.length,e=(this.width-t)/n;for(var c=0,u=o.length;c<=u;c++)r=this.__charBounds[a][c],this._reSpaceAndTab.test(o[c])?(r.width+=e,r.kernedWidth+=e,r.left+=i,i+=e):r.left+=i}},isEndOfWrapping:function(e){return e===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var e=this.callSuper("_getCacheCanvasDimensions"),t=this.fontSize;return e.width+=t*e.zoomX,e.height+=t*e.zoomY,e},_render:function(e){this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")},_renderText:function(e){"stroke"===this.paintFirst?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))},_setTextStyles:function(e,t,n){e.textBaseline="alphabetic",e.font=this._getFontDeclaration(t,n)},calcTextWidth:function(){for(var e=this.getLineWidth(0),t=1,n=this._textLines.length;t<n;t++){var i=this.getLineWidth(t);e<i&&(e=i)}return e},_renderTextLine:function(e,t,n,i,o,r){this._renderChars(e,t,n,i,o,r)},_renderTextLinesBackground:function(e){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var t,n,i,o,r,s,a=0,l=e.fillStyle,c=this._getLeftOffset(),u=this._getTopOffset(),h=0,d=0,f=0,p=this._textLines.length;f<p;f++)if(t=this.getHeightOfLine(f),this.textBackgroundColor||this.styleHas("textBackgroundColor",f)){i=this._textLines[f],n=this._getLineLeftOffset(f),h=d=0,o=this.getValueOfPropertyAt(f,0,"textBackgroundColor");for(var g=0,m=i.length;g<m;g++)r=this.__charBounds[f][g],(s=this.getValueOfPropertyAt(f,g,"textBackgroundColor"))!==o?((e.fillStyle=o)&&e.fillRect(c+n+h,u+a,d,t/this.lineHeight),h=r.left,d=r.width,o=s):d+=r.kernedWidth;s&&(e.fillStyle=s,e.fillRect(c+n+h,u+a,d,t/this.lineHeight)),a+=t}else a+=t;e.fillStyle=l,this._removeShadow(e)}},getFontCache:function(e){var t=e.fontFamily.toLowerCase();s.charWidthsCache[t]||(s.charWidthsCache[t]={});t=s.charWidthsCache[t],e=e.fontStyle.toLowerCase()+"_"+(e.fontWeight+"").toLowerCase();return t[e]||(t[e]={}),t[e]},_applyCharStyles:function(e,t,n,i,o){this._setFillStyles(t,o),this._setStrokeStyles(t,o),t.font=this._getFontDeclaration(o)},_measureChar:function(e,t,n,i){var o,r,s,a,l,c=this.getFontCache(t),u=n+e,h=this._getFontDeclaration(t)===this._getFontDeclaration(i),i=t.fontSize/this.CACHE_FONT_SIZE;return n&&void 0!==c[n]&&(s=c[n]),void 0!==c[e]&&(a=o=c[e]),h&&void 0!==c[u]&&(a=(r=c[u])-s),void 0!==o&&void 0!==s&&void 0!==r||(l=this.getMeasuringContext(),this._setTextStyles(l,t,!0)),void 0===o&&(a=o=l.measureText(e).width,c[e]=o),void 0===s&&h&&n&&(s=l.measureText(n).width,c[n]=s),h&&void 0===r&&(r=l.measureText(u).width,a=(c[u]=r)-s),{width:o*i,kernedWidth:a*i}},getHeightOfChar:function(e,t){return this.getValueOfPropertyAt(e,t,"fontSize")},measureLine:function(e){e=this._measureLine(e);return 0!==this.charSpacing&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e},_measureLine:function(e){var t,n,i,o,r=0,s=this._textLines[e],a=new Array(s.length);for(this.__charBounds[e]=a,t=0;t<s.length;t++)n=s[t],o=this._getGraphemeBox(n,e,t,i),r+=(a[t]=o).kernedWidth,i=n;return a[t]={left:o?o.left+o.width:0,width:0,kernedWidth:0,height:this.fontSize},{width:r,numOfSpaces:0}},_getGraphemeBox:function(e,t,n,i,o){var r=this.getCompleteStyleDeclaration(t,n),s=i?this.getCompleteStyleDeclaration(t,n-1):{},a=this._measureChar(e,r,i,s),e=a.kernedWidth,i=a.width;0!==this.charSpacing&&(i+=s=this._getWidthOfCharSpacing(),e+=s);r={width:i,left:0,height:r.fontSize,kernedWidth:e,deltaY:r.deltaY};return 0<n&&!o&&(n=this.__charBounds[t][n-1],r.left=n.left+n.width+a.kernedWidth-a.width),r},getHeightOfLine:function(e){if(this.__lineHeights[e])return this.__lineHeights[e];for(var t=this._textLines[e],n=this.getHeightOfChar(e,0),i=1,o=t.length;i<o;i++)n=Math.max(this.getHeightOfChar(e,i),n);return this.__lineHeights[e]=n*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var e,t=0,n=0,i=this._textLines.length;n<i;n++)e=this.getHeightOfLine(n),t+=n===i-1?e/this.lineHeight:e;return t},_getLeftOffset:function(){return-this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(e,t){e.save();for(var n=0,i=this._getLeftOffset(),o=this._getTopOffset(),r=this._applyPatternGradientTransform(e,"fillText"===t?this.fill:this.stroke),s=0,a=this._textLines.length;s<a;s++){var l=this.getHeightOfLine(s),c=l/this.lineHeight,u=this._getLineLeftOffset(s);this._renderTextLine(t,e,this._textLines[s],i+u-r.offsetX,o+n+c-r.offsetY,s),n+=l}e.restore()},_renderTextFill:function(e){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(e,"fillText")},_renderTextStroke:function(e){(this.stroke&&0!==this.strokeWidth||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())},_renderChars:function(e,t,n,i,o,r){var s,a,l,c,u=this.getHeightOfLine(r),h=-1!==this.textAlign.indexOf("justify"),d="",f=0,p=!h&&0===this.charSpacing&&this.isEmptyStyles(r);if(t.save(),o-=u*this._fontSizeFraction/this.lineHeight,p)return this._renderChar(e,t,r,0,n.join(""),i,o,u),void t.restore();for(var g=0,m=n.length-1;g<=m;g++)c=g===m||this.charSpacing,d+=n[g],l=this.__charBounds[r][g],0===f?(i+=l.kernedWidth-l.width,f+=l.width):f+=l.kernedWidth,h&&!c&&this._reSpaceAndTab.test(n[g])&&(c=!0),c||(s=s||this.getCompleteStyleDeclaration(r,g),a=this.getCompleteStyleDeclaration(r,g+1),c=this._hasStyleChanged(s,a)),c&&(this._renderChar(e,t,r,g,d,i,o,u),d="",s=a,i+=f,f=0);t.restore()},_renderChar:function(e,t,n,i,o,r,s){var a=this._getStyleDeclaration(n,i),l=this.getCompleteStyleDeclaration(n,i),c="fillText"===e&&l.fill,u="strokeText"===e&&l.stroke&&l.strokeWidth;(u||c)&&(a&&t.save(),this._applyCharStyles(e,t,n,i,l),a&&a.textBackgroundColor&&this._removeShadow(t),a&&a.deltaY&&(s+=a.deltaY),c&&t.fillText(o,r,s),u&&t.strokeText(o,r,s),a&&t.restore())},setSuperscript:function(e,t){return this._setScript(e,t,this.superscript)},setSubscript:function(e,t){return this._setScript(e,t,this.subscript)},_setScript:function(e,t,n){var i=this.get2DCursorLocation(e,!0),o=this.getValueOfPropertyAt(i.lineIndex,i.charIndex,"fontSize"),i=this.getValueOfPropertyAt(i.lineIndex,i.charIndex,"deltaY"),n={fontSize:o*n.size,deltaY:i+o*n.baseline};return this.setSelectionStyles(n,e,t),this},_hasStyleChanged:function(e,t){return e.fill!==t.fill||e.stroke!==t.stroke||e.strokeWidth!==t.strokeWidth||e.fontSize!==t.fontSize||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontStyle!==t.fontStyle||e.deltaY!==t.deltaY},_hasStyleChangedForSvg:function(e,t){return this._hasStyleChanged(e,t)||e.overline!==t.overline||e.underline!==t.underline||e.linethrough!==t.linethrough},_getLineLeftOffset:function(e){var t=this.getLineWidth(e);return"center"===this.textAlign?(this.width-t)/2:"right"===this.textAlign?this.width-t:"justify-center"===this.textAlign&&this.isEndOfWrapping(e)?(this.width-t)/2:"justify-right"===this.textAlign&&this.isEndOfWrapping(e)?this.width-t:0},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var e=this._forceClearCache;return(e=e||this.hasStateChanged("_dimensionAffectingProps"))&&(this.dirty=!0,this._forceClearCache=!1),e},getLineWidth:function(e){if(this.__lineWidths[e])return this.__lineWidths[e];var t=""===this._textLines[e]?0:this.measureLine(e).width;return this.__lineWidths[e]=t},_getWidthOfCharSpacing:function(){return 0!==this.charSpacing?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(e,t,n){t=this._getStyleDeclaration(e,t);return(t&&void 0!==t[n]?t:this)[n]},_renderTextDecoration:function(e,t){if(this[t]||this.styleHas(t)){for(var n,i,o,r,s,a,l,c,u,h,d,f,p,g,m,v,y=this._getLeftOffset(),b=this._getTopOffset(),C=this._getWidthOfCharSpacing(),x=0,w=this._textLines.length;x<w;x++)if(n=this.getHeightOfLine(x),this[t]||this.styleHas(t,x)){l=this._textLines[x],g=n/this.lineHeight,r=this._getLineLeftOffset(x),d=h=0,c=this.getValueOfPropertyAt(x,0,t),v=this.getValueOfPropertyAt(x,0,"fill"),u=b+g*(1-this._fontSizeFraction),i=this.getHeightOfChar(x,0),s=this.getValueOfPropertyAt(x,0,"deltaY");for(var S=0,_=l.length;S<_;S++)f=this.__charBounds[x][S],p=this.getValueOfPropertyAt(x,S,t),m=this.getValueOfPropertyAt(x,S,"fill"),o=this.getHeightOfChar(x,S),a=this.getValueOfPropertyAt(x,S,"deltaY"),(p!==c||m!==v||o!==i||a!==s)&&0<d?(e.fillStyle=v,c&&v&&e.fillRect(y+r+h,u+this.offsets[t]*i+s,d,this.fontSize/15),h=f.left,d=f.width,c=p,v=m,i=o,s=a):d+=f.kernedWidth;e.fillStyle=m,p&&m&&e.fillRect(y+r+h,u+this.offsets[t]*i+s,d-C,this.fontSize/15),b+=n}else b+=n;this._removeShadow(e)}},_getFontDeclaration:function(e,t){var n=e||this,i=this.fontFamily,e=-1<s.Text.genericFonts.indexOf(i.toLowerCase()),e=void 0===i||-1<i.indexOf("'")||-1<i.indexOf(",")||-1<i.indexOf('"')||e?n.fontFamily:'"'+n.fontFamily+'"';return[s.isLikelyNode?n.fontWeight:n.fontStyle,s.isLikelyNode?n.fontStyle:n.fontWeight,t?this.CACHE_FONT_SIZE+"px":n.fontSize+"px",e].join(" ")},render:function(e){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",e)))},_splitTextIntoLines:function(e){for(var t=e.split(this._reNewline),n=new Array(t.length),i=["\n"],o=[],r=0;r<t.length;r++)n[r]=s.util.string.graphemeSplit(t[r]),o=o.concat(n[r],i);return o.pop(),{_unwrappedLines:n,lines:t,graphemeText:o,graphemeLines:n}},toObject:function(e){e=["text","fontSize","fontWeight","fontFamily","fontStyle","lineHeight","underline","overline","linethrough","textAlign","textBackgroundColor","charSpacing"].concat(e),e=this.callSuper("toObject",e);return e.styles=a(this.styles,!0),e},set:function(e,t){this.callSuper("set",e,t);var n=!1;if("object"==typeof e)for(var i in e)n=n||-1!==this._dimensionAffectingProps.indexOf(i);else n=-1!==this._dimensionAffectingProps.indexOf(e);return n&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),s.Text.ATTRIBUTE_NAMES=s.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),s.Text.DEFAULT_SVG_FONT_SIZE=16,s.Text.fromElement=function(e,t,n){if(!e)return t(null);var i=s.parseAttributes(e,s.Text.ATTRIBUTE_NAMES),o=i.textAnchor||"left";(n=s.util.object.extend(n?a(n):{},i)).top=n.top||0,n.left=n.left||0,i.textDecoration&&(-1!==(r=i.textDecoration).indexOf("underline")&&(n.underline=!0),-1!==r.indexOf("overline")&&(n.overline=!0),-1!==r.indexOf("line-through")&&(n.linethrough=!0),delete n.textDecoration),"dx"in i&&(n.left+=i.dx),"dy"in i&&(n.top+=i.dy),"fontSize"in n||(n.fontSize=s.Text.DEFAULT_SVG_FONT_SIZE);var r="";"textContent"in e?r=e.textContent:"firstChild"in e&&null!==e.firstChild&&"data"in e.firstChild&&null!==e.firstChild.data&&(r=e.firstChild.data),r=r.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");i=n.strokeWidth;n.strokeWidth=0;e=new s.Text(r,n),r=e.getScaledHeight()/e.height,n=((e.height+e.strokeWidth)*e.lineHeight-e.height)*r,r=e.getScaledHeight()+n,n=0;"center"===o&&(n=e.getScaledWidth()/2),"right"===o&&(n=e.getScaledWidth()),e.set({left:e.left-n,top:e.top-(r-e.fontSize*(.07+e._fontSizeFraction))/e.lineHeight,strokeWidth:void 0!==i?i:1}),t(e)},s.Text.fromObject=function(e,t){return s.Object._fromObject("Text",e,t,"text")},s.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],s.util.createAccessors&&s.util.createAccessors(s.Text))}(),X.util.object.extend(X.Text.prototype,{isEmptyStyles:function(e){if(!this.styles)return!0;if(void 0!==e&&!this.styles[e])return!0;var t,n=void 0===e?this.styles:{line:this.styles[e]};for(t in n)for(var i in n[t])for(var o in n[t][i])return!1;return!0},styleHas:function(e,t){if(!this.styles||!e||""===e)return!1;if(void 0!==t&&!this.styles[t])return!1;var n,i=void 0===t?this.styles:{0:this.styles[t]};for(n in i)for(var o in i[n])if(void 0!==i[n][o][e])return!0;return!1},cleanStyle:function(e){if(!this.styles||!e||""===e)return!1;var t,n,i,o,r=this.styles,s=0,a=!0,l=0;for(o in r){for(var c in t=0,r[o])s++,(i=r[o][c]).hasOwnProperty(e)?(n?i[e]!==n&&(a=!1):n=i[e],i[e]===this[e]&&delete i[e]):a=!1,0!==Object.keys(i).length?t++:delete r[o][c];0===t&&delete r[o]}for(var u=0;u<this._textLines.length;u++)l+=this._textLines[u].length;a&&s===l&&(this[e]=n,this.removeStyle(e))},removeStyle:function(e){if(this.styles&&e&&""!==e){var t,n,i,o=this.styles;for(n in o){for(i in t=o[n])delete t[i][e],0===Object.keys(t[i]).length&&delete t[i];0===Object.keys(t).length&&delete o[n]}}},_extendStyles:function(e,t){e=this.get2DCursorLocation(e);this._getLineStyle(e.lineIndex)||this._setLineStyle(e.lineIndex),this._getStyleDeclaration(e.lineIndex,e.charIndex)||this._setStyleDeclaration(e.lineIndex,e.charIndex,{}),X.util.object.extend(this._getStyleDeclaration(e.lineIndex,e.charIndex),t)},get2DCursorLocation:function(e,t){void 0===e&&(e=this.selectionStart);for(var n=t?this._unwrappedTextLines:this._textLines,i=n.length,o=0;o<i;o++){if(e<=n[o].length)return{lineIndex:o,charIndex:e};e-=n[o].length+this.missingNewlineOffset(o)}return{lineIndex:o-1,charIndex:n[o-1].length<e?n[o-1].length:e}},getSelectionStyles:function(e,t,n){void 0===e&&(e=this.selectionStart||0),void 0===t&&(t=this.selectionEnd||e);for(var i=[],o=e;o<t;o++)i.push(this.getStyleAtPosition(o,n));return i},getStyleAtPosition:function(e,t){e=this.get2DCursorLocation(e);return(t?this.getCompleteStyleDeclaration(e.lineIndex,e.charIndex):this._getStyleDeclaration(e.lineIndex,e.charIndex))||{}},setSelectionStyles:function(e,t,n){void 0===t&&(t=this.selectionStart||0),void 0===n&&(n=this.selectionEnd||t);for(var i=t;i<n;i++)this._extendStyles(i,e);return this._forceClearCache=!0,this},_getStyleDeclaration:function(e,t){e=this.styles&&this.styles[e];return e?e[t]:null},getCompleteStyleDeclaration:function(e,t){for(var n,i=this._getStyleDeclaration(e,t)||{},o={},r=0;r<this._styleProperties.length;r++)o[n=this._styleProperties[r]]=(void 0===i[n]?this:i)[n];return o},_setStyleDeclaration:function(e,t,n){this.styles[e][t]=n},_deleteStyleDeclaration:function(e,t){delete this.styles[e][t]},_getLineStyle:function(e){return!!this.styles[e]},_setLineStyle:function(e){this.styles[e]={}},_deleteLineStyle:function(e){delete this.styles[e]}}),X.IText=X.util.createClass(X.Text,X.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(e,t){this.callSuper("initialize",e,t),this.initBehavior()},setSelectionStart:function(e){e=Math.max(e,0),this._updateAndFire("selectionStart",e)},setSelectionEnd:function(e){e=Math.min(e,this.text.length),this._updateAndFire("selectionEnd",e)},_updateAndFire:function(e,t){this[e]!==t&&(this._fireSelectionChanged(),this[e]=t),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(e){this.clearContextTop(),this.callSuper("render",e),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(e){this.callSuper("_render",e)},clearContextTop:function(e){var t,n;this.isEditing&&this.canvas&&this.canvas.contextTop&&(t=this.canvas.contextTop,n=this.canvas.viewportTransform,t.save(),t.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this.transform(t),this._clearTextArea(t),e||t.restore())},renderCursorOrSelection:function(){var e,t;this.isEditing&&this.canvas&&this.canvas.contextTop&&(e=this._getCursorBoundaries(),t=this.canvas.contextTop,this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(e,t):this.renderSelection(e,t),t.restore())},_clearTextArea:function(e){var t=this.width+4,n=this.height+4;e.clearRect(-t/2,-n/2,t,n)},_getCursorBoundaries:function(e){void 0===e&&(e=this.selectionStart);var t=this._getLeftOffset(),n=this._getTopOffset(),e=this._getCursorBoundariesOffsets(e);return{left:t,top:n,leftOffset:e.left,topOffset:e.top}},_getCursorBoundariesOffsets:function(e){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;for(var t=0,n=0,i=this.get2DCursorLocation(e),o=i.charIndex,r=i.lineIndex,s=0;s<r;s++)t+=this.getHeightOfLine(s);e=this._getLineLeftOffset(r);i=this.__charBounds[r][o];return i&&(n=i.left),0!==this.charSpacing&&o===this._textLines[r].length&&(n-=this._getWidthOfCharSpacing()),n={top:t,left:e+(0<n?n:0)},this.cursorOffsetCache=n,this.cursorOffsetCache},renderCursor:function(e,t){var n=this.get2DCursorLocation(),i=n.lineIndex,o=0<n.charIndex?n.charIndex-1:0,r=this.getValueOfPropertyAt(i,o,"fontSize"),s=this.scaleX*this.canvas.getZoom(),a=this.cursorWidth/s,n=e.topOffset,s=this.getValueOfPropertyAt(i,o,"deltaY");n+=(1-this._fontSizeFraction)*this.getHeightOfLine(i)/this.lineHeight-r*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(e,t),t.fillStyle=this.cursorColor||this.getValueOfPropertyAt(i,o,"fill"),t.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,t.fillRect(e.left+e.leftOffset-a/2,n+e.top+s,a,r)},renderSelection:function(e,t){for(var n=(this.inCompositionMode?this.hiddenTextarea:this).selectionStart,i=(this.inCompositionMode?this.hiddenTextarea:this).selectionEnd,o=-1!==this.textAlign.indexOf("justify"),n=this.get2DCursorLocation(n),i=this.get2DCursorLocation(i),r=n.lineIndex,s=i.lineIndex,a=n.charIndex<0?0:n.charIndex,l=i.charIndex<0?0:i.charIndex,c=r;c<=s;c++){var u,h=this._getLineLeftOffset(c)||0,d=this.getHeightOfLine(c),f=0,p=0;c===r&&(f=this.__charBounds[r][a].left),r<=c&&c<s?p=o&&!this.isEndOfWrapping(c)?this.width:this.getLineWidth(c)||5:c===s&&(p=0===l?this.__charBounds[s][l].left:(u=this._getWidthOfCharSpacing(),this.__charBounds[s][l-1].left+this.__charBounds[s][l-1].width-u)),u=d,(this.lineHeight<1||c===s&&1<this.lineHeight)&&(d/=this.lineHeight),this.inCompositionMode?(t.fillStyle=this.compositionColor||"black",t.fillRect(e.left+h+f,e.top+e.topOffset+d,p-f,1)):(t.fillStyle=this.selectionColor,t.fillRect(e.left+h+f,e.top+e.topOffset,p-f,d)),e.topOffset+=u}},getCurrentCharFontSize:function(){var e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,"fontSize")},getCurrentCharColor:function(){var e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,"fill")},_getCurrentCharIndex:function(){var e=this.get2DCursorLocation(this.selectionStart,!0),t=0<e.charIndex?e.charIndex-1:0;return{l:e.lineIndex,c:t}}}),X.IText.fromObject=function(e,t){if(we(e),e.styles)for(var n in e.styles)for(var i in e.styles[n])we(e.styles[n][i]);X.Object._fromObject("IText",e,t,"text")},I=X.util.object.clone,X.util.object.extend(X.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var t=this;this.on("added",function(){var e=t.canvas;e&&(e._hasITextHandlers||(e._hasITextHandlers=!0,t._initCanvasHandlers(e)),e._iTextInstances=e._iTextInstances||[],e._iTextInstances.push(t))})},initRemovedHandler:function(){var t=this;this.on("removed",function(){var e=t.canvas;e&&(e._iTextInstances=e._iTextInstances||[],X.util.removeFromArray(e._iTextInstances,t),0===e._iTextInstances.length&&(e._hasITextHandlers=!1,t._removeCanvasHandlers(e)))})},_initCanvasHandlers:function(e){e._mouseUpITextHandler=function(){e._iTextInstances&&e._iTextInstances.forEach(function(e){e.__isMousedown=!1})},e.on("mouse:up",e._mouseUpITextHandler)},_removeCanvasHandlers:function(e){e.off("mouse:up",e._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(e,t,n,i){var o={isAborted:!1,abort:function(){this.isAborted=!0}};return e.animate("_currentCursorOpacity",t,{duration:n,onComplete:function(){o.isAborted||e[i]()},onChange:function(){e.canvas&&e.selectionStart===e.selectionEnd&&e.renderCursorOrSelection()},abort:function(){return o.isAborted}}),o},_onTickComplete:function(){var e=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){e._currentTickCompleteState=e._animateCursor(e,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(e){var t=this,e=e?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){t._tick()},e)},abortCursorAnimation:function(){var e=this._currentTickState||this._currentTickCompleteState,t=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,e&&t&&t.clearContext(t.contextTop||t.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(e){var t=0,n=e-1;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)t++,n--;for(;/\S/.test(this._text[n])&&-1<n;)t++,n--;return e-t},findWordBoundaryRight:function(e){var t=0,n=e;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)t++,n++;for(;/\S/.test(this._text[n])&&n<this._text.length;)t++,n++;return e+t},findLineBoundaryLeft:function(e){for(var t=0,n=e-1;!/\n/.test(this._text[n])&&-1<n;)t++,n--;return e-t},findLineBoundaryRight:function(e){for(var t=0,n=e;!/\n/.test(this._text[n])&&n<this._text.length;)t++,n++;return e+t},searchWordBoundary:function(e,t){for(var n=this._text,i=this._reSpace.test(n[e])?e-1:e,o=n[i],r=X.reNonWord;!r.test(o)&&0<i&&i<n.length;)o=n[i+=t];return r.test(o)&&(i+=1===t?0:1),i},selectWord:function(e){e=e||this.selectionStart;var t=this.searchWordBoundary(e,-1),e=this.searchWordBoundary(e,1);this.selectionStart=t,this.selectionEnd=e,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(e){e=e||this.selectionStart;var t=this.findLineBoundaryLeft(e),e=this.findLineBoundaryRight(e);return this.selectionStart=t,this.selectionEnd=e,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(e){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(e),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas&&(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll()),this},exitEditingOnOthers:function(e){e._iTextInstances&&e._iTextInstances.forEach(function(e){e.selected=!1,e.isEditing&&e.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(e){var t,n;this.__isMousedown&&this.isEditing&&(t=this.getSelectionStartFromPointer(e.e),n=this.selectionStart,e=this.selectionEnd,(t===this.__selectionStartOnMouseDown&&n!==e||n!==t&&e!==t)&&(t>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=t):(this.selectionStart=t,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===n&&this.selectionEnd===e||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection())))},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(e,t,n){var i=n.slice(0,e),i=X.util.string.graphemeSplit(i).length;if(e===t)return{selectionStart:i,selectionEnd:i};t=n.slice(e,t);return{selectionStart:i,selectionEnd:i+X.util.string.graphemeSplit(t).length}},fromGraphemeToStringSelection:function(e,t,n){var i=n.slice(0,e).join("").length;return e===t?{selectionStart:i,selectionEnd:i}:{selectionStart:i,selectionEnd:i+n.slice(e,t).join("").length}},_updateTextarea:function(){var e;this.cursorOffsetCache={},this.hiddenTextarea&&(this.inCompositionMode||(e=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text),this.hiddenTextarea.selectionStart=e.selectionStart,this.hiddenTextarea.selectionEnd=e.selectionEnd),this.updateTextareaPosition())},updateFromTextArea:function(){var e;this.hiddenTextarea&&(this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),e=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),this.selectionEnd=this.selectionStart=e.selectionEnd,this.inCompositionMode||(this.selectionStart=e.selectionStart),this.updateTextareaPosition())},updateTextareaPosition:function(){var e;this.selectionStart===this.selectionEnd&&(e=this._calcTextareaPosition(),this.hiddenTextarea.style.left=e.left,this.hiddenTextarea.style.top=e.top)},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var e=this.inCompositionMode?this.compositionStart:this.selectionStart,t=this._getCursorBoundaries(e),n=this.get2DCursorLocation(e),i=n.lineIndex,o=n.charIndex,r=this.getValueOfPropertyAt(i,o,"fontSize")*this.lineHeight,s=t.leftOffset,a=this.calcTransformMatrix(),e={x:t.left+s,y:t.top+t.topOffset+r},n=this.canvas.getRetinaScaling(),i=this.canvas.upperCanvasEl,o=i.width/n,s=i.height/n,t=o-r,n=s-r,o=i.clientWidth/o,s=i.clientHeight/s,e=X.util.transformPoint(e,a);return(e=X.util.transformPoint(e,this.canvas.viewportTransform)).x*=o,e.y*=s,e.x<0&&(e.x=0),e.x>t&&(e.x=t),e.y<0&&(e.y=0),e.y>n&&(e.y=n),e.x+=this.canvas._offset.left,e.y+=this.canvas._offset.top,{left:e.x+"px",top:e.y+"px",fontSize:r+"px",charHeight:r}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var e=this._textBeforeEdit!==this.text,t=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,t&&(t.blur&&t.blur(),t.parentNode&&t.parentNode.removeChild(t)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),e&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),e&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var e in this.styles)this._textLines[e]||delete this.styles[e]},removeStyleFromTo:function(e,t){var n,e=this.get2DCursorLocation(e,!0),t=this.get2DCursorLocation(t,!0),i=e.lineIndex,o=e.charIndex,r=t.lineIndex,s=t.charIndex;if(i!==r){if(this.styles[i])for(u=o;u<this._unwrappedTextLines[i].length;u++)delete this.styles[i][u];if(this.styles[r])for(u=s;u<this._unwrappedTextLines[r].length;u++)(n=this.styles[r][u])&&(this.styles[i]||(this.styles[i]={}),this.styles[i][o+u-s]=n);for(u=i+1;u<=r;u++)delete this.styles[u];this.shiftLineStyles(r,i-r)}else if(this.styles[i]){n=this.styles[i];for(var a,l,c=s-o,u=o;u<s;u++)delete n[u];for(l in this.styles[i])s<=(a=parseInt(l,10))&&(n[a-c]=n[l],delete n[l])}},shiftLineStyles:function(e,t){var n,i=I(this.styles);for(n in this.styles){var o=parseInt(n,10);e<o&&(this.styles[o+t]=i[o],i[o-t]||delete this.styles[o])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(e,t,n,i){var o,r,s={},a=!1,l=this._unwrappedTextLines[e].length===t;for(r in n=n||1,this.shiftLineStyles(e,n),this.styles[e]&&(o=this.styles[e][0===t?t:t-1]),this.styles[e]){var c=parseInt(r,10);t<=c&&(a=!0,s[c-t]=this.styles[e][r],l&&0===t||delete this.styles[e][r])}var u=!1;for(a&&!l&&(this.styles[e+n]=s,u=!0),u&&n--;0<n;)i&&i[n-1]?this.styles[e+n]={0:I(i[n-1])}:o?this.styles[e+n]={0:I(o)}:delete this.styles[e+n],n--;this._forceClearCache=!0},insertCharStyleObject:function(e,t,n,i){this.styles||(this.styles={});var o,r=this.styles[e],s=r?I(r):{};for(o in n=n||1,s){var a=parseInt(o,10);t<=a&&(r[a+n]=s[a],s[a-n]||delete r[a])}if(this._forceClearCache=!0,i)for(;n--;)Object.keys(i[n]).length&&(this.styles[e]||(this.styles[e]={}),this.styles[e][t+n]=I(i[n]));else if(r)for(var l=r[t?t-1:1];l&&n--;)this.styles[e][t+n]=I(l)},insertNewStyleBlock:function(e,t,n){for(var i=this.get2DCursorLocation(t,!0),o=[0],r=0,s=0;s<e.length;s++)"\n"===e[s]?o[++r]=0:o[r]++;for(0<o[0]&&(this.insertCharStyleObject(i.lineIndex,i.charIndex,o[0],n),n=n&&n.slice(o[0]+1)),r&&this.insertNewlineStyleObject(i.lineIndex,i.charIndex+o[0],r),s=1;s<r;s++)0<o[s]?this.insertCharStyleObject(i.lineIndex+s,0,o[s],n):n&&(this.styles[i.lineIndex+s][0]=n[0]),n=n&&n.slice(o[s]+1);0<o[s]&&this.insertCharStyleObject(i.lineIndex+s,0,o[s],n)},setSelectionStartEndWithShift:function(e,t,n){n<=e?(t===e?this._selectionDirection="left":"right"===this._selectionDirection&&(this._selectionDirection="left",this.selectionEnd=e),this.selectionStart=n):e<n&&n<t?"right"===this._selectionDirection?this.selectionEnd=n:this.selectionStart=n:(t===e?this._selectionDirection="right":"left"===this._selectionDirection&&(this._selectionDirection="right",this.selectionStart=t),this.selectionEnd=n)},setSelectionInBoundaries:function(){var e=this.text.length;this.selectionStart>e?this.selectionStart=e:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>e?this.selectionEnd=e:this.selectionEnd<0&&(this.selectionEnd=0)}}),X.util.object.extend(X.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(e){var t;this.canvas&&(this.__newClickTime=+new Date,t=e.pointer,this.isTripleClick(t)&&(this.fire("tripleclick",e),this._stopEvent(e.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=t,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected)},isTripleClick:function(e){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===e.x&&this.__lastPointer.y===e.y},_stopEvent:function(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(e){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(e.e))},tripleClickHandler:function(e){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(e.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(e){!this.canvas||!this.editable||e.e.button&&1!==e.e.button||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(e.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(e){!this.canvas||!this.editable||e.e.button&&1!==e.e.button||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(e){if(this.__isMousedown=!1,!(!this.editable||this.group||e.transform&&e.transform.actionPerformed||e.e.button&&1!==e.e.button)){if(this.canvas){var t=this.canvas._activeObject;if(t&&t!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(e.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(e){var t=this.getSelectionStartFromPointer(e),n=this.selectionStart,i=this.selectionEnd;e.shiftKey?this.setSelectionStartEndWithShift(n,i,t):(this.selectionStart=t,this.selectionEnd=t),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(e){for(var t=this.getLocalPointer(e),n=0,i=0,o=0,r=0,s=0,a=0,l=this._textLines.length;a<l&&o<=t.y;a++)o+=this.getHeightOfLine(a)*this.scaleY,0<(s=a)&&(r+=this._textLines[a-1].length+this.missingNewlineOffset(a-1));i=this._getLineLeftOffset(s)*this.scaleX;for(var c=0,u=this._textLines[s].length;c<u&&(n=i,(i+=this.__charBounds[s][c].kernedWidth*this.scaleX)<=t.x);c++)r++;return this._getNewSelectionStartFromOffset(t,n,i,r,u)},_getNewSelectionStartFromOffset:function(e,t,n,i,o){t=e.x-t,e=n-e.x,e=i+(t<e||e<0?0:1);return this.flipX&&(e=o-e),e>this._text.length&&(e=this._text.length),e}}),X.util.object.extend(X.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=X.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var e=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+e.top+"; left: "+e.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; paddingï½°top: "+e.fontSize+";",X.document.body.appendChild(this.hiddenTextarea),X.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),X.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),X.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),X.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),X.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),X.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),X.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),X.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),X.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(X.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(e){if(this.isEditing){if(e.keyCode in this.keysMap)this[this.keysMap[e.keyCode]](e);else{if(!(e.keyCode in this.ctrlKeysMapDown&&(e.ctrlKey||e.metaKey)))return;this[this.ctrlKeysMapDown[e.keyCode]](e)}e.stopImmediatePropagation(),e.preventDefault(),33<=e.keyCode&&e.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(e){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:e.keyCode in this.ctrlKeysMapUp&&(e.ctrlKey||e.metaKey)&&(this[this.ctrlKeysMapUp[e.keyCode]](e),e.stopImmediatePropagation(),e.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(e){var t=this.fromPaste;if(this.fromPaste=!1,e&&e.stopPropagation(),this.isEditing){var n,i,o,r=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,s=this._text.length,a=r.length,l=a-s,c=this.selectionStart,u=this.selectionEnd,h=c!==u;if(""===this.hiddenTextarea.value)return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var d=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),e=c>d.selectionStart;h?(o=this._text.slice(c,u),l+=u-c):a<s&&(o=e?this._text.slice(u+l,u):this._text.slice(c,c-l)),d=r.slice(d.selectionEnd-l,d.selectionEnd),o&&o.length&&(d.length&&(n=this.getSelectionStyles(c,c+1,!1),n=d.map(function(){return n[0]})),o=h?(i=c,u):e?(i=u-o.length,u):(i=u)+o.length,this.removeStyleFromTo(i,o)),d.length&&(t&&d.join("")===X.copiedText&&!X.disableStyleCopyPaste&&(n=X.copiedTextStyle),this.insertNewStyleBlock(d,c,n)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(e){this.compositionStart=e.target.selectionStart,this.compositionEnd=e.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(X.copiedText=this.getSelectedText(),X.disableStyleCopyPaste?X.copiedTextStyle=null:X.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(e){return e&&e.clipboardData||X.window.clipboardData},_getWidthBeforeCursor:function(e,t){var n=this._getLineLeftOffset(e);return 0<t&&(n+=(t=this.__charBounds[e][t-1]).left+t.width),n},getDownCursorOffset:function(e,t){var n=this._getSelectionForOffset(e,t),i=this.get2DCursorLocation(n),t=i.lineIndex;if(t===this._textLines.length-1||e.metaKey||34===e.keyCode)return this._text.length-n;n=i.charIndex,i=this._getWidthBeforeCursor(t,n),i=this._getIndexOnLine(t+1,i);return this._textLines[t].slice(n).length+i+1+this.missingNewlineOffset(t)},_getSelectionForOffset:function(e,t){return e.shiftKey&&this.selectionStart!==this.selectionEnd&&t?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(e,t){var n=this._getSelectionForOffset(e,t),i=this.get2DCursorLocation(n),t=i.lineIndex;if(0===t||e.metaKey||33===e.keyCode)return-n;e=i.charIndex,n=this._getWidthBeforeCursor(t,e),i=this._getIndexOnLine(t-1,n),n=this._textLines[t].slice(0,e),e=this.missingNewlineOffset(t-1);return-this._textLines[t-1].length+i-n.length+(1-e)},_getIndexOnLine:function(e,t){for(var n,i=this._textLines[e],o=this._getLineLeftOffset(e),r=0,s=0,a=i.length;s<a;s++)if(t<(o+=c=this.__charBounds[e][s].width)){n=!0;var l=o-c,c=o,l=Math.abs(l-t),r=Math.abs(c-t)<l?s:s-1;break}return n||(r=i.length-1),r},moveCursorDown:function(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",e)},moveCursorUp:function(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorUpOrDown("Up",e)},_moveCursorUpOrDown:function(e,t){e=this["get"+e+"CursorOffset"](t,"right"===this._selectionDirection);t.shiftKey?this.moveCursorWithShift(e):this.moveCursorWithoutShift(e),0!==e&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(e){var t="left"===this._selectionDirection?this.selectionStart+e:this.selectionEnd+e;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,t),0!==e},moveCursorWithoutShift:function(e){return e<0?(this.selectionStart+=e,this.selectionEnd=this.selectionStart):(this.selectionEnd+=e,this.selectionStart=this.selectionEnd),0!==e},moveCursorLeft:function(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorLeftOrRight("Left",e)},_move:function(e,t,n){var i;if(e.altKey)i=this["findWordBoundary"+n](this[t]);else{if(!e.metaKey&&35!==e.keyCode&&36!==e.keyCode)return this[t]+="Left"===n?-1:1,!0;i=this["findLineBoundary"+n](this[t])}if(this[t]!==i)return this[t]=i,!0},_moveLeft:function(e,t){return this._move(e,t,"Left")},_moveRight:function(e,t){return this._move(e,t,"Right")},moveCursorLeftWithoutShift:function(e){var t=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&0!==this.selectionStart&&(t=this._moveLeft(e,"selectionStart")),this.selectionEnd=this.selectionStart,t},moveCursorLeftWithShift:function(e){return"right"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveLeft(e,"selectionEnd"):0!==this.selectionStart?(this._selectionDirection="left",this._moveLeft(e,"selectionStart")):void 0},moveCursorRight:function(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",e)},_moveCursorLeftOrRight:function(e,t){e="moveCursor"+e+"With";this._currentCursorOpacity=1,t.shiftKey?e+="Shift":e+="outShift",this[e](t)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(e){return"left"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveRight(e,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(e,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(e){var t=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(t=this._moveRight(e,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,t},removeChars:function(e,t){void 0===t&&(t=e+1),this.removeStyleFromTo(e,t),this._text.splice(e,t-e),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(e,t,n,i){void 0===i&&(i=n),n<i&&this.removeStyleFromTo(n,i);e=X.util.string.graphemeSplit(e);this.insertNewStyleBlock(e,n,t),this._text=[].concat(this._text.slice(0,n),e,this._text.slice(i)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),L=X.util.toFixed,j=/  +/g,X.util.object.extend(X.Text.prototype,{_toSVG:function(){var e=this._getSVGLeftTopOffsets(),e=this._getSVGTextAndBg(e.textTop,e.textLeft);return this._wrapSVGTextAndBg(e)},toSVG:function(e){return this._createBaseSVGMarkup(this._toSVG(),{reviver:e,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(e){var t=this.getSvgTextDecoration(this);return[e.textBgRects.join(""),'\t\t<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",t?'text-decoration="'+t+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",e.textSpans.join(""),"</text>\n"]},_getSVGTextAndBg:function(e,t){var n,i=[],o=[],r=e;this._setSVGBg(o);for(var s=0,a=this._textLines.length;s<a;s++)n=this._getLineLeftOffset(s),(this.textBackgroundColor||this.styleHas("textBackgroundColor",s))&&this._setSVGTextLineBg(o,s,t+n,r),this._setSVGTextLineText(i,s,t+n,r),r+=this.getHeightOfLine(s);return{textSpans:i,textBgRects:o}},_createTextCharSpan:function(e,t,n,i){var o=e!==e.trim()||e.match(j),r=this.getSvgSpanStyles(t,o),s=r?'style="'+r+'"':"",o=t.deltaY,r="",t=X.Object.NUM_FRACTION_DIGITS;return o&&(r=' dy="'+L(o,t)+'" '),['<tspan x="',L(n,t),'" y="',L(i,t),'" ',r,s,">",X.util.string.escapeXml(e),"</tspan>"].join("")},_setSVGTextLineText:function(e,t,n,i){var o,r,s,a,l=this.getHeightOfLine(t),c=-1!==this.textAlign.indexOf("justify"),u="",h=0,d=this._textLines[t];i+=l*(1-this._fontSizeFraction)/this.lineHeight;for(var f=0,p=d.length-1;f<=p;f++)a=f===p||this.charSpacing,u+=d[f],s=this.__charBounds[t][f],0===h?(n+=s.kernedWidth-s.width,h+=s.width):h+=s.kernedWidth,c&&!a&&this._reSpaceAndTab.test(d[f])&&(a=!0),a||(o=o||this.getCompleteStyleDeclaration(t,f),r=this.getCompleteStyleDeclaration(t,f+1),a=this._hasStyleChangedForSvg(o,r)),a&&(a=this._getStyleDeclaration(t,f)||{},e.push(this._createTextCharSpan(u,a,n,i)),u="",o=r,n+=h,h=0)},_pushTextBgRect:function(e,t,n,i,o,r){var s=X.Object.NUM_FRACTION_DIGITS;e.push("\t\t<rect ",this._getFillAttributes(t),' x="',L(n,s),'" y="',L(i,s),'" width="',L(o,s),'" height="',L(r,s),'"></rect>\n')},_setSVGTextLineBg:function(e,t,n,i){for(var o,r,s=this._textLines[t],a=this.getHeightOfLine(t)/this.lineHeight,l=0,c=0,u=this.getValueOfPropertyAt(t,0,"textBackgroundColor"),h=0,d=s.length;h<d;h++)o=this.__charBounds[t][h],(r=this.getValueOfPropertyAt(t,h,"textBackgroundColor"))!==u?(u&&this._pushTextBgRect(e,u,n+c,i,l,a),c=o.left,l=o.width,u=r):l+=o.kernedWidth;r&&this._pushTextBgRect(e,r,n+c,i,l,a)},_getFillAttributes:function(e){var t=e&&"string"==typeof e?new X.Color(e):"";return t&&t.getSource()&&1!==t.getAlpha()?'opacity="'+t.getAlpha()+'" fill="'+t.setAlpha(1).toRgb()+'"':'fill="'+e+'"'},_getSVGLineTopOffset:function(e){for(var t,n=0,i=0;i<e;i++)n+=this.getHeightOfLine(i);return t=this.getHeightOfLine(i),{lineTop:n,offset:(this._fontSizeMult-this._fontSizeFraction)*t/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(e){return X.Object.prototype.getSvgStyles.call(this,e)+" white-space: pre;"}}),function(){"use strict";var y=Se.fabric||(Se.fabric={});y.Textbox=y.util.createClass(y.IText,y.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:y.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(e){for(var t=0,n=0,i=0,o={},r=0;r<e.graphemeLines.length;r++)"\n"===e.graphemeText[i]&&0<r?(n=0,i++,t++):!this.splitByGrapheme&&this._reSpaceAndTab.test(e.graphemeText[i])&&0<r&&(n++,i++),o[r]={line:t,offset:n},i+=e.graphemeLines[r].length,n+=e.graphemeLines[r].length;return o},styleHas:function(e,t){var n;return!this._styleMap||this.isWrapping||(n=this._styleMap[t])&&(t=n.line),y.Text.prototype.styleHas.call(this,e,t)},isEmptyStyles:function(e){if(!this.styles)return!0;var t,n,i,o=0,r=!1,s=this._styleMap[e],a=this._styleMap[e+1];for(i in s&&(e=s.line,o=s.offset),a&&(r=a.line===e,t=a.offset),n=void 0===e?this.styles:{line:this.styles[e]})for(var l in n[i])if(o<=l&&(!r||l<t))for(var c in n[i][l])return!1;return!0},_getStyleDeclaration:function(e,t){if(this._styleMap&&!this.isWrapping){var n=this._styleMap[e];if(!n)return null;e=n.line,t=n.offset+t}return this.callSuper("_getStyleDeclaration",e,t)},_setStyleDeclaration:function(e,t,n){var i=this._styleMap[e];e=i.line,t=i.offset+t,this.styles[e][t]=n},_deleteStyleDeclaration:function(e,t){var n=this._styleMap[e];e=n.line,t=n.offset+t,delete this.styles[e][t]},_getLineStyle:function(e){e=this._styleMap[e];return!!this.styles[e.line]},_setLineStyle:function(e){e=this._styleMap[e];this.styles[e.line]={}},_wrapText:function(e,t){var n,i=[];for(this.isWrapping=!0,n=0;n<e.length;n++)i=i.concat(this._wrapLine(e[n],n,t));return this.isWrapping=!1,i},_measureWord:function(e,t,n){var i,o=0;n=n||0;for(var r=0,s=e.length;r<s;r++)o+=this._getGraphemeBox(e[r],t,r+n,i,!0).kernedWidth,i=e[r];return o},_wrapLine:function(e,t,n,i){var o,r,s=0,a=this.splitByGrapheme,l=[],c=[],u=a?y.util.string.graphemeSplit(e):e.split(this._wordJoiners),h=0,d=a?"":" ",f=0,p=0,g=!0,m=this._getWidthOfCharSpacing(),i=i||0;0===u.length&&u.push([]),n-=i;for(var v=0;v<u.length;v++)o=a?u[v]:y.util.string.graphemeSplit(u[v]),r=this._measureWord(o,t,h),h+=o.length,n<=(s+=f+r-m)&&!g?(l.push(c),c=[],s=r,g=!0):s+=m,g||a||c.push(d),c=c.concat(o),f=a?0:this._measureWord([d],t,h),h++,g=!1,p<r&&(p=r);return v&&l.push(c),p+i>this.dynamicMinWidth&&(this.dynamicMinWidth=p-m+i),l},isEndOfWrapping:function(e){return!this._styleMap[e+1]||this._styleMap[e+1].line!==this._styleMap[e].line},missingNewlineOffset:function(e){return!this.splitByGrapheme||this.isEndOfWrapping(e)?1:0},_splitTextIntoLines:function(e){for(var e=y.Text.prototype._splitTextIntoLines.call(this,e),t=this._wrapText(e.lines,this.width),n=new Array(t.length),i=0;i<t.length;i++)n[i]=t[i].join("");return e.lines=n,e.graphemeLines=t,e},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var e,t={};for(e in this._styleMap)this._textLines[e]&&(t[this._styleMap[e].line]=1);for(e in this.styles)t[e]||delete this.styles[e]},toObject:function(e){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(e))}}),y.Textbox.fromObject=function(e,t){return y.Object._fromObject("Textbox",e,t,"text")}}(),G=(B=X.controlsUtils).scaleSkewCursorStyleHandler,H=B.scaleCursorStyleHandler,e=B.scalingEqually,z=B.scalingYOrSkewingX,Y=B.scalingXOrSkewingY,U=B.scaleOrSkewActionName,(W=X.Object.prototype.controls).ml=new X.Control({x:-.5,y:0,cursorStyleHandler:G,actionHandler:Y,getActionName:U}),W.mr=new X.Control({x:.5,y:0,cursorStyleHandler:G,actionHandler:Y,getActionName:U}),W.mb=new X.Control({x:0,y:.5,cursorStyleHandler:G,actionHandler:z,getActionName:U}),W.mt=new X.Control({x:0,y:-.5,cursorStyleHandler:G,actionHandler:z,getActionName:U}),W.tl=new X.Control({x:-.5,y:-.5,cursorStyleHandler:H,actionHandler:e}),W.tr=new X.Control({x:.5,y:-.5,cursorStyleHandler:H,actionHandler:e}),W.bl=new X.Control({x:-.5,y:.5,cursorStyleHandler:H,actionHandler:e}),W.br=new X.Control({x:.5,y:.5,cursorStyleHandler:H,actionHandler:e}),W.mtr=new X.Control({x:0,y:-.5,actionHandler:B.rotationWithSnapping,cursorStyleHandler:B.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),X.Textbox&&((e=X.Textbox.prototype.controls={}).mtr=W.mtr,e.tr=W.tr,e.br=W.br,e.tl=W.tl,e.bl=W.bl,e.mt=W.mt,e.mb=W.mb,e.mr=new X.Control({x:.5,y:0,actionHandler:B.changeWidth,cursorStyleHandler:G,actionName:"resizing"}),e.ml=new X.Control({x:-.5,y:0,actionHandler:B.changeWidth,cursorStyleHandler:G,actionName:"resizing"}))}).call(this,_e(1).Buffer)},function(e,P,F){"use strict";(function(e){var s=F(3),r=F(4),a=F(5);function n(){return h.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function o(e,t){if(n()<t)throw new RangeError("Invalid typed array length");return h.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=h.prototype:(null===e&&(e=new h(t)),e.length=t),e}function h(e,t,n){if(!(h.TYPED_ARRAY_SUPPORT||this instanceof h))return new h(e,t,n);if("number"!=typeof e)return i(this,e,t,n);if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return c(this,e)}function i(e,t,n,i){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,i){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(i||0))throw new RangeError("'length' is out of bounds");return t=void 0===n&&void 0===i?new Uint8Array(t):void 0===i?new Uint8Array(t,n):new Uint8Array(t,n,i),h.TYPED_ARRAY_SUPPORT?(e=t).__proto__=h.prototype:e=u(e,t),e}(e,t,n,i):"string"==typeof t?function(e,t,n){if("string"==typeof n&&""!==n||(n="utf8"),!h.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var i=0|f(t,n),n=(e=o(e,i)).write(t,n);return n!==i&&(e=e.slice(0,n)),e}(e,t,n):function(e,t){if(h.isBuffer(t)){var n=0|d(t.length);return 0===(e=o(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(n=t.length)!=n?o(e,0):u(e,t);if("Buffer"===t.type&&a(t.data))return u(e,t.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function c(e,t){if(l(t),e=o(e,t<0?0:0|d(t)),!h.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function u(e,t){var n=t.length<0?0:0|d(t.length);e=o(e,n);for(var i=0;i<n;i+=1)e[i]=255&t[i];return e}function d(e){if(e>=n())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n().toString(16)+" bytes");return 0|e}function f(e,t){if(h.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return A(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return O(e).length;default:if(i)return A(e).length;t=(""+t).toLowerCase(),i=!0}}function t(e,o,r){var t,n,i=!1;if((void 0===o||o<0)&&(o=0),o>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(o>>>=0))return"";for(e=e||"utf8";;)switch(e){case"hex":return function(e,t,n){var i=e.length;(!t||t<0)&&(t=0),(!n||n<0||i<n)&&(n=i);for(var o,r="",s=t;s<n;++s)r+=(o=e[s])<16?"0"+o.toString(16):o.toString(16);return r}(this,o,r);case"utf8":case"utf-8":return y(this,o,r);case"ascii":return function(e,t,n){var i="";n=Math.min(e.length,n);for(var o=t;o<n;++o)i+=String.fromCharCode(127&e[o]);return i}(this,o,r);case"latin1":case"binary":return function(e,t,n){var i="";n=Math.min(e.length,n);for(var o=t;o<n;++o)i+=String.fromCharCode(e[o]);return i}(this,o,r);case"base64":return n=r,0===(t=o)&&n===this.length?s.fromByteArray(this):s.fromByteArray(this.slice(t,n));case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return function(e){for(var t=e.slice(o,r),n="",i=0;i<t.length;i+=2)n+=String.fromCharCode(t[i]+256*t[i+1]);return n}(this);default:if(i)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),i=!0}}function p(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function g(e,t,n,i,o){if(0===e.length)return-1;if("string"==typeof n?(i=n,n=0):2147483647<n?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=o?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(o)return-1;n=e.length-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof t&&(t=h.from(t,i)),h.isBuffer(t))return 0===t.length?-1:m(e,t,n,i,o);if("number"==typeof t)return t&=255,h.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?(o?Uint8Array.prototype.indexOf:Uint8Array.prototype.lastIndexOf).call(e,t,n):m(e,[t],n,i,o);throw new TypeError("val must be string, number or Buffer")}function m(e,t,n,i,o){var r=1,s=e.length,a=t.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(e.length<2||t.length<2)return-1;s/=r=2,a/=2,n/=2}function l(e,t){return 1===r?e[t]:e.readUInt16BE(t*r)}if(o)for(var c=-1,u=n;u<s;u++)if(l(e,u)===l(t,-1===c?0:u-c)){if(-1===c&&(c=u),u-c+1===a)return c*r}else-1!==c&&(u-=u-c),c=-1;else for(s<n+a&&(n=s-a),u=n;0<=u;u--){for(var h=!0,d=0;d<a;d++)if(l(e,u+d)!==l(t,d)){h=!1;break}if(h)return u}return-1}function v(e,t,n,i){return N(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,i)}function y(e,t,n){n=Math.min(e.length,n);for(var i=[],o=t;o<n;){var r,s,a,l,c=e[o],u=null,h=239<c?4:223<c?3:191<c?2:1;if(o+h<=n)switch(h){case 1:c<128&&(u=c);break;case 2:128==(192&(r=e[o+1]))&&127<(l=(31&c)<<6|63&r)&&(u=l);break;case 3:r=e[o+1],s=e[o+2],128==(192&r)&&128==(192&s)&&2047<(l=(15&c)<<12|(63&r)<<6|63&s)&&(l<55296||57343<l)&&(u=l);break;case 4:r=e[o+1],s=e[o+2],a=e[o+3],128==(192&r)&&128==(192&s)&&128==(192&a)&&65535<(l=(15&c)<<18|(63&r)<<12|(63&s)<<6|63&a)&&l<1114112&&(u=l)}null===u?(u=65533,h=1):65535<u&&(u-=65536,i.push(u>>>10&1023|55296),u=56320|1023&u),i.push(u),o+=h}return function(e){var t=e.length;if(t<=b)return String.fromCharCode.apply(String,e);for(var n="",i=0;i<t;)n+=String.fromCharCode.apply(String,e.slice(i,i+=b));return n}(i)}P.Buffer=h,P.SlowBuffer=function(e){return+e!=e&&(e=0),h.alloc(+e)},P.INSPECT_MAX_BYTES=50,h.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),P.kMaxLength=n(),h.poolSize=8192,h._augment=function(e){return e.__proto__=h.prototype,e},h.from=function(e,t,n){return i(null,e,t,n)},h.TYPED_ARRAY_SUPPORT&&(h.prototype.__proto__=Uint8Array.prototype,h.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&h[Symbol.species]===h&&Object.defineProperty(h,Symbol.species,{value:null,configurable:!0})),h.alloc=function(e,t,n){return i=null,t=t,n=n,l(e=e),e<=0||void 0===t?o(i,e):"string"==typeof n?o(i,e).fill(t,n):o(i,e).fill(t);var i},h.allocUnsafe=function(e){return c(null,e)},h.allocUnsafeSlow=function(e){return c(null,e)},h.isBuffer=function(e){return!(null==e||!e._isBuffer)},h.compare=function(e,t){if(!h.isBuffer(e)||!h.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,i=t.length,o=0,r=Math.min(n,i);o<r;++o)if(e[o]!==t[o]){n=e[o],i=t[o];break}return n<i?-1:i<n?1:0},h.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return h.alloc(0);if(void 0===t)for(o=t=0;o<e.length;++o)t+=e[o].length;for(var n=h.allocUnsafe(t),i=0,o=0;o<e.length;++o){var r=e[o];if(!h.isBuffer(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(n,i),i+=r.length}return n},h.byteLength=f,h.prototype._isBuffer=!0,h.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)p(this,t,t+1);return this},h.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},h.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},h.prototype.toString=function(){var e=0|this.length;return 0==e?"":0===arguments.length?y(this,0,e):t.apply(this,arguments)},h.prototype.equals=function(e){if(!h.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===h.compare(this,e)},h.prototype.inspect=function(){var e="",t=P.INSPECT_MAX_BYTES;return 0<this.length&&(e=this.toString("hex",0,t).match(/.{2}/g).join(" "),this.length>t&&(e+=" ... ")),"<Buffer "+e+">"},h.prototype.compare=function(e,t,n,i,o){if(!h.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===i&&(i=0),void 0===o&&(o=this.length),t<0||n>e.length||i<0||o>this.length)throw new RangeError("out of range index");if(o<=i&&n<=t)return 0;if(o<=i)return-1;if(n<=t)return 1;if(this===e)return 0;for(var r=(o>>>=0)-(i>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(r,s),l=this.slice(i,o),c=e.slice(t,n),u=0;u<a;++u)if(l[u]!==c[u]){r=l[u],s=c[u];break}return r<s?-1:s<r?1:0},h.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},h.prototype.indexOf=function(e,t,n){return g(this,e,t,n,!0)},h.prototype.lastIndexOf=function(e,t,n){return g(this,e,t,n,!1)},h.prototype.write=function(e,t,n,i){if(void 0===t)i="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)i=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===i&&(i="utf8")):(i=n,n=void 0)}var o=this.length-t;if((void 0===n||o<n)&&(n=o),0<e.length&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i=i||"utf8";for(var r,s,a,l,c=!1;;)switch(i){case"hex":return function(e,t,n,i){n=Number(n)||0;var o=e.length-n;(!i||o<(i=Number(i)))&&(i=o);o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");o/2<i&&(i=o/2);for(var r=0;r<i;++r){var s=parseInt(t.substr(2*r,2),16);if(isNaN(s))return r;e[n+r]=s}return r}(this,e,t,n);case"utf8":case"utf-8":return r=t,a=n,N(A(e,this.length-r),this,r,a);case"ascii":return v(this,e,t,n);case"latin1":case"binary":return v(this,e,t,n);case"base64":return l=t,s=n,N(O(e),this,l,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return a=t,l=n,N(function(e,t){for(var n,i,o=[],r=0;r<e.length&&!((t-=2)<0);++r)n=(i=e.charCodeAt(r))>>8,i=i%256,o.push(i),o.push(n);return o}(e,(s=this).length-a),s,a,l);default:if(c)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),c=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var b=4096;function C(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(n<e+t)throw new RangeError("Trying to access beyond buffer length")}function x(e,t,n,i,o,r){if(!h.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(o<t||t<r)throw new RangeError('"value" argument is out of bounds');if(n+i>e.length)throw new RangeError("Index out of range")}function w(e,t,n,i){t<0&&(t=65535+t+1);for(var o=0,r=Math.min(e.length-n,2);o<r;++o)e[n+o]=(t&255<<8*(i?o:1-o))>>>8*(i?o:1-o)}function S(e,t,n,i){t<0&&(t=4294967295+t+1);for(var o=0,r=Math.min(e.length-n,4);o<r;++o)e[n+o]=t>>>8*(i?o:3-o)&255}function _(e,t,n,i){if(n+i>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function E(e,t,n,i,o){return o||_(e,0,n,4),r.write(e,t,n,i,23,4),n+4}function T(e,t,n,i,o){return o||_(e,0,n,8),r.write(e,t,n,i,52,8),n+8}h.prototype.slice=function(e,t){var n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):n<e&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):n<t&&(t=n),t<e&&(t=e),h.TYPED_ARRAY_SUPPORT)(o=this.subarray(e,t)).__proto__=h.prototype;else for(var i=t-e,o=new h(i,void 0),r=0;r<i;++r)o[r]=this[r+e];return o},h.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var i=this[e],o=1,r=0;++r<t&&(o*=256);)i+=this[e+r]*o;return i},h.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var i=this[e+--t],o=1;0<t&&(o*=256);)i+=this[e+--t]*o;return i},h.prototype.readUInt8=function(e,t){return t||C(e,1,this.length),this[e]},h.prototype.readUInt16LE=function(e,t){return t||C(e,2,this.length),this[e]|this[e+1]<<8},h.prototype.readUInt16BE=function(e,t){return t||C(e,2,this.length),this[e]<<8|this[e+1]},h.prototype.readUInt32LE=function(e,t){return t||C(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},h.prototype.readUInt32BE=function(e,t){return t||C(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},h.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var i=this[e],o=1,r=0;++r<t&&(o*=256);)i+=this[e+r]*o;return(o*=128)<=i&&(i-=Math.pow(2,8*t)),i},h.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var i=t,o=1,r=this[e+--i];0<i&&(o*=256);)r+=this[e+--i]*o;return(o*=128)<=r&&(r-=Math.pow(2,8*t)),r},h.prototype.readInt8=function(e,t){return t||C(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},h.prototype.readInt16LE=function(e,t){t||C(e,2,this.length);e=this[e]|this[e+1]<<8;return 32768&e?4294901760|e:e},h.prototype.readInt16BE=function(e,t){t||C(e,2,this.length);e=this[e+1]|this[e]<<8;return 32768&e?4294901760|e:e},h.prototype.readInt32LE=function(e,t){return t||C(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},h.prototype.readInt32BE=function(e,t){return t||C(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},h.prototype.readFloatLE=function(e,t){return t||C(e,4,this.length),r.read(this,e,!0,23,4)},h.prototype.readFloatBE=function(e,t){return t||C(e,4,this.length),r.read(this,e,!1,23,4)},h.prototype.readDoubleLE=function(e,t){return t||C(e,8,this.length),r.read(this,e,!0,52,8)},h.prototype.readDoubleBE=function(e,t){return t||C(e,8,this.length),r.read(this,e,!1,52,8)},h.prototype.writeUIntLE=function(e,t,n,i){e=+e,t|=0,n|=0,i||x(this,e,t,n,Math.pow(2,8*n)-1,0);var o=1,r=0;for(this[t]=255&e;++r<n&&(o*=256);)this[t+r]=e/o&255;return t+n},h.prototype.writeUIntBE=function(e,t,n,i){e=+e,t|=0,n|=0,i||x(this,e,t,n,Math.pow(2,8*n)-1,0);var o=n-1,r=1;for(this[t+o]=255&e;0<=--o&&(r*=256);)this[t+o]=e/r&255;return t+n},h.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,1,255,0),h.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},h.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,2,65535,0),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):w(this,e,t,!0),t+2},h.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,2,65535,0),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):w(this,e,t,!1),t+2},h.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,4,4294967295,0),h.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):S(this,e,t,!0),t+4},h.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,4,4294967295,0),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):S(this,e,t,!1),t+4},h.prototype.writeIntLE=function(e,t,n,i){e=+e,t|=0,i||x(this,e,t,n,(i=Math.pow(2,8*n-1))-1,-i);var o=0,r=1,s=0;for(this[t]=255&e;++o<n&&(r*=256);)e<0&&0===s&&0!==this[t+o-1]&&(s=1),this[t+o]=(e/r>>0)-s&255;return t+n},h.prototype.writeIntBE=function(e,t,n,i){e=+e,t|=0,i||x(this,e,t,n,(i=Math.pow(2,8*n-1))-1,-i);var o=n-1,r=1,s=0;for(this[t+o]=255&e;0<=--o&&(r*=256);)e<0&&0===s&&0!==this[t+o+1]&&(s=1),this[t+o]=(e/r>>0)-s&255;return t+n},h.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,1,127,-128),h.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},h.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,2,32767,-32768),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):w(this,e,t,!0),t+2},h.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,2,32767,-32768),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):w(this,e,t,!1),t+2},h.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,4,2147483647,-2147483648),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):S(this,e,t,!0),t+4},h.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):S(this,e,t,!1),t+4},h.prototype.writeFloatLE=function(e,t,n){return E(this,e,t,!0,n)},h.prototype.writeFloatBE=function(e,t,n){return E(this,e,t,!1,n)},h.prototype.writeDoubleLE=function(e,t,n){return T(this,e,t,!0,n)},h.prototype.writeDoubleBE=function(e,t,n){return T(this,e,t,!1,n)},h.prototype.copy=function(e,t,n,i){if(n=n||0,i||0===i||(i=this.length),t>=e.length&&(t=e.length),t=t||0,0<i&&i<n&&(i=n),i===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-n&&(i=e.length-t+n);var o,r=i-n;if(this===e&&n<t&&t<i)for(o=r-1;0<=o;--o)e[o+t]=this[o+n];else if(r<1e3||!h.TYPED_ARRAY_SUPPORT)for(o=0;o<r;++o)e[o+t]=this[o+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+r),t);return r},h.prototype.fill=function(e,t,n,i){if("string"==typeof e){var o;if("string"==typeof t?(i=t,t=0,n=this.length):"string"==typeof n&&(i=n,n=this.length),1!==e.length||(o=e.charCodeAt(0))<256&&(e=o),void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!h.isEncoding(i))throw new TypeError("Unknown encoding: "+i)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;if(t>>>=0,n=void 0===n?this.length:n>>>0,"number"==typeof(e=e||0))for(a=t;a<n;++a)this[a]=e;else for(var r=h.isBuffer(e)?e:A(new h(e,i).toString()),s=r.length,a=0;a<n-t;++a)this[a+t]=r[a%s];return this};var k=/[^+\/0-9A-Za-z-_]/g;function A(e,t){var n;t=t||1/0;for(var i=e.length,o=null,r=[],s=0;s<i;++s){if(55295<(n=e.charCodeAt(s))&&n<57344){if(!o){if(56319<n){-1<(t-=3)&&r.push(239,191,189);continue}if(s+1===i){-1<(t-=3)&&r.push(239,191,189);continue}o=n;continue}if(n<56320){-1<(t-=3)&&r.push(239,191,189),o=n;continue}n=65536+(o-55296<<10|n-56320)}else o&&-1<(t-=3)&&r.push(239,191,189);if(o=null,n<128){if(--t<0)break;r.push(n)}else if(n<2048){if((t-=2)<0)break;r.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;r.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return r}function O(e){return s.toByteArray(function(e){var t;if((e=((t=e).trim?t.trim():t.replace(/^\s+|\s+$/g,"")).replace(k,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function N(e,t,n,i){for(var o=0;o<i&&!(o+n>=t.length||o>=e.length);++o)t[o+n]=e[o];return o}}).call(this,F(2))},function(e,t){var n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";t.byteLength=function(e){var t=u(e),e=t[0],t=t[1];return 3*(e+t)/4-t},t.toByteArray=function(e){for(var t,n=u(e),i=n[0],n=n[1],o=new c(3*(i+n)/4-n),r=0,s=0<n?i-4:i,a=0;a<s;a+=4)t=l[e.charCodeAt(a)]<<18|l[e.charCodeAt(a+1)]<<12|l[e.charCodeAt(a+2)]<<6|l[e.charCodeAt(a+3)],o[r++]=t>>16&255,o[r++]=t>>8&255,o[r++]=255&t;return 2===n&&(t=l[e.charCodeAt(a)]<<2|l[e.charCodeAt(a+1)]>>4,o[r++]=255&t),1===n&&(t=l[e.charCodeAt(a)]<<10|l[e.charCodeAt(a+1)]<<4|l[e.charCodeAt(a+2)]>>2,o[r++]=t>>8&255,o[r++]=255&t),o},t.fromByteArray=function(e){for(var t,n=e.length,i=n%3,o=[],r=0,s=n-i;r<s;r+=16383)o.push(function(e,t){for(var n,i=[],o=r;o<t;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),i.push(a[n>>18&63]+a[n>>12&63]+a[n>>6&63]+a[63&n]);return i.join("")}(e,s<r+16383?s:r+16383));return 1==i?(t=e[n-1],o.push(a[t>>2]+a[t<<4&63]+"==")):2==i&&(t=(e[n-2]<<8)+e[n-1],o.push(a[t>>10]+a[t>>4&63]+a[t<<2&63]+"=")),o.join("")};for(var a=[],l=[],c="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,r=i.length;o<r;++o)a[o]=i[o],l[i.charCodeAt(o)]=o;function u(e){var t=e.length;if(0<t%4)throw new Error("Invalid string. Length must be a multiple of 4");e=e.indexOf("=");return-1===e&&(e=t),[e,e===t?0:4-e%4]}l["-".charCodeAt(0)]=62,l["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,n,i,o){var r,s,a=8*o-i-1,l=(1<<a)-1,c=l>>1,u=-7,h=n?o-1:0,d=n?-1:1,n=e[t+h];for(h+=d,r=n&(1<<-u)-1,n>>=-u,u+=a;0<u;r=256*r+e[t+h],h+=d,u-=8);for(s=r&(1<<-u)-1,r>>=-u,u+=i;0<u;s=256*s+e[t+h],h+=d,u-=8);if(0===r)r=1-c;else{if(r===l)return s?NaN:1/0*(n?-1:1);s+=Math.pow(2,i),r-=c}return(n?-1:1)*s*Math.pow(2,r-i)},t.write=function(e,t,n,i,o,r){var s,a,l=8*r-o-1,c=(1<<l)-1,u=c>>1,h=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,d=i?0:r-1,f=i?1:-1,r=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=c):(s=Math.floor(Math.log(t)/Math.LN2),t*(i=Math.pow(2,-s))<1&&(s--,i*=2),2<=(t+=1<=s+u?h/i:h*Math.pow(2,1-u))*i&&(s++,i/=2),c<=s+u?(a=0,s=c):1<=s+u?(a=(t*i-1)*Math.pow(2,o),s+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,o),s=0));8<=o;e[n+d]=255&a,d+=f,a/=256,o-=8);for(s=s<<o|a,l+=o;0<l;e[n+d]=255&s,d+=f,s/=256,l-=8);e[n+d-f]|=128*r}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t){},function(e,t){},function(e,t){},function(e,t,n){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n.r(t),n.d(t,"default",function(){return xe});var o=(i(r.prototype,[{key:"Show",value:function(){null==this.loadingPanel&&this.InitLoadingPanel(),this.loadingPanel.style.display="flex";var e=this;setTimeout(function(){e.loadingPanelTimer=setInterval(function(){var n=!1,i=void 0;e.loadingPanelDots.forEach(function(e){null==i&&(i=e);var t=!1;"rgb(255, 145, 0)"==e.style.backgroundColor&&(n=t=!0),t?e.style.backgroundColor="rgb(255, 255, 255)":n&&(n=!1,e.style.backgroundColor="rgb(255, 145, 0)")}),n&&(n=!1,i.style.backgroundColor="rgb(255, 145, 0)")},300)},100)}},{key:"Hide",value:function(){clearInterval(this.loadingPanelTimer),null!=this.loadingPanel&&(this.loadingPanel.style.display="none")}},{key:"InitLoadingPanel",value:function(){this.loadingPanelDots=new Array;var e=document.createElement("div");e.style.position="fixed",e.style.display="none",e.style.backgroundColor="rgba(43, 48, 56, 1)",e.style.top="0px",e.style.left="0px",e.style.width="100vw",e.style.height="100vh",e.style.justifyContent="center",e.style.alignItems="center",e.style.zIndex=999999999;var t=document.createElement("div");t.style.position="absolute",t.style.width="100px",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";var n=document.createElement("div");n.style.width="10px",n.style.height="10px",n.style.backgroundColor="rgb(255, 145, 0)",t.appendChild(n),this.loadingPanelDots.push(n);n=document.createElement("div");n.style.width="10px",n.style.height="10px",n.style.marginLeft="10px",n.style.backgroundColor="rgb(255, 255, 255)",t.appendChild(n),this.loadingPanelDots.push(n);n=document.createElement("div");n.style.width="10px",n.style.height="10px",n.style.marginLeft="10px",n.style.backgroundColor="rgb(255, 255, 255)",t.appendChild(n),this.loadingPanelDots.push(n);n=document.createElement("div");n.style.width="10px",n.style.height="10px",n.style.marginLeft="10px",n.style.backgroundColor="rgb(255, 255, 255)",t.appendChild(n),this.loadingPanelDots.push(n),e.appendChild(t),this.loadingPanel=e,document.body.appendChild(this.loadingPanel)}}]),r);function r(){!function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this)}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var a=(s(l.prototype,[{key:"Start",value:function(){this.shown=!0}},{key:"Close",value:function(){this.shown&&(this.shown=!1)}},{key:"CreateToolsOptionsPnl",value:function(e){var n=this,t=document.createElement("div");t.setAttribute("class","cie-pnl-tool-option"),t.setAttribute("id","cie-btn-rotate-panel"),t.appendChild(e("","fa fa-undo",function(e){var t=n.currentAngle;n.rotatingAngle-=t,n.rotatingAngle<0&&(n.rotatingAngle=360+n.rotatingAngle),360<=n.currentAngle&&(n.currentAngle=360-(n.currentAngle-360)),n.Rotate(n.rotatingAngle)})),this.currentAngle=45,this.rotatingAngle=0;var i=document.createElement("input");return i.setAttribute("type","text"),i.setAttribute("min",0),i.setAttribute("max",360),i.setAttribute("step",1),i.setAttribute("value",this.currentAngle),i.setAttribute("autocomplete",!1),i.style.margin="10px 10px 20px 0px",i.style.backgroundColor="#2b3038",i.style.color="#9298a1",i.style.padding="6px",i.style.border="1px solid #9298a1",i.style.borderRadius="4px",i.style.width="22px",i.style.textAlign="center",i.oninput=function(){n.currentAngle=parseInt(this.value),360<n.currentAngle&&(n.currentAngle=360,this.value=n.currentAngle),n.currentAngle<0&&(n.currentAngle=0,this.value=n.currentAngle),360<n.currentAngle&&(n.currentAngle=360-(n.currentAngle-360))},t.appendChild(i),t.appendChild(e("","fa fa-repeat",function(e){var t=n.currentAngle;n.rotatingAngle+=t,n.rotatingAngle<0&&(n.rotatingAngle=360+n.rotatingAngle),360<=n.rotatingAngle&&(n.rotatingAngle=360-n.rotatingAngle),n.Rotate(n.rotatingAngle)})),t}},{key:"Rotate",value:function(e){this.editor.Rotate(e)}}]),l);function l(e){!function(e){if(!(e instanceof l))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e}function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var u=(c(h.prototype,[{key:"Start",value:function(){this.shown=!0}},{key:"Close",value:function(){this.shown&&(this.shown=!1)}},{key:"CreateToolsOptionsPnl",value:function(e){var t=this,n=document.createElement("div");return n.setAttribute("class","cie-pnl-tool-option"),n.setAttribute("id","cie-btn-flip-panel"),n.appendChild(e("Flip X","fa fa-arrows-h",function(e){t.Flip("horizontally")})),n.appendChild(e("Flip Y","fa fa-arrows-v",function(e){t.Flip("vertically")})),n}},{key:"Flip",value:function(e){this.editor.Flip(e)}}]),h);function h(e){!function(e){if(!(e instanceof h))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e}function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var f=(d(p.prototype,[{key:"OpenPickColorPanel",value:function(e){this.InitPanel();var t=e.srcElement.getBoundingClientRect();this.pickColorPanel.style.left=t.left-80+"px",this.pickColorPanel.style.top=t.top-150+"px",this.pickColorPanel.focus(),this.btn=e.srcElement}},{key:"HidePickColorPanel",value:function(){this.pickColorPanel.parentNode.removeChild(this.pickColorPanel)}},{key:"InitPanel",value:function(){var t=this,n=document.createElement("div");n.style.position="fixed",n.style.zIndex="99999",n.style.border="1px solid #9298a1",n.style.borderRadius="2px",n.style.backgroundColor="#2b3038",n.style.padding="4px 4px 0px 0px",n.style.left="10px",n.style.top="10px",n.setAttribute("tabindex","0");var e=[];e.push(["#dfb9b1","#eecdcd","#f8e5d0","#fdf2d0","#dce9d5","#d3dfe2","#ccdaf5","#d2e1f1","#d8d2e7","#e6d2db"]),e.push(["#d08270","#de9c9b","#f2cca2","#fbe5a3","#bcd5ac","#a9c3c8","#a9c2f0","#a6c4e5","#b2a8d2","#cea8bc"]),e.push(["#bd4b31","#d16d6a","#ecb476","#f9d978","#9dc284","#80a4ad","#779ee5","#7ba7d7","#8b7ebe","#b87f9e"]),e.push(["#982a15","#bb261a","#da944b","#eac251","#78a55a","#53808c","#4a79d1","#4f85c1","#6351a2","#9b5378"]),e.push(["#7a2817","#8c1a11","#a96324","#b89130","#48742c","#264e5b","#2657c5","#24538f","#312071","#6b2346"]);var i=document.createElement("div");i.style.display="flex",i.style.marginTop="2px",i.style.marginBottom="6px",["#000000","#434343","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#f3f3f3","#ffffff"].forEach(function(e){e=t._getDomCell_colorPicker(e);i.appendChild(e)}),n.appendChild(i),e.forEach(function(e){(i=document.createElement("div")).style.display="flex",e.forEach(function(e){e=t._getDomCell_colorPicker(e);i.appendChild(e)}),n.appendChild(i)}),n.addEventListener("blur",function(){null!=t.preventBlurEvent&&t.preventBlurEvent?t.preventBlurEvent=!1:this.parentNode.removeChild(this)}),document.body.appendChild(n),this.pickColorPanel=n}},{key:"_getDomCell_colorPicker",value:function(e){var t=this,n=e,e=document.createElement("div");return e.style.width="13px",e.style.height="13px",e.style.backgroundColor=n,e.style.margin="0px 0px 4px 4px ",t.currentColor==n?e.style.border="2px solid #30b7e8":e.style.border="2px solid "+n,e.style.borderRadius="2px",e.addEventListener("mouseover",function(){this.style.cursor="pointer",this.style.border="2px solid #30b7e8"}),e.addEventListener("mouseout",function(){t.currentColor==n?this.style.border="2px solid #30b7e8":this.style.border="2px solid "+n}),e.addEventListener("mousedown",function(e){t.preventBlurEvent=!0}),e.addEventListener("click",function(e){t.btn.style.color=n,t.currentColor=n,null!=t.onColorSelected&&t.onColorSelected(n),t.HidePickColorPanel()}),e}}]),p);function p(e,t){!function(e){if(!(e instanceof p))throw new TypeError("Cannot call a class as a function")}(this),this.onColorSelected=t,this.currentColor=e,this.pickColorPanel=void 0}function g(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var m=(g(v.prototype,[{key:"Start",value:function(){this.shown=!0}},{key:"Close",value:function(){this.shown&&(this.shown=!1)}},{key:"Reset",value:function(e,t){this.currentBrushColor=null==e||""==e?"#ffffff":e,this.currentFrameSize=t,this.iconDot.style.color=this.currentBrushColor,this.sizeInput.value=this.currentFrameSize}},{key:"ApplyFrame",value:function(){this.editor.Frame(this.currentBrushColor,this.currentFrameSize)}},{key:"CreateToolsOptionsPnl",value:function(e,t){var n=this,i=document.createElement("div");i.setAttribute("class","cie-pnl-tool-option"),i.setAttribute("id","cie-btn-frame-panel");var o=document.createElement("div");o.style.margin="10px 10px 20px 10px";var r=document.createElement("i");function s(e){n.colorPicker.OpenPickColorPanel(e)}r.setAttribute("class","fa fa-circle"),r.style.fontSize="30px",r.style.color=this.currentBrushColor,r.style.cursor="pointer",r.removeEventListener("click",s),r.addEventListener("click",s),this.iconDot=r,o.appendChild(r),i.appendChild(o),i.appendChild(t());o=document.createElement("div");o.innerHTML="Frame size:",o.style.color="#9298a1",o.style.margin="10px 10px 20px 0px",o.style.fontSize="14px",o.style.fontFamily="Arial",i.appendChild(o);o=document.createElement("input");return o.setAttribute("type","text"),o.setAttribute("min",0),o.setAttribute("max",100),o.setAttribute("step",1),o.setAttribute("value",this.currentFrameSize),o.setAttribute("autocomplete",!1),o.style.margin="10px 10px 20px 0px",o.style.backgroundColor="#2b3038",o.style.color="#9298a1",o.style.padding="6px",o.style.border="1px solid #9298a1",o.style.borderRadius="4px",o.style.width="22px",o.style.textAlign="center",o.oninput=function(){n.currentFrameSize=parseInt(this.value),999<n.currentFrameSize&&(n.currentFrameSize=999,this.value=n.currentFrameSize),n.currentFrameSize<0&&(n.currentFrameSize=1,this.value=n.currentFrameSize)},this.sizeInput=o,i.appendChild(o),i.appendChild(t()),i.appendChild(e("Apply","fa fa-check",function(e){n.ApplyFrame(!1)})),i}}]),v);function v(e){var t=this;!function(e){if(!(e instanceof v))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.currentBrushColor="#ffffff",this.currentFrameSize=20,this.colorPicker=new f(this.currentBrushColor,function(e){t.currentBrushColor=e})}function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var b=(y(C.prototype,[{key:"Start",value:function(){this.shown=!0,this.ShowCroppingRectangle()}},{key:"Close",value:function(){this.shown&&(this.shown=!1,this.HideCroppingRectangle())}},{key:"Apply",value:function(){var t=this;this.HideCroppingRectangle(),this.editor.FreezeCanvasEditing(),setTimeout(function(){var e=getComputedStyle(t.panel),e={top:parseInt(e.top.replace("px",""))-window.scrollY,left:parseInt(e.left.replace("px",""))-window.scrollX,width:parseInt(e.width.replace("px","")),height:parseInt(e.height.replace("px",""))};t.editor.Crop(e).then(function(){t.ShowCroppingRectangle(),t.editor.ResumeCanvasEditing()},function(e){console.log(e)})},10)}},{key:"CreateToolsOptionsPnl",value:function(e){var t=this,n=document.createElement("div");return n.setAttribute("class","cie-pnl-tool-option"),n.setAttribute("id","cie-btn-crop-panel"),n.appendChild(e("Apply","fa fa-check",function(e){t.Apply(e)})),n}},{key:"InitPanel",value:function(){function e(e){n.MouseDown(e,this)}function t(e){n.MouseDownForMove(e,this)}var n=this;this.panel=document.createElement("div"),this.panel.setAttribute("class","comma-img-resizable"),this.panel.removeEventListener("mousedown",t),this.panel.addEventListener("mousedown",t),this.panel.style.cursor="move";var i=document.createElement("div");i.setAttribute("class","comma-img-resizers");var o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-top-left"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),i.appendChild(o);o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-top-right"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),i.appendChild(o);o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-bottom-left"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),i.appendChild(o);o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-bottom-right"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),i.appendChild(o);o=document.createElement("div");o.setAttribute("class","cir-opaque-panel"),this.leftOpaquePnl=o,i.appendChild(o);o=document.createElement("div");o.setAttribute("class","cir-opaque-panel"),this.topOpaquePnl=o,i.appendChild(o);o=document.createElement("div");o.setAttribute("class","cir-opaque-panel"),this.rightOpaquePnl=o,i.appendChild(o);o=document.createElement("div");o.setAttribute("class","cir-opaque-panel"),this.bottomOpaquePnl=o,i.appendChild(o),this.panel.appendChild(i),document.body.appendChild(this.panel)}},{key:"ShowCroppingRectangle",value:function(){null==this.panel?this.InitPanel():this.panel.style.display="none";var i=this;setTimeout(function(){i.panel.style.display="block";var e=i.editor.GetBoundingClientRect(),t=parseInt(e.width/4),n=t/2;i.panel.style.top=e.top+window.scrollY+n+"px",i.panel.style.left=e.left+window.scrollX+n+"px",i.panel.style.width=e.width-t+"px",i.panel.style.height=e.height-t+"px",i.leftOpaquePnl.style.top=e.top+"px",i.leftOpaquePnl.style.left=e.left+"px",i.leftOpaquePnl.style.width=n+"px",i.leftOpaquePnl.style.height=e.height+"px",i.topOpaquePnl.style.top=e.top+"px",i.topOpaquePnl.style.left=e.left+n+"px",i.topOpaquePnl.style.width=e.width-n+"px",i.topOpaquePnl.style.height=n+"px",i.rightOpaquePnl.style.top=e.top+n+"px",i.rightOpaquePnl.style.left=e.left+e.width-n+"px",i.rightOpaquePnl.style.width=n+"px",i.rightOpaquePnl.style.height=e.height-n+"px",i.bottomOpaquePnl.style.top=e.top+e.height-n+"px",i.bottomOpaquePnl.style.left=e.left+n+"px",i.bottomOpaquePnl.style.width=e.width-t+"px",i.bottomOpaquePnl.style.height=n+"px"},200)}},{key:"HideCroppingRectangle",value:function(){null!=this.panel&&(this.panel.style.display="none")}},{key:"MouseDownForMove",value:function(e,t){var n=this;function i(e){n.StopMoving(e)}function o(e){n.Move(e,t)}this.px=e.pageX-window.scrollX,this.py=e.pageY-window.scrollY,this.f_move=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"StopMoving",value:function(){window.removeEventListener("mousemove",this.f_move),event.preventDefault(),event.stopPropagation()}},{key:"Move",value:function(){var e=this.editor.GetBoundingClientRect(),t=event.pageX-window.scrollX,n=event.pageY-window.scrollY,i=t-this.px,o=n-this.py,r=e.x,s=e.x+e.width,a=e.y,l=e.y+e.height,c=getComputedStyle(this.panel),u={};u.width=parseInt(c.width.replace("px","")),u.height=parseInt(c.height.replace("px","")),u.left=parseInt(c.left.replace("px","")),u.top=parseInt(c.top.replace("px",""));var h=u.width,d=u.height,f=u.left,c=(u.left,u.top),i=(u.top,f+i),o=c+o;i-window.scrollX<=r&&(i=f),i-window.scrollX+h>=s&&(i=f),o-window.scrollY<=a&&(o=c),o-window.scrollY+d>=l&&(o=c),this.panel.style.top=o+"px",this.panel.style.left=i+"px",this.leftOpaquePnl.style.width=i-e.x-window.scrollX+"px",this.topOpaquePnl.style.height=o-e.y-window.scrollY+"px",this.topOpaquePnl.style.left=i-window.scrollX+"px",this.topOpaquePnl.style.width=e.width-(i-e.x-window.scrollX)+"px",this.rightOpaquePnl.style.top=o-window.scrollY+"px",this.rightOpaquePnl.style.left=i-window.scrollX+h+"px",this.rightOpaquePnl.style.width=e.width-(i+h-e.x)+"px",this.rightOpaquePnl.style.height=e.height-(o-e.y-window.scrollY)+"px",this.bottomOpaquePnl.style.top=o+d-window.scrollY+"px",this.bottomOpaquePnl.style.left=i-window.scrollX+"px",this.bottomOpaquePnl.style.width=h+"px",this.bottomOpaquePnl.style.height=e.height-(o+d-e.y-window.scrollY)+"px",this.px=t,this.py=n,event.preventDefault(),event.stopPropagation()}},{key:"MouseDown",value:function(e,t){var n=this;function i(e){n.StopResize(e)}function o(e){n.Resize(e,t)}this.px=e.pageX-window.scrollX,this.py=e.pageY-window.scrollY,this.f_resize=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"Resize",value:function(e,t){var n=this.editor.GetBoundingClientRect(),i=e.pageX-window.scrollX,o=e.pageY-window.scrollY,r=i-this.px,s=o-this.py,a=n.x,l=n.x+n.width,c=n.y,u=n.y+n.height,h=getComputedStyle(this.panel),d=parseInt(h.width.replace("px","")),f=parseInt(h.height.replace("px","")),p=parseInt(h.left.replace("px","")),g=d+parseInt(h.left.replace("px","")),m=parseInt(h.top.replace("px","")),v=f+parseInt(h.top.replace("px","")),y=d,b=f,C=m,x=p;t.classList.contains("cir-bottom-right")?(y=g<l||r<0?d+r:l-parseInt(h.left.replace("px","")),b=v<u||s<0?f+s:u-parseInt(h.top.replace("px",""))):t.classList.contains("cir-top-right")?(y=g<l||r<0?d+r:l-parseInt(h.left.replace("px","")),C=c<m||0<s?(b=f-s,m+s):c):t.classList.contains("cir-top-left")?(x=a<p||0<r?(y=d-r,p+r):a,C=c<m||0<s?(b=f-s,m+s):c):t.classList.contains("cir-bottom-left")&&(x=a<p||0<r?(y=d-r,p+r):a,b=v<u||s<0?f+s:u-parseInt(h.top.replace("px",""))),y<20&&(y=20),b<20&&(b=20),this.panel.style.width=y+"px",this.panel.style.height=b+"px",this.panel.style.top=C+"px",this.panel.style.left=x+"px",this.leftOpaquePnl.style.width=x-n.x-window.scrollX+"px",this.topOpaquePnl.style.height=C-n.y-window.scrollY+"px",this.topOpaquePnl.style.left=x-window.scrollX+"px",this.topOpaquePnl.style.width=n.width-(x-n.x-window.scrollX)+"px",this.rightOpaquePnl.style.top=C-window.scrollY+"px",this.rightOpaquePnl.style.left=x-window.scrollX+d+"px",this.rightOpaquePnl.style.width=n.width-(x+d-n.x)+"px",this.rightOpaquePnl.style.height=n.height-(C-n.y-window.scrollY)+"px",this.bottomOpaquePnl.style.top=C+f-window.scrollY+"px",this.bottomOpaquePnl.style.left=x-window.scrollX+"px",this.bottomOpaquePnl.style.width=d+"px",this.bottomOpaquePnl.style.height=n.height-(C+f-n.y-window.scrollY)+"px",this.px=i,this.py=o,e.preventDefault(),e.stopPropagation()}},{key:"StopResize",value:function(e){window.removeEventListener("mousemove",this.f_resize),e.preventDefault(),e.stopPropagation()}}]),C);function C(e){!function(e){if(!(e instanceof C))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.panel=void 0}function x(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var w=(x(S.prototype,[{key:"Start",value:function(){this.shown=!0,this.editor.StartDrawing(this.brush,this.currentBrushSize,this.currentBrushColor)}},{key:"Close",value:function(){this.shown&&(this.shown=!1,this.editor.StopDrawing())}},{key:"CreateToolsOptionsPnl",value:function(e,t){var n=this,i=document.createElement("div");i.setAttribute("class","cie-pnl-tool-option"),i.setAttribute("id","cie-btn-draw-panel"),i.appendChild(e("Free","fa fa-google-wallet",function(e){n.SetDrawType("free")},"cie-free-hand-btn")),i.appendChild(e("Straight","fa fa-minus",function(e){n.SetDrawType("straight")},"cie-straight-btn")),i.appendChild(t());var o=document.createElement("div");o.style.margin="10px 10px 20px 10px";e=document.createElement("i");function r(e){n.colorPicker.OpenPickColorPanel(e)}e.setAttribute("class","fa fa-circle"),e.style.fontSize="30px",e.style.color=this.currentBrushColor,e.style.cursor="pointer",e.removeEventListener("click",r),e.addEventListener("click",r),this.iconColor=e,o.appendChild(e),i.appendChild(o),i.appendChild(t());t=document.createElement("div");t.innerHTML="Brush size:",t.style.color="#9298a1",t.style.margin="10px 10px 20px 0px",t.style.fontSize="14px",t.style.fontFamily="Arial",i.appendChild(t);t=document.createElement("input");return t.setAttribute("type","text"),t.setAttribute("min",0),t.setAttribute("max",100),t.setAttribute("step",1),t.setAttribute("value",this.currentBrushSize),t.setAttribute("autocomplete",!1),t.style.margin="10px 10px 20px 0px",t.style.backgroundColor="#2b3038",t.style.color="#9298a1",t.style.padding="6px",t.style.border="1px solid #9298a1",t.style.borderRadius="4px",t.style.width="22px",t.style.textAlign="center",t.oninput=function(){n.currentBrushSize=parseInt(this.value),999<n.currentBrushSize&&(n.currentBrushSize=999,this.value=n.currentBrushSize),n.currentBrushSize<0&&(n.currentBrushSize=1,this.value=n.currentBrushSize),n.SetDrawType(n.brush,n.currentBrushSize,n.currentBrushColor)},this.sizeInput=t,i.appendChild(t),setTimeout(function(){document.getElementById("cie-free-hand-btn").style.color="#ffffff"}),i}},{key:"SetDrawType",value:function(e){"free"==e?(document.getElementById("cie-free-hand-btn").style.color="#ffffff",document.getElementById("cie-straight-btn").style.color="#9298a1",this.brush="free"):"straight"==e&&(document.getElementById("cie-free-hand-btn").style.color="#9298a1",document.getElementById("cie-straight-btn").style.color="#ffffff",this.brush="straight"),this.editor.SetDrawingParameters(this.brush,this.currentBrushSize,this.currentBrushColor)}}]),S);function S(e){var t=this;!function(e){if(!(e instanceof S))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.brush="free",this.currentBrushSize=10,this.currentBrushColor="#bb261a",this.colorPicker=new f(this.currentBrushColor,function(e){t.currentBrushColor=e,t.editor.SetDrawingParameters(t.brush,t.currentBrushSize,t.currentBrushColor)})}function _(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var E=(_(T.prototype,[{key:"Start",value:function(){this.shown=!0,this.editor.StartDrawing(this.shape,this.currentBrushSize,this.currentBrushColor)}},{key:"Close",value:function(){this.shown&&(this.shown=!1,this.editor.StopDrawing())}},{key:"CreateToolsOptionsPnl",value:function(e,t){var n=this,i=document.createElement("div");i.setAttribute("class","cie-pnl-tool-option"),i.setAttribute("id","cie-btn-shapes-panel"),i.appendChild(e("Rectangle","fa fa-square-o",function(e){n.SetShape("rectangle")},"cie-rectangle-shape")),i.appendChild(e("Circle","fa fa-circle-o",function(e){n.SetShape("circle")},"cie-circle-shape")),i.appendChild(e("Arrow","fa fa-arrow-right",function(e){n.SetShape("arrow")},"cie-arrow-shape")),i.appendChild(t());var o=document.createElement("div");o.style.margin="10px 10px 20px 10px";e=document.createElement("i");function r(e){n.colorPicker.OpenPickColorPanel(e)}e.setAttribute("class","fa fa-circle"),e.setAttribute("id","cie-chosen-color-shapes"),e.style.fontSize="30px",e.style.color=this.currentBrushColor,e.style.cursor="pointer",e.removeEventListener("click",r),e.addEventListener("click",r),this.iconColor=e,o.appendChild(e),i.appendChild(o),i.appendChild(t());t=document.createElement("div");t.innerHTML="Shape style:",t.style.color="#9298a1",t.style.margin="10px 10px 20px 0px",t.style.fontSize="14px",t.style.fontFamily="Arial",i.appendChild(t);t=document.createElement("input");return t.setAttribute("type","text"),t.setAttribute("min",0),t.setAttribute("max",100),t.setAttribute("step",1),t.setAttribute("value",this.currentBrushSize),t.setAttribute("autocomplete",!1),t.style.margin="10px 10px 20px 0px",t.style.backgroundColor="#2b3038",t.style.color="#9298a1",t.style.padding="6px",t.style.border="1px solid #9298a1",t.style.borderRadius="4px",t.style.width="22px",t.style.textAlign="center",t.oninput=function(){n.currentBrushSize=parseInt(this.value),999<n.currentBrushSize&&(n.currentBrushSize=999,this.value=n.currentBrushSize),n.currentBrushSize<0&&(n.currentBrushSize=1,this.value=n.currentBrushSize),n.editor.SetDrawingParameters(n.shape,n.currentBrushSize,n.currentBrushColor)},this.sizeInput=t,i.appendChild(t),setTimeout(function(){document.getElementById("cie-rectangle-shape").style.color="#ffffff"}),i}},{key:"SetShape",value:function(e){this.shape=e,"rectangle"==this.shape?(document.getElementById("cie-rectangle-shape").style.color="#ffffff",document.getElementById("cie-circle-shape").style.color="#9298a1",document.getElementById("cie-arrow-shape").style.color="#9298a1"):"circle"==this.shape?(document.getElementById("cie-rectangle-shape").style.color="#9298a1",document.getElementById("cie-circle-shape").style.color="#ffffff",document.getElementById("cie-arrow-shape").style.color="#9298a1"):"arrow"==this.shape&&(document.getElementById("cie-rectangle-shape").style.color="#9298a1",document.getElementById("cie-circle-shape").style.color="#9298a1",document.getElementById("cie-arrow-shape").style.color="#ffffff"),this.editor.SetDrawingParameters(this.shape,this.currentBrushSize,this.currentBrushColor)}}]),T);function T(e){var t=this;!function(e){if(!(e instanceof T))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.currentBrushColor="#bb261a",this.currentBrushSize=10,this.fillShape=!1,this.shape="rectangle",this.colorPicker=new f(this.currentBrushColor,function(e){t.currentBrushColor=e,t.editor.SetDrawingParameters(t.shape,t.currentBrushSize,t.currentBrushColor)})}function k(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var A=(k(O.prototype,[{key:"Start",value:function(){this.shown=!0,this.editor.SetTextParameters(this.currentBrushSize,this.currentBrushColor),this.editor.StartAddText()}},{key:"Close",value:function(){this.shown&&(this.shown=!1,this.editor.StopAddText())}},{key:"CreateToolsOptionsPnl",value:function(e,t){var n=this,i=document.createElement("div");i.setAttribute("class","cie-pnl-tool-option"),i.setAttribute("id","cie-btn-text-panel");var o=document.createElement("div");o.style.margin="10px 10px 20px 10px";var r=document.createElement("i");function s(e){n.colorPicker.OpenPickColorPanel(e)}r.setAttribute("class","fa fa-circle"),r.setAttribute("id","cie-chosen-color-text"),r.style.fontSize="30px",r.style.color=this.currentBrushColor,r.style.cursor="pointer",r.removeEventListener("click",s),r.addEventListener("click",s),o.appendChild(r),i.appendChild(o),i.appendChild(t());t=document.createElement("div");t.innerHTML="Text size:",t.style.color="#9298a1",t.style.margin="10px 10px 20px 0px",t.style.fontSize="14px",t.style.fontFamily="Arial",i.appendChild(t);t=document.createElement("input");return t.setAttribute("type","text"),t.setAttribute("min",0),t.setAttribute("max",100),t.setAttribute("step",1),t.setAttribute("value",this.currentBrushSize),t.setAttribute("autocomplete",!1),t.style.margin="10px 10px 20px 0px",t.style.backgroundColor="#2b3038",t.style.color="#9298a1",t.style.padding="6px",t.style.border="1px solid #9298a1",t.style.borderRadius="4px",t.style.width="22px",t.style.textAlign="center",t.oninput=function(){n.currentBrushSize=parseInt(this.value),999<n.currentBrushSize&&(n.currentBrushSize=999,this.value=n.currentBrushSize),n.currentBrushSize<0&&(n.currentBrushSize=1,this.value=n.currentBrushSize),n.editor.SetTextParameters(n.currentBrushSize,n.currentBrushColor)},i.appendChild(t),i}}]),O);function O(e){var t=this;!function(e){if(!(e instanceof O))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.currentBrushColor="#bb261a",this.currentBrushSize=40,this.fillShape=!1,this.shape="rectangle",this.colorPicker=new f(this.currentBrushColor,function(e){t.currentBrushColor=e,t.editor.SetTextParameters(t.currentBrushSize,t.currentBrushColor)})}function N(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var P=(N(F.prototype,[{key:"Start",value:function(){this.shown=!0}},{key:"Close",value:function(){this.shown&&(this.shown=!1)}},{key:"SetFilters",value:function(n){null!=n&&Object.keys(n).forEach(function(e){var t=n[e];document.getElementById("pid-im-"+e).value=t})}},{key:"ResetToDefaults",value:function(){this.SetFilters(this.defaultFilters)}},{key:"ResetFilter",value:function(e){var t="red"!=e&&"green"!=e&&"blue"!=e?0:1;document.getElementById("pid-im-"+e).value=t,this.AdjustFilters(e,t)}},{key:"AdjustFilters",value:function(e,t){this.editor.ApplyFilter(e,t)}},{key:"CreateToolsOptionsPnl",value:function(){var t=this,e=document.createElement("div");e.setAttribute("class","cie-pnl-tool-option"),e.setAttribute("id","cie-btn-filters-panel");var n=document.createElement("div");n.style.margin="0px 10px 20px 10px",n.appendChild(this._createInputRange("brightness","Brightness",-1,1,.003921,this.defaultFilters.brightness,function(e){t.AdjustFilters("brightness",parseFloat(this.value))},function(e){t.ResetFilter("brightness")})),n.appendChild(this._createInputRange("contrast","Contrast",-1,1,.003921,this.defaultFilters.contrast,function(e){t.AdjustFilters("contrast",parseFloat(this.value))},function(e){t.ResetFilter("contrast")})),n.appendChild(this._createInputRange("blur","Blur",0,1,.01,this.defaultFilters.blur,function(e){t.AdjustFilters("blur",parseFloat(this.value))},function(e){t.ResetFilter("blur")})),e.appendChild(n);n=document.createElement("div");n.style.margin="0px 10px 20px 10px",n.appendChild(this._createInputRange("hue","Hue",-1,1,.002,this.defaultFilters.hue,function(e){t.AdjustFilters("hue",parseFloat(this.value))},function(e){t.ResetFilter("hue")})),n.appendChild(this._createInputRange("saturate","Saturate",-1,1,.003921,this.defaultFilters.saturate,function(e){t.AdjustFilters("saturate",parseFloat(this.value))},function(e){t.ResetFilter("saturate")})),n.appendChild(this._createInputRange("noise","Noise",0,1e3,50,this.defaultFilters.noise,function(e){t.AdjustFilters("noise",parseFloat(this.value))},function(e){t.ResetFilter("noise")})),e.appendChild(n);n=document.createElement("div");return n.style.margin="0px 10px 20px 10px",n.appendChild(this._createInputRange("red","Red",.2,2.2,.003921,this.defaultFilters.red,function(e){t.AdjustFilters("red",parseFloat(this.value))},function(e){t.ResetFilter("red")})),n.appendChild(this._createInputRange("green","Green",.2,2.2,.003921,this.defaultFilters.green,function(e){t.AdjustFilters("green",parseFloat(this.value))},function(e){t.ResetFilter("green")})),n.appendChild(this._createInputRange("blue","Blue",.2,2.2,.003921,this.defaultFilters.blue,function(e){t.AdjustFilters("blue",parseFloat(this.value))},function(e){t.ResetFilter("blue")})),e.appendChild(n),e}},{key:"_createInputRange",value:function(e,t,n,i,o,r,s,a){var l=document.createElement("div");l.setAttribute("class","cie-pnl-filters-param-container");var c=document.createElement("span");c.setAttribute("class","cie-pnl-filters-label"),c.textContent=t,l.appendChild(c);c=document.createElement("input");c.setAttribute("class","cie-pnl-input-range"),c.id="pid-im-"+e,c.type="range",c.max=i,c.min=n,c.step=o,c.value=r,c.oninput=s,l.appendChild(c);c=document.createElement("i");return c.setAttribute("class","fa fa-eraser cie-pnl-filters-erase-btn"),c.addEventListener("click",a),l.appendChild(c),l}}]),F);function F(e){!function(e){if(!(e instanceof F))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.defaultFilters={brightness:0,contrast:0,blur:0,noise:0,hue:0,saturate:0,red:1,green:1,blue:1}}function M(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var D=(M(R.prototype,[{key:"Destroy",value:function(){this.HideLoadingPanel(),this.OffMenuButton(),this.panelFullScreen.style.display="none",this.panelFullScreen.removeEventListener("keydown",this.keyDownEvent),null!=this.loadingPanel.parentNode&&this.loadingPanel.parentNode.removeChild(this.loadingPanel),null!=this.panelFullScreen&&null!=this.panelFullScreen.parentNode&&this.panelFullScreen.parentNode.removeChild(this.panelFullScreen)}},{key:"InitPanel",value:function(){var e=this,t=document.createElement("div");t.setAttribute("class","comma-img-editor"),t.style.display="flex",t.tabIndex=9999;var n=document.createElement("div");n.setAttribute("class","ciec-close-btn");var i=document.createElement("i");function o(){e.editor.Hide()}i.setAttribute("class","fa fa-close"),n.appendChild(i),n.removeEventListener("click",o),n.addEventListener("click",o),t.appendChild(n);var r=document.createElement("div");r.setAttribute("class","comma-img-editor-container");var s=document.createElement("div");s.setAttribute("class","cie-pnl-preview");i=document.createElement("div");i.setAttribute("class","cie-canvas-wrapper");n=document.createElement("canvas");return i.appendChild(n),this.canvasWrapper=i,s.appendChild(i),r.appendChild(s),r.appendChild(this._createToolsOptionsPnl()),r.appendChild(this._createMenuPnl()),t.appendChild(r),document.body.appendChild(t),(this.panelFullScreen=t).focus(),t.addEventListener("keydown",this.keyDownEvent,!1),n}},{key:"_onKeyDown",value:function(e){e=e.key;"Delete"===e?this.editor.DeleteSelectedObject():event.metaKey&&!event.shiftKey&&"z"==e?(this.editor.Undo(),event.preventDefault(),event.stopPropagation()):event.shiftKey&&event.metaKey&&"z"==e?(this.editor.Redo(),event.preventDefault(),event.stopPropagation()):event.ctrlKey&&!event.shiftKey&&"z"==e?(this.editor.Undo(),event.preventDefault(),event.stopPropagation()):event.ctrlKey&&event.shiftKey&&"z"==e&&(this.editor.Redo(),event.preventDefault(),event.stopPropagation())}},{key:"ShowLoadingPanel",value:function(){this.loadingPanel.Show()}},{key:"HideLoadingPanel",value:function(){this.loadingPanel.Hide()}},{key:"ClickMenuBtn",value:function(e,t){var n,i=this,o=t.getAttribute("id");"cie-btn-undo"==o?this.editor.Undo().then(function(e){i.RefreshCurrentPnl(e)}):"cie-btn-redo"==o?this.editor.Redo().then(function(e){i.RefreshCurrentPnl(e)}):"cie-btn-reset"==o?this.ResetToOrigin():"cie-btn-save"==o?this.editor.Save():(n=!0,null!=this.currentMenuBtn&&this.currentMenuBtn.id==t.id&&(n=!1,"cie-btn-crop"==this.currentMenuBtn.id?this.HideToolOptionPnl("crop"):"cie-btn-flip"==this.currentMenuBtn.id?this.HideToolOptionPnl("flip"):"cie-btn-rotate"==this.currentMenuBtn.id?this.HideToolOptionPnl("rotate"):"cie-btn-draw"==this.currentMenuBtn.id?this.HideToolOptionPnl("draw"):"cie-btn-shapes"==this.currentMenuBtn.id?this.HideToolOptionPnl("shapes"):"cie-btn-text"==this.currentMenuBtn.id?this.HideToolOptionPnl("text"):"cie-btn-filters"==this.currentMenuBtn.id?this.HideToolOptionPnl("filters"):"cie-btn-frame"==this.currentMenuBtn.id&&this.HideToolOptionPnl("frame")),this.OffMenuButton(),n&&(t.classList.contains("cie-pnl-menu-btn-selected")||(t.classList.add("cie-pnl-menu-btn-selected"),this.currentMenuBtn=t,"cie-btn-crop"==o?this.ShowToolOptionPnl("crop"):"cie-btn-flip"==o?this.ShowToolOptionPnl("flip"):"cie-btn-rotate"==o?this.ShowToolOptionPnl("rotate"):"cie-btn-draw"==o?this.ShowToolOptionPnl("draw"):"cie-btn-shapes"==o?this.ShowToolOptionPnl("shapes"):"cie-btn-text"==o?this.ShowToolOptionPnl("text"):"cie-btn-filters"==o?this.ShowToolOptionPnl("filters"):"cie-btn-frame"==o&&this.ShowToolOptionPnl("frame")))),e.preventDefault(),e.stopPropagation()}},{key:"ResetToOrigin",value:function(){this.editor.ResetToOriginalImage(),this.filtersManager.ResetToDefaults()}},{key:"RefreshCurrentPnl",value:function(e){null!=this.currentMenuBtn&&("cie-btn-crop"==this.currentMenuBtn.id?this.ShowToolOptionPnl("crop"):"cie-btn-flip"==this.currentMenuBtn.id||"cie-btn-rotate"==this.currentMenuBtn.id||"cie-btn-draw"==this.currentMenuBtn.id||"cie-btn-shapes"==this.currentMenuBtn.id||"cie-btn-text"==this.currentMenuBtn.id||("cie-btn-filters"==this.currentMenuBtn.id?this.filtersManager.SetFilters(e):"cie-btn-frame"==this.currentMenuBtn.id&&null!=e&&this.frameManager.Reset(e.color,e.width)))}},{key:"OffMenuButton",value:function(){var e;null!=this.currentMenuBtn&&(e=this.currentMenuBtn.id,document.getElementById(e+"-panel").style.display="none",this.currentMenuBtn.classList.remove("cie-pnl-menu-btn-selected"),this.currentMenuBtn=void 0,this.rotateManager.Close(),this.flipManager.Close(),this.frameManager.Close(),this.cropManager.Close(),this.drawManager.Close(),this.shapesManager.Close(),this.textManager.Close(),this.filtersManager.Close())}},{key:"HideToolOptionPnl",value:function(e){"crop"==e?this.cropManager.Close():"flip"==e?this.flipManager.Close():"rotate"==e?this.rotateManager.Close():"draw"==e?this.drawManager.Close():"shapes"==e?this.shapesManager.Close():"text"==e?this.textManager.Close():"filters"==e&&this.filtersManager.Close(),document.getElementById("cie-btn-"+e+"-panel").style.display="none",document.getElementById("cie-tool-option-panel").style.display="none"}},{key:"ShowToolOptionPnl",value:function(e){"crop"==e?this.cropManager.Start():"flip"==e?this.flipManager.Start():"rotate"==e?this.rotateManager.Start():"draw"==e?this.drawManager.Start():"shapes"==e?this.shapesManager.Start():"text"==e?this.textManager.Start():"filters"==e&&this.filtersManager.Start(),document.getElementById("cie-btn-"+e+"-panel").style.display="flex",document.getElementById("cie-tool-option-panel").style.display="flex"}},{key:"_createToolsOptionsPnl",value:function(){var e=document.createElement("div");return e.setAttribute("class","cie-pnl-tool-option"),e.setAttribute("id","cie-tool-option-panel"),e.appendChild(this.rotateManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.flipManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.frameManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.cropManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.drawManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.shapesManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.textManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.filtersManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e}},{key:"_createToolsOptionDivider",value:function(){var e=document.createElement("div");return e.setAttribute("class","cie-pnl-tool-option-btn-divider"),e}},{key:"_createToolsOptionButton",value:function(e,t,n,i){var o=document.createElement("div");o.setAttribute("class","cie-pnl-tool-option-btn"),null!=i&&o.setAttribute("id",i),o.removeEventListener("click",n),o.addEventListener("click",n);n=document.createElement("i");n.setAttribute("class",t),n.style.fontSize="18px",o.appendChild(n);n=document.createElement("span");return n.style.marginLeft="6px",n.innerHTML=e,o.appendChild(n),o}},{key:"_createMenuBtn",value:function(e,t,n,i){var o=document.createElement("div");o.setAttribute("class","cie-pnl-menu-btn"),o.setAttribute("id",e),o.setAttribute("title",n),o.removeEventListener("click",i),o.addEventListener("click",i);i=document.createElement("i");return i.setAttribute("class",t),o.appendChild(i),o}},{key:"_createMenuDivider",value:function(){var e=document.createElement("div");return e.setAttribute("class","cie-pnl-menu-divider"),e}},{key:"_createMenuPnl",value:function(){function e(e){t.ClickMenuBtn(e,this)}var t=this,n=document.createElement("div");n.setAttribute("class","cie-pnl-menu"),n.appendChild(this._createMenuBtn("cie-btn-undo","fa fa-reply","Undo",e)),n.appendChild(this._createMenuBtn("cie-btn-redo","fa fa-share","Redo",e)),n.appendChild(this._createMenuBtn("cie-btn-reset","fa fa-trash","Reset to Original",e)),n.appendChild(this._createMenuDivider()),n.appendChild(this._createMenuBtn("cie-btn-frame","fa fa-square-o","Add Frame",e)),n.appendChild(this._createMenuBtn("cie-btn-crop","fa fa-crop","Crop",e)),n.appendChild(this._createMenuBtn("cie-btn-flip","fa fa-arrows-h","Flip",e)),n.appendChild(this._createMenuBtn("cie-btn-rotate","fa fa-refresh","Rotate",e)),n.appendChild(this._createMenuDivider()),n.appendChild(this._createMenuBtn("cie-btn-draw","fa fa-paint-brush","Free Paint",e)),n.appendChild(this._createMenuBtn("cie-btn-shapes","fa fa-star-o","Add Shapes",e)),n.appendChild(this._createMenuBtn("cie-btn-text","fa fa-font","Add Text",e)),n.appendChild(this._createMenuDivider()),n.appendChild(this._createMenuBtn("cie-btn-filters","fa fa-sliders","Add Filter",e)),n.appendChild(this._createMenuDivider());var i=document.createElement("div");i.setAttribute("class","cie-pnl-menu-btn-save"),i.setAttribute("id","cie-btn-save"),i.removeEventListener("click",e),i.addEventListener("click",e);var o=document.createElement("div");return o.style.fontFamily="Arial",o.innerHTML="Save",i.appendChild(o),n.appendChild(i),n}}]),R);function R(e){!function(e){if(!(e instanceof R))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.panelFullScreen=void 0,this.canvasWrapper=void 0,this.loadingPanel=void 0,this.currentMenuBtn=void 0,this.loadingPanel=new o,this.rotateManager=new a(this.editor),this.flipManager=new u(this.editor),this.frameManager=new m(this.editor),this.cropManager=new b(this.editor),this.drawManager=new w(this.editor),this.shapesManager=new E(this.editor),this.textManager=new A(this.editor),this.filtersManager=new P(this.editor),this.keyDownEvent=this._onKeyDown.bind(this)}function I(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var L=(I(j.prototype,[{key:"Clear",value:function(){this.history=new Array,this.deletedHistory=new Array}},{key:"Push",value:function(e){this.history.push(e),this.deletedHistory=new Array}},{key:"Undo",value:function(){var e=this.history.pop();return null!=e&&this.deletedHistory.push(e),e}},{key:"Redo",value:function(){var e=this.deletedHistory.pop();return null!=e&&this.history.push(e),e}}]),j);function j(){!function(e){if(!(e instanceof j))throw new TypeError("Cannot call a class as a function")}(this),this.history=new Array,this.deletedHistory=new Array}function B(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var G=(B(z.prototype,[{key:"GetNew",value:function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=!1,n="";!t;){for(var i=0;i<5;i++)n+=e.charAt(Math.floor(Math.random()*e.length));null==this.allKeys[n]&&(t=this.allKeys[n]=!0)}return n}},{key:"Release",value:function(e){delete this.allKeys[e]}},{key:"VerifyAndRegister",value:function(e){return this.allKeys[e]&&(e=this.GetNew()),this.allKeys[e]=!0,e}},{key:"Reset",value:function(){this.allKeys={}}}]),z),H=n(0);function z(e){!function(e){if(!(e instanceof z))throw new TypeError("Cannot call a class as a function")}(this),this.allKeys={},null!=e&&e.forEach(function(e){this.allKeys[e]=!0})}function Y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var U=(t=[{key:"GetObjectConfiguration",value:function(){return{cornerStyle:"circle",cornerSize:18,cornerColor:"#fff",cornerStrokeColor:"#fff",transparentCorners:!1,lineWidth:3,borderColor:"#fff"}}}],Y((n=W).prototype,[{key:"Reset",value:function(){this.allObjects={},this.txtPrevious={}}},{key:"InitEvents",value:function(){var t=this;this.canvasManager.canvas.on({"selection:created":function(e){e=e.target;t.selectedObject=e}})}},{key:"_addEvents",value:function(e){e.on({scaled:this._listeners.objectScaled}),e.on({rotated:this._listeners.objectRotated}),e.on({moved:this._listeners.objectMoved}),e.on({"editing:exited":this._listeners.objectEditingExited})}},{key:"Add",value:function(e,t){t=1<arguments.length&&void 0!==t&&t;null==e.id&&(e.id=this.idManager.GetNew()),e.set(W.GetObjectConfiguration()),"i-text"==e.get("type").toLowerCase()&&(this.txtPrevious[e.id]=e.text),this.allObjects[e.id]=e,this._addEvents(e),t||(e={action:"added",idObject:e.id,json:e.toJSON(["id"])},this.canvasManager.PushToHistory("object",e))}},{key:"RemoveSelectedObject",value:function(){var e=this.canvasManager.canvas,t=e.getActiveObject(),n={action:"removed",idObject:t.id,json:t.toJSON(["id"])};e.remove(t),e.renderAll(),this.canvasManager.PushToHistory("object",n)}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){var t=this.allObjects[e.idObject];return"modified"==e.action?(t.set(e.previousState),t.setCoords(),this.canvasManager.canvas.renderAll()):"added"==e.action?(this.canvasManager.canvas.remove(t),this.canvasManager.canvas.renderAll()):"removed"==e.action?this._addObjFromHistory(e.idObject,e.json):"textModified"==e.action&&(t.text=e.prevText,t.setCoords(),this.canvasManager.canvas.renderAll()),Promise.resolve()}},{key:"_redo",value:function(e){var t=this.allObjects[e.idObject];return"modified"==e.action?(t.set(e.newState),t.setCoords(),this.canvasManager.canvas.renderAll()):"added"==e.action?this._addObjFromHistory(e.idObject,e.json):"removed"==e.action?(this.canvasManager.canvas.remove(t),this.canvasManager.canvas.renderAll()):"textModified"==e.action&&(t.text=e.newText,t.setCoords(),this.canvasManager.canvas.renderAll()),Promise.resolve()}},{key:"_addObjFromHistory",value:function(n,e){var i=this,o=this.canvasManager.canvas;H.fabric.util.enlivenObjects([e],function(e){var t=o.renderOnAddRemove;o.renderOnAddRemove=!1,e.forEach(function(e){e.id=n,i.allObjects[e.id]=e,i._addEvents(e),e.set(W.GetObjectConfiguration()),o.add(e)}),o.renderOnAddRemove=t,o.renderAll()})}},{key:"_onObjectScaled",value:function(e){this._pushChangesToHistory(e)}},{key:"_onObjectRotated",value:function(e){this._pushChangesToHistory(e)}},{key:"_onObjectMoved",value:function(e){this._pushChangesToHistory(e)}},{key:"_onObjectEditingExited",value:function(){var e,t=this.canvasManager.canvas.getActiveObject();"i-text"==t.get("type").toLowerCase()&&(e=this.txtPrevious[t.id],e={action:"textModified",newText:t.text,prevText:e,idObject:t.id},this.canvasManager.PushToHistory("object",e),this.txtPrevious[t.id]=t.text)}},{key:"_pushChangesToHistory",value:function(e){e={action:"modified",previousState:{angle:e.transform.original.angle,top:e.transform.original.top,left:e.transform.original.left,scaleX:e.transform.original.scaleX,scaleY:e.transform.original.scaleY,originX:"left",originY:"top"},newState:{angle:e.target.angle,top:e.target.top,left:e.target.left,scaleX:e.target.scaleX,scaleY:e.target.scaleY,originX:"left",originY:"top"},idObject:e.target.id};this.canvasManager.PushToHistory("object",e)}}]),Y(n,t),W);function W(e){!function(e){if(!(e instanceof W))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,this.selectedObject=void 0,this.allObjects={},this.idManager=new G,this.txtPrevious={},this._listeners={objectScaled:this._onObjectScaled.bind(this),objectRotated:this._onObjectRotated.bind(this),objectMoved:this._onObjectMoved.bind(this),objectEditingExited:this._onObjectEditingExited.bind(this)}}function X(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var V=(X(q.prototype,[{key:"Flip",value:function(e,t){t=1<arguments.length&&void 0!==t&&t;"vertically"==e?this.flipY():this.flipX(),t||(e={direction:e},this.canvasManager.PushToHistory("flip",e))}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){return this.Flip(e.direction,!0),Promise.resolve()}},{key:"_redo",value:function(e){return this.Flip(e.direction,!0),Promise.resolve()}},{key:"setImageProperties",value:function(e,t){var n=this.canvasManager.canvasImg;n&&(n.set(e).setCoords(),t&&this.canvasManager.canvas.renderAll())}},{key:"setFlip",value:function(e){var t=this.canvasManager.canvasImg.flipX,n=this.canvasManager.canvasImg.flipY,t=t!==e.flipX,n=n!==e.flipY;return t||n?(this.setImageProperties(e,!0),this._invertAngle(t,n),this._flipObjects(t,n),Promise.resolve({flipX:e.flipX,flipY:e.flipY,angle:this.canvasManager.canvasImg.angle})):Promise.reject(rejectMessages.flip)}},{key:"_invertAngle",value:function(e,t){var n=this.canvasManager.canvasImg,i=n.angle;e&&(i*=-1),t&&(i*=-1),n.rotate(parseFloat(i)).setCoords()}},{key:"_flipObjects",value:function(e,t){var n=this.canvasManager.canvas;e&&n.forEachObject(function(e){e.set({angle:parseFloat(-1*e.angle),flipX:!e.flipX,left:n.width-e.left}).setCoords()}),t&&n.forEachObject(function(e){e.set({angle:parseFloat(-1*e.angle),flipY:!e.flipY,top:n.height-e.top}).setCoords()}),n.renderAll()}},{key:"flipX",value:function(){var e={flipX:this.canvasManager.canvasImg.flipX,flipY:this.canvasManager.canvasImg.flipY};return this.setFlip({flipX:!e.flipX,flipY:e.flipY})}},{key:"flipY",value:function(){var e={flipX:this.canvasManager.canvasImg.flipX,flipY:this.canvasManager.canvasImg.flipY};return this.setFlip({flipX:e.flipX,flipY:!e.flipY})}}]),q);function q(e){!function(e){if(!(e instanceof q))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e}function K(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function J(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var $=(J(Z.prototype,[{key:"Start",value:function(){"free"==this.type?(this._initFreeDrawing(),this._stopStraightLine()):(this._stopFreeDrawing(),this._initStraightLine())}},{key:"Stop",value:function(){this._stopFreeDrawing(),this._stopStraightLine()}},{key:"_initFreeDrawing",value:function(){this.canvasManager.canvas.isDrawingMode=!0,this.canvasManager.canvas.on({"path:created":this._listeners.pathCreated})}},{key:"_stopFreeDrawing",value:function(){this.canvasManager.canvas.isDrawingMode=!1,this.canvasManager.canvas.off({"path:created":this._listeners.pathCreated})}},{key:"_initStraightLine",value:function(){var e=this.canvasManager.canvas;e.defaultCursor="crosshair",e.selection=!1,e.forEachObject(function(e){e.set({evented:!1,selectable:!1})}),e.on({"mouse:down":this._listeners.mousedown})}},{key:"_stopStraightLine",value:function(){var e=this.canvasManager.canvas;e.defaultCursor="default",e.selection=!0,e.forEachObject(function(e){e.set({evented:!0,selectable:!0})}),e.off({"mouse:down":this._listeners.mousedown}),e.__eventListeners["mouse:down"]=[]}},{key:"SetDrawingParameters",value:function(e,t,n){this.brushSize=t,this.color=n;var i=this.canvasManager.canvas.freeDrawingBrush;i.width=t,i.color=n,this.type!=e&&(this.type=e,"free"==this.type?(this._initFreeDrawing(),this._stopStraightLine()):(this._stopFreeDrawing(),this._initStraightLine()))}},{key:"_onPathCreated",value:function(e){e=e.path;e.set(U.GetObjectConfiguration()),this.canvasManager.AddObject(e)}},{key:"_onMouseDown",value:function(e){var t=this.canvasManager.canvas,n=t.getPointer(e.e),i=[n.x,n.y,n.x,n.y];this.startX=n.x,this.startY=n.y,"straight"==this.type?this._shape=new H.fabric.Line(i,{stroke:this.color,strokeWidth:this.brushSize,evented:!1,selectable:!1}):"rectangle"==this.type?this._shape=new H.fabric.Rect((K(e={stroke:this.color,strokeWidth:this.brushSize,evented:!1,left:n.x,top:n.y,width:0,height:0,fill:"transparent"},"evented",!1),K(e,"selectable",!1),e)):"circle"==this.type?this._shape=new H.fabric.Circle((K(n={stroke:this.color,strokeWidth:this.brushSize,evented:!1,left:n.x,top:n.y,radius:0,fill:"transparent"},"evented",!1),K(n,"selectable",!1),n)):"arrow"==this.type&&(this._shape=new H.fabric.Line(i,{stroke:this.color,strokeWidth:this.brushSize,evented:!1,selectable:!1})),t.add(this._shape),t.__eventListeners["mouse:move"]=[],t.__eventListeners["mouse:up"]=[],t.on({"mouse:move":this._listeners.mousemove,"mouse:up":this._listeners.mouseup})}},{key:"_onMouseMove",value:function(e){var t,n,i,o=this.canvasManager.canvas,r=o.getPointer(e.e);"straight"==this.type?this._shape.set({x2:r.x,y2:r.y}):"rectangle"==this.type?(n=this._shape.left,i=this._shape.top,e=r.x-this.startX,t=r.y-this.startY,e<0&&(n=r.x,e=Math.abs(e)),t<0&&(i=r.y,t=Math.abs(t)),this._shape.set({width:e,height:t,left:n,top:i})):"circle"==this.type?(t=this._shape.left,n=this._shape.top,(i=(r.x-this.startX)/2)<0&&(i=Math.abs(i),t=r.x,n=r.y),this._shape.set({radius:i,left:t,top:n})):"arrow"==this.type&&this._shape.set({x2:r.x,y2:r.y}),this._shape.setCoords(),o.renderAll()}},{key:"_onMouseUp",value:function(e){var t=this.canvasManager.canvas;"arrow"==this.type&&(e=t.getPointer(e.e),t.remove(this._shape),this._shape=this._drawArrow(this.startX,this.startY,e.x,e.y),t.add(this._shape),t.renderAll()),this._shape.set(U.GetObjectConfiguration()),this.canvasManager.AddObject(this._shape),t.off({"mouse:move":this._listeners.mousemove,"mouse:up":this._listeners.mouseup}),t.__eventListeners["mouse:move"]=[],t.__eventListeners["mouse:up"]=[]}},{key:"_drawArrow",value:function(e,t,n,i){var o=Math.atan2(i-t,n-e),r=this.brushSize/2;n-=r*Math.cos(o),i-=r*Math.sin(o);t=[{x:e,y:t},{x:e-r/4*Math.cos(o-Math.PI/2),y:t-r/4*Math.sin(o-Math.PI/2)},{x:n-r/4*Math.cos(o-Math.PI/2),y:i-r/4*Math.sin(o-Math.PI/2)},{x:n-r*Math.cos(o-Math.PI/2),y:i-r*Math.sin(o-Math.PI/2)},{x:n+r*Math.cos(o),y:i+r*Math.sin(o)},{x:n-r*Math.cos(o+Math.PI/2),y:i-r*Math.sin(o+Math.PI/2)},{x:n-r/4*Math.cos(o+Math.PI/2),y:i-r/4*Math.sin(o+Math.PI/2)},{x:e-r/4*Math.cos(o+Math.PI/2),y:t-r/4*Math.sin(o+Math.PI/2)},{x:e,y:t}];return new H.fabric.Polyline(t,{fill:this.color,stroke:this.color,opacity:1,strokeWidth:this.brushSize,selectable:!1,evented:!1})}}]),Z);function Z(e){!function(e){if(!(e instanceof Z))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,this.type="free",this.brushSize=10,this.color="#FFFFFF",this._listeners={mousedown:this._onMouseDown.bind(this),mousemove:this._onMouseMove.bind(this),mouseup:this._onMouseUp.bind(this),pathCreated:this._onPathCreated.bind(this)}}function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ee=(Q(te.prototype,[{key:"Crop",value:function(e){var n=this,i=this.canvasManager.canvas,t=this.canvasManager.domCanvas.getBoundingClientRect(),o=i.width/t.width,r=i.height/t.height,e={top:r*(e.top-t.top),left:o*(e.left-t.left),width:o*e.width,height:r*e.height},s=(this.canvasManager.toDataURL({format:"png"}),this.canvasManager.toDataURL(e)),a={undoCanvasJson:JSON.stringify(i.toObject(["id"])),frameBorder:this.canvasManager.frameBorder,redoCanvasPng:s};return new Promise(function(e,t){i.clear(),i.setBackgroundImage(s,function(){n.canvasManager.frameBorder=0,n.canvasManager.canvasImg=i.backgroundImage,n.canvasManager.AdjustToScreen(),n.canvasManager.PushToHistory("crop",a),e()})})}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(n){var i=this,o=this.canvasManager.canvas;return o.clear(),new Promise(function(e,t){o.loadFromJSON(n.undoCanvasJson,function(){o.renderAll(),i.canvasManager.canvas.forEachObject(function(e){i.canvasManager.AddObject(e,!0)}),i.canvasManager.frameBorder=n.frameBorder,i.canvasManager.canvasImg=o.backgroundImage,i.canvasManager.AdjustToScreen(),e()})})}},{key:"_redo",value:function(n){var i=this,o=this.canvasManager.canvas;return new Promise(function(e,t){o.clear(),o.setBackgroundImage(n.redoCanvasPng,function(){i.canvasManager.canvasImg=o.backgroundImage,i.canvasManager.AdjustToScreen(),e()})})}}]),te);function te(e){!function(e){if(!(e instanceof te))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e}function ne(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ie=(ne(oe.prototype,[{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){return 666==e.prevValue?this._removeFilter(e.type):this.Apply(e.type,e.prevValue,!0),Promise.resolve(this.currentState)}},{key:"_redo",value:function(e){return this.Apply(e.type,e.newValue,!0),Promise.resolve(this.currentState)}},{key:"Apply",value:function(e,t,n){var i=2<arguments.length&&void 0!==n&&n;this.currentState[e]=t;var o=this.canvasManager.canvasImg,n=0;null==o.filters[this.filtersNames[e]]?(n=666,this._initFilter(o,e,t)):n=this._applyValue(o,e,t),o.applyFilters(),this.canvasManager.canvas.renderAll(),i||(t={type:e,prevValue:n,newValue:t},this.canvasManager.PushToHistory("filters",t))}},{key:"_removeFilter",value:function(e){var t,n,i=this.canvasManager.canvasImg;"red"==e||"green"==e||"blue"==e?(this.currentState[e]=1,n=(t=i.filters[this.filtersNames[e]]).gamma,"red"==e?n[0]=1:"green"==e?n[1]=1:"blue"==e&&(n[2]=1),t.gamma=n):(this.currentState[e]=0,i.filters.splice(this.filtersNames[e],1)),i.applyFilters(),this.canvasManager.canvas.renderAll()}},{key:"_initFilter",value:function(e,t,n){var i;"brightness"==t?e.filters[this.filtersNames[t]]=new this.f.Brightness({brightness:parseFloat(n)}):"contrast"==t?e.filters[this.filtersNames[t]]=new this.f.Contrast({contrast:parseFloat(n)}):"blur"==t?e.filters[this.filtersNames[t]]=new this.f.Blur({blur:parseFloat(n)}):"hue"==t?e.filters[this.filtersNames[t]]=new this.f.HueRotation({rotation:parseFloat(n)}):"saturate"==t?e.filters[this.filtersNames[t]]=new this.f.Saturation({saturation:parseFloat(n)}):"noise"==t?e.filters[this.filtersNames[t]]=new this.f.Noise({noise:parseFloat(n)}):"red"!=t&&"green"!=t&&"blue"!=t||(i=[],"red"==t?(i.push(n),i.push(1),i.push(1)):"green"==t?(i.push(1),i.push(n),i.push(1)):"blue"==t&&(i.push(1),i.push(1),i.push(n)),e.filters[this.filtersNames[t]]=new this.f.Gamma({gamma:i}))}},{key:"_applyValue",value:function(e,t,n){var i=0,o=e.filters[this.filtersNames[t]];return"brightness"==t?(i=o.brightness,o.brightness=parseFloat(n)):"contrast"==t?(i=o.contrast,o.contrast=parseFloat(n)):"blur"==t?(i=o.blur,o.blur=parseFloat(n)):"hue"==t?(i=o.rotation,o.rotation=parseFloat(n)):"saturate"==t?(i=o.saturation,o.saturation=parseFloat(n)):"noise"==t?(i=o.noise,o.noise=parseFloat(n)):"red"!=t&&"green"!=t&&"blue"!=t||(i=o.gamma,e=JSON.parse(JSON.stringify(i)),"red"==t?(i=i[0],e[0]=n):"green"==t?(i=i[1],e[1]=n):"blue"==t&&(i=i[2],e[2]=n),o.gamma=e),i}}]),oe);function oe(e){!function(e){if(!(e instanceof oe))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,H.fabric.textureSize=10016384,this.filterEngine=new H.fabric.Canvas2dFilterBackend,H.fabric.filterBackend=H.fabric.initFilterBackend(),H.fabric.filterBackend=this.filterEngine,this.f=H.fabric.Image.filters,this.filtersNames={brightness:0,contrast:1,blur:2,noise:3,hue:4,saturate:5,red:6,green:6,blue:6},this.currentState={brightness:0,contrast:0,blur:0,noise:0,hue:0,saturate:0,red:1,green:1,blue:1}}function re(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var se=(re(ae.prototype,[{key:"Frame",value:function(e,t,n){var i=2<arguments.length&&void 0!==n&&n,o=this.canvasManager.canvas,r=this.canvasManager.canvasImg,s={prevWidth:this.previousFrameSize,prevColor:o.backgroundColor,newWidth:t,newColor:e};i||(this.previousFrameSize=t);n=this.canvasManager.domCanvas.getBoundingClientRect(),n=o.width/n.width*t;this.canvasManager.frameBorder=n;t=r.getCenterPoint();r.top=n,r.left=n,o.renderAll();r=r.getCenterPoint();this._adjustAllObjects(t,r,n),this.canvasManager.AdjustToScreen(),o.backgroundColor=e,o.renderAll(),i||this.canvasManager.PushToHistory("frame",s)}},{key:"_adjustAllObjects",value:function(e,t){var n=this.canvasManager.canvas,i=e.x-t.x,o=e.y-t.y;n.forEachObject(function(e){var t=e.getCenterPoint();e.set({left:t.x-i,top:t.y-o,originX:"center",originY:"center"}),e.setCoords()}),n.renderAll()}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){return this.Frame(e.prevColor,e.prevWidth,!0),Promise.resolve({color:e.prevColor,width:e.prevWidth})}},{key:"_redo",value:function(e){return this.Frame(e.newColor,e.newWidth,!0),Promise.resolve({color:e.newColor,width:e.newWidth})}}]),ae);function ae(e){!function(e){if(!(e instanceof ae))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,this.previousFrameSize=0}function le(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ce=(le(ue.prototype,[{key:"Rotate",value:function(e,t){var n=1<arguments.length&&void 0!==t&&t,i=this.canvasManager.canvasImg,o=i.angle%360;e%=360;t=i.getCenterPoint();i.set({angle:e}).setCoords(),this.canvasManager.AdjustToScreen();i=i.getCenterPoint();this._rotateAllObjects(t,i,e-o),n||(e={oldAngle:o,newAngle:e},this.canvasManager.PushToHistory("rotate",e))}},{key:"_rotateAllObjects",value:function(i,e,o){var t=this.canvasManager.canvas,r=i.x-e.x,s=i.y-e.y;t.forEachObject(function(e){var t=e.getCenterPoint(),n=H.fabric.util.degreesToRadians(o),n=H.fabric.util.rotatePoint(t,i,n);e.set({left:n.x-r,top:n.y-s,originX:"center",originY:"center",angle:(e.angle+o)%360}),e.setCoords()}),t.renderAll()}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){return this.Rotate(e.oldAngle,!0),Promise.resolve(e.oldAngle)}},{key:"_redo",value:function(e){return this.Rotate(e.newAngle,!0),Promise.resolve(e.newAngle)}}]),ue);function ue(e){!function(e){if(!(e instanceof ue))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e}function he(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var de=(he(fe.prototype,[{key:"Start",value:function(){var e=this.canvasManager.canvas;e.defaultCursor="crosshair",e.selection=!1,e.on({"mouse:down":this.mousedown})}},{key:"Stop",value:function(){var e=this.canvasManager.canvas;e.defaultCursor="default",e.selection=!0,e.off({"mouse:down":this.mousedown}),e.__eventListeners["mouse:down"]=[]}},{key:"SetTextParameters",value:function(e,t,n){n=2<arguments.length&&void 0!==n?n:"Arial";this.fontSize=e,this.color=t,this.fontFamily=n}},{key:"AddText",value:function(e,t){var n=this.canvasManager.canvas,t=new H.fabric.IText("Click to edit",{left:e,top:t,fontSize:this.fontSize,fontFamily:this.fontFamily,stroke:this.color,fill:this.color});t.set(U.GetObjectConfiguration()),n.add(t),this.canvasManager.AddObject(t)}},{key:"_onMouseDown",value:function(e){null==e.target&&(e=this.canvasManager.canvas.getPointer(e.e),this.AddText(e.x,e.y))}}]),fe);function fe(e){!function(e){if(!(e instanceof fe))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,this.fontSize=40,this.color="#ffffff",this.fontFamily="Arial",this.mousedown=this._onMouseDown.bind(this)}function pe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ge=(pe(me.prototype,[{key:"Reset",value:function(i){var o=this;this.canvasManager.imgSrc=i;var r=this.canvasManager.canvas,s={undoCanvasJson:JSON.stringify(r.toObject(["id"])),frameBorder:this.canvasManager.frameBorder};return r.clear(),new Promise(function(e,t){var n=new Image;n.onload=function(){o.canvasManager.frameBorder=0,o.canvasManager.canvasImg=new H.fabric.Image(n),r.setBackgroundImage(o.canvasManager.canvasImg),o.canvasManager.AdjustToScreen(),s.redoCanvasPng=r.toDataURL({format:"png"}),o.canvasManager.PushToHistory("reset",s),o.canvasManager.canvas.renderAll(),e()},n.src=i})}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(n){var i=this,o=this.canvasManager.canvas;return o.clear(),new Promise(function(e,t){o.loadFromJSON(n.undoCanvasJson,function(){o.renderAll(),i.canvasManager.canvas.forEachObject(function(e){i.canvasManager.AddObject(e,!0)}),i.canvasManager.frameBorder=n.frameBorder,i.canvasManager.canvasImg=o.backgroundImage,i.canvasManager.AdjustToScreen(),e()})})}},{key:"_redo",value:function(n){var i=this,o=this.canvasManager.canvas;return new Promise(function(e,t){o.clear(),o.setBackgroundImage(n.redoCanvasPng,function(){i.canvasManager.canvasImg=o.backgroundImage,i.canvasManager.AdjustToScreen(),e()})})}}]),me);function me(e){!function(e){if(!(e instanceof me))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e}function ve(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ye=(ve(be.prototype,[{key:"InitCanvas",value:function(){var i=this;return new Promise(function(e,t){var n=new Image;n.onload=function(){i.canvas=new H.fabric.Canvas(i.domCanvas,{enableRetinaScaling:!1,width:n.width,height:n.height}),i.canvasImg=new H.fabric.Image(n),i.canvas.setBackgroundImage(i.canvasImg),i.canvas.requestRenderAll(),i.AdjustToScreen(),i.objectsManager.InitEvents(),e()},n.src=i.imgSrc})}},{key:"toDataURL",value:function(e){return this.canvas.toDataURL(e)}},{key:"GetBoundingClientRect",value:function(){return this.domCanvas.getBoundingClientRect()}},{key:"_adjustDimensions",value:function(e,t){var n=this.maxWindowWidth/e,i=this.maxWindowHeight/t,o=Math.min(e,this.maxWindowWidth),r=Math.min(t,this.maxWindowHeight);return n<1&&n<i?(o=e*n,r=t*n):i<1&&i<n&&(o=e*i,r=t*i),{width:Math.floor(o),height:Math.floor(r)}}},{key:"AdjustToScreen",value:function(){var e=this.canvasImg.scale(1),t=e.getBoundingRect(),n=t.width,i=t.height;n+=this.frameBorder,i+=this.frameBorder;t=this._adjustDimensions(n,i);this.setCanvasDimension_CSS({"max-width":t.width+"px","max-height":t.height+"px"}),this.setCanvasDimension_Backstore({width:n,height:i}),this.canvas.centerObject(e)}},{key:"setCanvasDimension_CSS",value:function(e){this.canvas.setDimensions(e,{cssOnly:!0})}},{key:"setCanvasDimension_Backstore",value:function(e){this.canvas.setDimensions(e,{backstoreOnly:!0})}},{key:"AddObject",value:function(e,t){t=1<arguments.length&&void 0!==t&&t;this.objectsManager.Add(e,t)}},{key:"DeleteSelectedObject",value:function(){this.objectsManager.RemoveSelectedObject()}},{key:"ResetToImage",value:function(e){this.resetManager.Reset(e)}},{key:"FreezeCanvasEditing",value:function(){this.domCanvas.style.opacity=.4}},{key:"ResumeCanvasEditing",value:function(){this.domCanvas.style.opacity=1}},{key:"Rotate",value:function(e){return this.rotateManager.Rotate(e)}},{key:"Flip",value:function(e){return this.flipManager.Flip(e)}},{key:"Frame",value:function(e,t){return this.frameManager.Frame(e,t)}},{key:"Crop",value:function(e){return this.cropManager.Crop(e)}},{key:"Undo",value:function(){var e=this.historyManager.Undo();return this._manageHistory("undo",e)}},{key:"Redo",value:function(){var e=this.historyManager.Redo();return this._manageHistory("redo",e)}},{key:"_manageHistory",value:function(e,t){var n=void 0;return null!=t?"crop"==t.action?n=this.cropManager.ManageHistory(e,t.params):"frame"==t.action?n=this.frameManager.ManageHistory(e,t.params):"flip"==t.action?n=this.flipManager.ManageHistory(e,t.params):"rotate"==t.action?n=this.rotateManager.ManageHistory(e,t.params):"object"==t.action?n=this.objectsManager.ManageHistory(e,t.params):"filters"==t.action?n=this.filtersManager.ManageHistory(e,t.params):"reset"==t.action&&(n=this.resetManager.ManageHistory(e,t.params)):n=Promise.resolve(),n}},{key:"PushToHistory",value:function(e,t){t={action:e,params:t};this.historyManager.Push(t)}},{key:"StartDrawing",value:function(e,t,n){this.SetDrawingParameters(e,t,n),this.drawManager.Start()}},{key:"SetDrawingParameters",value:function(e,t,n){this.drawManager.SetDrawingParameters(e,t,n)}},{key:"StopDrawing",value:function(){this.drawManager.Stop()}},{key:"SetTextParameters",value:function(e,t){this.textManager.SetTextParameters(e,t)}},{key:"StartAddText",value:function(){this.textManager.Start()}},{key:"StopAddText",value:function(){this.textManager.Stop()}},{key:"ApplyFilter",value:function(e,t){this.filtersManager.Apply(e,t)}}]),be);function be(e,t){var n=this;!function(e){if(!(e instanceof be))throw new TypeError("Cannot call a class as a function")}(this),this.domCanvas=e,this.imgSrc=t,this.canvasImg=void 0,this.canvas=void 0,this.maxWPerc=.6,this.maxHPerc=.6,this.maxWindowWidth=parseInt(this.maxWPerc*window.innerWidth),this.maxWindowHeight=parseInt(this.maxHPerc*window.innerHeight),this.frameBorder=0,window.onresize=function(){n.maxWindowWidth=parseInt(n.maxWPerc*window.innerWidth),n.maxWindowHeight=parseInt(n.maxHPerc*window.innerHeight),n.AdjustToScreen()},this.historyManager=new L,this.objectsManager=new U(this),this.flipManager=new V(this),this.drawManager=new $(this),this.cropManager=new ee(this),this.filtersManager=new ie(this),this.frameManager=new se(this),this.rotateManager=new ce(this),this.textManager=new de(this),this.resetManager=new ge(this)}function Ce(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var xe=(Ce(we.prototype,[{key:"Init",value:function(){var t=this;this.interfaceManager.ShowLoadingPanel();var e=this.interfaceManager.InitPanel();this.canvas=new ye(e,this.imgSrc),this.canvas.InitCanvas().then(function(e){t.interfaceManager.HideLoadingPanel()},function(e){console.log(e)})}},{key:"Save",value:function(){this.interfaceManager.ShowLoadingPanel(),null!=this.SaveEditedImage&&this.SaveEditedImage(this.canvas.toDataURL({format:"png"})),this.Hide()}},{key:"ResetToOriginalImage",value:function(){this.canvas.ResetToImage(this.originSrc)}},{key:"DeleteSelectedObject",value:function(){this.canvas.DeleteSelectedObject()}},{key:"GetBoundingClientRect",value:function(){return this.canvas.GetBoundingClientRect()}},{key:"Hide",value:function(){this.shown=!1,this.interfaceManager.Destroy()}},{key:"FreezeCanvasEditing",value:function(){return this.canvas.FreezeCanvasEditing()}},{key:"ResumeCanvasEditing",value:function(){return this.canvas.ResumeCanvasEditing()}},{key:"Undo",value:function(){return this.canvas.Undo()}},{key:"Redo",value:function(){return this.canvas.Redo()}},{key:"Rotate",value:function(e){return this.canvas.Rotate(e)}},{key:"Flip",value:function(e){return this.canvas.Flip(e)}},{key:"Frame",value:function(e,t){return this.canvas.Frame(e,t)}},{key:"Crop",value:function(e){return this.canvas.Crop(e)}},{key:"StartDrawing",value:function(e,t,n){this.canvas.StartDrawing(e,t,n)}},{key:"SetDrawingParameters",value:function(e,t,n){this.canvas.SetDrawingParameters(e,t,n)}},{key:"StopDrawing",value:function(){this.canvas.StopDrawing()}},{key:"StartAddText",value:function(){this.canvas.StartAddText()}},{key:"SetTextParameters",value:function(e,t){this.canvas.SetTextParameters(e,t)}},{key:"StopAddText",value:function(){this.canvas.StopAddText()}},{key:"ApplyFilter",value:function(e,t){this.canvas.ApplyFilter(e,t)}}]),we);function we(e,t,n){!function(e){if(!(e instanceof we))throw new TypeError("Cannot call a class as a function")}(this),this.imgSrc=e,this.originSrc=t,this.SaveEditedImage=n,this.interfaceManager=new D(this),this.Init()}}],o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=9))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var w=n(0);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(x,w.Plugin);var e,t,n,i,o=(n=x,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=c(n);return!(t=i?(e=c(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==r(t)&&"function"!=typeof t?l(this):t});function x(e){var t;!function(e){if(!(e instanceof x))throw new TypeError("Cannot call a class as a function")}(this);var n,e=(t=o.call(this,e)).rootNode.domElement;return null==t.contextmenuFunction&&(n=l(t),t.contextmenuFunction=function(e){n.EditStartingNumber(),e.preventDefault(),e.stopPropagation()}),e.removeEventListener("contextmenu",t.contextmenuFunction),e.addEventListener("contextmenu",t.contextmenuFunction),t}return t=[{key:"CreateNew",value:function(i,e){"ordered"==e&&(e="numbered");var t="numbered",n=!1;null!=e&&("string"==typeof e?t=e:(t=e.type,n=e.isTab));var o,r="padding-left:40px;",e=i.GetStyleAtCurrentCursorPosition();null!=e.nodeStyle&&(null!=e.nodeStyle.fontColor&&(o=e.nodeStyle.fontColor,r=r+"color: "+o.on+";"),null!=e.nodeStyle.fontFamily&&(o=e.nodeStyle.fontFamily,r=r+"font-family: "+o.on+";"),null!=e.nodeStyle.fontSize&&(d=e.nodeStyle.fontSize,r=r+"font-size: "+d.on+";"));var s,a,l,e=i.GetSelectedLines(),c=!1,u=!1,h="";if(0<e.length&&(s=[],a=[],l=[],e.forEach(function(e){"ul"==e.tagName.toLowerCase()||"ol"==e.tagName.toLowerCase()?(h=e.tagName.toLowerCase(),c=!0,a.push(e)):"li"!=e.tagName.toLowerCase()||n?l.push(e):(c=u=!0,s.push(e))}),c?u?(e=[],f=s[0].parent,e.push(f),c=!(u=!1),h=f.tagName.toLowerCase()):e=a:e=l),!c){var d=i.GetCursorPosition(),f="ul";"numbered"==t&&(f="ol");var p=w.BlockNode.CreateNew(i,f);p.SetAttributes([{name:"style",value:r}]);var g,m=void 0,v=[];return e.forEach(function(e){m=e.parent;var t=w.BlockNode.CreateNew(i,"li");e.children.forEach(function(e){t.Append(e)}),p.Append(t),v.push(e.id)}),null!=m&&(f=m.children,m.children=[],g=!0,f.forEach(function(e){v.indexOf(e.id)<0?m.Append(e):(g&&(m.Append(p),g=!1),i.DeleteNode(e,!0))})),i.GetNodeById(d.idStartNode).SetFocus(d.startOffset),new x(p)}var y=void 0;if("numbered"==t&&"ol"==h||"bulleted"==t&&"ul"==h){var b={},C=[];e.forEach(function(t){"ol"!=t.tagName.toLowerCase()&&"ul"!=t.tagName.toLowerCase()||(C.push(t),b[t.id]=[],t.children.forEach(function(e){"li"==e.tagName.toLowerCase()&&(e.ChangeTagName("div"),b[t.id].push(e))}))}),C.forEach(function(e){var t,n;null!=e&&(t=e.parent,b[(n=e).id].forEach(function(e){t.AppendAfter(n,e),y=n=e}),i.RemovePluginInstance(e.id),i.DeleteNode(e,!1,!1))}),null!=y&&y.GetFirstTextNode().SetFocus()}else if(e.forEach(function(e){"ul"==(y=e).tagName.toLowerCase()?e.ChangeTagName("ol"):e.ChangeTagName("ul"),e.SetAttributes([{name:"style",value:r}])}),null!=y)return new x(y)}},{key:"GetName",value:function(){return"lists"}},{key:"GetTagToParseOnPaste",value:function(){return["ul","ol"]}},{key:"CreateNewFromPastedNode",value:function(n,e){var t="ul";"ol"==e.tagName.toLowerCase()&&(t="ol");var i="margin-left:40px;list-style-position: inside;",o=n.GetStyleAtCurrentCursorPosition();null!=o.nodeStyle&&(null!=o.nodeStyle.fontColor&&(i=i+"color: "+o.nodeStyle.fontColor.on+";"),null!=o.nodeStyle.fontFamily&&(i=i+"font-family: "+o.nodeStyle.fontFamily.on+";"));var r=w.BlockNode.CreateNew(n,t);r.SetAttributes([{name:"style",value:i}]);e=[].slice.call(e.getElementsByTagName("li"));return null!=e&&e.forEach(function(e){var t=w.BlockNode.CreateNew(n,"li"),e=w.TextNode.CreateNew(n,"span",e.textContent.toString(),n.GetDefaultNodeStyle().Copy());t.Append(e),r.Append(t)}),new x(r)}}],s((e=x).prototype,[{key:"EditStartingNumber",value:function(){var n,i,e,t,o;"ol"==this.rootNode.tagName.toLowerCase()&&(n=this,(i=document.createElement("div")).style.backgroundColor="rgba(0,0,0,0.2)",i.style.width="100%",i.style.height="100%",i.style.position="absolute",i.style.left="0px",i.style.top="0px",i.style.overflow="auto",i.style.zIndex="999",i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",(e=document.createElement("div")).style.backgroundColor="#282d36",e.style.borderRadius="10px",e.style.color="#ffffff",e.style.width="200px",e.style.height="100px",e.style.display="flex",e.style.justifyContent="start",e.style.alignItems="center",(t=document.createElement("div")).textContent="Start from:",t.style.fontSize="16px",t.style.padding="0px 10px 0px 20px",e.appendChild(t),t=document.createElement("div"),(o=document.createElement("input")).style.border="none",o.style.width="50px",o.style.padding="4px",o.style.borderRadius="4px",o.style.outline="none",t.appendChild(o),o.addEventListener("blur",function(){try{i.parentNode.removeChild(i)}catch(e){}}),o.addEventListener("keyup",function(e){var t=e.key;if("Enter"==t){""!=o.value&&n.rootNode.AddAttribute("start",o.value);try{i.parentNode.removeChild(i)}catch(e){}}else if("Esc"==t||"Escape"==t)try{i.parentNode.removeChild(i)}catch(e){}}),e.appendChild(t),i.appendChild(e),document.body.appendChild(i),o.focus())}},{key:"ManageDeleteTop",value:function(e){var t;null==e.parent.previous&&(t=e.parent,e.parent.parent.InsertEmptyBlockNodeBefore().Merge(e.parent,!0).SetFocus(),this.rootNode.document.DeleteNode(t),0==this.rootNode.children.length&&this.rootNode.document.DeleteNode(this.rootNode))}},{key:"ManageEnter",value:function(e){var t,n,i,o=!1;return null!=e&&null==e.parent.next&&(n=e.parent,t=!0,n.children.forEach(function(e){""!=e.text&&t&&(t=!1)}),t&&(o=!0,i="div",null!=(n=e.parent).parent.parent&&null!=n.parent.parent.GetPluginType()&&"lists"==n.parent.parent.GetPluginType()&&(i="li"),e.parent.parent.InsertEmptyBlockNodeAfter(i).Merge(e.parent,!0).SetFocus(),1==this.rootNode.children.length?this.rootNode.document.DeleteNode(this.rootNode):this.rootNode.document.DeleteNode(n))),o}},{key:"_getLastTextNode",value:function(e){var t=this,n=void 0;return e.children.forEach(function(e){e.isTextNode()&&(n=e),null!=e.children&&0<e.children.length&&(n=t._getLastTextNode(e))}),n}},{key:"_GetLastItem",value:function(){var t=this,n=void 0;return this.rootNode.children.forEach(function(e){n=t._getLastTextNode(e)}),n}},{key:"_getFirstTextNode",value:function(e){var t=this,n=void 0;return e.children.forEach(function(e){null==n&&e.isTextNode()&&(n=e),null==n&&null!=e.children&&0<e.children.length&&(n=t._getFirstTextNode(e))}),n}},{key:"_GetFirstItem",value:function(){var t=this,n=void 0;return this.rootNode.children.forEach(function(e){null==n&&(n=t._getFirstTextNode(e))}),n}},{key:"ManageDeleteFromBottom",value:function(){var e,t,n=this.rootNode.document.selectionManager.GetCurrent().startNode.parent;return n.isBlockNode()&&(e=this._GetLastItem(),t=e.parent,n.children.forEach(function(e){t.Append(e)}),this.rootNode.document.DeleteNode(n),e.SetCarretAtTheEnd()),!0}},{key:"ManageTab",value:function(e){var t={type:"numbered",isTab:!0};return"ul"==this.rootNode.tagName&&(t.type="bulleted"),e.InsertPluginAtSection("lists",t),!0}},{key:"ManageCancelFromTop",value:function(){var e,t,n=this.rootNode.document.selectionManager.GetCurrent().startNode.parent;return n.isBlockNode()&&((t=(e=this._GetFirstItem()).parent).children.forEach(function(e){n.Append(e)}),this.rootNode.document.DeleteNode(t),e.SetFocus()),!0}},{key:"ManageCancelFrombottom",value:function(e){var t,n;return null!=this.rootNode.next&&(!(t=this.rootNode.next).isBlockNode()||null!=t.GetPluginType()&&""!=t.GetPluginType()||(n=e.parent,t.children.forEach(function(e){n.Append(e)}),this.rootNode.document.DeleteNode(t),e.SetCarretAtTheEnd())),!0}},{key:"Fire",value:function(e,t,n){var i=!1;switch(e){case w.PluginActions.DELETE_TOP:i=this.ManageDeleteTop(t);break;case w.PluginActions.DELETE_FROM_BOTTOM:i=this.ManageDeleteFromBottom(t);break;case w.PluginActions.CANCEL_FROM_TOP:i=this.ManageCancelFromTop();break;case w.PluginActions.CANCEL_FROM_BOTTOM:i=this.ManageCancelFrombottom(t);break;case w.PluginActions.ENTER:i=this.ManageEnter(t);break;case w.PluginActions.TAB:i=this.ManageTab(n);break;case w.PluginActions.CLICK:break;default:return}return i}}]),s(e,t),x}();t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return b});var f=n(0);function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var r=(o(c,[{key:"draw",value:function(){this.build()}},{key:"build",value:function(){var e=this.context.createLinearGradient(0,0,this.width,0);e.addColorStop(0,"rgb(255, 0, 0)"),e.addColorStop(.15,"rgb(255, 0, 255)"),e.addColorStop(.33,"rgb(0, 0, 255)"),e.addColorStop(.49,"rgb(0, 255, 255)"),e.addColorStop(.67,"rgb(0, 255, 0)"),e.addColorStop(.84,"rgb(255, 255, 0)"),e.addColorStop(1,"rgb(255, 0, 0)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),(e=this.context.createLinearGradient(0,0,0,this.height)).addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(.5,"rgba(255, 255, 255, 0)"),e.addColorStop(.5,"rgba(0, 0, 0, 0)"),e.addColorStop(1,"rgba(0, 0, 0, 1)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),this.context.beginPath(),this.context.arc(this.pickerCircle.x,this.pickerCircle.y,this.pickerCircle.width,0,2*Math.PI),this.context.strokeStyle="#ffffff",this.context.stroke(),this.context.closePath()}},{key:"listenForEvents",value:function(){var i=this;this.canvas.addEventListener("mousemove",function(e){var t=i.canvas.getBoundingClientRect(),n=e.clientX-t.left,t=e.clientY-t.top;i.pickerCircle.x=n,i.pickerCircle.y=t,i.previewbox.style.backgroundColor=i.getPickedColor(),i.draw()}),this.canvas.addEventListener("click",function(){return i.SelectColor()})}},{key:"getPickedColor",value:function(){var e=this.context.getImageData(this.pickerCircle.x,this.pickerCircle.y,1,1);return"#"+this.fullColorHex(e.data[0],e.data[1],e.data[2])}},{key:"SelectColor",value:function(){try{this.panel.parentNode.removeChild(this.panel)}catch(e){}this.onChangeCallback(this.getPickedColor())}},{key:"rgbToHex",value:function(e){e=Number(e).toString(16);return e.length<2&&(e="0"+e),e}},{key:"fullColorHex",value:function(e,t,n){return this.rgbToHex(e)+this.rgbToHex(t)+this.rgbToHex(n)}}]),c),s=(o(l,[{key:"_parseSelectedColor",value:function(e){var t=e;return null!=e&&-1<e.toLowerCase().indexOf("rgb")&&(e=(e=e.toLowerCase()).split("(")[1].split(")")[0].split(","),t="#"+this._rgbToHex(e[0].split(" ").join(""))+this._rgbToHex(e[1].split(" ").join(""))+this._rgbToHex(e[2].split(" ").join(""))),t}},{key:"_rgbToHex",value:function(e){e=Number(e).toString(16);return e.length<2&&(e="0"+e),e}},{key:"_showColorPalette",value:function(){var t=this,n=document.createElement("div");n.style.position="absolute",n.style.zIndex="99999",n.style.border="1px solid #e1e1e1",n.style.borderRadius="2px",n.style.backgroundColor="#f9f9f9",n.style.padding="4px 4px 0px 0px",n.style.outline="none",n.setAttribute("tabindex","123");var e=this.event.srcElement.getBoundingClientRect();n.style.left=e.left+parseInt(this.addToLeft)+"px",n.style.top=parseInt(this.addToTop)+ +window.scrollY+e.height+e.top+"px";e=[];e.push(["#dfb9b1","#eecdcd","#f8e5d0","#fdf2d0","#dce9d5","#d3dfe2","#ccdaf5","#d2e1f1","#d8d2e7","#e6d2db"]),e.push(["#d08270","#de9c9b","#f2cca2","#fbe5a3","#bcd5ac","#a9c3c8","#a9c2f0","#a6c4e5","#b2a8d2","#cea8bc"]),e.push(["#bd4b31","#d16d6a","#ecb476","#ffefa1","#9dc284","#80a4ad","#779ee5","#7ba7d7","#8b7ebe","#b87f9e"]),e.push(["#982a15","#bb261a","#da944b","#eac251","#78a55a","#53808c","#4a79d1","#4f85c1","#6351a2","#9b5378"]),e.push(["#7a2817","#8c1a11","#a96324","#b89130","#48742c","#264e5b","#2657c5","#24538f","#312071","#6b2346"]);var i=document.createElement("div");i.style.display="flex",i.style.marginTop="2px",i.style.marginBottom="6px",["#000000","#39434d","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#ffffff","TRANSPARENT"].forEach(function(e){e=t._getDomCell_colorPicker(e,n);i.appendChild(e)}),n.appendChild(i),e.forEach(function(e){(i=document.createElement("div")).style.display="flex",e.forEach(function(e){e=t._getDomCell_colorPicker(e,n);i.appendChild(e)}),n.appendChild(i)});var o,e=document.createElement("div");e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.fontFamily="Arial",e.style.padding="2px 4px 2px 4px",e.style.fontSize="14px",e.style.color="#999999",e.textContent="Custom",e.addEventListener("mouseover",function(){this.style.color="#30b7e8"}),e.addEventListener("mouseout",function(){this.style.color="#999999"}),e.addEventListener("click",function(){t.pnl.style.display="none",t.ShowCustomPanel()}),n.appendChild(e),0<this.usedCustomColors.length?((o=document.createElement("div")).style.display="flex",o.style.marginTop="2px",o.style.marginBottom="0px",this.usedCustomColors.forEach(function(e){e=t._getDomCell_colorPicker(e,n);o.appendChild(e)}),n.appendChild(o)):e.style.padding="2px 4px 4px 4px",n.addEventListener("blur",function(){t.keepOnAfterSelection||this.parentNode.removeChild(this)}),document.body.appendChild(n),n.focus(),this.pnl=n}},{key:"_getDomCell_colorPicker",value:function(e){var t=this,n=e,i=this.selectedColor,o=void 0;return"TRANSPARENT"==e?((o=document.createElement("canvas")).width=13,o.height=13,o.style.border="2px solid #ffffff",o.style.margin="0px 0px 4px 4px ",o.style.borderRadius="2px",(e=o.getContext("2d")).fillStyle="#ffffff",e.fillRect(0,0,o.width,o.height),e.strokeStyle="#FF0000",e.lineWidth=2,e.beginPath(),e.moveTo(0,13),e.lineTo(13,0),e.stroke()):((o=document.createElement("div")).style.width="13px",o.style.height="13px",o.style.backgroundColor=n,o.style.margin="0px 0px 4px 4px ",o.style.borderRadius="2px",o.style.border=i==n?"2px solid #30b7e8":"2px solid "+n),o.addEventListener("mouseover",function(){this.style.cursor="pointer",this.style.border="2px solid #30b7e8"}),o.addEventListener("mouseout",function(){this.style.border=n!=i?"TRANSPARENT"==n?"2px solid #ffffff":"2px solid "+n:"2px solid #30b7e8"}),o.addEventListener("click",function(){if(t.callBack(n),!t.keepOnAfterSelection)try{t.pnl.parentNode.removeChild(t.pnl)}catch(e){}}),this.preserveFocus&&o.addEventListener("mousedown",function(e){e.preventDefault()}),o}},{key:"ShowCustomPanel",value:function(){var t=this;new r(this.pnl.style.left,this.pnl.style.top,function(e){t.usedCustomColors.indexOf(e)<0&&(t.usedCustomColors.push(e),10<t.usedCustomColors.length&&t.usedCustomColors.shift(),localStorage.setItem("usedCustomColors",JSON.stringify(t.usedCustomColors))),t.callBack(e),null===t.pnl.parentNode||t.pnl.parentNode.removeChild(t.pnl)})}}]),l);function l(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,r=5<arguments.length&&void 0!==arguments[5]&&arguments[5],s=6<arguments.length&&void 0!==arguments[6]&&arguments[6];a(this,l),this.event=e,this.callBack=t,this.preserveFocus=s,this.keepOnAfterSelection=r,this.addToLeft=n,this.addToTop=i,this.selectedColor=this._parseSelectedColor(o),this.usedCustomColors=[],"undefined"!=typeof Storage&&(this.usedCustomColors=JSON.parse(localStorage.getItem("usedCustomColors")),null==this.usedCustomColors&&(this.usedCustomColors=[])),this._showColorPalette()}function c(e,t,n){a(this,c),this.onChangeCallback=n;n=document.createElement("div");n.style.position="absolute",n.style.zIndex="99999",n.style.border="1px solid #e1e1e1",n.style.borderRadius="2px",n.style.backgroundColor="#f9f9f9",n.style.padding="4px",n.style.left=e,n.style.top=t,n.style.outline="none",n.setAttribute("tabindex","3333"),n.addEventListener("blur",function(){this.parentNode.removeChild(this)}),this.canvas=document.createElement("canvas"),this.width=200,this.height=140,this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.cursor="pointer",this.context=this.canvas.getContext("2d"),this.pickerCircle={x:10,y:10,width:7,height:7},this.draw(),n.appendChild(this.canvas),this.previewbox=document.createElement("div"),this.previewbox.style.width="200px",this.previewbox.style.height="14px",this.previewbox.style.backgroundColor="rgba(0,0,0,0)",n.appendChild(this.previewbox),this.listenForEvents(),document.body.appendChild(n),n.focus(),this.panel=n}function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var h=(u(d.prototype,[{key:"Init",value:function(){var e=this,t=document.createElement("div");t.style.backgroundColor="#ffffff",t.style.width="180px",t.style.height="264px",t.style.borderRadius="2px",t.style.boxShadow="2px 2px 5px #e3e3e3",t.style.position="fixed";var n=this.event.clientX+4,i=this.event.clientY-60;i<0&&(i=1),i+264>window.innerHeight&&(i=window.innerHeight-266),t.style.left=n+"px",t.style.top=i+"px",t.style.overflow="auto",t.style.zIndex="999";n=document.createElement("input");n.style.opacity=0,n.style.position="absolute",n.style.width="0px",n.style.height="0px",this.keepAlive=!1,n.addEventListener("blur",function(){e.exitingRightBorder||(e._removeRequestNumberPanel(),setTimeout(function(){e.keepAlive||e.destroy()},200))}),this.inputForFocus=n,t.appendChild(n);i="";1<this.table.selectedNodes.length&&(i="s"),t=this._addMenuEntry(t,"addRowAbove","Insert Row(s) Above",!0),t=this._addMenuEntry(t,"addRowBelow","Insert Row(s) Below",!0),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"addColLeft","Insert Column(s) Before",!0),t=this._addMenuEntry(t,"addColRight","Insert Column(s) After",!0),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"delRow","Delete Row"+i),t=this._addMenuEntry(t,"delCol","Delete Column"+i),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"cellBgColor","Background Color"),t=this._addMenuEntry(t,"borderColor","Border Color"),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"distributeRows","Distribute Rows"),t=this._addMenuEntry(t,"distributeCols","Distribute Columns"),document.body.appendChild(t),n.focus(),this.panel=t}},{key:"refreshFocus",value:function(){this.inputForFocus.focus()}},{key:"_addMenuEntry",value:function(e,t,n,i){var o=3<arguments.length&&void 0!==i&&i,r=this,i=document.createElement("div");return i.style.padding="6px 10px 6px 10px",i.style.fontFamily="Arial",i.style.fontSize="12px",i.style.margin="0px",i.style.cursor="pointer",i.style.backgroundColor="#ffffff",i.style.color="#828282",i.innerText=n,o?(i.addEventListener("mouseover",function(e){r.refreshFocus(),r._removeRequestNumberPanel(),this.style.backgroundColor="#FF9100",this.style.color="#ffffff",r._showRequestNumber(this,t),r.exitingRightBorder=!1}),i.addEventListener("mousemove",function(e){var t=this.getBoundingClientRect(),n=t.width,t=t.width-4;e.offsetX>=t&&e.offsetX<=n&&(r.exitingRightBorder=!0)})):(i.addEventListener("mouseover",function(e){r.exitingRightBorder=!1,this.style.backgroundColor="#FF9100",this.style.color="#ffffff"}),i.addEventListener("click",function(e){r.PerformAction(t)})),i.addEventListener("mouseout",function(e){r.exitingRightBorder||r._removeRequestNumberPanel(),this.style.backgroundColor="#ffffff",this.style.color="#828282"}),e.appendChild(i),e}},{key:"_addMenuSpace",value:function(e){var t=document.createElement("div");return t.style.height="1px",t.style.backgroundColor="#e3e3e3",e.appendChild(t),e}},{key:"_showRequestNumber",value:function(e,t){var n=this,i="Rows:";-1<t.indexOf("Col")&&(i="Cols:");var o=e.getBoundingClientRect(),e=document.createElement("div");e.style.backgroundColor="#ffffff",e.style.height=o.height+"px",e.style.borderRadius="0px 2px 2px 0px",e.style.boxShadow="2px 2px 5px #e3e3e3",e.style.display="flex",e.style.alignItems="center",e.style.zIndex="9999",e.style.fontFamily="Arial",e.style.fontSize="12px",e.style.color="#828282",e.style.position="fixed",e.style.top=o.top+"px",e.style.left=o.left+o.width+"px";o=document.createElement("div");o.style.padding="0px 4px 0px 4px",o.textContent=i,e.appendChild(o);var r=document.createElement("input");r.style.display="block",r.style.width="40px",r.style.outline="none",r.style.border="1px solid #e1e1e1",r.style.borderRadius="3px",r.style.color="#828282",r.style.fontFamily="Arial",r.style.fontSize="12px",r.value=1,r.addEventListener("click",function(e){this.select()}),e.appendChild(r);o=document.createElement("div");o.style.padding="0px 4px 0px 4px",o.style.cursor="pointer",o.style.fontWeight="bold",o.style.color="#30b7e8",o.textContent="add",o.addEventListener("click",function(e){n.PerformAction(t,r.value),n._removeRequestNumberPanel(),n.destroy()}),o.addEventListener("mouseover",function(e){this.style.color="#FF9100"}),o.addEventListener("mouseout",function(e){this.style.color="#30b7e8"}),e.appendChild(o),document.body.appendChild(e),this.additionalPnl=e}},{key:"_removeRequestNumberPanel",value:function(){null!=this.additionalPnl&&null!=this.additionalPnl.parentNode&&this.additionalPnl.parentNode.removeChild(this.additionalPnl)}},{key:"destroy",value:function(){this._removeRequestNumberPanel(),null!=this.panel.parentNode&&this.panel.parentNode.removeChild(this.panel)}},{key:"PerformAction",value:function(e,t){if(0<this.table.selectedNodes.length){var n=this.table.selectedNodes.length-1;switch(e){case"addRowAbove":if(0<t){for(;0<t;)this.AddRow("above",this.table.selectedNodes[0].parent),t--;this.table.rootNode.document.PushToHistory()}break;case"addRowBelow":if(0<t){for(;0<t;)this.AddRow("below",this.table.selectedNodes[n].parent),t--;this.table.rootNode.document.PushToHistory()}break;case"addColLeft":if(0<t){for(;0<t;)this.AddColumn("left",this.table.selectedNodes[0]),t--;this.table.rootNode.document.PushToHistory()}break;case"addColRight":if(0<t){for(;0<t;)this.AddColumn("right",this.table.selectedNodes[n]),t--;this.table.rootNode.document.PushToHistory()}break;case"delRow":this.DeleteRows(),this.table.rootNode.document.PushToHistory();break;case"delCol":this.DeleteColumns(),this.table.rootNode.document.PushToHistory();break;case"cellBgColor":this.ShowPicColorPanel();break;case"borderColor":this.ShowPicBorderColorPanel();break;case"distributeRows":this.DistributeRows(),this.table.rootNode.document.PushToHistory();break;case"distributeCols":this.DistributeCols(),this.table.rootNode.document.PushToHistory();break;case"fitToScreen":this.FitToScreen(),this.table.rootNode.document.PushToHistory();break;case"mergeCells":this.MergeCells(),this.table.rootNode.document.PushToHistory();break;default:return}}}},{key:"MergeCells",value:function(){var i=this,o=[],r=!0,s=void 0,a=void 0,n=this.table.rootNode.document,l=void 0,c=1,u=1;this.table.selectedNodes.forEach(function(e){var t=e.GetAttribute("colspan"),n=e.GetAttribute("rowspan");null!=t&&""!=t&&(c=c+t-1),null!=n&&""!=n&&(u=u+n-1),r?(l=e,s=i.table.GetCoordinatesPerNode(e.id),r=!1):(o.push(e.id),a=i.table.GetCoordinatesPerNode(e.id))});var e=a.col-s.col+c,t=a.row-s.row+u;1<e&&(l.RemoveAttribute("colspan"),l.AddAttribute("colspan",e)),1<t&&(l.RemoveAttribute("rowspan"),l.AddAttribute("rowspan",t)),this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){var t=[];e.children.forEach(function(e){o.indexOf(e.id)<0?t.push(e):n.DeleteNode(e)}),0<t.length||n.DeleteNode(e)})}),this.table.Init()}},{key:"ShowPicBorderColorPanel",value:function(){this.HideButKeepAlive();var t=this;new s(this.event,function(e){t.ChangBorderColor(e)},-20,6)}},{key:"ChangBorderColor",value:function(t){this.table.selectedNodes.forEach(function(e){e.domElement.style.border="1px double "+t}),this.table.rootNode.document.PushToHistory()}},{key:"DistributeRows",value:function(){this.table.rootNode.document;var i=this.table.rootNode.domElement.getBoundingClientRect().height;this.table.rootNode.children.forEach(function(e){var t,n;"tbody"==e.tagName.toLowerCase()&&(t=e.children.length,n=i/t,e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.style.height=n+"px"})}))})}},{key:"DistributeCols",value:function(){this.table.rootNode.document;var o=this.table.rootNode.domElement.getBoundingClientRect().width;this.table.rootNode.children.forEach(function(e){var n,i;"tbody"==e.tagName.toLowerCase()&&(n=!0,i=void 0,e.children.forEach(function(e){var t;n&&(n=!1,t=e.children.length,i=o/t),e.children.forEach(function(e){e.domElement.style.width=i+"px"})}))})}},{key:"FitToScreen",value:function(){this.table.rootNode.domElement.style.width="100%"}},{key:"HideButKeepAlive",value:function(){this.keepAlive=!0,this.panel.style.display="none"}},{key:"ShowPicColorPanel",value:function(){this.HideButKeepAlive();var t=this;new s(this.event,function(e){t.ChangCellBgColor(e)},-20,6)}},{key:"ChangCellBgColor",value:function(t){this.table.selectedNodes.forEach(function(e){e.domElement.style.backgroundColor=t}),this.table.rootNode.document.PushToHistory()}},{key:"DeleteRows",value:function(){var i=[];this.table.selectedNodes.forEach(function(e){i.indexOf(e.parent.id)<0&&i.push(e.parent.id)});var o=this.table.rootNode.document;this.table.rootNode.children.forEach(function(t){var n;"tbody"==t.tagName.toLowerCase()&&(n=[],t.children.forEach(function(e){i.indexOf(e.id)<0?n.push(e):o.DeleteNode(e)}),t.children=[],n.forEach(function(e){t.Append(e)}))}),this.table.Init()}},{key:"DeleteColumns",value:function(){var n=[];this.table.selectedNodes.forEach(function(e){n.push(e.id)});var i=[];this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){var t=0;e.children.forEach(function(e){n.indexOf(e.id)<0||n.indexOf(t)<0&&i.push(parseInt(t)),t++})})});var o=this.table.rootNode.document;this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){var t=0;e.children.forEach(function(e){i.indexOf(t)<0||o.DeleteNode(e),t++})})}),this.table.Init()}},{key:"AddRow",value:function(i,o){var r=b.AddRow(o.document,this.table.numberOfColumns,o.GetFirstTextNode().nodeStyle).tr;this.table.rootNode.children.forEach(function(t){var n;"tbody"==t.tagName.toLowerCase()&&(n=[],t.children.forEach(function(e){e.id==o.id?"above"==i?(n.push(r),n.push(e)):"below"==i&&(n.push(e),n.push(r)):n.push(e)}),t.children=[],n.forEach(function(e){t.Append(e)}))}),this.table.Init()}},{key:"AddColumn",value:function(i,o){var r=o.GetFirstTextNode().nodeStyle,s=void 0,a=!1;this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(t){var n=0;t.children.forEach(function(e){e.id==o.id&&("left"==i?s=parseInt(n):"right"==i&&(s=parseInt(n+1)),s==t.children.length&&(a=!0)),n++})})}),this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(n){var i=0;n.children.forEach(function(e){var t=!1;(s==i||a&&i==n.children.length-1)&&(t=!0),t&&(t=b.AddCell(o.document,r).td,n.Append(t,s)),i++})})}),this.table.Init()}}]),d);function d(e,t,n){!function(e){if(!(e instanceof d))throw new TypeError("Cannot call a class as a function")}(this),this.table=e,this.td=t,this.event=n,this.additionalPnl=void 0,this.inputForFocus=void 0,this.Init()}function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function g(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function m(e,t,n){return t&&g(e.prototype,t),n&&g(e,n),e}function v(e,t){return(v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var b=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}(d,f.Plugin);var i,o,t=(i=d,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=y(i),n=this;return!(t=o?(e=y(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==p(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function d(e){return function(e){if(!(e instanceof d))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e)).isMouseDown=!1,e.isMouseOnRightBorder=!1,e.isMouseOnBottomBorder=!1,e.currentColResizing=void 0,e.currentRowResizing=void 0,e.startNode=void 0,e.endNode=void 0,e.selectedNodes=[],e.numberOfRows=0,e.numberOfColumns=0,e.cellsResized=!1,e.readOnly=e.rootNode.document.readOnly,e.InitializeDomElements(),e}return m(d,null,[{key:"GetName",value:function(){return"table"}}]),m(d,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#345-23")):this.readOnly||this.Init()}},{key:"Init",value:function(){var t=this;function e(e){t.isMouseDown&&(t.isMouseOnRightBorder?t.ResizeColumn(e):t.isMouseOnBottomBorder&&t.ResizeRow(e))}this.coordinatesPerNode=new Array,this.nodePerCoordinates=new Array;var n=0,i=0;function o(e){0==e.button&&(t.isMouseDown=!1)}this.rootNode.parent.domElement.removeEventListener("mousemove",e),this.rootNode.parent.domElement.addEventListener("mousemove",e),this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){i=0,e.children.forEach(function(e){t.InitCell(e.domElement,n,i),null==t.coordinatesPerNode[n]&&(t.coordinatesPerNode[n]=new Array),t.coordinatesPerNode[n][i]=e,t.nodePerCoordinates[e.id]={col:i,row:n},i++}),n++})}),this.numberOfRows=n,this.numberOfColumns=i,document.body.removeEventListener("mouseup",o),document.body.addEventListener("mouseup",o)}},{key:"InitCell",value:function(e,l,c){function t(e){0==u.selectedNodes.length?u.SelectCell(l,c,!0):1==u.selectedNodes.length&&u.SelectCell(l,c,!1),u.OpenSettingsPanel(this,e),e.preventDefault(),e.stopPropagation()}function n(e){var t,n,i,o,r,s,a;0==e.button&&(u.isMouseDown?u.isMouseOnRightBorder||u.isMouseOnBottomBorder||(t=(o=u.startNode.domElement.getBoundingClientRect()).height,s=o.width,n=o.top,a=o.left,i=e.pageY+window.scrollY,o=e.pageX+window.scrollX,n<i&&i<n+t&&a<o&&o<a+s||(window.getSelection&&document.createRange?(r=window.getSelection()).empty?r.empty():r.removeAllRanges&&r.removeAllRanges():document.selection&&(r=document.selection.createRange()).empty(),u.SelectOnDrag(l,c),e.preventDefault())):(s=(a=this.getBoundingClientRect()).width,r=a.width-6,e.offsetX>=r&&e.offsetX<=s?(u.isMouseOnRightBorder=!0,u.currentColResizing=c,this.style.cursor="col-resize"):(u.isMouseOnRightBorder=!1,u.currentColResizing=void 0,this.style.cursor="auto"),u.isMouseOnRightBorder||(s=a.height,a=a.height-6,e.offsetY>=a&&e.offsetY<=s?(u.isMouseOnBottomBorder=!0,u.currentRowResizing=l,this.style.cursor="row-resize"):(u.isMouseOnBottomBorder=!1,u.currentRowResizing=void 0,this.style.cursor="auto"))))}function i(e){0==e.button&&(u.cellsResized&&(u.cellsResized=!1,u.PushToHistory()),u.isMouseDown=!1,u.endNode=u.GetNodeFromDom(this),u.endNode.row=l,u.endNode.col=c)}var u=this;e.removeEventListener("contextmenu",t),e.addEventListener("contextmenu",t),e.removeEventListener("mousedown",t),e.addEventListener("mousedown",function(e){u.prevX=e.pageX+window.scrollX,u.prevY=e.pageY+window.scrollY,0==e.button&&(u.DeselectAll(),u.isMouseDown=!0,u.startNode=u.GetNodeFromDom(this),u.startNode.row=l,u.startNode.col=c,u.endNode=void 0,u.SelectCell(l,c,!1))}),e.removeEventListener("mousemove",n),e.addEventListener("mousemove",n),e.removeEventListener("mouseup",i),e.addEventListener("mouseup",i)}},{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"GetCoordinatesPerNode",value:function(e){return this.nodePerCoordinates[e]}},{key:"GetNodePerCoordinates",value:function(e,t){return this.coordinatesPerNode[e][t]}},{key:"GetTableDimensions",value:function(){var e={cols:0,rows:0},t=0,n=0;return this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){0==t&&e.children.forEach(function(e){t++}),n++})}),e.cols=t,e.rows=n,e}},{key:"ResizeRow",value:function(o){var e,t,r,s,a;null!=this.currentRowResizing&&(window.getSelection&&document.createRange?(e=window.getSelection()).empty?e.empty():e.removeAllRanges&&e.removeAllRanges():document.selection&&(e=document.selection.createRange()).empty(),s=!(t=0),a=0,(r=this).rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&(t=0,e.children.forEach(function(e){t==r.currentRowResizing&&e.children.forEach(function(e){var t,n,i;s&&(t=e.domElement.getBoundingClientRect(),i=(n=o.pageY)-r.prevY,a=t.height+i,r.prevY=n,s=!1),e.domElement.style.height=a+"px",r.cellsResized=!0}),t++}))}))}},{key:"ResizeColumn",value:function(o){var e,r,s,a,l,c,u;null!=this.currentColResizing&&(window.getSelection&&document.createRange?(e=window.getSelection()).empty?e.empty():e.removeAllRanges&&e.removeAllRanges():document.selection&&(e=document.selection.createRange()).empty(),c=l=r=0,u=!(a=!0),(s=this).rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){var t,n,i;r==s.currentColResizing&&(a&&(t=e.domElement.getBoundingClientRect(),n=(i=o.pageX+window.scrollX)-s.prevX,l=t.width+n,s.prevX=i,null!=e.next&&(u=!0,i=e.next.domElement.getBoundingClientRect(),c=i.width-n),a=!1),e.domElement.style.width=l+"px",u&&null!=e.next&&(e.next.domElement.style.width=c+"px"),s.cellsResized=!0),r++})})}))}},{key:"SelectCell",value:function(t,n,e){null!=e&&0!=e||this.DeselectAll();var i=0,o=0,r=this;this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){o=0,e.children.forEach(function(e){i==t&&o==n&&(e.domElement.className="commaTableCellSelected",r.selectedNodes.push(e)),o++}),i++})})}},{key:"DeselectAll",value:function(){this.selectedNodes=[],null!=this.rootNode&&this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.className="commaTableCell"})})})}},{key:"SelectOnDrag",value:function(t,n){var i,o,r,s,a,l,e=0,c=null==this.endNode?(e=this.startNode.row,this.startNode.col):(e=this.endNode.row,this.endNode.col);e==t&&c==n||(this.DeselectAll(),i=this.startNode.row,o=this.startNode.col,r=i<=t&&o<=n?"right":t<=i&&o<n?"topRight":i<=t&&n<=o?"bottomLeft":"left",a=s=0,(l=this).rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){a=0,e.children.forEach(function(e){"right"==r?i<=s&&s<=t&&o<=a&&a<=n&&l.SelectCell(s,a,!0):"left"==r?t<=s&&s<=i&&n<=a&&a<=o&&l.SelectCell(s,a,!0):"topRight"==r?s<=i&&t<=s&&o<=a&&a<=n&&l.SelectCell(s,a,!0):"bottomLeft"==r&&i<=s&&s<=t&&a<=o&&n<=a&&l.SelectCell(s,a,!0),a++}),s++})}))}},{key:"OpenSettingsPanel",value:function(e,t){this.CloseSettingsPanel(),this.cellSettingsPanel=new h(this,e,t)}},{key:"CloseSettingsPanel",value:function(){null!=this.cellSettingsPanel&&this.cellSettingsPanel.destroy()}},{key:"GetNodeFromDom",value:function(e){e=e.getAttribute("cm-id");return this.rootNode.document.GetNodeById(e)}},{key:"ApplyStyleOnSelectedLines",value:function(t,n){this.selectedNodes.forEach(function(e){e.children.forEach(function(e){e.isBlockNode()&&e.ToggleStyle(t,n,!0)})})}},{key:"_applyToTextNodes",value:function(e,t,n){var i;e.isTextNode()&&e.ToggleStyle(t,n,!0),null!=e.children&&(i=this,e.children.forEach(function(e){i._applyToTextNodes(e,t,n)}))}},{key:"ApplyStyleOnSelectedCells",value:function(t,n){var i=this;this.selectedNodes.forEach(function(e){i._applyToTextNodes(e,t,n)})}},{key:"DeleteContentOfSelectedCells",value:function(e){var e=0<arguments.length&&void 0!==e&&e,n=this.rootNode.document,i=void 0;this.selectedNodes.forEach(function(e){var t;e.children[0].children.forEach(function(e){t=e.nodeStyle.Copy(),n.DeleteNode(e,!1,!0,t)}),i=e.GetFirstTextNode()}),e&&null!=i&&i.SetFocus()}},{key:"_fintTDContainer",value:function(e){return null!=e.parent?"td"==e.parent.tagName?e.parent:this._fintTDContainer(e.parent):void 0}},{key:"MoveToNextCell",value:function(){var e=this.rootNode.document.GetNodeAtCursor();!e.isTextNode()||null!=(e=this._fintTDContainer(e))&&(null!=e.next?e.next.GetFirstTextNode().SetFocus():null!=e.parent&&(null!=e.parent.next?e.parent.next.children[0].GetFirstTextNode().SetFocus():null!=this.rootNode.next&&this.rootNode.next.GetFirstTextNode().SetFocus()))}},{key:"SelectAll",value:function(){this.DeselectAll();var t=0,n=0,i=this;this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){n=0,e.children.forEach(function(e){i.SelectCell(t,n,!0),n++}),t++})})}},{key:"AddSelectedCellsToClipboard",value:function(e){var t=0<arguments.length&&void 0!==e&&e,n=this.rootNode.document,e=f.BlockNode.CreateNew(n,"table");e.SetAttributes([{name:"class",value:"commaTable"}]),e.SetPluginType(this.rootNode.GetPluginType());var i=f.BlockNode.CreateNew(n,"tbody"),o=this,r=void 0,s=void 0;this.selectedNodes.forEach(function(e){var t=o.GetCoordinatesPerNode(e.id);s!=t.row&&(null!=r&&i.Append(r),s=t.row,r=f.BlockNode.CreateNew(n,"tr")),r.Append(e.Copy())}),null!=r&&i.Append(r),e.Append(i),t&&this.DeleteContentOfSelectedCells(),this.rootNode.document.ForceClipboardContent(e.domElement)}},{key:"PasteCells",value:function(e){var t,i,o,n=!1,r=this,s=(new DOMParser).parseFromString(e,"text/html").body.firstElementChild;return null==s||null!=(e=[].slice.call(s.getElementsByTagName("tr")))&&0<e.length&&(n=!0,s=this.selectedNodes[0],t=this.GetCoordinatesPerNode(s.id),i=this.GetTableDimensions(),o=t.row,e.forEach(function(e){var n=t.col;[].slice.call(e.getElementsByTagName("td")).forEach(function(e){var t;o<i.rows&&n<i.cols&&null!=(t=r.GetNodePerCoordinates(o,n))&&t.GetFirstTextNode().ForceTextContent(e.textContent.toString()),n++}),o++})),n&&this.PushToHistory(),n}},{key:"Fire",value:function(e,t,n,i){var o=JSON.parse(JSON.stringify(e));e==f.PluginActions.NEW_CHAR_ADDED&&"Backspace"==i.key&&1<this.selectedNodes.length&&(o=f.PluginActions.DELETE);var r=!1;switch(o){case f.PluginActions.LOST_FOCUS:this.CloseSettingsPanel(),this.DeselectAll();break;case f.PluginActions.BEFORE_PASTE:var s=i.clipboardData.getData("text/html");null!=s&&""!=s||(s=i.clipboardData.getData("text")),r=this.PasteCells(s);break;case f.PluginActions.BEFORE_COPY:var a=!0;1==this.selectedNodes.length&&(this.rootNode.document.selectionManager.IsCollapsed()?a=!0:(l=this.selectedNodes[0].domElement.textContent,null!=window.getSelection()&&(a=window.getSelection().toString()==l))),a&&(this.AddSelectedCellsToClipboard(),r=!0);break;case f.PluginActions.BEFORE_CUT:var l=!0;1==this.selectedNodes.length&&(this.rootNode.document.selectionManager.IsCollapsed()?l=!0:(a=this.selectedNodes[0].domElement.textContent,null!=window.getSelection()&&(l=window.getSelection().toString()==a))),l&&(this.AddSelectedCellsToClipboard(!0),r=!0);break;case f.PluginActions.SELECT_ALL:1==this.selectedNodes.length&&this.selectedNodes[0].SelectWholeTextContent(),r=!0;break;case f.PluginActions.APPLY_STYLE_ON_LINE:null==t&&this.ApplyStyleOnSelectedLines(i.styleName,i.value);break;case f.PluginActions.APPLY_STYLE_ON_TEXT:null==t&&this.ApplyStyleOnSelectedCells(i.styleName,i.value);break;case f.PluginActions.DELETE:this.DeleteContentOfSelectedCells(!0),r=!0;break;case f.PluginActions.CANCEL_FROM_TOP:r=!0;break;case f.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),r=!1;break;case f.PluginActions.TAB:this.MoveToNextCell(),r=!0;break;default:return this.CloseSettingsPanel(),r}return r}}],[{key:"AddRow",value:function(e,t,n){null==n&&(n=new f.NodeStyle);for(var i=f.BlockNode.CreateNew(e,"tr"),o=0,r=void 0;o<t;){var s=d.AddCell(e,n);null==r&&(r=s.nodeForFocus),i.Append(s.td),o++}return{tr:i,nodeForFocus:r}}},{key:"AddCell",value:function(e,t){var n=f.BlockNode.CreateNew(e,"td");n.SetAttributes([{name:"class",value:"commaTableCell"}]);var i=f.BlockNode.CreateNew(e,"div"),t=f.TextNode.CreateNew(e,"span","",t.Copy());return i.Append(t),n.Append(i),{td:n,nodeForFocus:t}}},{key:"CreateNew",value:function(e,t){var n=e.GetStyleAtCurrentCursorPosition(),i=new f.NodeStyle(e,n.nodeStyle),o=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("table");o.SetAttributes([{name:"class",value:"commaTable"}]);for(var r=f.BlockNode.CreateNew(e,"tbody"),s=t.rows,a=void 0,l=0;l<s;){var c=d.AddRow(e,t.cols,i);null==a&&(a=c.nodeForFocus),r.Append(c.tr),l++}o.Append(r);var u=o.InsertEmptyBlockNodeAfter("div"),n=f.TextNode.CreateNew(e,"span","",i.Copy());u.Append(n);var h=new d(o);return setTimeout(function(){a.SetFocus(),h.SelectCell(0,0)},100),h}},{key:"GetTagToParseOnPaste",value:function(){return["table"]}},{key:"CreateNewFromPastedNode",value:function(o,e){var t=f.BlockNode.CreateNew(o,"table");t.SetAttributes([{name:"class",value:"commaTable"}]);var r=f.BlockNode.CreateNew(o,"tbody");return null==e||null!=(e=[].slice.call(e.getElementsByTagName("tr")))&&e.forEach(function(e){var t=[].slice.call(e.getElementsByTagName("td"));0==t.length&&(t=[].slice.call(e.getElementsByTagName("th")));var n=d.AddRow(o,t.length,o.GetDefaultNodeStyle().Copy()).tr,i=0;t.forEach(function(e){n.children[i].GetFirstTextNode().ForceTextContent(e.textContent.toString()),i++}),r.Append(n)}),t.Append(r),new d(t)}}]),d}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var a=n(0);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(s,a.Plugin);var i,o,t=(i=s,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=u(i),n=this;return!(t=o?(e=u(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==r(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function s(e){return function(e){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}(this),t.call(this,e)}return l(s,null,[{key:"GetName",value:function(){return"horizontalRule"}}]),l(s,null,[{key:"CreateNew",value:function(e){var t=e.GetStyleAtCurrentCursorPosition();e.DeleteSelection();var n=e.GetNodeAtCursor().GetBlockContainer(),i=n.InsertEmptyBlockNodeAfter(n.tagName),o=a.TextNode.CreateNew(e,"span","",new a.NodeStyle(e,t.nodeStyle));i.Append(o),i.ToggleStyle("horizontalRule",void 0,!0);var r=new s(i),n=i.InsertEmptyBlockNodeAfter(n.tagName),o=a.TextNode.CreateNew(e,"span","",new a.NodeStyle(e,t.nodeStyle));return n.Append(o),n=n.InsertEmptyBlockNodeAfter(n.tagName),o=a.TextNode.CreateNew(e,"span","",new a.NodeStyle(e,t.nodeStyle)),n.Append(o),o.SetFocus(),r}}]),s}();t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return o});var f=n(0);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(r,f.Plugin);var i,o,t=(i=r,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=c(i),n=this;return!(t=o?(e=c(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==s(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function r(e){return function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e)).readOnly=e.rootNode.document.readOnly,e.InitializeDomElements(),e}return a(r,null,[{key:"GetName",value:function(){return"tasks"}}]),a(r,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#345-23")):this.readOnly||this.Init()}},{key:"Init",value:function(){0==this.rootNode.children.length&&this.rootNode.document.DeleteNode(this.rootNode)}},{key:"ManageEnter",value:function(e,t){var n,i,o=!1;return""==e.text&&(o=this.isLineEmpty(e)),null==e.next&&o?(n=!1,o=[],null==e.previous.previous.previous?n=!0:(o.push(e.previous.previous.previous.id),e.previous.previous.previous.Delete()),o.push(e.previous.previous.id),e.previous.previous.Delete(),o.push(e.previous.id),e.previous.Delete(),o.push(e.id),e.Delete(),this.DeleteNodes(o),i=void 0,null==this.rootNode.next?(o=this.rootNode.InsertEmptyBlockNodeAfter("div"),e=f.TextNode.CreateNew(this.rootNode.document,"span","",e.nodeStyle.Copy()),o.Append(e),i=e):this.rootNode.next.children.forEach(function(e){null==i&&e.isTextNode()&&(i=e)}),n&&(this.rootNode.Delete(!0),t.DeletePluginInstance(this)),i.SetFocus()):this.rootNode.document.InsertPluginAtSection("tasks"),!0}},{key:"GetWholeLine",value:function(t){var n=[],i=!1,o=!1;return this.rootNode.children.forEach(function(e){"br"==e.tagName&&(o?i=!0:n=[]),i||n.push(e),e.id==t.id&&(o=!0)}),n}},{key:"isLineEmpty",value:function(t){var n=!1,i=!0;return this.rootNode.children.forEach(function(e){"br"==e.tagName?n||(i=!0):e.isTextNode()&&(""==e.text||n||(i=!1),e.id==t.id&&(n=!0))}),i}},{key:"DeleteNodes",value:function(t){var n=[];this.rootNode.children.forEach(function(e){t.indexOf(e.id)<0?n.push(e):null!=e.previous&&(e.previous.next=void 0)}),this.rootNode.children=n}},{key:"DeleteTask_onBackspace",value:function(e,t){var n,i,o,r,s,a,l,c,u,h,d;null!=e.previous.previous?(n=[],i=e.previous.previous.previous,n.push(e.previous.previous.id),e.previous.previous.Delete(),n.push(e.previous.id),e.previous.Delete(),n.push(e.id),e.Delete(),e.next.isTextNode()&&""==e.next.text&&(n.push(e.next.id),e.next.Delete()),this.DeleteNodes(n),i.SetFocusAtTheEnd()):(i=!1,o=[],this.isLineEmpty(e.next)?(d=this.GetWholeLine(e.next),r=[],s=void 0,d.forEach(function(e){s=e.next,r.push(e.id),e.Delete()}),null==s?i=!0:"br"==s.tagName&&(r.push(s.id),s.Delete()),this.DeleteNodes(r)):(h=this.GetWholeLine(e.next),l=!(a=[]),c=void 0,h.forEach(function(e){c=e.next,l?o.push(e):("i"==e.tagName&&(l=!0),a.push(e.id),e.Delete())}),null==c?i=!0:"br"==c.tagName&&(a.push(c.id),c.Delete()),this.DeleteNodes(a)),d=void 0,d=null!=this.rootNode.previous?(u=this,o.forEach(function(e){u.rootNode.previous.Append(e)}),this.rootNode.previous.GetLastTextNode()):(h=this.rootNode.InsertEmptyBlockNodeBefore("div"),e=f.TextNode.CreateNew(h.document,"span","",e.nodeStyle.Copy()),h.Append(e),e),i&&(this.rootNode.Delete(!0),t.DeletePluginInstance(this)),d.SetFocusAtTheEnd())}},{key:"DeleteTask_onCancel",value:function(t){var n=[],i=!1,o=void 0;this.rootNode.children.forEach(function(e){e.id==t.id?(i=!0,n.push(e.id),e.Delete()):i&&(n.push(e.id),e.Delete(),"i"==e.tagName&&(i=!1,o=e.next))}),this.DeleteNodes(n),o.SetFocus()}},{key:"ToggleCheck",value:function(e){"i"==e.tagName&&((e=e.domElement).classList.contains("fa-square-o")?(e.classList.remove("fa-square-o"),e.classList.add("fa-check-square-o")):(e.classList.remove("fa-check-square-o"),e.classList.add("fa-square-o")),this.rootNode.document.RestoreCursorPositionBeforeClick(),this.rootNode.document.PushToHistory())}},{key:"VerifyHtml",value:function(){var t=!1;this.rootNode.children.map(function(e){"i"==e.tagName&&(t=!0)}),t||this.rootNode.document.RemovePluginInstance(this.id)}},{key:"_getLastTextNode",value:function(e){var t=this,n=void 0;return e.children.forEach(function(e){e.isTextNode()&&(n=e),null!=e.children&&0<e.children.length&&(n=t._getLastTextNode(e))}),n}},{key:"_GetLastItem",value:function(){var t=this,n=void 0;return this.rootNode.children.forEach(function(e){n=t._getLastTextNode(e)}),n}},{key:"Fire",value:function(e,t,n){var i=!1;switch(e){case f.PluginActions.NODE_UNREGISTERED:this.VerifyHtml();break;case f.PluginActions.DELETE:var o=this;setTimeout(function(){var t=[];o.rootNode.children.forEach(function(e){null==document.querySelector('[cm-id="'+e.id+'"]')&&(t.push(e.id),e.Delete())}),o.DeleteNodes(t)});break;case f.PluginActions.NODE_DELETE:this.DeleteNodes([t.id]);break;case f.PluginActions.DELETE_TOP:i=!0;break;case f.PluginActions.DELETE_FROM_BOTTOM:i=!1;break;case f.PluginActions.CANCEL_FROM_TOP:case f.PluginActions.CANCEL_FROM_BOTTOM:i=!0;break;case f.PluginActions.ENTER:i=this.ManageEnter(t,n);break;case f.PluginActions.DELETE_BEFORE_INLINE:this.DeleteTask_onBackspace(t,n),i=!0;break;case f.PluginActions.CANCEL_BEFORE_INLINE:this.DeleteTask_onCancel(t,n),i=!0;break;case f.PluginActions.CLICK:this.ToggleCheck(t);break;default:return}return i}}],[{key:"CreateNew",value:function(e){var t=e.GetStyleAtCurrentCursorPosition(),n=new f.NodeStyle(e,t.nodeStyle),t=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("div"),i=f.InlineNode.CreateNew(e,"i","",void 0,[{name:"class",value:"fa fa-square-o commaTask"},{name:"contentEditable",value:!1}]);t.Append(i);t=new r(t);return i.next.ApplyNodeStyle(n.Copy()),setTimeout(function(){i.next.SetFocus()}),t}}]),r}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return o});var h=n(0);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(u,h.Plugin);var i,o,t=(i=u,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=l(i),n=this;return!(t=o?(e=l(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==r(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function u(e){return function(e){if(!(e instanceof u))throw new TypeError("Cannot call a class as a function")}(this),t.call(this,e)}return s(u,null,[{key:"GetName",value:function(){return"multiColumns"}}]),s(u,[{key:"Fire",value:function(e,t,n){var i=!1;switch(e){case h.PluginActions.CANCEL_FROM_TOP:i=!0;break;case h.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),i=!1;break;default:return}return i}}],[{key:"AddRow",value:function(e,t,n){null==n&&(n=new h.NodeStyle);for(var i=h.BlockNode.CreateNew(e,"tr"),o=0,r=void 0;o<t;){var s=u.AddCell(e,n);null==r&&(r=s.nodeForFocus),i.Append(s.td),o++}return{tr:i,nodeForFocus:r}}},{key:"AddCell",value:function(e,t){var n=h.BlockNode.CreateNew(e,"td");n.SetAttributes([{name:"class",value:"commaParagraphColumn"}]);var i=h.BlockNode.CreateNew(e,"div"),t=h.TextNode.CreateNew(e,"span","",t.Copy());return i.Append(t),n.Append(i),{td:n,nodeForFocus:t}}},{key:"CreateNew",value:function(e,t){var n=e.GetStyleAtCurrentCursorPosition(),i=new h.NodeStyle(e,n.nodeStyle),o=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("table");o.SetAttributes([{name:"class",value:"commaColumnsContainer"}]);var r=h.BlockNode.CreateNew(e,"tbody"),s=2;null!=t.cols&&0<t.cols&&(s=t.cols);for(var a=void 0,l=0;l<1;){var c=u.AddRow(e,s,i);null==a&&(a=c.nodeForFocus),r.Append(c.tr),l++}o.Append(r);n=o.InsertEmptyBlockNodeAfter("div"),t=h.TextNode.CreateNew(e,"span","",i.Copy());n.Append(t);o=new u(o);return setTimeout(function(){a.SetFocus()},20),o}}]),u}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(module,exports,__webpack_require__){var GSb;window,GSb=function(__WEBPACK_EXTERNAL_MODULE__0__){return d=[function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE__0__},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}n.d(t,"a",function(){return l});var a=(r(h,[{key:"_replaceAll",value:function(e,t,n){return e.replace(new RegExp(t,"g"),n)}},{key:"patternToString",value:function(e){var t="";return"YYYY"==e?t=this.date.getFullYear():"YY"==e?t=this.date.getFullYear().toString().substring(2):"MMMM"==e?t=this.months[this.date.getMonth()]:"MMM"==e?t=this.monthsShort[this.date.getMonth()]:"MM"==e?t=(t=parseInt(this.date.getMonth())+1)<10?"0"+t:t.toString():"M"==e?t=parseInt(this.date.getMonth())+1:"DD"==e?t=(t=this.date.getDate())<10?"0"+t:t.toString():"D"==e?t=this.date.getDate():"EE"==e?t=this.daysOfTheWeek[this.date.getDay()]:"E"==e&&(t=this.daysOfTheWeekShort[this.date.getDay()]),t}},{key:"toString",value:function(t){var n=this,i=0;this.patterns.forEach(function(e){-1<t.indexOf(e)&&(t=n._replaceAll(t,e,"#"+i+"#")),i++});var o="";return t.split("#").forEach(function(e){var t;""!=e&&(t=parseInt(e),isNaN(t)?o+=e:o+=n.patternToString(n.patterns[t]))}),o}}],[{key:"fromString",value:function(e,t,n){var i=1<arguments.length&&void 0!==t&&t,o=2<arguments.length&&void 0!==n?n:"en",r=e.split(" ")[0].split("/");return r.length<2&&(r=e.split(" ")[0].split("-")),r.length<2?void 0:(t=parseInt(r[0]),n=parseInt(r[1]),e=parseInt(r[2]),"en"==o||"??"==o&&(t=parseInt(r[1]),n=parseInt(r[0]),e=parseInt(r[2])),i&&(i=new Date,isNaN(t)&&(t=i.getMonth()+1),isNaN(n)&&(n=i.getDate()),isNaN(e)&&(e=i.getFullYear())),isNaN(t)||isNaN(n)||isNaN(e)?void 0:(e<100&&(e=2e3+e),new h(new Date(t+"/"+n+"/"+e))))}}]),h),s=(r(u,[{key:"Destroy",value:function(){this.panel.parentNode.removeChild(this.panel)}},{key:"VerifyAnPrepareFormat",value:function(){var e=!1;return null!=this.format&&""!=this.format&&("text"==this.format.type?e=!0:"number"==this.format.type?null==this.format.params.precision||""==this.format.params.precision?e=!(this.errorBox.textContent="Decimal places cannot be empty"):l.isNumber(this.format.params.precision)?(e=!0,delete this.format.params.dateFormat):e=!(this.errorBox.textContent="Decimal places must be a number"):"date"==this.format.type&&(e=null!=this.format.params.dateFormat&&""!=this.format.params.dateFormat||!(this.errorBox.textContent="Select date format"),delete this.format.params.precision)),e}},{key:"Apply",value:function(){var t,n,i=this;this.VerifyAnPrepareFormat()&&(t=JSON.stringify(this.format),n=void 0,this.spreadsheet.selectedNodes.forEach(function(e){n=e,"text"==i.format.type?(e.children.forEach(function(e){e.isBlockNode()&&e.ToggleStyle("align","left",!0)}),e.domElement.removeAttribute("cell-format")):(e.children.forEach(function(e){e.isBlockNode()&&e.ToggleStyle("align","right",!0)}),e.domElement.setAttribute("cell-format",t)),l.Format(e)}),null!=n&&n.GetFirstTextNode().SetFocus(),this.panel.parentNode.removeChild(this.panel))}},{key:"_initNavPanel",value:function(){var n=this,e=document.createElement("div");function t(e){e.style.color="#FF9100"}function i(e,t){t==n.format.type?e.style.color="#666666":e.style.color="#ffffff"}function o(e,t){t!=n.format.type&&("number"==n.format.type?(n.numberNavBtn.style.color="#ffffff",n.numberNavBtn.style.backgroundColor="#666666"):"date"==n.format.type?(n.dateNavBtn.style.color="#ffffff",n.dateNavBtn.style.backgroundColor="#666666"):"text"==n.format.type&&(n.textNavBtn.style.color="#ffffff",n.textNavBtn.style.backgroundColor="#666666"),n.format.type=t,e.style.color="#666666",e.style.backgroundColor="#ffffff","number"==n.format.type?(n.numbersOptionsPnl.style.display="block",n.dateOptionsPnl.style.display="none",n.textOptionsPnl.style.display="none"):"date"==n.format.type?(n.numbersOptionsPnl.style.display="none",n.dateOptionsPnl.style.display="block",n.textOptionsPnl.style.display="none"):"text"==n.format.type&&(n.numbersOptionsPnl.style.display="none",n.dateOptionsPnl.style.display="none",n.textOptionsPnl.style.display="block"))}e.style="width:90px;height:300px;background-color:#666666;box-sizing:border-box;padding:20px 0px 10px 10px;";var r="color:#ffffff;font-size:14px;cursor:pointer;margin-bottom:2px;background-color:#666666;padding:6px;border-radius: 6px 0px 0px 6px;",s=document.createElement("div");s.style=r,s.textContent="Number",s.addEventListener("mouseover",function(){t(this)}),s.addEventListener("mouseout",function(){i(this,"number")}),s.addEventListener("click",function(){o(this,"number")}),this.numberNavBtn=s,e.appendChild(s);s=document.createElement("div");s.style=r,s.textContent="Date",s.addEventListener("mouseover",function(){t(this)}),s.addEventListener("mouseout",function(){i(this,"date")}),s.addEventListener("click",function(){o(this,"date")}),this.dateNavBtn=s,e.appendChild(s);s=document.createElement("div");return s.style=r,s.textContent="Text",s.addEventListener("mouseover",function(){t(this)}),s.addEventListener("mouseout",function(){i(this,"text")}),s.addEventListener("click",function(){o(this,"text")}),this.textNavBtn=s,e.appendChild(s),"number"==this.format.type?(this.numberNavBtn.style.color="#666666",this.numberNavBtn.style.backgroundColor="#ffffff"):"date"==this.format.type?(this.dateNavBtn.style.color="#666666",this.dateNavBtn.style.backgroundColor="#ffffff"):"text"==this.format.type&&(this.textNavBtn.style.color="#666666",this.textNavBtn.style.backgroundColor="#ffffff"),e}},{key:"_initOptionsPanel",value:function(){var n=this,e=document.createElement("div");e.style="height:230px;overflow:auto;box-sizing:border-box;";var t="display:none;overflow:auto;padding:10px 20px 20px 20px;",i=document.createElement("div");i.style=t;var o=document.createElement("div");o.style="display:flex;justify-content:flex-start;align-items:center;";var r=document.createElement("div");r.style="font-size:14px;color:#39434d;margin-right:10px;",r.textContent="Decimal places: ",o.appendChild(r);var s=document.createElement("input");s.style="display: block;padding:4px;font-size:14px;color:#39434d;border:1px solid #e3e3e3;border-radius:4px;width:30px;",s.value=this.format.params.precision,s.addEventListener("keyup",function(){n.format.params.precision=s.value}),o.appendChild(s),i.appendChild(o),this.numbersOptionsPnl=i,e.appendChild(i);o=document.createElement("div");o.style=t;i=document.createElement("div");i.style="font-size:14px;color:#39434d;margin-bottom:4px;",i.textContent="Date Format:",o.appendChild(i);var a=document.createElement("select");a.size="5",a.style="display: block;padding:6px;font-size:12px;color:#39434d;border:1px solid #e3e3e3;border-radius:4px;width:200px;",this.availableDateFormats.forEach(function(e){var t=document.createElement("option");n.format.params.dateFormat==e.format&&t.setAttribute("selected",""),t.value=e.format,t.textContent=e.label,a.appendChild(t)}),a.addEventListener("change",function(){n.format.params.dateFormat=n.availableDateFormats[a.selectedIndex].format}),o.appendChild(a),this.dateOptionsPnl=o,e.appendChild(o);o=document.createElement("div");o.style=t;t=document.createElement("div");return t.style="font-size:14px;color:#39434d;",t.textContent="Text format cells are treated as text even when a number is in the cell. The cell is displayed exactly as entered.",o.appendChild(t),this.textOptionsPnl=o,e.appendChild(o),"number"==this.format.type?this.numbersOptionsPnl.style.display="block":"date"==this.format.type?this.dateOptionsPnl.style.display="block":"text"==this.format.type&&(this.textOptionsPnl.style.display="block"),e}},{key:"Show",value:function(){var e=this,t=document.createElement("div");t.style="z-index: 99999999999;position:fixed;display:flex;background-color:rgba(33, 33, 33, 0.5);top:0px;left:0px;width:100vw;height:100vh;justify-content:center;align-items:center;";var n=document.createElement("div");n.style="font-family:Arial;width:500px;height:300px;display:flex;justify-content:center;align-items:center;border-radius:6px;overflow:hidden;",n.appendChild(this._initNavPanel());var i=document.createElement("div");i.style="height:300px;background-color:#ffffff;flex:1;box-sizing:border-box;";var o=document.createElement("div");o.style="display:flex;justify-content:center;align-items:center;padding:6px;";var r=document.createElement("div");r.style="flex:1",o.appendChild(r);var s=document.createElement("i");s.style="color:#666666;font-size:20px;cursor:pointer",s.setAttribute("class","fa fa-times"),s.addEventListener("mouseover",function(){s.style.color="#FF9100"}),s.addEventListener("mouseout",function(){s.style.color="#666666"}),s.addEventListener("click",function(){e.Destroy()}),o.appendChild(s),i.appendChild(o),i.appendChild(this._initOptionsPanel());r=document.createElement("div");r.style="display:flex;justify-content:center;align-items:center;padding:6px;";o=document.createElement("div");o.style="flex:1;font-size:12px;color:#f04f4f;",o.textContent="",this.errorBox=o,r.appendChild(o);var a=document.createElement("div");a.style="color:#ffffff;font-size:14px;cursor:pointer;background-color: #30b7e8;padding:4px 8px 4px 8px;border-radius:4px;",a.textContent="Apply",a.addEventListener("mouseover",function(){a.style.backgroundColor="#FF9100"}),a.addEventListener("mouseout",function(){a.style.backgroundColor="#30b7e8"}),a.addEventListener("click",function(){e.Apply()}),r.appendChild(a),i.appendChild(r),n.appendChild(i),t.appendChild(n),document.body.appendChild(t),this.panel=t}}]),u),l=(r(c,null,[{key:"isNumber",value:function(e){var t=e;return"-"==e[0]&&(t=e.replace("-","")),"."!=e[e.length-1]&&/^[0-9.]*$/.test(t)}},{key:"Format",value:function(e,t){var n,i,o,r=1<arguments.length&&void 0!==t&&t,s=e.domElement.getAttribute("cell-format");r&&((n=e.document.GetCursorPosition()).startOffset,n.endOffset),null!=s&&""!=s&&("number"==(s=JSON.parse(s)).type?null==(t=s.params.precision)||""==t||""!=(n=(i=e.GetFirstTextNode()).domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""))&&(t=parseInt(t),o="",c.isNumber(n)&&(o=Number.parseFloat(n).toFixed(t)),n.toString()!=o.toString()&&(i.ForceTextContent(o.toString()),r&&i.SelectText(void 0,void 0))):"date"!=s.type||null!=(o=s.params.dateFormat)&&""!=o&&(""==(s=(i=e.GetFirstTextNode()).domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""))||null!=(e=a.fromString(s,!0))&&(o=e.toString(o),s.toString()!=o.toString()&&(i.ForceTextContent(o.toString()),r&&i.SelectText(void 0,void 0)))))}},{key:"OpenFormatDialog",value:function(e){new s(e)}}]),c);function c(){i(this,c)}function u(e){i(this,u),this.spreadsheet=e,this.availableDateFormats=[{format:"D-MMM",label:"1-Dec"},{format:"D-MMM-YYYY",label:"1-Dec-2019"},{format:"D-MMM-YY",label:"1-Dec-19"},{format:"MM/DD/YYYY",label:"12/01/2019"},{format:"MM/DD/YY",label:"12/01/19"},{format:"MM-DD-YYYY",label:"12-01-2019"},{format:"MM-DD-YY",label:"12-01-19"},{format:"MMM D, YYYY",label:"Dec 1, 2019"},{format:"MMM D, YY",label:"Dec 1, 19"},{format:"MMMM D, YYYY",label:"December 1, 2019"},{format:"D MMMM, YYYY",label:"1 December, 2019"},{format:"D MMMM, YYYY",label:"1 December 2019"},{format:"EE, MMMM D, YY",label:"Sunday, December 1, 19"},{format:"E, MMMM D, YY",label:"Sun, December 1, 19"}],this.format={type:"number"};var t,e={precision:2,dateFormat:""};0<this.spreadsheet.selectedNodes.length&&null!=(t=this.spreadsheet.selectedNodes[0].domElement.getAttribute("cell-format"))&&""!=t&&(this.format=JSON.parse(t),"number"==this.format.type?e.precision=this.format.params.precision:"date"==this.format.type?e.dateFormat=this.format.params.dateFormat:this.format.type),this.format.params=e,this.Show()}function h(e){i(this,h),this.date=e,this.patterns=["YYYY","YY","MMMM","MMM","MM","M","DD","D","EE","E"],this.months=["January","February","March","April","May","June","July","August","September","October","November","December"],this.monthsShort=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],this.daysOfTheWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],this.daysOfTheWeekShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",function(){return FunctionsManager});var _CellFormatter__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1);function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var CommaMath=(_createClass(bVb,null,[{key:"isFunction",value:function(e){return!(["sum","sin","cos","round","pow","sqrt","abs","ceil","floor","min","max","exp","ln","log","avg","count","stdev","concatenate","len"].indexOf(e.toLowerCase())<0)}},{key:"getFunctionType",value:function(e){return"concatenate"==e?"string":"number"}},{key:"getFunctionName",value:function(e){var t="";return"sum"==(e=e.toLowerCase())?t="sum":"sin"==e?t="sin":"cos"==e?t="cos":"round"==e?t="round":"pow"==e?t="pow":"sqrt"==e?t="sqrt":"abs"==e?t="abs":"ceil"==e?t="ceil":"floor"==e?t="floor":"min"==e?t="min":"max"==e?t="max":"exp"==e?t="exp":"ln"==e?t="ln":"log"==e?t="log":"avg"==e?t="avg":"count"==e?t="count":"stdev"==e||"stdev"==e?t="stDev":"concatenate"==e?t="concatenate":"len"==e&&(t="len"),t}},{key:"isNumber",value:function(e){var t=e;return"-"==e[0]&&(t=e.replace("-","")),/^[0-9.]*$/.test(t)}},{key:"concatenate",value:function(e){var t="";return e.forEach(function(e){null!=e&&(t+=e)}),t}},{key:"len",value:function(e){return null==e&&(e=""),bVb.isNumber(e)&&(e=e.toString()),e.length}},{key:"stDev",value:function(e){var t=e;if(!Array.isArray(e)){t=[];for(var n=0;n<arguments.length;n++){var i=arguments[n];null!=i&&t.push(parseFloat(i))}}var o=bVb.avg(t),e=t.map(function(e){e=parseFloat(e)-o;return e*e}),e=bVb.avg(e);return Math.sqrt(e)}},{key:"count",value:function(e){var t=e;return Array.isArray(e)||(t=arguments),t.length}},{key:"sum",value:function(e){var t=e;Array.isArray(e)||(t=arguments);for(var n=0,i=0;i<t.length;i++){var o=t[i];null!=o&&(n+=parseFloat(o))}return n}},{key:"avg",value:function(e){var t=e;Array.isArray(e)||(t=arguments);for(var n=0,i=0;i<t.length;i++){var o=t[i];null!=o&&(n+=parseFloat(o))}return n/t.length}},{key:"sin",value:function(e){return Math.sin(parseFloat(e))}},{key:"cos",value:function(e){return Math.cos(parseFloat(e))}},{key:"atan",value:function(e){return Math.atan(parseFloat(e))}},{key:"round",value:function(e,t){return e=parseFloat(e),t=parseFloat(t),Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"pow",value:function(e,t){return Math.pow(parseFloat(e),parseFloat(t))}},{key:"floor",value:function(e){return Math.floor(parseFloat(e))}},{key:"ceil",value:function(e){return Math.ceil(parseFloat(e))}},{key:"sqrt",value:function(e){return Math.sqrt(parseFloat(e))}},{key:"abs",value:function(e){return Math.abs(parseFloat(e))}},{key:"min",value:function(e){var t=e;return Array.isArray(e)||(t=arguments),Math.min.apply(Math,_toConsumableArray(t))}},{key:"max",value:function(e){return Math.max.apply(Math,_toConsumableArray(e))}},{key:"exp",value:function(e){return Math.exp(parseFloat(e))}},{key:"ln",value:function(e){return Math.log(parseFloat(e))}},{key:"log",value:function(e){return Math.log10(parseFloat(e))}},{key:"_CreateEntryInfoPanel",value:function(t,n,e,i,o){var r=document.createElement("div");r.setAttribute("class","cscfe_info_pnl_entry");var s=document.createElement("div");s.setAttribute("class","cscfe_info_pnl_entry_label"),s.textContent=e,r.appendChild(s);s=document.createElement("div");return s.setAttribute("class","cscfe_info_pnl_entry_description"),s.innerHTML=o,r.appendChild(s),r.addEventListener("click",function(e){n.SetCommaMathFunction(i),t.style.display="none"}),r}},{key:"GetInfoPanel",value:function(e){var t=document.createElement("div");t.setAttribute("class","cscfe_info_pnl_container");var n=document.createElement("div");n.setAttribute("class","cscfe_info_pnl");var i=document.createElement("div");i.setAttribute("class","cscfe_info_pnl_header");var o=document.createElement("div");o.setAttribute("class","cscfe_info_pnl_header_title"),o.textContent="Available Functions",i.appendChild(o);o=document.createElement("i");o.setAttribute("class","fa fa-times cscfe_info_pnl_closeBtn"),o.addEventListener("click",function(e){t.style.display="none"}),i.appendChild(o),n.appendChild(i);o=document.createElement("div");o.style.display="flex";i=document.createElement("div");i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Sum","SUM()","Adds all the numbers in a range of cells.<br>Syntax: SUM(number1, number2,...) or SUM(D1:D5)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Round","ROUND()","Rounds a number to a specific number of digits.<br>Syntax: ROUND(number, numOfDigits) or ROUND(A1,B2)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Pow","POW()","Returns the result of a number (base) raised to a power (exponent).<br>Syntax: POW(base, exponent) or POW(A1,B2)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Sqrt","SQRT()","Returns the square root of a number.<br>Syntax: SQRT(number) or SQRT(A1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Abs","ABS()","Returns the absolute value of a number.<br>Syntax: ABS(number) or ABS(A1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Ceil","CEIL()","Rounds a number up to the next largest whole number or integer.<br>Syntax: CEIL(number) or CEIL(A1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Floor","FLOOR()","Returns the largest integer less than or equal to a given number.<br>Syntax: FLOOR(number) or FLOOR(A1)")),o.appendChild(i);i=document.createElement("div");i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Min","MIN()","Returns the lowest-valued number passed into it.<br>Syntax: MIN(number1, number2,...) or MIN(D1:D5)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Max","MAX()","Returns the largest number passed into it.<br>Syntax: MAX(number1, number2,...) or MAX(D1:D5)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Exp","EXP()","Returns <code>e<sup>x</sup></code>, where x is the argument, and e is Euler's number.<br>Syntax: EXP(number1) or EXP(D1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Ln","LN()","Returns the natural logarithm (base e) of a number.<br>Syntax: LN(number1) or LN(D1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Log","LOG()","Returns the natural logarithm (base 10) of a number.<br>Syntax: LOG(number1) or LOG(D1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Avg","AVG()","Returns the average (arythmetic mean) of its arguments.<br>Syntax: AVG(number1, number2,...) or AVG(D1:D5)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Standard Deviation","STDEV()","Returns the standard deviation of its arguments.<br>Syntax: STDEV(number1, number2,...) or STDEV(D1:D5)")),o.appendChild(i);i=document.createElement("div");return i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Count","COUNT(","Returns the number of its arguments.<br>Syntax: COUNT(number1, number2,...) or COUNT(D1:D5)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Sin","SIN()","Returns the sine of a number.<br>Syntax: SIN(number) or SIN(D1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Cos","COS()","Returns the cosine of a number.<br>Syntax: COS(number) or COS(D1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Atan","ATAN()","Returns the arctangent (in radians) of a number.<br>Syntax: ATAN(number) or ATAN(D1)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Concatenate","CONCATENATE()","Returns a string that concatenates all the strings passed as arguments.<br>Syntax: CONCATENATE(string1, string2, ....) or CONCATENATE(D1:D5)")),i.appendChild(bVb._CreateEntryInfoPanel(t,e,"Len","LEN()","Returns the number of characters in a string.<br>Syntax: LEN(string) or LEN(D1)")),o.appendChild(i),n.appendChild(o),t.appendChild(n),document.body.appendChild(t),t}}]),bVb),FunctionsManager=function(){function FunctionsManager(e){_classCallCheck(this,FunctionsManager),this.spreadsheet=e,this.input=void 0,this.currentTd=void 0,this.currentFunction=[],this.classesToHighlightCells=["cscfe_highlight_cell_one","cscfe_highlight_cell_two","cscfe_highlight_cell_three","cscfe_highlight_cell_four","cscfe_highlight_cell_five","cscfe_highlight_cell_six"],this.useHighlightClass=-1,this.precision=5,this.cellAffects={},this.labelInitialized=!1,this.inputInitialized=!1}return _createClass(FunctionsManager,[{key:"Reset",value:function(){this.cellAffects={},this.useHighlightClass=-1,this.precision=5,this.currentTd=void 0,this.currentFunction=[]}},{key:"SetPrecision",value:function(e){null==e&&(e=5),this.precision=parseInt(e)}},{key:"_round",value:function(e){return Number(Math.round(e+"e"+this.precision)+"e-"+this.precision)}},{key:"SetFxLabelNode",value:function(e){var t;this.labelInitialized||(this.labelInitialized=!0,this.fxLabel=e,null==(t=this).f_click&&(this.f_click=function(e){null==t.fxInfoPanel&&(t.fxInfoPanel=CommaMath.GetInfoPanel(t)),t.fxInfoPanel.style.display="flex"}),this.fxLabel.domElement.removeEventListener("click",this.f_click),this.fxLabel.domElement.addEventListener("click",this.f_click))}},{key:"SetInputNode",value:function(e){var t;this.inputInitialized||(this.inputInitialized=!0,this.input=e,null==(t=this).f_keyup&&(this.f_keyup=function(e){t.FunctionEdited(e)}),this.input.domElement.removeEventListener("keyup",this.f_keyup),this.input.domElement.addEventListener("keyup",this.f_keyup),null==this.f_mousedown&&(this.f_mousedown=function(e){t.spreadsheet.StartFunctionEditing()}),this.input.domElement.removeEventListener("mousedown",this.f_mousedown),this.input.domElement.addEventListener("mousedown",this.f_mousedown))}},{key:"GetCurrentCell",value:function(){return this.currentTd}},{key:"GetIdCurrentCell",value:function(){var e=void 0;return null!=this.currentTd&&(e=this.currentTd.id),e}},{key:"SetEditingCell",value:function(e){this.HideInputError(),this.currentTd=e,this.currentFunction=JSON.parse(e.domElement.getAttribute("cell-function")),this.originalFunction=this.currentFunction,this.input.domElement.value=this.FunctionJsonToString(),this.currentCellCoordinates=this.spreadsheet.GetCoordinatesPerNode(this.currentTd.id),this.HighlightAllRanges()}},{key:"StartEditingCell",value:function(e){this.HideInputError(),""==this.input.domElement.value?(this.input.domElement.value="=",this.currentFunction=this.StringToFunctionJson(this.input.domElement.value)):this.currentFunction=JSON.parse(e.domElement.getAttribute("cell-function")),this.input.domElement.focus(),this.currentTd=e,this.originalFunction=this.currentFunction,this.currentCellCoordinates=this.spreadsheet.GetCoordinatesPerNode(this.currentTd.id),this.HighlightAllRanges()}},{key:"StopEditingCell",value:function(){null!=this.input&&(this.input.domElement.value=""),this.currentTd=void 0}},{key:"FunctionEdited",value:function(e){e=e.key;"Esc"==e||"Escape"==e?(this.input.domElement.value="",this.spreadsheet.StopFunctionEditing(!0)):"Enter"==e?(this.currentTd.domElement.setAttribute("cell-function",JSON.stringify(this.currentFunction)),this.TrackCell(this.currentTd,this.currentCellCoordinates.row,this.currentCellCoordinates.col),this.spreadsheet.StopFunctionEditing(!0)):(this.DehighlightAllRanges(),this.currentFunction=this.StringToFunctionJson(this.input.domElement.value,this.currentCellCoordinates),this.HighlightAllRanges(),this.EvalFunctionPerNode(this.currentTd,this.currentCellCoordinates,this.currentFunction))}},{key:"EvalFunctionPerNode",value:function EvalFunctionPerNode(tdCell,currentCellCoordinates,currentFunction){var skipPushToHistory=3<arguments.length&&void 0!==arguments[3]&&arguments[3];if(this.noCircularReference(currentCellCoordinates))this.showCircularError||(this.ShowInputError(),this.showCircularError=!0,alert("Formula cannot be calculated: cell references in the formula refer to the formula's result, creating a circular reference."));else{this.showCircularError=!1;var tn=tdCell.GetFirstTextNode(),nv=void 0;try{nv=eval(this.GetStringForEval(tdCell,currentCellCoordinates,currentFunction)),this.HideInputError()}catch(e){this.ShowInputError()}null==nv&&(nv=""),tn.ForceTextContent(nv.toString()),_CellFormatter__WEBPACK_IMPORTED_MODULE_0__.a.Format(tdCell),this.CellValueChanged(tdCell,skipPushToHistory)}}},{key:"HideInputError",value:function(){this.input.domElement.classList.remove("functionWithErrors")}},{key:"ShowInputError",value:function(){this.input.domElement.classList.add("functionWithErrors")}},{key:"_insertBeforeCursor",value:function(e,t){e.setRangeText?e.setRangeText(t):(e.focus(),document.execCommand("insertText",!1,t))}},{key:"_insertAtCursor",value:function(e,t){var n,i;document.selection?(e.focus(),sel=document.selection.createRange(),sel.text=t):e.selectionStart||"0"==e.selectionStart?(n=e.selectionStart,i=e.selectionEnd,e.value=e.value.substring(0,n)+t+e.value.substring(i,e.value.length)):e.value+=t}},{key:"_moveCursorBackOne",value:function(){var e,t=this.input.domElement;null!=t&&((e=t.selectionStart-1)<0&&(e=0),t.setSelectionRange?(t.focus(),t.setSelectionRange(e,e)):t.createTextRange&&((t=t.createTextRange()).collapse(!0),t.moveEnd("character",e),t.moveStart("character",e),t.select()))}},{key:"SetCommaMathFunction",value:function(e){null==this.currentTd&&1==this.spreadsheet.selectedNodes.length&&this.spreadsheet.StartFunctionEditing(this.spreadsheet.selectedNodes[0]),this._insertAtCursor(this.input.domElement,e),this._moveCursorBackOne(),this.currentFunction=this.StringToFunctionJson(this.input.domElement.value,this.currentCellCoordinates)}},{key:"noCircularReference",value:function(e,t){var n,i=1<arguments.length&&void 0!==t?t:void 0,o=!1;return null==i&&(i=e.row+"#"+e.col),null!=this.cellAffects&&null!=this.cellAffects[e.row]&&null!=this.cellAffects[e.row][e.col]&&(-1<(e=this.cellAffects[e.row][e.col]).indexOf(i)?o=!0:(n=this,e.forEach(function(e){o||(e={row:(e=e.split("#"))[0],col:e[1]},o=n.noCircularReference(e,i))}))),o}},{key:"GetRangeValue",value:function(e,t){var n,i=e.r1c1,o=i.isColAbsolute?i.col:t.col+parseInt(i.col),r=i.isRowAbsolute?parseInt(i.row)-1:t.row+parseInt(i.row)-1;return"range"==i.type?(e=0,e=i.toCell.isColAbsolute?parseInt(i.toCell.col):t.col+parseInt(i.toCell.col),n=i.toCell.isRowAbsolute?parseInt(i.toCell.row)-1:t.row+parseInt(i.toCell.row)-1,this.spreadsheet.GetValues(r,o,n,e)):this.spreadsheet.GetValue(r,o)}},{key:"_prepareValue",value:function(e,t){return e&&"string"==typeof t&&(""==(t=t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""))?t=0:t.match(/[a-zA-Z]/i)&&(t='"'+t+'"')),t}},{key:"GetStringForEval",value:function(e,i,t){var o=this,r="";null==t&&(t=[]);var s=!0,n=!1,a="";return t.forEach(function(e){var t;"space"!=e.type&&("function"==e.type?(a=e.value.toLowerCase(),"string"==CommaMath.getFunctionType(e.value.toLowerCase())&&(n=!(s=!1))):"range"==e.type?s&&""==a&&(t=o.GetRangeValue(e,i),Array.isArray(t)?t.forEach(function(e){"string"==typeof o._prepareValue(s,e)&&(s=!1)}):"string"==typeof o._prepareValue(s,t)&&(s=!1)):"value"==e.type?""!=e.value&&(t=parseFloat(e.value),CommaMath.isNumber(t)||(s=!1)):"operator"==e.type&&")"==e.value&&(a=""))}),t.forEach(function(e){var t,n;"space"!=e.type&&("function"==e.type?r=r+"CommaMath."+CommaMath.getFunctionName(e.value):"range"==e.type?(t=o.GetRangeValue(e,i),Array.isArray(t)?(n=[],t.forEach(function(e){n.push(o._prepareValue(s,e))}),r+=JSON.stringify(n)):r+=o._prepareValue(s,t)):"value"==e.type?r+=o._prepareValue(s,e.value):r+=e.value)}),s&&""!=r?r="this._round("+r+")":n||(r="'"+r+"'"),r}},{key:"FunctionJsonToString",value:function(){var t="";return null!=this.currentFunction&&this.currentFunction.forEach(function(e){t+=e.value}),t}},{key:"GetFunctionFromDomNode",value:function(e){return e.getAttribute("cell-function")}},{key:"CopyFunctionToNode",value:function(e,t){var r,s,a;null!=e&&""!=e&&(r=this.spreadsheet.GetCoordinatesPerNode(t.id),s=this.spreadsheet.GetNumberOfColumns(),a=this.spreadsheet.GetNumberOfRows(),(e=JSON.parse(e)).forEach(function(e){var t,n,i,o;"range"==e.type&&(o="",o=(t=e.r1c1).isColAbsolute?"$"+FunctionsManager.toColumnName(t.col):(n=r.col+parseInt(t.col),s<n&&(t.col=s-r.col,n=r.col+parseInt(t.col)),FunctionsManager.toColumnName(n)),t.isRowAbsolute?o+="$"+t.row:(n=r.row+parseInt(t.row),a<n&&(t.row=a-r.row,n=r.row+parseInt(t.row)),o+=n),"range"==t.type&&(t.toCell.isColAbsolute?o+=":$"+FunctionsManager.toColumnName(t.toCell.col):(i=r.col+parseInt(t.toCell.col),s<i&&(t.toCell.col=s-r.col,i=r.col+parseInt(t.toCell.col)),o+=":"+FunctionsManager.toColumnName(i)),t.toCell.isRowAbsolute?o+="$"+t.toCell.row:(i=r.row+parseInt(t.toCell.row),a<i&&(t.toCell.row=a-r.row,i=r.row+parseInt(t.toCell.row)),o+=i)),e.value=o)}),t.domElement.setAttribute("cell-function",JSON.stringify(e)),this.TrackCell(t,r.row,r.col),this.EvalFunctionPerNode(t,r,e))}},{key:"StringToFunctionJson",value:function(e,t){for(var n=[],i="",o="",r=!1,s=0;s<e.length;s++){var a=e[s],l=parseInt(a);" "!=a&&"="!=a?CommaMath.isNumber(l)?r?o+=a:i+=a:"+"==a||"-"==a||"*"==a||"/"==a||"("==a||")"==a||"%"==a||","==a||"."==a?(""!=i?(n.push({type:"value",value:i}),i=""):""!=o&&(CommaMath.isFunction(o.toLowerCase())?n.push({type:"function",value:o}):n.push({type:"range",value:o}),o=""),n.push({type:"operator",value:a}),r=!1):"$"==a||":"==a?(o+=a,r=!0):a.match(/[a-zA-Z]/i)&&(o+=a.toUpperCase(),r=!0):n.push({type:"space",value:a})}""!=i?n.push({type:"value",value:i}):""!=o&&n.push({type:"range",value:o});var c=this;return n.forEach(function(e){"range"==e.type&&(e.r1c1=c.stringToR1C1(e.value,t))}),n}},{key:"stringToR1C1",value:function(e,t){for(var n,i,o=void 0,r=!1,s="",a="",l=!1,c=!1,u=0;u<e.length;u++){var h=e[u],d=parseInt(h);CommaMath.isNumber(d)?(a+=h,r=r&&!(c=!0)):":"==h?(d=l?this.colNameToNumber(s):this.colNameToNumber(s)-t.col,o={type:"single",isColAbsolute:l,isRowAbsolute:c,row:c?parseInt(a):parseInt(a)-t.row,col:d},a=s="",c=l=r=!1):"$"==h?r=!0:h.match(/[a-zA-Z]/i)&&(s+=h,r=r&&!(l=!0))}return null!=o?(0,i=l?this.colNameToNumber(s):this.colNameToNumber(s)-t.col,n=c?parseInt(a):parseInt(a)-t.row,o.type="range",o.toCell={isColAbsolute:l,isRowAbsolute:c,row:n,col:i}):(i=l?this.colNameToNumber(s):this.colNameToNumber(s)-t.col,o={type:"single",isColAbsolute:l,isRowAbsolute:c,row:c?parseInt(a):parseInt(a)-t.row,col:i}),o}},{key:"GetNextHighlightColor",value:function(){return this.useHighlightClass++,this.useHighlightClass>this.classesToHighlightCells.length-1&&(this.useHighlightClass=0),this.classesToHighlightCells[this.useHighlightClass]}},{key:"StartSelectingCells",value:function(){return this.currentRange={},this.GetNextHighlightColor()}},{key:"DehighlightAllRanges",value:function(){var t;null!=this.currentFunction&&(t=this).currentFunction.forEach(function(e){"range"==e.type&&t.ToggleRange(!1,e,t.currentCellCoordinates)})}},{key:"HighlightAllRanges",value:function(){var t;this.useHighlightClass=0,null!=this.currentFunction&&(t=this).currentFunction.forEach(function(e){"range"==e.type&&t.ToggleRange(!0,e,t.currentCellCoordinates)})}},{key:"ToggleRange",value:function(e,t,n,i){var o=t.r1c1,r=0,s=0,a=void 0,l=void 0,c=!1;null!=i&&(c=!0,s=(u=i.r1c1).isColAbsolute?u.col:n.col+parseInt(u.col),r=u.isRowAbsolute?parseInt(u.row)-1:n.row+parseInt(u.row)-1,"range"==u.type&&(l=u.toCell.isColAbsolute?parseInt(u.toCell.col):n.col+parseInt(u.toCell.col),a=u.toCell.isRowAbsolute?parseInt(u.toCell.row)-1:n.row+parseInt(u.toCell.row)-1));var u,t=0,h=o.isColAbsolute?o.col:n.col+parseInt(o.col),t=o.isRowAbsolute?parseInt(o.row)-1:n.row+parseInt(o.row)-1;"range"==o.type?(i=0,u=o.toCell.isColAbsolute?parseInt(o.toCell.col):n.col+parseInt(o.toCell.col),i=o.toCell.isRowAbsolute?parseInt(o.toCell.row)-1:n.row+parseInt(o.toCell.row)-1,CommaMath.isNumber(t)&&CommaMath.isNumber(i)&&(e?this.spreadsheet.SelectRangeForFunctionEditing(t,h,i,u,this.GetNextHighlightColor()):this.spreadsheet.DeselectRangeForFunctionEditing(t,h,i,u,c,r,s,a,l))):CommaMath.isNumber(t)&&(e?this.spreadsheet.SelectRangeForFunctionEditing(t,h,void 0,void 0,this.GetNextHighlightColor()):this.spreadsheet.DeselectRangeForFunctionEditing(t,h,void 0,void 0,c,r,s,a,l))}},{key:"ClearCurrentRange",value:function(){this.currentRange={}}},{key:"AddCell",value:function(e,t){null==this.currentRange[e]&&(this.currentRange[e]=new Array),this.currentRange[e][t]=!0}},{key:"colNameToNumber",value:function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n=0,i=0,o=e.length-1;i<e.length;i+=1,--o)n+=Math.pow(t.length,o)*(t.indexOf(e[i])+1);return n}},{key:"addRangeToCurrentFunction",value:function(e){var t={type:"range",value:e,r1c1:this.stringToR1C1(e,this.currentCellCoordinates)};null==this.currentFunction&&(this.currentFunction=[]);var e=this.currentFunction[this.currentFunction.length-1];null!=e&&"range"==e.type&&(e=this.currentFunction.pop(),this.ToggleRange(!1,e,this.currentCellCoordinates,t)),this.currentFunction.push(t)}},{key:"DoneSelectingCells",value:function(){var e,t="",n=!0,i="";for(e in this.currentRange)if(this.currentRange.hasOwnProperty(e))for(var o in this.currentRange[e])this.currentRange[e].hasOwnProperty(o)&&(n?(n=!1,t=FunctionsManager.toColumnName(o)+(parseInt(e)+1)):i=FunctionsManager.toColumnName(o)+(parseInt(e)+1));""!=i&&(i=":"+i);var r,s=this.currentFunction[this.currentFunction.length-1];null!=s&&"range"==s.type&&(r=this.currentFunction.pop(),s=this.input.domElement.value.lastIndexOf(r.value),this.input.domElement.value=this.input.domElement.value.substring(0,s),this.ToggleRange(!1,r,this.currentCellCoordinates)),this._insertAtCursor(this.input.domElement,t+i),this.DehighlightAllRanges(),this.currentFunction=this.StringToFunctionJson(this.input.domElement.value,this.currentCellCoordinates),this.HighlightAllRanges(),this.EvalFunctionPerNode(this.currentTd,this.currentCellCoordinates,this.currentFunction)}},{key:"RecalculateAll",value:function(){var i=this;this.spreadsheet.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){var t=i.spreadsheet.GetCoordinatesPerNode(e.id),n=JSON.parse(e.domElement.getAttribute("cell-function"));null!=n&&i.EvalFunctionPerNode(e,t,n,!0)})})})}},{key:"CellValueChanged",value:function(e,t){var n=this.spreadsheet.GetCoordinatesPerNode(e.id),e=n.row,n=n.col,n=this.GetAffectedCells(e,n),i=this;n.forEach(function(e){e.row=parseInt(e.row),e.col=parseInt(e.col);var t=i.spreadsheet.GetNodePerCoordinates(e.row,e.col),n=JSON.parse(t.domElement.getAttribute("cell-function"));null!=n&&i.EvalFunctionPerNode(t,e,n)})}},{key:"GetAffectedCells",value:function(e,t){var n=[];return null!=this.cellAffects&&null!=this.cellAffects[e]&&null!=this.cellAffects[e][t]&&this.cellAffects[e][t].forEach(function(e){e=e.split("#");n.push({row:e[0],col:e[1]})}),n}},{key:"TrackCell",value:function(e,a,l){var c;null!=e.domElement.getAttribute("cell-function")&&(e=JSON.parse(e.domElement.getAttribute("cell-function")),null==(c=this).cellAffects&&(c.cellAffects={}),Object.keys(c.cellAffects).forEach(function(n){var e=c.cellAffects[n];Object.keys(e).forEach(function(e){var t;-1<c.cellAffects[n][e].indexOf(a+"#"+l)&&(t=[],c.cellAffects[n][e].forEach(function(e){e!=a+"#"+l&&t.push(e)}),c.cellAffects[n][e]=t)})}),e.forEach(function(e){if("range"==e.type){var t,n,i=e.r1c1,e=0,o=i.isColAbsolute?i.col:l+parseInt(i.col),e=i.isRowAbsolute?parseInt(i.row)-1:a+parseInt(i.row)-1;if("range"==i.type){n=i.toCell.isColAbsolute?parseInt(i.toCell.col):l+parseInt(i.toCell.col),t=i.toCell.isRowAbsolute?parseInt(i.toCell.row)-1:a+parseInt(i.toCell.row)-1;for(var r=e;r<=t;){for(var s=o;s<=n;)null==c.cellAffects[r]&&(c.cellAffects[r]={},c.cellAffects[r][s]=[]),null==c.cellAffects[r][s]&&(c.cellAffects[r][s]=[]),c.cellAffects[r][s].indexOf(a+"#"+l)<0&&c.cellAffects[r][s].push(a+"#"+l),s++;r++}}else null==c.cellAffects[e]&&(c.cellAffects[e]={},c.cellAffects[e][o]=[]),null==c.cellAffects[e][o]&&(c.cellAffects[e][o]=[]),c.cellAffects[e][o].indexOf(a+"#"+l)<0&&c.cellAffects[e][o].push(a+"#"+l)}}))}}],[{key:"toColumnName",value:function(e){for(var t="",n=1,i=26;0<=(e-=n);n=i,i*=26)t=String.fromCharCode(parseInt(e%i/n)+65)+t;return t}},{key:"RemoveFunction",value:function(e){e.domElement.removeAttribute("cell-function")}},{key:"AdjustAllRowsOnInsert",value:function(e,t,r){var s,a,n=JSON.parse(e.domElement.getAttribute("cell-function"));null!=n&&(s=t.GetCoordinatesPerNode(e.id),a=s.row,s.row>=r&&(a=s.row+1),n.forEach(function(e){var t,n,i,o;"range"==e.type&&((t=e.r1c1).row=parseInt(t.row),t.col=parseInt(t.col),n="",n=t.isColAbsolute?"$"+FunctionsManager.toColumnName(t.col):(i=s.col+t.col,FunctionsManager.toColumnName(i)),t.isRowAbsolute?n+="$"+t.row:(i=s.row+t.row-1,s.row>=r&&i<r?t.row=t.row-1:s.row<r&&r<=i&&(t.row=t.row+1),n+=a+t.row),"range"==t.type&&(t.toCell.isColAbsolute?n+=":$"+FunctionsManager.toColumnName(t.toCell.col):(o=s.col+parseInt(t.toCell.col),n+=":"+FunctionsManager.toColumnName(o)),t.toCell.isRowAbsolute?n+="$"+t.toCell.row:(o=s.row+t.toCell.row-1,s.row>=r&&o<r?t.toCell.row=t.toCell.row-1:s.row<r&&r<=o&&(t.toCell.row=t.toCell.row+1),n+=a+t.toCell.row)),e.value=n)}),e.domElement.setAttribute("cell-function",JSON.stringify(n)))}},{key:"AdjustAllRowsOnDelete",value:function(e,t,n){var a,i=JSON.parse(e.domElement.getAttribute("cell-function"));null!=i&&(a=t.GetCoordinatesPerNode(e.id),n.forEach(function(r){var s;r!=a.row&&(s=a.row,a.row>r&&(s=a.row-1),i.forEach(function(e){var t,n,i,o;"range"==e.type&&((t=e.r1c1).row=parseInt(t.row),t.col=parseInt(t.col),n="",n=t.isColAbsolute?"$"+FunctionsManager.toColumnName(t.col):(i=a.col+t.col,FunctionsManager.toColumnName(i)),t.isRowAbsolute?n+="$"+t.row:(i=a.row+t.row-1,a.row>=r&&i<r?t.row=t.row+1:a.row<r&&r<=i&&(t.row=t.row-1),n+=s+t.row),"range"==t.type&&(t.toCell.isColAbsolute?n+=":$"+FunctionsManager.toColumnName(t.toCell.col):(o=a.col+parseInt(t.toCell.col),n+=":"+FunctionsManager.toColumnName(o)),t.toCell.isRowAbsolute?n+="$"+t.toCell.row:(o=a.row+t.toCell.row-1,a.row>=r&&o<r?t.toCell.row=t.toCell.row+1:a.row<r&&r<=o&&(t.toCell.row=t.toCell.row-1),n+=s+t.toCell.row)),e.value=n)}),a.row=s)}),e.domElement.setAttribute("cell-function",JSON.stringify(i)))}},{key:"AdjustAllColsOnInsert",value:function(e,t,o){var r,s,n=JSON.parse(e.domElement.getAttribute("cell-function"));null!=n&&(r=t.GetCoordinatesPerNode(e.id),s=r.col,r.col>=o&&(s=r.col+1),n.forEach(function(e){var t,n,i;"range"==e.type&&((t=e.r1c1).row=parseInt(t.row),t.col=parseInt(t.col),n="",t.isColAbsolute?n="$"+FunctionsManager.toColumnName(t.col):(i=r.col+t.col,r.col>=o&&i<o?t.col=t.col-1:r.col<o&&o<=i&&(t.col=t.col+1),n+=FunctionsManager.toColumnName(s+t.col)),t.isRowAbsolute?n+="$"+t.row:n+=r.row+parseInt(t.row),"range"==t.type&&(t.toCell.isColAbsolute?n+=":$"+FunctionsManager.toColumnName(t.toCell.col):(i=r.col+t.toCell.col,r.col>=o&&i<o?t.toCell.col=t.toCell.col-1:r.col<o&&o<=i&&(t.toCell.col=t.toCell.col+1),n+=":"+FunctionsManager.toColumnName(s+t.toCell.col)),t.toCell.isRowAbsolute?n+="$"+t.toCell.row:n+=r.row+parseInt(t.toCell.row)),e.value=n)}),e.domElement.setAttribute("cell-function",JSON.stringify(n)))}},{key:"AdjustAllColsOnDelete",value:function(e,t,n){var s,i=JSON.parse(e.domElement.getAttribute("cell-function"));null!=i&&(s=t.GetCoordinatesPerNode(e.id),n.forEach(function(o){var r;o!=s.col&&(r=s.col,s.col>o&&(r=s.col-1),i.forEach(function(e){var t,n,i;"range"==e.type&&((t=e.r1c1).row=parseInt(t.row),t.col=parseInt(t.col),n="",t.isColAbsolute?n="$"+FunctionsManager.toColumnName(t.col):(i=s.col+t.col,s.col>=o&&i<o?t.col=t.col+1:s.col<o&&o<=i&&(t.col=t.col-1),n+=FunctionsManager.toColumnName(r+t.col)),t.isRowAbsolute?n+="$"+t.row:n+=s.row+t.row,"range"==t.type&&(t.toCell.isColAbsolute?n+=":$"+FunctionsManager.toColumnName(t.toCell.col):(i=s.col+t.toCell.col,s.col>=o&&i<o?t.toCell.col=t.toCell.col+1:s.col<o&&o<=i&&(t.toCell.col=t.toCell.col-1),n+=":"+FunctionsManager.toColumnName(r+t.toCell.col)),t.toCell.isRowAbsolute?n+="$"+t.toCell.row:n+=s.row+parseInt(t.toCell.row)),e.value=n)}),s.col=r)}),e.domElement.setAttribute("cell-function",JSON.stringify(i)))}}]),FunctionsManager}();function bVb(){_classCallCheck(this,bVb)}},function(e,t,n){"use strict";n.r(t);var p=n(0);function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var r=(o(u,[{key:"draw",value:function(){this.build()}},{key:"build",value:function(){var e=this.context.createLinearGradient(0,0,this.width,0);e.addColorStop(0,"rgb(255, 0, 0)"),e.addColorStop(.15,"rgb(255, 0, 255)"),e.addColorStop(.33,"rgb(0, 0, 255)"),e.addColorStop(.49,"rgb(0, 255, 255)"),e.addColorStop(.67,"rgb(0, 255, 0)"),e.addColorStop(.84,"rgb(255, 255, 0)"),e.addColorStop(1,"rgb(255, 0, 0)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),(e=this.context.createLinearGradient(0,0,0,this.height)).addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(.5,"rgba(255, 255, 255, 0)"),e.addColorStop(.5,"rgba(0, 0, 0, 0)"),e.addColorStop(1,"rgba(0, 0, 0, 1)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),this.context.beginPath(),this.context.arc(this.pickerCircle.x,this.pickerCircle.y,this.pickerCircle.width,0,2*Math.PI),this.context.strokeStyle="#ffffff",this.context.stroke(),this.context.closePath()}},{key:"listenForEvents",value:function(){var i=this;this.canvas.addEventListener("mousemove",function(e){var t=i.canvas.getBoundingClientRect(),n=e.clientX-t.left,t=e.clientY-t.top;i.pickerCircle.x=n,i.pickerCircle.y=t,i.previewbox.style.backgroundColor=i.getPickedColor(),i.draw()}),this.canvas.addEventListener("click",function(){return i.SelectColor()})}},{key:"getPickedColor",value:function(){var e=this.context.getImageData(this.pickerCircle.x,this.pickerCircle.y,1,1);return"#"+this.fullColorHex(e.data[0],e.data[1],e.data[2])}},{key:"SelectColor",value:function(){try{this.panel.parentNode.removeChild(this.panel)}catch(e){}this.onChangeCallback(this.getPickedColor())}},{key:"rgbToHex",value:function(e){e=Number(e).toString(16);return e.length<2&&(e="0"+e),e}},{key:"fullColorHex",value:function(e,t,n){return this.rgbToHex(e)+this.rgbToHex(t)+this.rgbToHex(n)}}]),u),s=(o(l,[{key:"_parseSelectedColor",value:function(e){var t=e;return null!=e&&-1<e.toLowerCase().indexOf("rgb")&&(e=(e=e.toLowerCase()).split("(")[1].split(")")[0].split(","),t="#"+this._rgbToHex(e[0].split(" ").join(""))+this._rgbToHex(e[1].split(" ").join(""))+this._rgbToHex(e[2].split(" ").join(""))),t}},{key:"_rgbToHex",value:function(e){e=Number(e).toString(16);return e.length<2&&(e="0"+e),e}},{key:"_showColorPalette",value:function(){var t=this,n=document.createElement("div");n.style.position="absolute",n.style.zIndex="99999",n.style.border="1px solid #e1e1e1",n.style.borderRadius="2px",n.style.backgroundColor="#f9f9f9",n.style.padding="4px 4px 0px 0px",n.style.outline="none",n.setAttribute("tabindex","123");var e=this.event.srcElement.getBoundingClientRect();n.style.left=e.left+parseInt(this.addToLeft)+"px",n.style.top=parseInt(this.addToTop)+window.scrollY+e.height+e.top+"px";e=[];e.push(["#dfb9b1","#eecdcd","#f8e5d0","#fdf2d0","#dce9d5","#d3dfe2","#ccdaf5","#d2e1f1","#d8d2e7","#e6d2db"]),e.push(["#d08270","#de9c9b","#f2cca2","#fbe5a3","#bcd5ac","#a9c3c8","#a9c2f0","#a6c4e5","#b2a8d2","#cea8bc"]),e.push(["#bd4b31","#d16d6a","#ecb476","#ffefa1","#9dc284","#80a4ad","#779ee5","#7ba7d7","#8b7ebe","#b87f9e"]),e.push(["#982a15","#bb261a","#da944b","#eac251","#78a55a","#53808c","#4a79d1","#4f85c1","#6351a2","#9b5378"]),e.push(["#7a2817","#8c1a11","#a96324","#b89130","#48742c","#264e5b","#2657c5","#24538f","#312071","#6b2346"]);var i=document.createElement("div");i.style.display="flex",i.style.marginTop="2px",i.style.marginBottom="6px",["#000000","#39434d","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#ffffff","TRANSPARENT"].forEach(function(e){e=t._getDomCell_colorPicker(e,n);i.appendChild(e)}),n.appendChild(i),e.forEach(function(e){(i=document.createElement("div")).style.display="flex",e.forEach(function(e){e=t._getDomCell_colorPicker(e,n);i.appendChild(e)}),n.appendChild(i)});var o,e=document.createElement("div");e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.fontFamily="Arial",e.style.padding="2px 4px 2px 4px",e.style.fontSize="14px",e.style.color="#999999",e.textContent="Custom",e.addEventListener("mouseover",function(){this.style.color="#30b7e8"}),e.addEventListener("mouseout",function(){this.style.color="#999999"}),e.addEventListener("click",function(){t.pnl.style.display="none",t.ShowCustomPanel()}),n.appendChild(e),0<this.usedCustomColors.length?((o=document.createElement("div")).style.display="flex",o.style.marginTop="2px",o.style.marginBottom="0px",this.usedCustomColors.forEach(function(e){e=t._getDomCell_colorPicker(e,n);o.appendChild(e)}),n.appendChild(o)):e.style.padding="2px 4px 4px 4px",n.addEventListener("blur",function(){t.keepOnAfterSelection||this.parentNode.removeChild(this)}),document.body.appendChild(n),n.focus(),this.pnl=n}},{key:"_getDomCell_colorPicker",value:function(e){var t=this,n=e,i=this.selectedColor,o=void 0;return"TRANSPARENT"==e?((o=document.createElement("canvas")).width=13,o.height=13,o.style.border="2px solid #ffffff",o.style.margin="0px 0px 4px 4px ",o.style.borderRadius="2px",(e=o.getContext("2d")).fillStyle="#ffffff",e.fillRect(0,0,o.width,o.height),e.strokeStyle="#FF0000",e.lineWidth=2,e.beginPath(),e.moveTo(0,13),e.lineTo(13,0),e.stroke()):((o=document.createElement("div")).style.width="13px",o.style.height="13px",o.style.backgroundColor=n,o.style.margin="0px 0px 4px 4px ",o.style.borderRadius="2px",o.style.border=i==n?"2px solid #30b7e8":"2px solid "+n),o.addEventListener("mouseover",function(){this.style.cursor="pointer",this.style.border="2px solid #30b7e8"}),o.addEventListener("mouseout",function(){this.style.border=n!=i?"TRANSPARENT"==n?"2px solid #ffffff":"2px solid "+n:"2px solid #30b7e8"}),o.addEventListener("click",function(){if(t.callBack(n),!t.keepOnAfterSelection)try{t.pnl.parentNode.removeChild(t.pnl)}catch(e){}}),this.preserveFocus&&o.addEventListener("mousedown",function(e){e.preventDefault()}),o}},{key:"ShowCustomPanel",value:function(){var t=this;new r(this.pnl.style.left,this.pnl.style.top,function(e){t.usedCustomColors.indexOf(e)<0&&(t.usedCustomColors.push(e),10<t.usedCustomColors.length&&t.usedCustomColors.shift(),localStorage.setItem("usedCustomColors",JSON.stringify(t.usedCustomColors))),t.callBack(e),null===t.pnl.parentNode||t.pnl.parentNode.removeChild(t.pnl)})}}]),l),c=n(2),g=n(1);function l(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,r=5<arguments.length&&void 0!==arguments[5]&&arguments[5],s=6<arguments.length&&void 0!==arguments[6]&&arguments[6];a(this,l),this.event=e,this.callBack=t,this.preserveFocus=s,this.keepOnAfterSelection=r,this.addToLeft=n,this.addToTop=i,this.selectedColor=this._parseSelectedColor(o),this.usedCustomColors=[],"undefined"!=typeof Storage&&(this.usedCustomColors=JSON.parse(localStorage.getItem("usedCustomColors")),null==this.usedCustomColors&&(this.usedCustomColors=[])),this._showColorPalette()}function u(e,t,n){a(this,u),this.onChangeCallback=n;n=document.createElement("div");n.style.position="absolute",n.style.zIndex="99999",n.style.border="1px solid #e1e1e1",n.style.borderRadius="2px",n.style.backgroundColor="#f9f9f9",n.style.padding="4px",n.style.left=e,n.style.top=t,n.style.outline="none",n.setAttribute("tabindex","3333"),n.addEventListener("blur",function(){this.parentNode.removeChild(this)}),this.canvas=document.createElement("canvas"),this.width=200,this.height=140,this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.cursor="pointer",this.context=this.canvas.getContext("2d"),this.pickerCircle={x:10,y:10,width:7,height:7},this.draw(),n.appendChild(this.canvas),this.previewbox=document.createElement("div"),this.previewbox.style.width="200px",this.previewbox.style.height="14px",this.previewbox.style.backgroundColor="rgba(0,0,0,0)",n.appendChild(this.previewbox),this.listenForEvents(),document.body.appendChild(n),n.focus(),this.panel=n}function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var d=(h(f.prototype,[{key:"Init",value:function(){var e=this,t=document.createElement("div");t.style.backgroundColor="#ffffff",t.style.width="180px",t.style.height="291px",t.style.borderRadius="2px",t.style.boxShadow="2px 2px 5px #e3e3e3",t.style.position="fixed";var n=this.event.clientX+4,i=this.event.clientY-60;i<0&&(i=1),i+291>window.innerHeight&&(i=window.innerHeight-295),t.style.left=n+"px",t.style.top=i+"px",t.style.overflow="hidden",t.style.zIndex="999";n=document.createElement("input");n.style.opacity=0,n.style.position="absolute",n.style.width="0px",n.style.height="0px",this.keepAlive=!1,n.addEventListener("blur",function(){e.exitingRightBorder||(e._removeRequestNumberPanel(),setTimeout(function(){e.keepAlive||e.destroy()},200))}),this.inputForFocus=n,t.appendChild(n);i="";1<this.spreadsheet.selectedNodes.length&&(i="s"),t=this._addMenuEntry(t,"addRowAbove","Insert Row(s) Above",!0),t=this._addMenuEntry(t,"addRowBelow","Insert Row(s) Below",!0),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"addColLeft","Insert Column(s) Before",!0),t=this._addMenuEntry(t,"addColRight","Insert Column(s) After",!0),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"delRow","Delete Row"+i),t=this._addMenuEntry(t,"delCol","Delete Column"+i),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"cellBgColor","Background Color"),t=this._addMenuEntry(t,"borderColor","Border Color"),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"distributeRows","Distribute Rows"),t=this._addMenuEntry(t,"distributeCols","Distribute Columns"),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"formatCells","Format Cells"),document.body.appendChild(t),n.focus(),this.panel=t}},{key:"refreshFocus",value:function(){this.inputForFocus.focus()}},{key:"_addMenuEntry",value:function(e,t,n,i){var o=3<arguments.length&&void 0!==i&&i,r=this,i=document.createElement("div");return i.style.padding="6px 10px 6px 10px",i.style.fontFamily="Arial",i.style.fontSize="12px",i.style.margin="0px",i.style.cursor="pointer",i.style.backgroundColor="#ffffff",i.style.color="#828282",i.innerText=n,o?(i.addEventListener("mouseover",function(e){r.refreshFocus(),r._removeRequestNumberPanel(),this.style.backgroundColor="#FF9100",this.style.color="#ffffff",r._showRequestNumber(this,t),r.exitingRightBorder=!1}),i.addEventListener("mousemove",function(e){var t=this.getBoundingClientRect(),n=t.width,t=t.width-2;e.offsetX>=t&&e.offsetX<=n&&(r.exitingRightBorder=!0)})):(i.addEventListener("mouseover",function(e){r.exitingRightBorder=!1,this.style.backgroundColor="#FF9100",this.style.color="#ffffff"}),i.addEventListener("click",function(e){r.PerformAction(t)})),i.addEventListener("mouseout",function(e){r.exitingRightBorder||r._removeRequestNumberPanel(),this.style.backgroundColor="#ffffff",this.style.color="#828282"}),e.appendChild(i),e}},{key:"_addMenuSpace",value:function(e){var t=document.createElement("div");return t.style.height="1px",t.style.backgroundColor="#e3e3e3",e.appendChild(t),e}},{key:"_showRequestNumber",value:function(e,t){var n=this,i="Rows:";-1<t.indexOf("Col")&&(i="Cols:");var o=e.getBoundingClientRect(),e=document.createElement("div");e.style.backgroundColor="#ffffff",e.style.height=o.height+"px",e.style.borderRadius="0px 2px 2px 0px",e.style.boxShadow="2px 2px 5px #e3e3e3",e.style.display="flex",e.style.alignItems="center",e.style.zIndex="9999",e.style.fontFamily="Arial",e.style.fontSize="12px",e.style.color="#828282",e.style.position="fixed",e.style.top=o.top+"px",e.style.left=o.left+o.width+"px";o=document.createElement("div");o.style.padding="0px 4px 0px 4px",o.textContent=i,e.appendChild(o);var r=document.createElement("input");r.style.display="block",r.style.width="40px",r.style.outline="none",r.style.border="1px solid #e1e1e1",r.style.borderRadius="3px",r.style.color="#828282",r.style.fontFamily="Arial",r.style.fontSize="12px",r.value=1,r.addEventListener("click",function(e){this.select()}),e.appendChild(r);o=document.createElement("div");o.style.padding="0px 4px 0px 4px",o.style.cursor="pointer",o.style.fontWeight="bold",o.style.color="#30b7e8",o.textContent="add",o.addEventListener("click",function(e){n.PerformAction(t,r.value),n._removeRequestNumberPanel(),n.destroy()}),o.addEventListener("mouseover",function(e){this.style.color="#FF9100"}),o.addEventListener("mouseout",function(e){this.style.color="#30b7e8"}),e.appendChild(o),document.body.appendChild(e),this.additionalPnl=e}},{key:"_removeRequestNumberPanel",value:function(){null!=this.additionalPnl&&null!=this.additionalPnl.parentNode&&this.additionalPnl.parentNode.removeChild(this.additionalPnl)}},{key:"destroy",value:function(){this._removeRequestNumberPanel(),null!=this.panel.parentNode&&this.panel.parentNode.removeChild(this.panel)}},{key:"PerformAction",value:function(e,t){if(0<this.spreadsheet.selectedNodes.length){var n=this.spreadsheet.selectedNodes.length-1;switch(e){case"addRowAbove":if(0<t){for(;0<t;)this.AddRow("above",this.spreadsheet.selectedNodes[0]),t--;this.spreadsheet.PushToHistory()}break;case"addRowBelow":if(0<t){for(;0<t;)this.AddRow("below",this.spreadsheet.selectedNodes[n]),t--;this.spreadsheet.PushToHistory()}this.spreadsheet.PushToHistory();break;case"addColLeft":if(0<t){for(;0<t;)this.AddColumn("left",this.spreadsheet.selectedNodes[0]),t--;this.spreadsheet.PushToHistory()}this.spreadsheet.PushToHistory();break;case"addColRight":if(0<t){for(;0<t;)this.AddColumn("right",this.spreadsheet.selectedNodes[n]),t--;this.spreadsheet.PushToHistory()}this.spreadsheet.PushToHistory();break;case"delRow":this.DeleteRows(),this.spreadsheet.PushToHistory();break;case"delCol":this.DeleteColumns(),this.spreadsheet.PushToHistory();break;case"cellBgColor":this.ShowPicColorPanel();break;case"borderColor":this.ShowPicBorderColorPanel();break;case"distributeRows":this.DistributeRows(),this.spreadsheet.PushToHistory();break;case"distributeCols":this.DistributeCols(),this.spreadsheet.PushToHistory();break;case"fitToScreen":this.FitToScreen(),this.spreadsheet.PushToHistory();break;case"formatCells":this.OpenFormatCells(),this.spreadsheet.PushToHistory();break;default:return}}}},{key:"HideButKeepAlive",value:function(){this.keepAlive=!0,this.panel.style.display="none"}},{key:"ShowPicColorPanel",value:function(){this.HideButKeepAlive();var t=this;new s(this.event,function(e){t.ChangCellBgColor(e)},-20,6)}},{key:"ChangCellBgColor",value:function(t){this.spreadsheet.selectedNodes.forEach(function(e){e.domElement.style.backgroundColor=t}),this.spreadsheet.PushToHistory()}},{key:"ShowPicBorderColorPanel",value:function(){this.HideButKeepAlive();var t=this;new s(this.event,function(e){t.ChangBorderColor(e)},-20,6)}},{key:"ChangBorderColor",value:function(t){this.spreadsheet.selectedNodes.forEach(function(e){e.domElement.style.border="1px double "+t}),this.spreadsheet.PushToHistory()}},{key:"DistributeRows",value:function(){this.spreadsheet.rootNode.document;var i=this.spreadsheet.tableNode.domElement.getBoundingClientRect().height;this.spreadsheet.tableNode.children.forEach(function(e){var t,n;"tbody"==e.tagName.toLowerCase()&&(t=e.children.length,n=i/t,e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.style.height=n+"px"})}))})}},{key:"DistributeCols",value:function(){this.spreadsheet.rootNode.document;var r=this.spreadsheet.tableNode.domElement.getBoundingClientRect().width;this.spreadsheet.tableNode.children.forEach(function(e){var i,o;"tbody"==e.tagName.toLowerCase()&&(i=!0,o=void 0,e.children.forEach(function(e){var t;i&&(i=!1,t=e.children.length-1,o=r/t);var n=!0;e.children.forEach(function(e){n?n=!1:e.domElement.style.width=o+"px"})}))})}},{key:"AddRow",value:function(e,t){var r=this;this.spreadsheet.DeselectAll(),this.spreadsheet.StopFunctionEditing();var n=this.spreadsheet.GetCoordinatesPerNode(t.id),s=n.row,i=n.row;"above"==e?i=n.row+1:"below"==e&&(s+=1);var a=A.AddRow(s,t.document,this.spreadsheet.GetNumberOfColumns()).tr,e=this.spreadsheet.GetNumberOfRows();s==e?this.spreadsheet.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.Append(a)}):this.spreadsheet.tableNode.children.forEach(function(t){var n,i,o;"tbody"==t.tagName.toLowerCase()&&(i=0,o=!(n=[]),t.children.forEach(function(e){e.children.forEach(function(e){c.a.AdjustAllRowsOnInsert(e,r.spreadsheet,s)}),i==s?(o=!0,n.push(a),i+=2):i++,o&&e.children[0].UpdateTextContent(i),n.push(e)}),t.children=[],n.forEach(function(e){t.Append(e)}))}),this.spreadsheet.Init(),t.GetFirstTextNode().SetFocus(),this.spreadsheet.SelectCell(i,n.col),this.spreadsheet.ShowAutofillHandle()}},{key:"DeleteRows",value:function(){var r=this;this.spreadsheet.StopFunctionEditing();var s=[],a=[];this.spreadsheet.selectedNodes.forEach(function(e){s.indexOf(e.parent.id)<0&&(s.push(e.parent.id),e=r.spreadsheet.GetCoordinatesPerNode(e.id),a.push(e.row))});var e=this.spreadsheet.GetCoordinatesPerNode(this.spreadsheet.selectedNodes[0].id);this.spreadsheet.DeselectAll();var l=this.spreadsheet.rootNode.document;this.spreadsheet.tableNode.children.forEach(function(t){var n,i,o;"tbody"==t.tagName.toLowerCase()&&(i=0,o=!(n=[]),t.children.forEach(function(e){e.children.forEach(function(e){c.a.AdjustAllRowsOnDelete(e,r.spreadsheet,a)}),s.indexOf(e.id)<0?(i++,o&&e.children[0].UpdateTextContent(i),n.push(e)):(l.DeleteNode(e),o=!0)}),t.children=[],n.forEach(function(e){t.Append(e)}))}),this.spreadsheet.Init(),this.spreadsheet.functionsManager.RecalculateAll();try{var t=this.spreadsheet.GetNodePerCoordinates(e.row,e.col);this.spreadsheet.SelectCell(e.row,e.col),t.GetFirstTextNode().SetFocus()}catch(e){}}},{key:"AddColumn",value:function(e,r){var o=this;this.spreadsheet.DeselectAll(),this.spreadsheet.StopFunctionEditing();var t=this.spreadsheet.GetCoordinatesPerNode(r.id),s=parseInt(t.col);"left"==e||"right"==e&&(s=parseInt(t.col+1));var n=this.spreadsheet.GetNumberOfColumns();this.spreadsheet.tableNode.children.forEach(function(e){"thead"==e.tagName.toLowerCase()?s==n?e.children.forEach(function(e){e.Append(A.AddCellColumn(r.document,s))}):e.children.forEach(function(t){var n=[],i=0,o=!1;t.children.forEach(function(e){i==s&&(o=!0,n.push(A.AddCellColumn(r.document,s))),i++,o&&e.UpdateTextContent(A.toColumnName(i)),n.push(e)}),t.children=[],n.forEach(function(e){t.Append(e)})}):"tbody"==e.tagName.toLowerCase()&&(s==n?e.children.forEach(function(e){e.Append(A.AddNormalCell(r.document))}):e.children.forEach(function(t){var n=[],i=0;t.children.forEach(function(e){c.a.AdjustAllColsOnInsert(e,o.spreadsheet,s),i==s&&n.push(A.AddNormalCell(r.document)),i++,n.push(e)}),t.children=[],n.forEach(function(e){t.Append(e)})}))}),this.spreadsheet.Init(),r.GetFirstTextNode().SetFocus(),t=this.spreadsheet.GetCoordinatesPerNode(r.id),this.spreadsheet.SelectCell(t.row,t.col),this.spreadsheet.ShowAutofillHandle()}},{key:"DeleteColumns",value:function(){var o=this;this.spreadsheet.StopFunctionEditing();var s=[];this.spreadsheet.selectedNodes.forEach(function(e){e=o.spreadsheet.GetCoordinatesPerNode(e.id);s.indexOf(e.col)<0&&s.push(e.col)});var e=this.spreadsheet.GetCoordinatesPerNode(this.spreadsheet.selectedNodes[0].id);this.spreadsheet.DeselectAll();var a=this.spreadsheet.rootNode.document;this.spreadsheet.tableNode.children.forEach(function(e){"thead"==e.tagName.toLowerCase()?e.children.forEach(function(t){var n=[],i=0,o=!1,r=0;t.children.forEach(function(e){-1<s.indexOf(i)?(a.DeleteNode(e),o=!0):(o&&e.UpdateTextContent(A.toColumnName(r)),n.push(e),r++),i++}),t.children=[],n.forEach(function(e){t.Append(e)})}):"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(t){var n=[],i=0;t.children.forEach(function(e){c.a.AdjustAllColsOnDelete(e,o.spreadsheet,s),-1<s.indexOf(i)?a.DeleteNode(e):n.push(e),i++}),t.children=[],n.forEach(function(e){t.Append(e)})})}),this.spreadsheet.Init(),this.spreadsheet.functionsManager.RecalculateAll();try{var t=this.spreadsheet.GetNodePerCoordinates(e.row,e.col);this.spreadsheet.SelectCell(e.row,e.col),t.GetFirstTextNode().SetFocus()}catch(e){}}},{key:"OpenFormatCells",value:function(){g.a.OpenFormatDialog(this.spreadsheet)}}]),f);function f(e,t,n){!function(e){if(!(e instanceof f))throw new TypeError("Cannot call a class as a function")}(this),this.spreadsheet=e,this.td=t,this.event=n,this.additionalPnl=void 0,this.inputForFocus=void 0,this.Init()}function m(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var v=(m(y.prototype,[{key:"SetPrecision",value:function(e){null==e&&(e=4),this.precision=parseInt(e)}},{key:"_round",value:function(e){return Number(Math.round(e+"e"+this.precision)+"e-"+this.precision)}},{key:"_isNumber",value:function(e){var t=e;return"-"==e[0]&&(t=e.replace("-","")),/^[0-9.]*$/.test(t)}},{key:"LineFitter",value:function(e,t,n){for(var i=2<arguments.length&&void 0!==n?n:"after",o=0,r=0,s=0,a=0,l=0,c=0;c<e.length;c++){var u=e[c];o++,r+=c,s+=c*c,a+=c*u,l+=u}var n=o*s-r*r,h=(s*l-r*a)/n,d=(o*a-r*l)/n,f=new Array;if("after"==i)for(var p=e.length,g=p+t;p<g;)f.push(this._round(h+p*d)),p++;else for(var m=-1,v=m-t;v<m;)f.push(this._round(h+m*d)),m--;return f}},{key:"_debugPrintSet",value:function(e){console.log("----------------------"),e.forEach(function(e){var t="",n="";e.originals.forEach(function(e){t+=e.id+" "}),e.toFill.forEach(function(e){n+=e.id+" "}),console.log("originals: "+t),console.log("toFill: "+n),console.log("")}),console.log("----------------------")}},{key:"PerformAutofill",value:function(){var n,i,o,r,u=this,e=this.spreadsheet.selectedNodes,s=this.spreadsheet.originalNodesForAutofill,h=this.spreadsheet.autofillSelectionDirection,a=[];-1<h.indexOf("row-right")||-1<h.indexOf("row-left")?(n=void 0,i=new Array,o=new Array,e.forEach(function(e){var t=u.spreadsheet.GetCoordinatesPerNode(e.id);null==n&&(n=t.row),n!=t.row&&(n=t.row,a.push({originals:i,toFill:o}),i=new Array,o=new Array),(s.indexOf(e.id)<0?o:i).push(e)}),a.push({originals:i,toFill:o})):(-1<h.indexOf("col-up")||-1<h.indexOf("col-down"))&&(r={},e.forEach(function(e){var t=u.spreadsheet.GetCoordinatesPerNode(e.id);null==r[t.col]&&(r[t.col]={originals:new Array,toFill:new Array}),(s.indexOf(e.id)<0?r[t.col].toFill:r[t.col].originals).push(e)}),Object.keys(r).forEach(function(e){a.push(r[e])})),a.forEach(function(e){var i,t,n,o,r,s=!1,a=!1,l=[],c=[];e.originals.forEach(function(e){var t=e.domElement.getAttribute("cell-function"),n=e.domElement.getAttribute("cell-format");c.push(n),null!=t?(a=!0,l.push(t)):(e=e.domElement.textContent,u._isNumber(e)?l.push(parseFloat(e)):(s=!0,l.push(e)))}),1!=l.length||a||(s=!0),s||a?(-1<h.indexOf("row-right")||-1<h.indexOf("col-down")||(-1<h.indexOf("row-left")||-1<h.indexOf("col-up"))&&(e.toFill=e.toFill.reverse(),l=l.reverse()),i=0,e.toFill.forEach(function(e){var t=l[i];null==t&&(t=l[i=0]);var n=c[i];null!=n&&""!=n&&e.domElement.setAttribute("cell-format",n),a?u.spreadsheet.functionsManager.CopyFunctionToNode(t,e):(e.GetFirstTextNode().ForceTextContent(t),g.a.Format(e),u.spreadsheet.functionsManager.CellValueChanged(e)),i++})):(t=e.toFill.length,n="",-1<h.indexOf("row-right")||-1<h.indexOf("col-down")?n="after":(-1<h.indexOf("row-left")||-1<h.indexOf("col-up"))&&(n="before",e.toFill=e.toFill.reverse()),o=u.LineFitter(l,t,n),r=0,e.toFill.forEach(function(e){var t=o[r],n=c[r];null!=n&&""!=n&&e.domElement.setAttribute("cell-format",n),e.GetFirstTextNode().ForceTextContent(t.toString()),g.a.Format(e),u.spreadsheet.functionsManager.CellValueChanged(e),r++}))})}}]),y);function y(e,t){!function(e){if(!(e instanceof y))throw new TypeError("Cannot call a class as a function")}(this),this.spreadsheet=e,this.SetPrecision(t)}function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var C=(b(x.prototype,[{key:"DownloadCsv",value:function(){var e=this.spreadsheet.Export(),i="";e.forEach(function(e){var t="",n=!0;e.forEach(function(e){n?(t=e,n=!1):t+=',"'+e.replace(/"/g,'""')+'"'}),i+=t+"\r\n"});var t=encodeURI("data:text/csv;charset=utf-8,"+i),e=document.createElement("a");e.setAttribute("href",t),e.setAttribute("download","myData.csv"),document.body.appendChild(e),e.click(),document.body.removeChild(e)}},{key:"UploadCsv",value:function(){var i=this;this.input=document.createElement("input"),this.input.type="file",document.body.appendChild(this.input),this.input.addEventListener("change",function(e){var t,n;this.files&&this.files[0]&&(t=this.files[0],(n=new FileReader).addEventListener("load",function(e){e=e.target.result;i.ImportCsv(e)}),n.readAsBinaryString(t)),i.RemoveInput()}),this.input.click()}},{key:"RemoveInput",value:function(){document.body.removeChild(this.input)}},{key:"ImportCsv",value:function(e){for(var t=this._guessLineEndings(e),n=this._guessDelimiter(e,t),i=[],o=e.split(t),r=0;r<o.length;r++){var s=o[r];"#"!==s.substr(0,1)&&i.push(s.split(n))}this.spreadsheet.Import(i)}},{key:"_guessLineEndings",value:function(e,t){t=1<arguments.length&&void 0!==t?t:'"';e=e.substr(0,1048576);var t=new RegExp(this._escapeRegExp(t)+"([^]*?)"+this._escapeRegExp(t),"gm"),n=(e=e.replace(t,"")).split("\r"),e=e.split("\n"),e=1<e.length&&e[0].length<n[0].length;if(1===n.length||e)return"\n";for(var i=0,o=0;o<n.length;o++)"\n"===n[o][0]&&i++;return i>=n.length/2?"\r\n":"\r"}},{key:"_escapeRegExp",value:function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},{key:"_testEmptyLine",value:function(e){return 1===e.length&&0===e[0].length}},{key:"_guessDelimiter",value:function(e,t){for(var n,i,o,r=[",","\t","|",";",String.fromCharCode(30),String.fromCharCode(31)],s=0;s<r.length;s++){for(var a,l=r[s],c=0,u=0,h=0,d=void 0,f=e.split(t),p=0;p<f.length;p++)this._testEmptyLine(f[p])?h++:(u+=a=f[p].length,void 0!==d?0<a&&(c+=Math.abs(a-d),d=a):d=a);0<f.length&&(u/=f.length-h),(void 0===i||c<=i)&&(void 0===o||o<u)&&1.99<u&&(i=c,n=l,o=u)}return n}}]),x);function x(e){!function(e){if(!(e instanceof x))throw new TypeError("Cannot call a class as a function")}(this),this.spreadsheet=e}function w(e){return(w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function S(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _(e,t,n){return t&&S(e.prototype,t),n&&S(e,n),e}function E(e,t){return(E=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function k(e){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&E(e,t)}(f,p.Plugin);var n,i,t=(n=f,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=k(n);return!(t=i?(e=k(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==w(t)&&"function"!=typeof t?T(this):t});function f(e){return function(e){if(!(e instanceof f))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e,!0)).isMouseDown=!1,e.isMouseOnRightBorder=!1,e.isMouseOnBottomBorder=!1,e.currentColResizing=void 0,e.currentRowResizing=void 0,e.startNode=void 0,e.endNode=void 0,e.selectedNodes=[],e.allSelectedRows=new Array,e.allSelectedCols=new Array,e.minSelectedRow=0,e.minSelectedCol=0,e.numberOfRows=0,e.numberOfColumns=0,e.tableNode=void 0,e.autofillHandle=void 0,e.isMovingAutofillHandle=!1,e.originalNodesForAutofill=new Array,e.autofillSelectionDirection="",e.prevPageX=void 0,e.prevPageY=void 0,e.coordinatesPerNode=new Array,e.nodePerCoordinates=new Array,e.autofillManager=new v(T(e)),e.functionsManager=new c.a(T(e)),e.csvManager=new C(T(e)),e.editingFunction=!1,e.readOnly=e.rootNode.document.readOnly,e.InitializeDomElements(),e}return _(f,null,[{key:"GetName",value:function(){return"spreadsheet"}}]),_(f,[{key:"PluginDidMount",value:function(){this.readOnly?this.InitReadOnly():this.Init()}},{key:"InitReadOnly",value:function(){this.HideAutofillHandle(),this.fxInput=this.rootNode.children[0].children[1],null!=this.fxInput&&(this.fxInput.domElement.style.opacity="0.2",this.fxInput.domElement.readOnly=!0)}},{key:"Init",value:function(){"table"==this.rootNode.tagName&&this.TransformTableInSpreadsheet();var t=this;this.HideAutofillHandle(),this.coordinatesPerNode=new Array,this.nodePerCoordinates=new Array,this.coordinatesPerNodeHeader=new Array,this.nodeHeaderPerCoordinates=new Array,this.functionsManager.Reset(),this.fxLabel=this.rootNode.children[0].children[0],this.fxInput=this.rootNode.children[0].children[1];var e=this.rootNode.children[0].children[2].domElement,n=this.rootNode.children[0].children[3].domElement;function i(e){t.isMouseDown&&(t.isMouseOnRightBorder?t.ResizeColumn(e):t.isMouseOnBottomBorder&&t.ResizeRow(e))}this._prepareUploadDownloadButtons(n,e),this.functionsManager.SetInputNode(this.fxInput),this.functionsManager.SetFxLabelNode(this.fxLabel);var o=0,r=0;this.rootNode.parent.domElement.removeEventListener("mousemove",i),this.rootNode.parent.domElement.addEventListener("mousemove",i),this.rootNode.children.forEach(function(e){"table"==e.tagName.toLowerCase()&&(t.tableNode=e,e=t.tableNode.domElement.getAttribute("cm-sh-precision"),t.autofillManager.SetPrecision(e),t.functionsManager.SetPrecision(e),t.tableNode.children.forEach(function(e){"thead"==e.tagName.toLowerCase()?e.children.forEach(function(e){r=0,e.children.forEach(function(e){0<r&&(t.coordinatesPerNodeHeader[r]=e,t.nodeHeaderPerCoordinates[e.id]=r,t.InitHeaderCell(e.id,e.domElement,r)),r++})}):"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){t.functionsManager.TrackCell(e,o,r),t.InitCell(e.id,e.domElement,o,r),null==t.coordinatesPerNode[o]&&(t.coordinatesPerNode[o]=new Array),t.coordinatesPerNode[o][r]=e,t.nodePerCoordinates[e.id]={col:r,row:o},r++}),o++})}))}),this.numberOfRows=o,this.numberOfColumns=r,this.cellsResized=!1}},{key:"InitHeaderCell",value:function(e,t){var c=this;null==this.mousedownHeaderFunction&&(this.mousedownHeaderFunction=function(e){var t=c.nodeHeaderPerCoordinates[c.GetNodeFromDom(this).id];c.prevX=e.pageX+window.scrollX,c.prevY=e.pageY+window.scrollY,0==e.button&&(c.isMouseDownHeader=!0,c.startColNode=c.coordinatesPerNodeHeader[t],c.startCol=t,c.endCol=void 0,c.SelectCol(t))}),null==this.mousemoveHeaderFunction&&(this.mousemoveHeaderFunction=function(e){var t,n,i,o,r,s,a,l=c.nodeHeaderPerCoordinates[c.GetNodeFromDom(this).id];0==e.button&&c.isMouseDownHeader&&(t=(s=c.startColNode.domElement.getBoundingClientRect()).height,n=s.width,i=s.top,o=s.left,r=e.pageY+window.scrollY,s=e.pageX+window.scrollX,i<r&&r<i+t&&o<s&&s<o+n||(window.getSelection&&document.createRange?(a=window.getSelection()).empty?a.empty():a.removeAllRanges&&a.removeAllRanges():document.selection&&(a=document.selection.createRange()).empty(),c.SelectColOnDrag(l),e.preventDefault()))}),null==this.mouseupHeaderFunction&&(this.mouseupHeaderFunction=function(e){var t=c.nodeHeaderPerCoordinates[c.GetNodeFromDom(this).id];0==e.button&&(c.isMouseDownHeader=!1,c.endNode=c.GetNodeFromDom(this),c.endCol=t,c.ShowAutofillHandle())}),t.removeEventListener("mousedown",this.mousedownHeaderFunction),t.addEventListener("mousedown",this.mousedownHeaderFunction),t.removeEventListener("mousemove",this.mousemoveHeaderFunction),t.addEventListener("mousemove",this.mousemoveHeaderFunction),t.removeEventListener("mouseup",this.mouseupHeaderFunction),t.addEventListener("mouseup",this.mouseupHeaderFunction)}},{key:"InitCell",value:function(e,t){var u=this;null==this.contextmenuFunction&&(this.contextmenuFunction=function(e){var t=u.GetCoordinatesPerNode(u.GetNodeFromDom(this).id);0==u.selectedNodes.length?u.SelectCell(t.row,t.col,!0):1==u.selectedNodes.length&&u.SelectCell(t.row,t.col,!1),u.OpenSettingsPanel(this,e),e.preventDefault(),e.stopPropagation()}),u.clicks=0,u.useArrowsForText=!0,null==this.mousedownFunction&&(this.mousedownFunction=function(e){u.clicks++,1===u.clicks?u.singleClickTimer=setTimeout(function(){u.clicks=0,u.useArrowsForText=!0},300):2===u.clicks&&(clearTimeout(u.singleClickTimer),u.clicks=0,u.useArrowsForText=!1);var t=u.GetCoordinatesPerNode(u.GetNodeFromDom(this).id);u.prevX=e.pageX+window.scrollX,u.prevY=e.pageY+window.scrollY,u.editingFunction&&u.functionsManager.GetIdCurrentCell()==u.GetNodeFromDom(this).id&&u.StopFunctionEditing(),u.editingFunction?(u.isMouseDown=!0,u.startNode=u.GetNodeFromDom(this),u.startNode.row=t.row,u.startNode.col=t.col,u.endNode=void 0,u.SelectCellForFunctionEditing(t.row,t.col,!0)):0==e.button&&(u.isMouseDown=!0,u.startNode=u.GetNodeFromDom(this),u.startNode.row=t.row,u.startNode.col=t.col,u.endNode=void 0,0==t.col?(u.selectingRow=!0,u.SelectRow(t.row)):u.SelectCell(t.row,t.col))}),null==this.mousemoveFunction&&(this.mousemoveFunction=function(e){var t,n,i,o,r,s,a,l,c=u.GetCoordinatesPerNode(u.GetNodeFromDom(this).id);u.editingFunction?u.isMouseDown&&(n=(r=u.startNode.domElement.getBoundingClientRect()).height,a=r.width,i=r.top,l=r.left,o=e.pageY+window.scrollY,r=e.pageX+window.scrollX,i<o&&o<i+n&&l<r&&r<l+a||(window.getSelection&&document.createRange?(s=window.getSelection()).empty?s.empty():s.removeAllRanges&&s.removeAllRanges():document.selection&&(s=document.selection.createRange()).empty(),u.userSelectedOnDrag=!0,u.SelectOnDragForFunctionEditing(c.row,c.col),e.preventDefault())):u.isMovingAutofillHandle?(n=(t=u.startNode.domElement.getBoundingClientRect()).height,a=t.width,i=t.top,l=t.left,o=e.pageY+window.scrollY,r=e.pageX+window.scrollX,i<o&&o<i+n&&l<r&&r<l+a||(window.getSelection&&document.createRange?(s=window.getSelection()).empty?s.empty():s.removeAllRanges&&s.removeAllRanges():document.selection&&(s=document.selection.createRange()).empty(),u.userSelectedOnDrag=!0,u.SelectForAutofill(e,c.row,c.col),e.preventDefault()),e.preventDefault()):0==e.button&&(u.isMouseDown?u.isMouseOnRightBorder||u.isMouseOnBottomBorder||(n=(t=u.startNode.domElement.getBoundingClientRect()).height,a=t.width,i=t.top,l=t.left,o=e.pageY+window.scrollY,r=e.pageX+window.scrollX,i<o&&o<i+n&&l<r&&r<l+a||(window.getSelection&&document.createRange?(s=window.getSelection()).empty?s.empty():s.removeAllRanges&&s.removeAllRanges():document.selection&&(s=document.selection.createRange()).empty(),u.userSelectedOnDrag=!0,u.selectingRow?u.SelectRowOnDrag(c.row):u.SelectOnDrag(c.row,c.col),e.preventDefault())):(a=(l=this.getBoundingClientRect()).width,s=l.width-4,e.offsetX>=s&&e.offsetX<=a?(u.isMouseOnRightBorder=!0,u.currentColResizing=c.col,this.style.cursor="col-resize"):(u.isMouseOnRightBorder=!1,u.currentColResizing=void 0,this.style.cursor="auto"),u.isMouseOnRightBorder||(a=l.height,l=l.height-4,e.offsetY>=l&&e.offsetY<=a?(u.isMouseOnBottomBorder=!0,u.currentRowResizing=c.row,this.style.cursor="row-resize"):(u.isMouseOnBottomBorder=!1,u.currentRowResizing=void 0,this.style.cursor="auto"))))}),null==this.mouseupFunction&&(this.mouseupFunction=function(e){u.cellsResized&&(u.cellsResized=!1,u.PushToHistory());var t=u.GetCoordinatesPerNode(u.GetNodeFromDom(this).id);u.selectingRow=!1,u.editingFunction?(u.functionsManager.DoneSelectingCells(),u.fxInput.domElement.focus()):1==u.selectedNodes.length&&u.functionsManager.SetEditingCell(u.selectedNodes[0]),u.isMovingAutofillHandle?(document.body.style.caretColor="auto",u.rootNode.document.RestoreCursorPositionBeforeClick(),u.isMovingAutofillHandle=!1,u.ShowAutofillHandle(),u.autofillManager.PerformAutofill(),u.PushToHistory()):0==e.button&&(u.isMouseDown=!1,u.endNode=u.GetNodeFromDom(this),u.endNode.row=t.row,u.endNode.col=t.col,u.userSelectedOnDrag&&(u.userSelectedOnDrag=!1),u.ShowAutofillHandle())}),t.removeEventListener("contextmenu",this.contextmenuFunction),t.addEventListener("contextmenu",this.contextmenuFunction),t.removeEventListener("mousedown",this.mousedownFunction),t.addEventListener("mousedown",this.mousedownFunction),t.removeEventListener("mousemove",this.mousemoveFunction),t.addEventListener("mousemove",this.mousemoveFunction),t.removeEventListener("mouseup",this.mouseupFunction),t.addEventListener("mouseup",this.mouseupFunction)}},{key:"_prepareUploadDownloadButtons",value:function(e,t){var n=this;null==this.uploadCsvFnc&&(this.uploadCsvFnc=function(e){n.csvManager.UploadCsv()}),null==this.downloaCsvFnc&&(this.downloaCsvFnc=function(e){n.csvManager.DownloadCsv()}),e.removeEventListener("click",this.uploadCsvFnc),e.addEventListener("click",this.uploadCsvFnc),t.removeEventListener("click",this.downloaCsvFnc),t.addEventListener("click",this.downloaCsvFnc)}},{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"GetCoordinatesPerNode",value:function(e){return this.nodePerCoordinates[e]}},{key:"GetNodePerCoordinates",value:function(e,t){return this.coordinatesPerNode[e][t]}},{key:"GetNumberOfColumns",value:function(){return this.coordinatesPerNode[0].length}},{key:"GetNumberOfRows",value:function(){return this.coordinatesPerNode.length}},{key:"GetValue",value:function(e,t){e=(e=this.GetNodePerCoordinates(e,t).domElement.textContent).replace("Â ",""),t=parseFloat(e);return isNaN(t)?e:t}},{key:"GetValues",value:function(e,t,n,i){var o=[];i+=1;for(var r=0;r<=this.coordinatesPerNode.length;r++)if(e<=r&&r<=n)for(var s,a,l=0;l<=this.coordinatesPerNode[r].length;l++)t<=l&&l<i&&(s=this.GetNodePerCoordinates(r,l).domElement.textContent.replace("Â ",""),a=parseFloat(s),isNaN(a)?o.push(s):o.push(a));return o}},{key:"HideAutofillHandle",value:function(){null!=this.autofillHandle&&null!=this.autofillHandle.parentNode&&this.autofillHandle.parentNode.removeChild(this.autofillHandle),this.autofillHandle=void 0}},{key:"ShowAutofillHandle",value:function(){var e,t,n;0<this.selectedNodes.length&&!this.editingFunction&&(null==this.startNode&&(this.startNode=this.selectedNodes[0]),this.autofillHandle=document.createElement("div"),this.autofillHandle.setAttribute("class","csTableAutofillHandle"),this.autofillHandle.setAttribute("contentEditable","false"),t=this.selectedNodes.length-1,e=this.selectedNodes[t].domElement.getBoundingClientRect(),t=this.rootNode.domElement.getBoundingClientRect(),this.autofillHandle.style.top=e.top-t.top+e.height-3+"px",this.autofillHandle.style.left=e.left+e.width-t.left-3+"px",(n=this).autofillHandle.addEventListener("mousedown",function(e){document.body.style.caretColor="transparent",n.prevPageX=e.pageX,n.prevPageY=e.pageY,n.rootNode.document.SaveCursorPositonBeforeClick(),n.isMovingAutofillHandle=!0,n.allSelectedRows=new Array,n.allSelectedCols=new Array,n.minSelectedRow=void 0,n.minSelectedCol=void 0,n.originalNodesForAutofill=new Array,n.selectedNodes.forEach(function(e){n.originalNodesForAutofill.push(e.id);e=n.GetCoordinatesPerNode(e.id);n.allSelectedRows.indexOf(e.row)<0&&(n.allSelectedRows.push(e.row),(null==n.minSelectedRow||n.minSelectedRow>e.row)&&(n.minSelectedRow=e.row)),n.allSelectedCols.indexOf(e.col)<0&&(n.allSelectedCols.push(e.col),(null==n.minSelectedCol||n.minSelectedCol>e.col)&&(n.minSelectedCol=e.col))})}),this.autofillHandle.addEventListener("mouseup",function(e){document.body.style.caretColor="auto",n.isMovingAutofillHandle=!1,n.rootNode.document.RestoreCursorPositionBeforeClick()}),this.rootNode.domElement.appendChild(this.autofillHandle))}},{key:"ResizeRow",value:function(o){var e,t,r,s,a;null!=this.currentRowResizing&&(window.getSelection&&document.createRange?(e=window.getSelection()).empty?e.empty():e.removeAllRanges&&e.removeAllRanges():document.selection&&(e=document.selection.createRange()).empty(),s=!(t=0),a=0,(r=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&(t=0,e.children.forEach(function(e){t==r.currentRowResizing&&e.children.forEach(function(e){var t,n,i;s&&(t=e.domElement.getBoundingClientRect(),i=(n=o.pageY)-r.prevY,a=t.height+i,r.prevY=n,s=!1),e.domElement.style.height=a+"px",r.cellsResized=!0}),t++}))}))}},{key:"ResizeColumn",value:function(o){var e,r,s,a,l,c,u;null!=this.currentColResizing&&(window.getSelection&&document.createRange?(e=window.getSelection()).empty?e.empty():e.removeAllRanges&&e.removeAllRanges():document.selection&&(e=document.selection.createRange()).empty(),c=l=r=0,u=!(a=!0),(s=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){var t,n,i;r==s.currentColResizing&&(a&&(t=e.domElement.getBoundingClientRect(),n=(i=o.pageX)-s.prevX,l=t.width+n,s.prevX=i,null!=e.next&&(u=!0,i=e.next.domElement.getBoundingClientRect(),c=i.width-n),a=!1),e.domElement.style.width=l+"px",u&&null!=e.next&&(e.next.domElement.style.width=c+"px"),s.cellsResized=!0),r++})})}))}},{key:"SelectRowOnDrag",value:function(t){var n,i,o,r,s;(null==this.endNode?this.startNode:this.endNode).row!=t&&(this.DeselectAll(),n="up",(i=this.startNode.row)<=t&&(n="down"),r=o=0,(s=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){"down"==n?i<=o&&o<=t&&s.SelectCell(o,r,!0):"up"==n&&t<=o&&o<=i&&s.SelectCell(o,r,!0),r++}),o++})}))}},{key:"SelectColOnDrag",value:function(t){var n,i,o,r,s;(null==this.endCol?this.startCol:this.endCol)!=t&&(this.DeselectAll(),n="left",(i=this.startCol)<=t&&(n="right"),r=o=0,(s=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){"right"==n?i<=r&&r<=t&&s.SelectCell(o,r,!0):"left"==n&&t<=r&&r<=i&&s.SelectCell(o,r,!0),r++}),o++})}))}},{key:"SelectRow",value:function(t,e){null!=e&&0!=e||this.DeselectAll();var n=0,i=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){n==t&&e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className="commaSpreadsheetCellSelected",i.selectedNodes.push(e))}),n++})})}},{key:"SelectCol",value:function(t,e){null!=e&&0!=e||this.DeselectAll();var n=0,i=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){n=0,e.children.forEach(function(e){n==t&&e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className="commaSpreadsheetCellSelected",i.selectedNodes.push(e)),n++})})})}},{key:"SelectCell",value:function(t,n,e,i){var o=3<arguments.length&&void 0!==i&&i;null!=e&&0!=e||this.DeselectAll();var r=0,s=0,a=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){s=0,e.children.forEach(function(e){r==t&&s==n&&e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className=o?"commaSpreadsheetCellAutofillSelected":"commaSpreadsheetCellSelected",a.selectedNodes.push(e)),s++}),r++})})}},{key:"DeselectAll",value:function(){this.StopFunctionEditing(),this.HideAutofillHandle(),this.selectedNodes=[],null!=this.tableNode&&this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className="commaSpreadsheetCell")})})})}},{key:"SelectOnDrag",value:function(t,n){var i,o,r,s,a,l,e=0,c=null==this.endNode?(e=this.startNode.row,this.startNode.col):(e=this.endNode.row,this.endNode.col);e==t&&c==n||(this.DeselectAll(),i=this.startNode.row,o=this.startNode.col,r=i<=t&&o<=n?"right":t<=i&&o<n?"topRight":i<=t&&n<=o?"bottomLeft":"left",a=s=0,(l=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){a=0,e.children.forEach(function(e){"right"==r?i<=s&&s<=t&&o<=a&&a<=n&&l.SelectCell(s,a,!0):"left"==r?t<=s&&s<=i&&n<=a&&a<=o&&l.SelectCell(s,a,!0):"topRight"==r?s<=i&&t<=s&&o<=a&&a<=n&&l.SelectCell(s,a,!0):"bottomLeft"==r&&i<=s&&s<=t&&a<=o&&n<=a&&l.SelectCell(s,a,!0),a++}),s++})}))}},{key:"SelectForAutofill",value:function(e,t,n){this.DeselectAll();var i=e.pageX,e=e.pageY,i=i-this.prevPageX,e=e-this.prevPageY,o=Math.abs(i)<Math.abs(e)?0<e?"col-down":"col-up":0<i?"row-right":"row-left";this.autofillSelectionDirection=o;var r=0,s=0,a=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){"row-left"==o?-1<a.allSelectedRows.indexOf(s)&&(-1<a.allSelectedCols.indexOf(r)||r<=a.minSelectedCol&&n<=r)&&a.SelectCell(s,r,!0,!0):"row-right"==o?-1<a.allSelectedRows.indexOf(s)&&(-1<a.allSelectedCols.indexOf(r)||r>=a.minSelectedCol&&r<=n)&&a.SelectCell(s,r,!0,!0):"col-down"==o?-1<a.allSelectedCols.indexOf(r)&&(-1<a.allSelectedRows.indexOf(s)||s>=a.minSelectedRow&&s<=t)&&a.SelectCell(s,r,!0,!0):"col-up"==o&&-1<a.allSelectedCols.indexOf(r)&&(-1<a.allSelectedRows.indexOf(s)||s<=a.minSelectedRow&&t<=s)&&a.SelectCell(s,r,!0,!0),r++}),s++})})}},{key:"SelectOnDragForFunctionEditing",value:function(t,n){this.DeselectAllForFunctionEditing(),this.functionsManager.ClearCurrentRange();var i,o,r,s,a,l,e=0,c=null==this.endNode?(e=this.startNode.row,this.startNode.col):(e=this.endNode.row,this.endNode.col);e==t&&c==n||(i=this.startNode.row,o=this.startNode.col,r=i<=t&&o<=n?"right":t<=i&&o<n?"topRight":i<=t&&n<=o?"bottomLeft":"left",a=s=0,(l=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){a=0,e.children.forEach(function(e){"right"==r?i<=s&&s<=t&&o<=a&&a<=n&&l.SelectCellForFunctionEditing(s,a):"left"==r?t<=s&&s<=i&&n<=a&&a<=o&&l.SelectCellForFunctionEditing(s,a):"topRight"==r?s<=i&&t<=s&&o<=a&&a<=n&&l.SelectCellForFunctionEditing(s,a):"bottomLeft"==r&&i<=s&&s<=t&&a<=o&&n<=a&&l.SelectCellForFunctionEditing(s,a),a++}),s++})}))}},{key:"SelectCellForFunctionEditing",value:function(t,n,e){var i=0,o=0,r=this;2<arguments.length&&void 0!==e&&e&&(this.useHighlightClass=this.functionsManager.StartSelectingCells());e=this.functionsManager.GetCurrentCell(),e=this.GetCoordinatesPerNode(e.id);e.row==t&&e.col==n||this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){o=0,e.children.forEach(function(e){i==t&&o==n&&e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className=r.useHighlightClass,r.functionsManager.AddCell(t,n)),o++}),i++})})}},{key:"DeselectAllForFunctionEditing",value:function(){null!=this.tableNode&&this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&-1<e.domElement.className.indexOf("cscfe_highlight_cell")&&(e.domElement.className="commaSpreadsheetCell")})})})}},{key:"SelectRangeForFunctionEditing",value:function(e,t,n,i,o){if(null==n){var r=this.GetNodePerCoordinates(e,t);r.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(r.domElement.className=o)}else{i+=1;for(var s=0;s<=this.coordinatesPerNode.length;s++)if(e<=s&&s<=n)for(var a,l=0;l<=this.coordinatesPerNode[s].length;l++)t<=l&&l<i&&(a=this.GetNodePerCoordinates(s,l)).domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(a.domElement.className=o)}}},{key:"DeselectRangeForFunctionEditing",value:function(e,t,n,i,o,r,s,a,l){if(null==n){var c;o&&e==r&&t==s||(c=this.GetNodePerCoordinates(e,t)).domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&-1<c.domElement.className.indexOf("cscfe_highlight_cell")&&(c.domElement.className="commaSpreadsheetCell")}else{i+=1;for(var u=0;u<=this.coordinatesPerNode.length;u++)if(e<=u&&u<=n)for(var h,d=0;d<=this.coordinatesPerNode[u].length;d++)t<=d&&d<i&&(o&&r<=u&&u<=a&&s<=d&&d<l||(h=this.GetNodePerCoordinates(u,d)).domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&-1<h.domElement.className.indexOf("cscfe_highlight_cell")&&(h.domElement.className="commaSpreadsheetCell"))}}},{key:"StartFunctionEditing",value:function(e){this.editingFunction||(null==e&&(e=this.rootNode.document.GetNodeAtCursor().parent.parent),this.editingFunction=!0,this.fxLabel.domElement.style.color="#FFC15E",this.functionsManager.StartEditingCell(e))}},{key:"StopFunctionEditing",value:function(e){0<arguments.length&&void 0!==e&&e&&this.functionsManager.GetCurrentCell().GetFirstTextNode().SetFocus(),null!=this.fxLabel&&(this.fxLabel.domElement.style.color="#FFFFFF"),this.editingFunction=!1,this.functionsManager.StopEditingCell(),this.DeselectAllForFunctionEditing()}},{key:"OpenSettingsPanel",value:function(e,t){this.CloseSettingsPanel(),this.cellSettingsPanel=new d(this,e,t)}},{key:"CloseSettingsPanel",value:function(){null!=this.cellSettingsPanel&&this.cellSettingsPanel.destroy()}},{key:"GetNodeFromDom",value:function(e){e=e.getAttribute("cm-id");return this.rootNode.document.GetNodeById(e)}},{key:"ApplyStyleOnSelectedLines",value:function(t,n){this.selectedNodes.forEach(function(e){e.children.forEach(function(e){e.isBlockNode()&&e.ToggleStyle(t,n,!0)})})}},{key:"_applyToTextNodes",value:function(e,t,n){var i;e.isTextNode()&&e.ToggleStyle(t,n,!0),null!=e.children&&(i=this,e.children.forEach(function(e){i._applyToTextNodes(e,t,n)}))}},{key:"ApplyStyleOnSelectedCells",value:function(t,n){var i=this;this.selectedNodes.forEach(function(e){i._applyToTextNodes(e,t,n)})}},{key:"DeleteContentOfSelectedCells",value:function(e){var e=0<arguments.length&&void 0!==e&&e,n=this.rootNode.document,i=void 0;this.selectedNodes.forEach(function(e){var t;c.a.RemoveFunction(e),e.children[0].children.forEach(function(e){t=e.nodeStyle.Copy(),n.DeleteNode(e,!1,!0,t)}),i=e.GetFirstTextNode()}),e&&null!=i&&i.SetFocus()}},{key:"_fintTDContainer",value:function(e){return null!=e.parent?"td"==e.parent.tagName?e.parent:this._fintTDContainer(e.parent):void 0}},{key:"MoveToNextCell",value:function(){var e=this.rootNode.document.GetNodeAtCursor();null!=e&&e.isTextNode()&&(e=this._fintTDContainer(e),this.MoveCellFocus("RIGHT",e))}},{key:"MoveAndSelectCellFocus",value:function(){}},{key:"MoveCellFocus",value:function(e,t){var n=this.GetCoordinatesPerNode(t.id),i=void 0,o=void 0,t=void 0;"RIGHT"==e?(o=n.col+1,t=n.row,null==(i=this.GetNodePerCoordinates(t,o))&&((t+=o=1)>=this.GetNumberOfRows()&&(--t,o=this.GetNumberOfColumns()-1),i=this.GetNodePerCoordinates(t,o))):"LEFT"==e?(o=n.col-1,t=n.row,o<1&&(o=this.GetNumberOfColumns()-1,--t<0&&(t=0,o=1)),i=this.GetNodePerCoordinates(t,o)):"DOWN"==e?(o=n.col,(t=n.row+1)>=this.GetNumberOfRows()&&--t,i=this.GetNodePerCoordinates(t,o)):"UP"==e&&(o=n.col,(t=n.row-1)<0&&(t=0),i=this.GetNodePerCoordinates(t,o)),null!=i&&((i=i.GetFirstTextNode()).SelectText(0,i.text.toString().length),this.SelectCell(t,o),this.functionsManager.SetEditingCell(this.selectedNodes[0]),this.ShowAutofillHandle())}},{key:"SelectAll",value:function(){this.DeselectAll();var t=0,n=0,i=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){n=0,e.children.forEach(function(e){i.SelectCell(t,n,!0),n++}),t++})})}},{key:"AddSelectedCellsToClipboard",value:function(e){var t=0<arguments.length&&void 0!==e&&e,n=this.rootNode.document,e=p.BlockNode.CreateNew(n,"table");e.SetAttributes([{name:"class",value:"commaSpreadsheetTable"}]),e.SetPluginType(this.rootNode.GetPluginType());var i=p.BlockNode.CreateNew(n,"tbody"),o=this,r=void 0,s=void 0;this.selectedNodes.forEach(function(e){var t=o.GetCoordinatesPerNode(e.id);s!=t.row&&(null!=r&&i.Append(r),s=t.row,r=p.BlockNode.CreateNew(n,"tr")),r.Append(e.Copy())}),null!=r&&i.Append(r),e.Append(i),t&&this.DeleteContentOfSelectedCells(),this.rootNode.document.ForceClipboardContent(e.domElement)}},{key:"PasteCells",value:function(e){var t,r,n=!1,s=this,i=(new DOMParser).parseFromString(e,"text/html").body.firstElementChild;return null==i||null!=(e=[].slice.call(i.getElementsByTagName("tr")))&&0<e.length&&(n=!0,i=this.selectedNodes[0],t=this.GetCoordinatesPerNode(i.id),r=t.row,e.forEach(function(e){var o=t.col;[].slice.call(e.getElementsByTagName("td")).forEach(function(e){var t,n,i;o<s.GetNumberOfColumns()&&r<s.GetNumberOfRows()&&null!=(t=s.GetNodePerCoordinates(r,o))&&(n=t.GetFirstTextNode(),null==(i=s.functionsManager.GetFunctionFromDomNode(e))||""==i?(n.ForceTextContent(e.textContent.toString()),g.a.Format(t)):s.functionsManager.CopyFunctionToNode(i,t)),o++}),r++})),n&&(this.functionsManager.RecalculateAll(),this.PushToHistory()),n}},{key:"Fire",value:function(e,t,n,i){var o=JSON.parse(JSON.stringify(e));e==p.PluginActions.NEW_CHAR_ADDED&&"Backspace"==i.key&&1<this.selectedNodes.length&&(o=p.PluginActions.DELETE);var r,s,a,l=!1,c=this,u=void 0;switch(o){case p.PluginActions.LOST_FOCUS:this.CloseSettingsPanel(),this.DeselectAll(),this.StopFunctionEditing();break;case p.PluginActions.BEFORE_PASTE:var h=i.clipboardData.getData("text/html");null!=h&&""!=h||(h=i.clipboardData.getData("text")),l=this.PasteCells(h);break;case p.PluginActions.BEFORE_COPY:var d=!0;1==this.selectedNodes.length&&(this.rootNode.document.selectionManager.IsCollapsed()?d=!0:(f=this.selectedNodes[0].domElement.textContent,null!=window.getSelection()&&(d=window.getSelection().toString()==f))),d&&(this.AddSelectedCellsToClipboard(),l=!0);break;case p.PluginActions.BEFORE_CUT:var f=!0;1==this.selectedNodes.length&&(this.rootNode.document.selectionManager.IsCollapsed()?f=!0:(d=this.selectedNodes[0].domElement.textContent,null!=window.getSelection()&&(f=window.getSelection().toString()==d))),f&&(this.AddSelectedCellsToClipboard(!0),l=!0);break;case p.PluginActions.SELECT_ALL:1==this.selectedNodes.length&&this.selectedNodes[0].SelectWholeTextContent(),l=!0;break;case p.PluginActions.SHIFT_DOWN:case p.PluginActions.SHIFT_UP:break;case p.PluginActions.ARROW_UP:null!=t&&null!=t.parent&&("td"==t.parent.tagName?u=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(u=t.parent.parent)),null!=u&&(c.MoveCellFocus("UP",u),l=!0);break;case p.PluginActions.ARROW_DOWN:null!=t&&null!=t.parent&&("td"==t.parent.tagName?u=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(u=t.parent.parent)),null!=u&&(c.MoveCellFocus("DOWN",u),l=!0);break;case p.PluginActions.ARROW_LEFT:null!=t&&null!=t.parent&&("td"==t.parent.tagName?u=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(u=t.parent.parent)),null!=u&&(s=!0,c.useArrowsForText&&(s=!1,null!=(r=u.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""))&&""!=r&&0!=u.document.GetCursorPosition().startOffset||(s=!0)),s&&(c.MoveCellFocus("LEFT",u),l=!0));break;case p.PluginActions.ARROW_RIGHT:null!=t&&null!=t.parent&&("td"==t.parent.tagName?u=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(u=t.parent.parent)),null!=u&&(r=!0,c.useArrowsForText&&(r=!1,null!=(s=u.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""))&&""!=s&&u.document.GetCursorPosition().startOffset!=s.length||(r=!0)),r&&(c.MoveCellFocus("RIGHT",u),l=!0));break;case p.PluginActions.SHIFT_ARROW_UP:case p.PluginActions.SHIFT_ARROW_DOWN:case p.PluginActions.SHIFT_ARROW_LEFT:case p.PluginActions.SHIFT_ARROW_RIGHT:break;case p.PluginActions.ENTER:l=!0,null!=t&&null!=t.parent&&("td"==t.parent.tagName?u=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(u=t.parent.parent)),null!=u&&c.MoveCellFocus("DOWN",u);break;case p.PluginActions.NEW_CHAR_ADDED:null!=t&&null!=t.parent&&null!=t.parent.parent&&"td"==t.parent.parent.tagName&&("="==t.parent.parent.domElement.textContent?(t.ForceTextContent(""),this.StartFunctionEditing(t.parent.parent)):(a=t.parent.parent,null==c.prevTimeoutOnTyping&&(c.prevTimeoutOnTyping={}),null!=c.prevTimeoutOnTyping[a.id]&&clearTimeout(c.prevTimeoutOnTyping[a.id]),c.prevTimeoutOnTyping[a.id]=setTimeout(function(){g.a.Format(a),c.functionsManager.CellValueChanged(a)},2e3)));break;case p.PluginActions.APPLY_STYLE_ON_LINE:null==t&&this.ApplyStyleOnSelectedLines(i.styleName,i.value);break;case p.PluginActions.APPLY_STYLE_ON_TEXT:null==t&&this.ApplyStyleOnSelectedCells(i.styleName,i.value);break;case p.PluginActions.DELETE:this.editingFunction||(this.DeleteContentOfSelectedCells(!0),l=!0);break;case p.PluginActions.CANCEL_FROM_TOP:l=!0;break;case p.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),l=!1;break;case p.PluginActions.TAB:this.MoveToNextCell(),l=!0;break;default:return void this.CloseSettingsPanel()}return l}},{key:"AddRows",value:function(e){for(var n=this,i=0;i<e;)!function(){var t=f.AddRow(n.GetNumberOfRows()+i,n.rootNode.document,n.GetNumberOfColumns()).tr;n.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.Append(t)}),i++}();this.Init()}},{key:"AddColumns",value:function(e){for(var n=this,i=this.rootNode.document,o=0;o<e;)!function(){var t=n.GetNumberOfColumns()+o;n.tableNode.children.forEach(function(e){"thead"==e.tagName.toLowerCase()?e.children.forEach(function(e){e.Append(f.AddCellColumn(i,t))}):"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.Append(f.AddNormalCell(i))})}),o++}();this.Init()}},{key:"TransformTableInSpreadsheet",value:function(){var e=this.rootNode,t=this,n=this.id,i=this.rootNode.GetPluginType(),o=e.document,r=e.InsertEmptyBlockNodeBefore("div");r.SetAttributes([{name:"class",value:"spreadsheetContainer"}]),r.SetPluginType(i),r.Append(f.CreateHeader(o));var s=p.BlockNode.CreateNew(o,"table",void 0,[{name:"class",value:"commaSpreadsheetTable"}]),a=0,l=[];e.children.forEach(function(e){"tbody"==e.tagName?e.children.forEach(function(e){0==a&&(a=e.children.length),l.push(e)}):"tr"==e.tagName&&(0==a&&(a=e.children.length),l.push(e))});var c=p.BlockNode.CreateNew(o,"thead"),i=f.AddColsCounterRow(o,a+1);c.Append(i),s.Append(c);var u=p.BlockNode.CreateNew(o,"tbody"),h=void 0,d=1;l.forEach(function(e){var t=p.BlockNode.CreateNew(o,"td",void 0,[],!0,d);t.SetAttributes([{name:"class",value:"commaSpreadsheetCellCounter csRowCounterCell"}]),t.SetAttributes([{name:"contentEditable",value:!1}]),null==h&&(h=e.children[0].GetFirstTextNode()),e.Append(t,0),u.Append(e),d++}),s.Append(u),r.Append(s),o.DeleteNode(e);s=r.InsertEmptyBlockNodeAfter("div"),e=p.TextNode.CreateNew(o,"span","");e.ToggleStyle("fontColor","#475666"),s.Append(e),this.rootNode=r,this.id=r.id,o.ChangePluginInstanceId(n,r.id),setTimeout(function(){h.SetFocus(),t.SelectCell(0,1),t.ShowAutofillHandle()},100)}},{key:"Import",value:function(e){var t,o,r,n,i,s,a,l;0<e.length&&(o=(t=this).rootNode.document,s=e[0].length,r=void 0,n=p.BlockNode.CreateNew(o,"table",void 0,[{name:"class",value:"commaSpreadsheetTable"}]),i=p.BlockNode.CreateNew(o,"thead"),s=f.AddColsCounterRow(o,s+1),i.Append(s),n.Append(i),a=p.BlockNode.CreateNew(o,"tbody"),l=1,e.forEach(function(e){var n=p.BlockNode.CreateNew(o,"tr"),i=0;e.forEach(function(e){var t=void 0;0==i?t=f.AddCell(o,!0,!1,l):(t=f.AddCell(o)).td.GetFirstTextNode().ForceTextContent(e),null==r&&(r=t.nodeForFocus),n.Append(t.td),i++}),a.Append(n),l++}),n.Append(a),o.DeleteNode(this.tableNode),this.rootNode.Append(n),this.Init(),setTimeout(function(){r.SetFocus(),t.SelectCell(0,1),t.ShowAutofillHandle()},100))}},{key:"Export",value:function(){var i=[];return this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){var t=[],n=!0;e.children.forEach(function(e){n?n=!1:t.push(e.domElement.textContent.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""))}),i.push(t)})}),i}}],[{key:"toColumnName",value:function(e){for(var t="",n=1,i=26;0<=(e-=n);n=i,i*=26)t=String.fromCharCode(parseInt(e%i/n)+65)+t;return t}},{key:"AddRow",value:function(e,t,n){for(var i=p.BlockNode.CreateNew(t,"tr"),o=0,r=void 0;o<n;){var s=0==o?f.AddCell(t,!0,!1,e):f.AddCell(t);null==r&&(r=s.nodeForFocus),i.Append(s.td),o++}return{tr:i,nodeForFocus:r}}},{key:"AddColsCounterRow",value:function(e,t){for(var n=p.BlockNode.CreateNew(e,"tr"),i=0;i<t;){var o=0==i?f.AddCell(e,!1,!0,"",!0):f.AddCell(e,!1,!0,f.toColumnName(i));n.Append(o.td),i++}return n}},{key:"AddCellColumn",value:function(e,t){return f.AddCell(e,!1,!0,f.toColumnName(t)).td}},{key:"AddNormalCell",value:function(e){return f.AddCell(e,!1,!1,"",!0).td}},{key:"AddCell",value:function(e,t,n,i,o){var r=1<arguments.length&&void 0!==t&&t,t=2<arguments.length&&void 0!==n&&n,n=3<arguments.length&&void 0!==i?i:0,i=4<arguments.length&&void 0!==o&&o,o=void 0,o=t?p.BlockNode.CreateNew(e,"th",void 0,[],!0,n):r?(n+=1,p.BlockNode.CreateNew(e,"td",void 0,[],!0,n)):p.BlockNode.CreateNew(e,"td");r||t?(o.SetAttributes([{name:"class",value:"commaSpreadsheetCellCounter"}]),(r||i)&&o.SetAttributes([{name:"class",value:"commaSpreadsheetCellCounter csRowCounterCell"}])):o.SetAttributes([{name:"class",value:"commaSpreadsheetCell"}]);i=void 0;return r||t?o.SetAttributes([{name:"contentEditable",value:!1}]):(r=p.BlockNode.CreateNew(e,"div"),t=e.GetDefaultNodeStyle(),(i=p.TextNode.CreateNew(e,"span","",t)).ToggleStyle("fontColor","#475666"),r.Append(i),o.Append(r)),{td:o,nodeForFocus:i}}},{key:"CreateHeader",value:function(e){var t=p.BlockNode.CreateNew(e,"div",void 0,[{name:"class",value:"functContainer"},{name:"contentEditable",value:!1}]),n=p.BlockNode.CreateNew(e,"div",void 0,[{name:"class",value:"functBoxFxLabel"}],!0,"f(x)");t.Append(n);n=p.BlockNode.CreateNew(e,"input",void 0,[{name:"class",value:"functInputBox"}]);t.Append(n);n=p.BlockNode.CreateNew(e,"i",void 0,[{name:"class",value:"fa fa-download cscfe_functBtn"},{name:"title",value:"Export as CSV"}]);t.Append(n);e=p.BlockNode.CreateNew(e,"i",void 0,[{name:"class",value:"fa fa-upload cscfe_functBtn"},{name:"title",value:"Import CSV"}]);return t.Append(e),t}},{key:"CreateNew",value:function(e,t){t.cols=JSON.parse(t.cols)+1,e.GetStyleAtCurrentCursorPosition();var n=e.GetDefaultNodeStyle(),i=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("div");i.SetAttributes([{name:"class",value:"spreadsheetContainer"}]),i.Append(f.CreateHeader(e));var o=p.BlockNode.CreateNew(e,"table",void 0,[{name:"class",value:"commaSpreadsheetTable"}]),r=p.BlockNode.CreateNew(e,"thead"),s=f.AddColsCounterRow(e,t.cols);r.Append(s),o.Append(r);for(var a=p.BlockNode.CreateNew(e,"tbody"),l=t.rows,c=void 0,u=0;u<l;){var h=f.AddRow(u,e,t.cols);null==c&&(c=h.nodeForFocus),a.Append(h.tr),u++}o.Append(a),i.Append(o);o=i.InsertEmptyBlockNodeAfter("div"),n=p.TextNode.CreateNew(e,"span","",n.Copy());n.ToggleStyle("fontColor","#475666"),o.Append(n);var d=new f(i);return setTimeout(function(){c.SetFocus(),d.SelectCell(0,1),d.ShowAutofillHandle()},100),d}}]),f}(),A=t.default=n}],e={},f.m=d,f.c=e,f.d=function(e,t,n){f.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},f.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},f.t=function(t,e){if(1&e&&(t=f(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(f.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)f.d(n,i,function(e){return t[e]}.bind(null,i));return n},f.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return f.d(t,"a",t),t},f.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},f.p="/",f(f.s=3);function f(t){if(e[t])return e[t].exports;var n=e[t]={i:t,l:!1,exports:{}};return d[t].call(n.exports,n,n.exports,f),n.l=!0,n.exports}var d,e},module.exports=GSb(__webpack_require__(0))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var l=n(0);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(a,l.Plugin);var n,i,o=(n=a,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=h(n);return!(t=i?(e=h(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==r(t)&&"function"!=typeof t?u(this):t});function a(e){!function(e){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this);var t=u(e=o.call(this,e));return e.endResizing=function(e){t.EndResizing(e)},e.resizing=function(e){t.resizingRunning=!0,t.Resize(e)},e.readOnly=e.rootNode.document.readOnly,e.InitializeDomElements(),e}return s(a,null,[{key:"GetName",value:function(){return"stickyNote"}}]),s(a,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#345-23")):this.readOnly||this.Init()}},{key:"Init",value:function(){var e,t;null==this.rootNode.next&&(e=this.rootNode.InsertEmptyBlockNodeAfter("div"),t=l.TextNode.CreateNew(this.rootNode.document,"span","",this.rootNode.document.GetDefaultNodeStyle().Copy()),e.Append(t));var n=this;this.rootNode.domElement.addEventListener("mousemove",function(e){n.ShowPointerOnRightBorder(e,this)}),this.rootNode.domElement.addEventListener("mousedown",function(e){n.ShowPointerOnRightBorder(e,this)&&n.StartResizing(e)})}},{key:"ShowPointerOnRightBorder",value:function(e,t){var n=!1,i=e,e=t.getBoundingClientRect(),e=e.left+e.width;return t.style.cursor="auto",i.pageX<e&&i.pageX>e-10&&(t.style.cursor="col-resize",n=!0),n}},{key:"Resize",value:function(e){var t=e.pageX+window.scrollX-this.prevX;this.prevX=e.pageX+window.scrollX;t=this.rootNode.domElement.getBoundingClientRect().width+t;this.rootNode.domElement.style.width=t+"px"}},{key:"StartResizing",value:function(e){this.resizingRunning=!0,this.prevX=e.pageX+window.scrollX,document.body.addEventListener("mouseup",this.endResizing),document.body.addEventListener("mousemove",this.resizing)}},{key:"EndResizing",value:function(e){var t;null!=e&&(t=this.rootNode.domElement.getBoundingClientRect(),e=window.innerWidth,e=parseInt(100*t.width/e)+"vw",this.rootNode.ToggleStyle("width",e,!0,!0)),this.resizingRunning=!1,document.body.removeEventListener("mousemove",this.resizing),document.body.removeEventListener("mouseup",this.endResizing)}},{key:"Fire",value:function(e,t,n){var i=!1;switch(e){case l.PluginActions.LOST_FOCUS:case l.PluginActions.CLICK:this.resizingRunning&&this.EndResizing();break;case l.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),i=!1;break;default:return}return i}}],[{key:"CreateNew",value:function(e,t){var n="#ffefa1",i=void 0;null!=t?(t.type="inline",null!=t.bgColor&&(n=t.bgColor),null!=t.textColor&&(i=t.textColor)):t={type:"inline"};var o=new l.NodeStyle(e,e.GetStyleAtCurrentCursorPosition().nodeStyle).Copy(),r=void 0;"floating"==t.type?(t=e.GetFloatingContainer(),(r=l.BlockNode.CreateNew(e,"div")).SetAttributes([{name:"class",value:"commaStickyNoteFloating"},{name:"contentEditable",value:!0}]),t.Append(r)):(r=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("div")).SetAttributes([{name:"class",value:"commaStickyNote"}]),r.ToggleStyle("backgroundColor",n,!0,!0);var n=l.BlockNode.CreateNew(e,"div"),s=l.TextNode.CreateNew(e,"span","",o.Copy());return n.Append(s),r.Append(n),setTimeout(function(){s.SetFocus(),null!=i&&e.ToggleStyleOnSelection("fontColor",i)},50),new a(r)}}]),a}();t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var s=n(0);function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var a=(i(o.prototype,[{key:"InitPanel",value:function(){function e(e){t.MouseDown(e,this)}var t=this;this.panel=document.createElement("div"),this.panel.setAttribute("class","comma-img-resizable");var n=document.createElement("div");n.setAttribute("class","comma-img-resizers");var i=document.createElement("div");i.setAttribute("class","comma-img-resizer cir-top-left"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i);i=document.createElement("div");i.setAttribute("class","comma-img-resizer cir-top-right"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i);i=document.createElement("div");i.setAttribute("class","comma-img-resizer cir-bottom-left"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i);var o,r,i=document.createElement("div");function s(){t.Hide()}i.setAttribute("class","comma-img-resizer cir-bottom-right"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i),this.showEditingBtn&&((r=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-edit"),o=function(e){t.OpenEditingPanel(e)},r.removeEventListener("mousedown",o),r.addEventListener("mousedown",o),n.appendChild(r)),this.showMagnifyBtn&&((o=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-search-plus"),o.style.marginLeft="6px",r=function(e){t.MagnifyImage(e)},o.removeEventListener("mousedown",r),o.addEventListener("mousedown",r),n.appendChild(o)),this.panel.removeEventListener("mousedown",s),this.panel.addEventListener("mousedown",s),this.panel.appendChild(n),document.body.appendChild(this.panel)}},{key:"Show",value:function(){this.shown=!0,this.panel.style.display="block",this.RenderPanel()}},{key:"RenderPanel",value:function(){var e=this.img.getBoundingClientRect();this.panel.style.top=e.top+window.scrollY+"px",this.panel.style.left=e.left+window.scrollX+"px",this.panel.style.width=e.width+"px",this.panel.style.height=e.height+"px"}},{key:"Hide",value:function(){this.shown=!1,this.panel.style.display="none"}},{key:"MouseDown",value:function(e,t){var n=this;function i(e){n.StopResize(e)}function o(e){n.Resize(e,t)}this.px=e.pageX,this.f_resize=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"Resize",value:function(e,t){var n=e.pageX,i=n-this.px;this.img.style.height="auto";var o=parseInt(getComputedStyle(this.img).width.replace("px",""));t.classList.contains("cir-bottom-right")||t.classList.contains("cir-top-right")?o+=i:o-=i,this.img.style.width=o+"px",this.panel.style.width=o+"px",this.panel.style.height=getComputedStyle(this.img).height,this.px=n,this.RenderPanel(),e.preventDefault(),e.stopPropagation()}},{key:"StopResize",value:function(e){window.removeEventListener("mousemove",this.f_resize),this.imgPluginInstance.PushToHistory(),e.preventDefault(),e.stopPropagation()}},{key:"OpenEditingPanel",value:function(e){this.imgPluginInstance.OpenEditingPanel(),e.preventDefault(),e.stopPropagation()}},{key:"MagnifyImage",value:function(e){this.imgPluginInstance.MagnifyImage(),e.preventDefault(),e.stopPropagation()}}]),o);function o(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];!function(e){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this),this.img=e,this.imgPluginInstance=t,this.panel=void 0,this.shown=!1,this.showEditingBtn=n,this.showMagnifyBtn=i,this.InitPanel()}function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(r,s.Plugin);var i,o,t=(i=r,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=h(i),n=this;return!(t=o?(e=h(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==l(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function r(e){return function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e)).readOnly=e.rootNode.document.readOnly,e.InitializeDomElements(),e}return c(r,null,[{key:"GetName",value:function(){return"video"}}]),c(r,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#545-27")):this.readOnly||this.Init()}},{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"Init",value:function(){var e=this;function t(){}function n(){}function i(){e.resizeManager.Show()}this.resizeManager=new a(this.rootNode.domElement,this,!1,!1),this.rootNode.domElement.removeEventListener("mousemove",t),this.rootNode.domElement.addEventListener("mousemove",t),this.rootNode.domElement.removeEventListener("mouseout",n),this.rootNode.domElement.addEventListener("mouseout",n),this.rootNode.domElement.removeEventListener("click",i),this.rootNode.domElement.addEventListener("click",i)}},{key:"Fire",value:function(e){return e===s.PluginActions.LOST_FOCUS&&this.resizeManager.Hide(),!1}}],[{key:"CreateNew",value:function(e,t){e.DeleteSelection();var n=t.link,i=t.mimeType;"video/quicktime"==i&&(i="video/mp4");t=s.InlineNode.CreateNew(e,"video","",void 0,[{name:"class",value:"commaVideo"},{name:"controls",value:""}]);e.InsertNodeAtCursor(t);i=s.TextNode.CreateNew(e,"source","",void 0,[{name:"src",value:n},{name:"type",value:i}]);return t.Append(i),new r(t)}},{key:"GetTagToParseOnPaste",value:function(){return["video"]}},{key:"CreateNewFromPastedNode",value:function(e,t){var n=t.getAttribute("src"),i=t.getAttribute("type");"video/quicktime"==i&&(i="video/mp4");t=s.InlineNode.CreateNew(e,"video","",void 0,[{name:"class",value:"commaVideo"},{name:"controls",value:""}]),i=s.TextNode.CreateNew(e,"source","",void 0,[{name:"src",value:n},{name:"type",value:i}]);return t.Append(i),new r(t)}}]),r}();t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"CommaMentionsFactory",function(){return g}),n.d(t,"CommaMention",function(){return r});var s=n(0);function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var r=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(r,s.Plugin);var i,o,t=(i=r,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=u(i),n=this;return!(t=o?(e=u(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==a(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function r(e){return function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e)).options=e.rootNode.document.GetPluginOptions("mentions"),e.InitializeDomElements(),e}return l(r,null,[{key:"GetName",value:function(){return"mentions"}}]),l(r,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#555-23")):this.Init()}},{key:"Init",value:function(){var e,t=this,n=this.rootNode.domElement,i=n.getAttribute("cm-ment-entry");this.entry=void 0,null==i||""==i?(this.entry=JSON.parse(n.getAttribute("cm-ment-params")),e=n.getAttribute("cm-ment-type"),this.entry.mentionType=e):null!=i&&""!=i&&(this.entry=JSON.parse(s.Base64.decode(i))),n.addEventListener("click",function(){t.Click()}),n.addEventListener("mouseover",function(){t.MouseOver()}),n.addEventListener("mouseout",function(){t.MouseOut()})}},{key:"Click",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnClick&&this.options.externalFunctions.OnClick(this.entry,this.rootNode)}},{key:"MouseOver",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMouseOver&&this.options.externalFunctions.OnMouseOver(this.entry,this.rootNode)}},{key:"MouseOut",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMouseOut&&this.options.externalFunctions.OnMouseOut(this.entry,this.rootNode)}},{key:"OnMentionDeleted",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMentionDeleted&&this.options.externalFunctions.OnMentionDeleted(this.entry,this.rootNode)}},{key:"Fire",value:function(e){return e===s.PluginActions.NODE_UNREGISTERED&&this.OnMentionDeleted(),!1}}],[{key:"CreateNew",value:function(e,t){e.DeleteSelection();var n=e.GetStyleAtCurrentCursorPosition();null!=n.nodeStyle&&null!=n.nodeStyle.fontSize&&n.nodeStyle.fontSize.on;var n=t,t=s.Base64.encode(JSON.stringify(n)),i=s.InlineNode.CreateNew(e,"span","",void 0,[{name:"cm-ment-entry",value:t},{name:"contenteditable",value:!1}]);if(e.InsertNodeAtCursor(i),!e.GetPluginOptions("mentions").externalFunctions.FormatMention(n,i)){n=new r(i);return setTimeout(function(){null!=i.next&&i.next.isTextNode()&&i.next.SetFocus()},200),n}i.Delete(!0)}}]),r}();function h(e){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var g=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(n,s.Plugin);var i,o,t=(i=n,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=p(i),n=this;return!(t=o?(e=p(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))||"object"!==h(t)&&"function"!=typeof t?function(){if(void 0!==n)return n;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function n(e){return function(e){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e)).options=e.rootNode.document.GetPluginOptions("mentionsFactory"),e.verifyAt=!1,e.searchResults=[],e.searchBoxes=[],e.arrowPosition=-1,e.highlightOnMouse=!1,e.searchingMention=!1,e.preserveTextHasBeenCalculated=!1,e.preserveTextAfterAt="",e}return d(n,null,[{key:"GetName",value:function(){return"mentionsFactory"}}]),d(n,[{key:"Destroy",value:function(){if(null!=this.searchPnl)try{this.searchPnl.parentNode.removeChild(this.searchPnl)}catch(e){}this.rootNode.document.RemovePluginInstance(this.rootNode.id)}},{key:"Search",value:function(e){var t=this;""!=e&&null!=this.options.externalFunctions.Search?(this._startSearching(),this.options.externalFunctions.Search(e).then(function(e){null!=(t.searchResults=e).hits&&(t.searchResults=e.hits),t._stopSearching()},function(e){console.log("Searching for mentions error",e)})):this._stopSearching()}},{key:"_startSearching",value:function(){this.searchingMention||(this.searchingMention=!0,this.UpdatePnl())}},{key:"_stopSearching",value:function(){this.searchingMention=!1,this.UpdatePnl()}},{key:"UpdatePnl",value:function(){for(var e=this.searchPnl;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(this.GenerateResultsPnl())}},{key:"Start",value:function(){var e=this.rootNode.document.GetSelectionBoundingClientRect(),t=e.left+"px",n=300+e.left+16;n>window.innerWidth&&(i=n-window.innerWidth,t=e.left-i+"px");var i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #cccccc",i.style.borderRadius="4px",i.style.backgroundColor="#ffffff",i.style.left=t,i.style.top=window.scrollY+2+e.height+e.top+"px",i.style.width="300px",i.style.minHeight="40px",i.style.maxHeight="160px",i.style.overflow="auto",(this.searchPnl=i).appendChild(this.GenerateResultsPnl()),document.body.appendChild(i)}},{key:"GenerateResultsPnl",value:function(){var e,t,n,i=this,o=document.createElement("div");return 0==this.searchResults.length?(1==this.options.showAbove&&((t=this.rootNode.document.GetSelectionBoundingClientRect().top-48)<0&&(t=0),this.searchPnl.style.top=window.scrollY+t+"px"),o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.margin="10px",(e=document.createElement("div")).style.flex="1",e.style.fontSize="12px",e.style.fontFamily="Verdana",e.style.color="#aaaaaa",this.searchingMention?e.textContent="Searching...":e.textContent="Keep typing to search...",o.appendChild(e),(t=document.createElement("div")).style.color="#aaaaaa",e=document.createElement("i"),this.searchingMention?(t.style.paddingTop="1px",t.style.fontSize="18px",e.setAttribute("class","fa fa-circle-o-notch fa-spin")):(t.style.fontSize="20px",e.setAttribute("class","fa fa-times"),t.style.cursor="pointer",t.addEventListener("mouseover",function(e){this.style.color="#30b7e8"}),t.addEventListener("mouseout",function(e){this.style.color="#aaaaaa"}),t.addEventListener("mousedown",function(e){i.Destroy(),e.preventDefault(),e.stopPropagation()})),t.appendChild(e),o.appendChild(t)):(1==this.options.showAbove&&(t=(e=this.rootNode.document.GetSelectionBoundingClientRect()).top-168,2==this.searchResults.length?t=e.top-108:1==this.searchResults.length&&(t=e.top-58),t<0&&(t=0),this.searchPnl.style.top=window.scrollY+t+"px"),this.searchBoxes=[],this.arrowPosition=-1,this.highlightOnMouse=!1,o.style.opacity="0",n=0,this.searchResults.forEach(function(e){o.appendChild(i.GenerateResultItemPnl(n,e)),n++}),null!=this.prevTimeout&&clearTimeout(this.prevTimeout),this.prevTimeout=setTimeout(function(){o.style.opacity="1"},50)),o}},{key:"GenerateResultItemPnl",value:function(e,t){var n=this,i=this.options.externalFunctions.FormatEntry(t);return null!=i?(i.setAttribute("cm-entry-id",e),i.style.cursor="pointer",i.style.padding="4px 0px 4px 0px",i.setAttribute("tabindex","123"+e),i.addEventListener("mousemove",function(e){n.highlightOnMouse=!0}),i.addEventListener("mouseover",function(e){n.highlightOnMouse&&(i.style.backgroundColor="#ededed")}),i.addEventListener("mouseout",function(e){i.style.backgroundColor="#ffffff"}),i.addEventListener("mousedown",function(e){n.AddMentions(t)})):console.log("Panel undefined - cannot list item",t),this.searchBoxes.push(i),i}},{key:"ManagerArrowUp",value:function(){this.arrowPosition--,this.arrowPosition<0&&(this.arrowPosition=0),this.HighlightEntry()}},{key:"ManagerArrowDown",value:function(){this.arrowPosition++,this.arrowPosition>=this.searchBoxes.length&&(this.arrowPosition=this.searchBoxes.length-1),this.HighlightEntry()}},{key:"HighlightEntry",value:function(){var e;this.searchBoxes.forEach(function(e){e.style.backgroundColor="#ffffff"}),-1<this.arrowPosition&&this.arrowPosition<this.searchBoxes.length&&((e=this.searchBoxes[this.arrowPosition]).style.backgroundColor="#ededed",e.scrollIntoView(!1))}},{key:"AddMentionFromKeyboard",value:function(){var e;-1==this.arrowPosition&&(this.arrowPosition=0),-1<this.arrowPosition&&this.arrowPosition<this.searchBoxes.length&&(e=this.searchBoxes[this.arrowPosition],e=parseInt(e.getAttribute("cm-entry-id")),null!=(e=this.searchResults[e])&&this.AddMentions(e))}},{key:"AddMentions",value:function(e){var t=this.rootNode.text.indexOf("@"),n=this.rootNode.text.length-this.preserveTextAfterAt.length,n={idStartNode:this.rootNode.id,idEndNode:this.rootNode.id,startOffset:t,endOffset:n};this.rootNode.document.SetCursorPosition(n),this.rootNode.document.DeleteSelection(n),this.rootNode.document.InsertPluginAtSection(r.GetName(),e),this.Destroy()}},{key:"CalculateTextToPreserver",value:function(){this.preserveTextHasBeenCalculated=!0;var e=this.rootNode.text.indexOf("@")+1;this.preserveTextAfterAt=this.rootNode.text.substring(e)}},{key:"Fire",value:function(e){var t=!1;switch(this.preserveTextHasBeenCalculated||this.CalculateTextToPreserver(),e){case s.PluginActions.LOST_FOCUS:this.Destroy();break;case s.PluginActions.ARROW_UP:t=!0,this.ManagerArrowUp();break;case s.PluginActions.ARROW_DOWN:t=!0,this.ManagerArrowDown();break;case s.PluginActions.DELETE:case s.PluginActions.DELETE_TOP:case s.PluginActions.DELETE_FROM_BOTTOM:case s.PluginActions.CANCEL_FROM_TOP:case s.PluginActions.CANCEL_FROM_BOTTOM:case s.PluginActions.DELETE_BEFORE_INLINE:case s.PluginActions.CANCEL_BEFORE_INLINE:case s.PluginActions.NODE_UNREGISTERED:-1==this.rootNode.text.indexOf("@")?this.Destroy():this.verifyAt=!0;break;case s.PluginActions.ENTER:case s.PluginActions.TAB:t=!0,this.AddMentionFromKeyboard();break;case s.PluginActions.ESC:this.Destroy(),t=!0;break;case s.PluginActions.NEW_CHAR_ADDED:var n=event.key;"Tab"!=n&&"Meta"!=n&&"Shift"!=n&&"Alt"!=n&&"Control"!=n&&"Down"!=n&&"ArrowDown"!=n&&"Up"!=n&&"ArrowUp"!=n&&"Left"!=n&&"ArrowLeft"!=n&&"Right"!=n&&"ArrowRight"!=n&&"CapsLock"!=n&&"Enter"!=n&&"Esc"!=n&&"Escape"!=n&&("Backspace"==n&&(this.verifyAt=!0),n=!0,this.verifyAt&&(this.verifyAt=!1,-1==this.rootNode.text.indexOf("@")&&(this.Destroy(),n=!1)),n&&(n=this.rootNode.text.indexOf("@")+1,n=this.rootNode.text.substring(n),0<this.preserveTextAfterAt.length&&(n=n.slice(0,-1*this.preserveTextAfterAt.length)),this.Search(n)));break;default:return}return t}}],[{key:"CreateNew",value:function(e){e=new n(e.GetNodeAtCursor());return e.Start(),e}}]),n}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var r=n(0);function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var s=(i(o.prototype,[{key:"InitPanel",value:function(){function e(e){t.MouseDown(e,this)}var t=this;this.panel=document.createElement("div"),this.panel.setAttribute("class","comma-img-resizable");var n=document.createElement("div");n.setAttribute("class","comma-img-resizers");var i,o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-top-left"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o),(o=document.createElement("div")).setAttribute("class","comma-img-resizer cir-top-right"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o),(o=document.createElement("div")).setAttribute("class","comma-img-resizer cir-bottom-left"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o),(o=document.createElement("div")).setAttribute("class","comma-img-resizer cir-bottom-right"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o),this.showEditingBtn&&((i=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-edit"),o=function(e){t.OpenEditingPanel(e)},i.removeEventListener("mousedown",o),i.addEventListener("mousedown",o),n.appendChild(i)),this.showMagnifyBtn&&((r=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-search-plus"),r.style.marginLeft="6px",i=function(e){t.MagnifyImage(e)},r.removeEventListener("mousedown",i),r.addEventListener("mousedown",i),n.appendChild(r));var r=function(){t.Hide()};this.panel.removeEventListener("mousedown",r),this.panel.addEventListener("mousedown",r),this.panel.appendChild(n),document.body.appendChild(this.panel)}},{key:"Show",value:function(){this.shown=!0,this.panel.style.display="block",this.RenderPanel()}},{key:"RenderPanel",value:function(){var e=this.img.getBoundingClientRect();this.panel.style.top=e.top+window.scrollY+"px",this.panel.style.left=e.left+window.scrollX+"px",this.panel.style.width=e.width+"px",this.panel.style.height=e.height+"px"}},{key:"Hide",value:function(){this.shown=!1,this.panel.style.display="none"}},{key:"MouseDown",value:function(e,t){var n=this;function i(e){n.StopResize(e)}function o(e){n.Resize(e,t)}this.px=e.pageX,this.f_resize=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"Resize",value:function(e,t){var n=e.pageX,i=n-this.px,o=parseInt(getComputedStyle(this.img).width.replace("px",""));t.classList.contains("cir-bottom-right")||t.classList.contains("cir-top-right")?o+=i:o-=i;var r=parseInt(getComputedStyle(this.img).height.replace("px",""));t.classList.contains("cir-bottom-right")||t.classList.contains("cir-top-right")?r+=i:r-=i,this.img.style.width=o+"px",this.img.style.height=r+"px",this.panel.style.width=o+"px",this.panel.style.height=getComputedStyle(this.img).height,this.px=n,this.RenderPanel(),e.preventDefault(),e.stopPropagation()}},{key:"StopResize",value:function(e){window.removeEventListener("mousemove",this.f_resize),this.imgPluginInstance.PushToHistory(),e.preventDefault(),e.stopPropagation()}},{key:"OpenEditingPanel",value:function(e){this.imgPluginInstance.OpenEditingPanel(),e.preventDefault(),e.stopPropagation()}},{key:"MagnifyImage",value:function(e){this.imgPluginInstance.MagnifyImage(),e.preventDefault(),e.stopPropagation()}}]),o);function o(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];!function(e){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this),this.img=e,this.imgPluginInstance=t,this.panel=void 0,this.shown=!1,this.showEditingBtn=n,this.showMagnifyBtn=i,this.InitPanel()}function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),e}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(o,r.Plugin);var n,i,t=(n=o,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e=h(n),t=i?(t=h(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),e=this;return!t||"object"!==a(t)&&"function"!=typeof t?function(){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function o(e){return function(e){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e)).readOnly=e.rootNode.document.readOnly,e}return c(o,null,[{key:"GetName",value:function(){return"youtube"}}]),c(o,[{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"PluginDidMount",value:function(){var e,t=this;this.rootNode.domElement.style.display="inline-block",this.rootNode.domElement.style.position="relative",this.rootNode.domElement.firstChild.style.pointerEvents="none",this.rootNode.domElement.firstChild.position="absolute",this.rootNode.domElement.firstChild.top=0,this.rootNode.domElement.firstChild.left=0,this.rootNode.domElement.firstChild.width="100%",this.rootNode.domElement.firstChild.height="100%",this.readOnly||(this.resizeManager=new s(this.rootNode.domElement,this,!1,!1),e=function(){t.resizeManager.Show(),t.rootNode.domElement.firstChild.style.pointerEvents="auto"},this.rootNode.domElement.removeEventListener("click",e),this.rootNode.domElement.addEventListener("click",e))}},{key:"Fire",value:function(e){return e==r.PluginActions.LOST_FOCUS&&null!=this.resizeManager&&(this.resizeManager.Hide(),null!=this.rootNode.domElement.firstChild&&(this.rootNode.domElement.firstChild.style.pointerEvents="none")),!1}}],[{key:"getVideoId",value:function(e){return(e=e.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/))&&11===e[2].length?e[2]:null}},{key:"CreateNew",value:function(e,t){e.DeleteSelection(),e.GetNodeAtCursor();var n="https://www.youtube.com/embed/"+o.getVideoId(t.link);return(t=r.InlineNode.CreateNew(e,"span","")).domElement.style.display="inline-block",e.InsertNodeAtCursor(t),n=r.TextNode.CreateNew(e,"iframe","",void 0,[{name:"class",value:"commaYouTubeVideo"},{name:"src",value:n},{name:"allowfullscreen",value:""}]),t.Append(n),n=new o(t),t.domElement.style.width="426px",t.domElement.style.height="240px",n}}]),o}(),t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r;window,e.exports=(r={},o.m=i=[function(e,t,n){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n.r(t),n.d(t,"default",function(){return o});var o=(i(r.prototype,[{key:"Init",value:function(){var t=this,e=this.GetMainPnl();null!=e&&(e.addEventListener("dragenter",function(e){t.ShowDropPanel(),e.preventDefault()}),e.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation()}))}},{key:"GetMainPnl",value:function(){return"string"==typeof this.idEditor?document.getElementById(this.idEditor):this.idEditor}},{key:"ShowDropPanel",value:function(){var e,t,n=this;this.showingDropPanl||(this.showingDropPanl=!0,null!=(t=this.GetMainPnl())&&((e=document.createElement("div")).style.backgroundColor="rgba(156, 156, 156,0.4)",e.style.position="absolute",e.style.display="flex",e.style.justifyContentsplay="center",e.style.alignItems="stretch",e.style.zIndex=99999,t=t.getBoundingClientRect(),e.style.width=t.width+"px",e.style.height=t.height+"px",e.style.left=window.scrollX+t.left+"px",e.style.top=window.scrollY+t.top+"px",(t=document.createElement("div")).style.border="2px dotted rgba(156, 156, 156, 0.8)",t.style.borderRadius="10px",t.style.margin="30px",t.style.flex=1,t.style.pointerEvents="none",e.appendChild(t),e.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()}),e.addEventListener("dragleave",function(e){n.HideDropPanel()}),e.addEventListener("drop",function(e){n.HideDropPanel(),n.ManageDrop(e),e.preventDefault(),e.stopPropagation()}),this.overPnl=e,document.body.appendChild(this.overPnl)))}},{key:"HideDropPanel",value:function(){this.showingDropPanl=!1,null!=this.overPnl&&(this.overPnl.parentElement.removeChild(this.overPnl),this.overPnl=void 0)}},{key:"ManageDrop",value:function(e){var t=[];if(e.dataTransfer.items)for(var n,i=0;i<e.dataTransfer.items.length;i++)"file"===e.dataTransfer.items[i].kind&&(n=e.dataTransfer.items[i].getAsFile(),t.push(n));else for(i=0;i<e.dataTransfer.files.length;i++)t.push(e.dataTransfer.files[i]);null!=this.onFilesDrop?this.onFilesDrop(t):console.log("CommaJS: please specify a function to handle file(s) drop")}}]),r);function r(e,t){!function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this),this.idEditor=e,this.showingDropPanl=!1,this.onFilesDrop=t,null!=this.onFilesDrop&&this.Init()}}],o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=0))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var s=n(0);function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(r,s.Plugin);var n,i,o=(n=r,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e=u(n),t=i?(t=u(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),e=this;return!t||"object"!==a(t)&&"function"!=typeof t?function(){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function r(e){var t;return function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this),(t=o.call(this,e)).preContainer=e.children[0].children[0],t.preContainer.domElement.style.margin="0px",t}return l(r,null,[{key:"GetName",value:function(){return"code"}}]),l(r,[{key:"Fire",value:function(e,t,n,i){var o=!1;switch(e){case s.PluginActions.CANCEL_FROM_TOP:o=!0;break;case s.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),o=!1;break;case s.PluginActions.BEFORE_PASTE:var r=i.clipboardData.getData("text/plain");this.preContainer.ForceInsertString(r),o=!0;break;case s.PluginActions.ENTER:this.preContainer.ForceInsertString("\n"),o=!0;break;case s.PluginActions.TAB:this.preContainer.ForceInsertString("    "),o=!0;break;case s.PluginActions.APPLY_STYLE_ON_LINE:case s.PluginActions.APPLY_STYLE_ON_TEXT:o=!0;break;case s.PluginActions.SELECT_ALL:e=document.createRange(),n=window.getSelection(),null!=(i=this.preContainer.domElement).firstChild&&(r=this.preContainer.text.length,e.setStart(i.firstChild,0),e.setEnd(i.firstChild,r),n.removeAllRanges(),n.addRange(e)),o=!0;break;default:return}return o}}],[{key:"CreateNew",value:function(e){e.DeleteSelection();var t=e.GetCurrentStyle(),n=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("div");n.SetAttributes([{name:"class",value:"commaCodeContainer"}]);var i=s.BlockNode.CreateNew(e,"div"),o=s.TextNode.CreateNew(e,"pre","");return o.ToggleStyle("fontFamily","monospace",!0),o.ToggleStyle("fontSize","14px",!0),i.Append(o),n.Append(i),i=n.InsertEmptyBlockNodeAfter("div"),t=s.TextNode.CreateNew(e,"span"," ",t),i.Append(t),setTimeout(function(){o.SetFocus()},50),new r(n)}}]),r}(),t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return i});var r=n(0),o=n.n(r),t=n(5),s=n.n(t),t=n(6),a=n.n(t),t=n(7),l=n.n(t),t=n(1),c=n.n(t),t=n(8),u=n.n(t),t=n(9),h=n.n(t),t=n(10),d=n.n(t),t=n(3),f=n.n(t),t=n(11),p=n.n(t),t=n(12),g=n.n(t),t=n(2),m=n.n(t),t=n(4),v=n.n(t),y=n(13),t=n(15),b=n.n(t),t=n(14),C=n.n(t),t=n(16),x=n.n(t);function w(t,e){var n,i=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)),i}function S(i){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?w(Object(o),!0).forEach(function(e){var t,n;t=i,e=o[n=e],n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):w(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))})}return i}function _(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var i=function(){function n(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.idEditorContainer=e,this.InitOptions(t),this.commaEditor=new o.a(this.idEditorContainer,this.options),this.options.allowFilesDrop&&new b.a(this.idEditorContainer,this.options.onUploadFiles)}var e,t,i;return e=n,i=[{key:"GetPluginImageName",value:function(){return m.a.GetName()}},{key:"GetPluginVideoName",value:function(){return g.a.GetName()}},{key:"GetPluginListsName",value:function(){return s.a.GetName()}},{key:"GetPluginTableName",value:function(){return a.a.GetName()}},{key:"GetPluginHorizontalRuleName",value:function(){return l.a.GetName()}},{key:"GetPluginLinkName",value:function(){return c.a.GetName()}},{key:"GetPluginTasksName",value:function(){return u.a.GetName()}},{key:"GetPluginMultiColumnsName",value:function(){return h.a.GetName()}},{key:"GetPluginSpreadsheetName",value:function(){return d.a.GetName()}},{key:"GetPluginTableOfContentsName",value:function(){return f.a.GetName()}},{key:"GetPluginOutlineName",value:function(){return f.a.GetName()}},{key:"GetPluginStickyNoteName",value:function(){return p.a.GetName()}},{key:"GetPluginYouTubeName",value:function(){return C.a.GetName()}}],(t=[{key:"InitOptions",value:function(e){this.options={readOnly:!1,content:void 0,styles:void 0,defaultStyle:{fontSize:"14px",fontFamily:"Verdana",fontColor:"#39434d"},defaultLineStyle:{align:"left"},catchUserInput:{characters:["enter"],onCharacterEntered:function(){return!1}},shortcuts:[{shortcut:"Ctrl+w",action:"insertText",params:{text:"E"}},{shortcut:"Ctrl+q",action:"insertPlugin",params:{pluginName:"table",pluginParams:{rows:2,cols:2}}},{shortcut:"Ctrl+q",action:"function",params:function(){console.log("asd")}}],autocorrect:[{string:"\\mu",replaceWith:"Î¼"}],onChange:function(){},onSelectinChange:function(){},styleMonitoring:function(){},onStyleChanged:function(){}};var t=void 0;null!=e&&(t=e.plugins,this.options=S(S({},this.options),e)),this.options.plugins=[{pClass:s.a},{pClass:a.a},{pClass:l.a},{pClass:u.a},{pClass:h.a},{pClass:d.a},{pClass:f.a},{pClass:p.a},{pClass:g.a},{pClass:C.a},{pClass:x.a}],null!=t?(null!=t.links?this.options.plugins.push({pClass:c.a,options:t.links}):this.options.plugins.push({pClass:c.a}),null!=t.images?this.options.plugins.push({pClass:m.a,options:{externalFunctions:t.images,imageEditor:v.a}}):this.options.plugins.push({pClass:m.a,imageEditor:v.a}),null!=t.mentions&&(null!=t.mentions.factory.charForFire&&""!=t.mentions.factory.charForFire||(t.mentions.factory.charForFire="@"),this.options.plugins.push({pClass:y.CommaMentionsFactory,options:{fireOnChar:!0,charForFire:t.mentions.factory.charForFire,fireCreateNew:!0,fireStaticFunction:"",externalFunctions:t.mentions.factory,showAbove:t.mentions.factory.showAbove}}),this.options.plugins.push({pClass:y.CommaMention,options:{externalFunctions:t.mentions.mention}}))):(this.options.plugins.push({pClass:c.a}),this.options.plugins.push({pClass:m.a,imageEditor:v.a}))}},{key:"isContentEmpty",value:function(){return this.commaEditor.isContentEmpty()}},{key:"Undo",value:function(){return this.commaEditor.Undo()}},{key:"Redo",value:function(){return this.commaEditor.Redo()}},{key:"Focus",value:function(){return this.commaEditor.Focus()}},{key:"FocusAtTheEnd",value:function(){return this.commaEditor.FocusAtTheEnd()}},{key:"GetContent",value:function(){return this.commaEditor.GetContent()}},{key:"SetContent",value:function(e){this.commaEditor.SetContent(e)}},{key:"SetUserSettings",value:function(e){this.commaEditor.SetUserSettings(e)}},{key:"ToggleStyleOnSelection",value:function(e,t){return this.commaEditor.ToggleStyleOnSelection(e,t)}},{key:"ToggleStyleOnLine",value:function(e,t){return this.commaEditor.ToggleStyleOnLine(e,t)}},{key:"StoreCursorPosition",value:function(){return this.commaEditor.StoreCursorPosition()}},{key:"RestoreCursorPosition",value:function(){return this.commaEditor.RestoreCursorPosition()}},{key:"InsertPluginAtSection",value:function(e,t){return this.commaEditor.InsertPluginAtSection(e,t)}},{key:"CallPluginStaticMethod",value:function(e,t,n){return this.commaEditor.CallPluginStaticMethod(e,t,n)}},{key:"IsolateSelectedText",value:function(){return this.commaEditor.IsolateSelectedText()}},{key:"CreateTextNode",value:function(e,t,n,i){return r.TextNode.CreateNew(this.commaEditor.document,e,t,n,i)}},{key:"CreateInlineNode",value:function(e,t,n,i){return r.InlineNode.CreateNew(this.commaEditor.document,e,t,n,i)}},{key:"CreateBlockNode",value:function(e,t,n,i,o){i=3<arguments.length&&void 0!==i&&i,o=4<arguments.length&&void 0!==o?o:"";return r.BlockNode.CreateNew(this.commaEditor.document,e,t,n,i,o)}}])&&_(e.prototype,t),i&&_(e,i),n}()}],h={},i.m=g,i.c=h,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=17).default;function i(e){if(h[e])return h[e].exports;var t=h[e]={i:e,l:!1,exports:{}};return g[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}var g,h});